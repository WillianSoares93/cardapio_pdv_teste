<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Venda Balcão - Sâmia Pizzaria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="https://raw.githubusercontent.com/WillianSoares93/cardapio_samia_PDV/refs/heads/main/logo.png" type="image/png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #DDE2E6;
            visibility: hidden;
            overflow: hidden;
        }
        .main-container {
            display: grid;
            grid-template-columns: 0px 1fr; /* Começa com a barra lateral escondida */
            height: calc(100vh - 57px);
            transition: grid-template-columns 0.3s ease-in-out;
        }
        .main-container.sidebar-open {
            grid-template-columns: 80px 1fr; /* Mostra a barra lateral */
        }
        .main-content {
            display: grid;
            grid-template-columns: 400px 1fr 180px;
            gap: 1rem;
            padding: 1rem;
            height: 100%;
            overflow: hidden;
        }
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
        }
        .product-card {
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.5rem;
            text-align: center;
            background-color: #ffffff;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            aspect-ratio: 1 / 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
        }
        .product-card.unavailable {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #f3f4f6;
        }
         .product-card.unavailable::after {
            content: 'Esgotado';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-15deg);
            background-color: rgba(185, 28, 28, 0.8);
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.875rem;
        }
        .product-card:hover:not(.unavailable) {
            transform: translateY(-4px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border-color: #3b82f6;
        }
        .category-btn {
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
            color: #374151;
            transition: all 0.2s ease-in-out;
        }
        .category-btn.active, .category-btn:hover {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        .sidebar-nav {
            background-color: #2C3E50;
            overflow: hidden;
        }
        .sidebar-btn {
            color: #BDC3C7;
            transition: all 0.2s ease-in-out;
        }
        .sidebar-btn:hover {
            background-color: #34495E;
            color: white;
        }
        .sidebar-btn.active {
            background-color: #3b82f6;
            color: white;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
             background-color: #fff;
             padding: 1.5rem;
             border-radius: 0.5rem;
             box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
             width: 90%;
             max-width: 500px;
        }
        .ingredient-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            border: 1px solid #d1d5db;
            transition: all 0.2s ease-in-out;
        }
        .ingredient-option:hover {
            background-color: #f9fafb;
            border-color: #3b82f6;
        }
        .ingredient-option.selected-ingredient {
            background-color: #dbeafe; /* blue-100 */
            border-color: #3b82f6; /* blue-500 */
        }
        .quantity-btn {
            background-color: #e5e7eb;
            color: #4b5563;
            transition: all 0.2s ease-in-out;
            width: 28px;
            height: 28px;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            font-weight: bold;
        }
        .quantity-btn:hover:not(:disabled) {
            background-color: #d1d5db;
        }
        .half-pizza-selection-active {
            background-color: #fef9c3; /* yellow-100 */
            border: 2px dashed #f59e0b; /* yellow-500 */
        }
        .scope-button {
            transition: all 0.2s ease-in-out;
            padding: 4px 12px;
            border-radius: 9999px;
            background-color: #e5e7eb;
            color: #4b5563;
            font-size: 0.875rem;
        }
        .scope-button.active {
            background-color: #3b82f6;
            color: white;
        }
        .feedback-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #22c55e;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            z-index: 2000;
            font-size: 0.875rem;
            font-weight: 500;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            opacity: 0;
            transition: opacity 0.3s ease-in-out, top 0.3s ease-in-out;
        }
        .payment-option {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .payment-option:hover {
            background-color: #f9fafb;
            border-color: #10b981;
        }
        .payment-option.selected {
            background-color: #e6ffed; /* green-50 */
            border-color: #10b981; /* green-600 */
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
        }
        .payment-option input[type="radio"] {
            margin-right: 12px;
            accent-color: #10b981;
        }
        .payment-option .icon {
            font-size: 1.5rem;
            margin-right: 12px;
            color: #4b5563;
        }
        .payment-option.selected .icon {
            color: #10b981;
        }
        .payment-option .text-content {
            flex-grow: 1;
        }
        .payment-option .text-content h4 {
            font-weight: 600;
            color: #1f2937;
        }
        .payment-option .text-content p {
            font-size: 0.875rem;
            color: #6b7280;
        }
    </style>
</head>
<body class="h-screen flex flex-col">

    <header class="bg-white shadow-sm z-10">
        <div class="max-w-full mx-auto px-4 py-3 flex justify-between items-center">
             <div class="flex items-center space-x-4">
                <i class="fas fa-bars text-xl text-gray-600"></i>
                <h1 class="text-xl font-bold text-gray-800">VENDA BALCÃO</h1>
            </div>
            <div class="flex items-center space-x-4">
                <span id="current-user" class="text-sm font-medium text-gray-600"></span>
                <a href="pdv.html" class="px-3 py-2 bg-gray-600 text-white text-xs font-bold rounded-md hover:bg-gray-700">PAINEL PDV</a>
                <a href="gerenciar.html" class="px-3 py-2 bg-gray-600 text-white text-xs font-bold rounded-md hover:bg-gray-700">GERENCIAR</a>
                <a href="editar-cardapio.html" class="px-3 py-2 bg-gray-600 text-white text-xs font-bold rounded-md hover:bg-gray-700">EDITAR</a>
                <button id="logout-btn" class="px-3 py-2 bg-red-600 text-white text-xs font-bold rounded-md hover:bg-red-700">SAIR</button>
            </div>
        </div>
    </header>

    <div class="main-container">
        <!-- Sidebar Vertical Esquerda -->
        <aside class="sidebar-nav flex flex-col items-center py-4 space-y-4">
            <a href="pdv.html" class="sidebar-btn w-full flex flex-col items-center p-3 text-xs" title="Painel de Pedidos">
                <i class="fas fa-receipt fa-2x"></i>
                <span>PEDIDOS</span>
            </a>
            <a href="venda-balcao.html" class="sidebar-btn active w-full flex flex-col items-center p-3 text-xs" title="Venda Balcão">
                <i class="fas fa-cash-register fa-2x"></i>
                <span>BALCÃO</span>
            </a>
            <a href="editar-cardapio.html" class="sidebar-btn w-full flex flex-col items-center p-3 text-xs" title="Editar Cardápio">
                <i class="fas fa-edit fa-2x"></i>
                <span>EDITAR</span>
            </a>
            <a href="gerenciar.html" class="sidebar-btn w-full flex flex-col items-center p-3 text-xs" title="Gerenciar Itens">
                <i class="fas fa-tasks fa-2x"></i>
                <span>GERENCIAR</span>
            </a>
        </aside>

        <main class="main-content">
            <!-- Coluna da Esquerda: Pedido -->
            <section class="bg-white rounded-lg shadow-md flex flex-col overflow-hidden">
                <div class="flex-shrink-0">
                    <div class="p-4 border-b flex justify-between items-start">
                        <div>
                            <label class="text-sm font-medium text-gray-700 mb-2 block">Tipo de Pedido</label>
                            <div id="order-type-selector" class="flex space-x-4">
                                <label class="flex items-center">
                                    <input type="radio" name="orderType" value="Retirada" checked class="form-radio text-blue-600">
                                    <span class="ml-2">Retirada</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="orderType" value="Delivery" class="form-radio text-blue-600">
                                    <span class="ml-2">Delivery</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="orderType" value="Mesa" class="form-radio text-blue-600">
                                    <span class="ml-2">Mesa</span>
                                </label>
                            </div>
                        </div>
                        <button id="open-client-data-modal-btn" class="px-3 py-2 bg-blue-500 text-white font-bold rounded-md hover:bg-blue-600 text-sm whitespace-nowrap">Dados do Cliente</button>
                    </div>
                    <div id="client-data-summary" class="p-4 border-b hidden bg-blue-50 text-sm text-blue-800">
                        <!-- Summary of client data will go here -->
                    </div>
                </div>

                <div id="order-items-container" class="flex-grow overflow-y-auto p-4 space-y-4">
                     <div id="empty-cart-message" class="text-center text-gray-400 p-10 flex flex-col items-center justify-center h-full">
                        <i class="fas fa-shopping-cart fa-3x mb-4"></i>
                        <p class="font-medium">Carrinho Vazio</p>
                    </div>
                </div>
                
                <div class="flex-shrink-0 p-4 border-t bg-gray-50">
                    <div class="flex justify-between items-center text-gray-600 text-sm">
                        <span>Total de Itens</span>
                        <span id="total-items">0</span>
                    </div>
                     <div id="delivery-fee-summary" class="flex justify-between items-center text-gray-600 text-sm hidden">
                        <span>Taxa de Entrega</span>
                        <span id="delivery-fee-value">R$ 0,00</span>
                    </div>
                    <div class="flex justify-between items-center text-2xl font-bold text-gray-800 mt-2 pt-2 border-t">
                        <span>VALOR A PAGAR</span>
                        <span id="total-value">R$ 0,00</span>
                    </div>
                    <div class="mt-4 grid grid-cols-2 gap-4">
                        <button id="cancel-order-btn" class="w-full py-3 bg-red-600 text-white font-bold rounded-md hover:bg-red-700">Cancelar</button>
                        <button id="finalize-order-btn" class="w-full py-3 bg-green-600 text-white font-bold rounded-md hover:bg-green-700">Finalizar</button>
                    </div>
                </div>
            </section>

            <!-- Coluna do Meio: Produtos -->
            <section id="product-display" class="bg-white rounded-lg shadow-md flex flex-col p-4 overflow-hidden">
                 <div class="mb-4">
                    <input type="text" id="search-product" placeholder="Buscar produto..." class="w-full p-2 border rounded-md">
                </div>
                <div class="product-grid flex-grow overflow-y-auto pr-2" id="product-grid"></div>
            </section>

            <!-- Coluna da Direita: Categorias -->
            <section id="category-list" class="flex flex-col p-0 space-y-2 overflow-y-auto"></section>
        </main>
    </div>
    
    <!-- Modal de Opções de Pizza -->
    <div id="pizza-option-modal" class="modal">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <div class="flex justify-between items-center pb-3 border-b">
                <h3 id="modal-pizza-name" class="text-xl font-bold text-gray-900"></h3>
                <button id="close-pizza-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">&times;</button>
            </div>
            <div id="pizza-size-options" class="mt-4 space-y-2"></div>
        </div>
    </div>

    <!-- Modal de Montagem de Hambúrguer -->
    <div id="burger-builder-modal" class="modal">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl">
            <div class="flex justify-between items-center pb-3 border-b">
                <h3 id="modal-burger-name" class="text-xl font-bold text-gray-900">Monte seu Hambúrguer</h3>
                <button id="close-burger-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">&times;</button>
            </div>
            <div id="burger-ingredients-container" class="mt-4 mb-4 max-h-80 overflow-y-auto p-2 space-y-4"></div>
            <div class="flex justify-between items-center bg-gray-100 p-4 rounded-lg mt-4">
                <span class="text-lg font-bold">Total do Hambúrguer:</span>
                <span id="burger-total-price" class="text-2xl font-bold text-blue-600">R$ 0,00</span>
            </div>
            <div class="mt-6 flex justify-end space-x-4">
                <button id="cancel-burger-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancelar</button>
                <button id="add-custom-burger-btn" class="px-6 py-2 bg-green-600 text-white font-bold rounded-md hover:bg-green-700">Adicionar ao Pedido</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para Adicionais da Pizza -->
    <div id="pizza-extras-builder-modal" class="modal">
         <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl">
            <div class="flex justify-between items-center pb-3 border-b">
                <h3 id="pizza-extras-builder-title" class="text-xl font-bold text-gray-900">Adicionais para a Pizza</h3>
                <button id="close-pizza-extras-builder-modal" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">&times;</button>
            </div>
            <div id="pizza-extras-scope-buttons" class="flex flex-wrap gap-2 my-4 border-b pb-4"></div>
            <div id="pizza-extras-ingredients-container" class="mb-4 max-h-80 overflow-y-auto p-2"></div>
            <div class="flex justify-between items-center bg-gray-100 p-4 rounded-lg mt-4">
                <span class="text-lg font-bold">Total da Pizza:</span>
                <span id="pizza-extras-total-price" class="text-2xl font-bold text-blue-600">R$ 0,00</span>
            </div>
            <div class="mt-6 flex justify-end">
                <button id="add-pizza-with-extras-btn" class="px-6 py-2 bg-green-600 text-white font-bold rounded-md hover:bg-green-700">Confirmar Adicionais</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para perguntar sobre adicionais -->
    <div id="ask-pizza-extras-modal" class="modal">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
             <p class="text-lg font-semibold text-gray-800 mb-4 text-center">Deseja adicionar ingredientes extras?</p>
            <div class="flex justify-center gap-4">
                <button id="ask-extras-no-btn" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-lg font-bold hover:bg-gray-400 transition">Não, obrigado</button>
                <button id="ask-extras-yes-btn" class="px-6 py-2 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 transition">Sim, quero!</button>
            </div>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div id="alert-modal" class="modal">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
             <p id="alert-message" class="text-lg font-semibold text-gray-800 mb-4 text-center">Message goes here.</p>
            <div class="flex justify-center">
                <button id="alert-ok-btn" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition">OK</button>
            </div>
        </div>
    </div>

    <!-- Custom Confirm Modal -->
    <div id="confirm-modal" class="modal">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
             <p id="confirm-message" class="text-lg font-semibold text-gray-800 mb-6 text-center">Are you sure?</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-no-btn" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-lg font-bold hover:bg-gray-400 transition">Não</button>
                <button id="confirm-yes-btn" class="px-6 py-2 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition">Sim</button>
            </div>
        </div>
    </div>

    <!-- Client Data Modal -->
    <div id="client-data-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center pb-3 border-b">
                <h3 id="client-modal-title" class="text-xl font-bold text-gray-900">Dados do Cliente e Pagamento</h3>
                <button id="close-client-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">&times;</button>
            </div>
            <div id="client-modal-error-message" class="hidden mt-4 p-3 bg-red-100 text-red-700 rounded-md text-sm"></div>
            <div class="mt-4 space-y-4">
                <!-- Fields for Retirada -->
                <div id="client-modal-retirada-fields" class="hidden space-y-4">
                    <div>
                        <label for="client-modal-name-retirada" class="text-sm font-medium text-gray-700">Nome do Cliente</label>
                        <input type="text" id="client-modal-name-retirada" class="w-full mt-1 p-2 border rounded-md">
                    </div>
                    <div>
                        <label for="client-modal-contact-retirada" class="text-sm font-medium text-gray-700">Contato (Opcional)</label>
                        <input type="tel" id="client-modal-contact-retirada" class="w-full mt-1 p-2 border rounded-md">
                    </div>
                </div>
                <!-- Fields for Delivery -->
                <div id="client-modal-delivery-fields" class="hidden space-y-4">
                    <div>
                        <label for="client-modal-name-delivery" class="text-sm font-medium text-gray-700">Nome do Cliente</label>
                        <input type="text" id="client-modal-name-delivery" class="w-full mt-1 p-2 border rounded-md">
                    </div>
                    <div>
                        <label for="client-modal-contact-delivery" class="text-sm font-medium text-gray-700">Contato</label>
                        <input type="tel" id="client-modal-contact-delivery" class="w-full mt-1 p-2 border rounded-md">
                    </div>
                    <div>
                        <label for="client-modal-street" class="text-sm font-medium text-gray-700">Rua</label>
                        <input type="text" id="client-modal-street" class="w-full mt-1 p-2 border rounded-md">
                    </div>
                    <div>
                        <label for="client-modal-number" class="text-sm font-medium text-gray-700">Número</label>
                        <input type="text" id="client-modal-number" class="w-full mt-1 p-2 border rounded-md">
                    </div>
                    <div>
                        <label for="client-modal-neighborhood" class="text-sm font-medium text-gray-700">Bairro</label>
                        <select id="client-modal-neighborhood" class="w-full mt-1 p-2 border rounded-md"></select>
                    </div>
                </div>
                <!-- Fields for Mesa -->
                <div id="client-modal-mesa-fields" class="hidden space-y-4">
                    <div>
                        <label for="client-modal-table-number" class="text-sm font-medium text-gray-700">Número da Mesa</label>
                        <input type="number" id="client-modal-table-number" class="w-full mt-1 p-2 border rounded-md">
                    </div>
                    <div>
                        <label for="client-modal-name-mesa" class="text-sm font-medium text-gray-700">Nome do Cliente (Opcional)</label>
                        <input type="text" id="client-modal-name-mesa" class="w-full mt-1 p-2 border rounded-md">
                    </div>
                </div>
                <!-- Observation Field for all -->
                 <div class="mt-4">
                    <label for="client-modal-observation" class="text-sm font-medium text-gray-700">Observação (Geral)</label>
                    <textarea id="client-modal-observation" rows="2" class="w-full mt-1 p-2 border rounded-md"></textarea>
                </div>

                <!-- Payment Method Fields (NEW SECTION) -->
                <div class="pt-4 border-t border-gray-200">
                    <h4 class="text-md font-bold text-gray-800 mb-3">Forma de Pagamento</h4>
                    <div id="payment-options-container" class="flex flex-col gap-2">
                        <label class="payment-option selected" data-method="Dinheiro">
                            <input type="radio" name="modalPaymentMethod" value="Dinheiro" class="form-radio" checked>
                            <i class="fas fa-money-bill-wave icon"></i>
                            <div class="text-content">
                                <h4>Dinheiro</h4>
                            </div>
                        </label>
                        <label class="payment-option" data-method="Cartão de Crédito/Débito">
                            <input type="radio" name="modalPaymentMethod" value="Cartão de Crédito/Débito" class="form-radio">
                            <i class="fas fa-credit-card icon"></i>
                            <div class="text-content">
                                <h4>Cartão de Crédito/Débito</h4>
                            </div>
                        </label>
                        <label class="payment-option" data-method="Pix">
                            <input type="radio" name="modalPaymentMethod" value="Pix" class="form-radio">
                            <i class="fas fa-qrcode icon"></i>
                            <div class="text-content">
                                <h4>Pix</h4>
                            </div>
                        </label>
                        <label class="payment-option" data-method="A Definir">
                            <input type="radio" name="modalPaymentMethod" value="A Definir" class="form-radio">
                            <i class="fas fa-question-circle icon"></i>
                            <div class="text-content">
                                <h4>A Definir</h4>
                            </div>
                        </label>
                    </div>

                    <div id="troco-input-container" class="mt-4 p-3 border border-gray-300 rounded-lg bg-gray-50">
                        <label for="modal-trocoPara" class="block text-gray-700 text-sm font-medium mb-2">
                            Troco para (R$):
                        </label>
                        <input type="number" id="modal-trocoPara" step="0.01" min="0" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none mb-2" placeholder="0,00">
                        <p class="text-gray-600 text-sm">
                            Troco: <span id="modal-trocoTotalDisplay" class="font-bold text-green-600">R$ 0,00</span>
                        </p>
                    </div>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-4">
                <button id="cancel-client-data-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancelar</button>
                <button id="confirm-client-data-btn" class="px-6 py-2 bg-green-600 text-white font-bold rounded-md hover:bg-green-700">Confirmar e Finalizar</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        const firebaseConfig = {
           apiKey: "AIzaSyBJ44RVDGhBIlQBTx-pyIUp47XDKzRXk84",
           authDomain: "pizzaria-pdv.firebaseapp.com",
           projectId: "pizzaria-pdv",
           storageBucket: "pizzaria-pdv.firebasestorage.app",
           messagingSenderId: "304171744691",
           appId: "1:304171744691:web:e54d7f9fe55c7a75485fc6"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let allItems = [];
        let allIngredients = {};
        let allPizzaExtras = {};
        let allDeliveryFees = [];
        let order = [];
        let currentUserEmail = '';
        let currentOrderType = 'Retirada';
        let clientData = { name: null, contact: null, address: null, table: null, observation: null };
        let paymentMethod = null; 
        let pauseTime = 2000; 

        let itemStatus = {}, itemVisibility = {}, itemExtrasStatus = {}, pizzaHalfStatus = {};
        let ingredientStatus = {}, ingredientVisibility = {};
        let extraStatus = {}, extraVisibility = {};

        let isSelectingHalfPizza = false;
        let firstHalfPizza = null;
        let currentPizzaExtrasState = {};

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.body.style.visibility = 'visible';
                currentUserEmail = user.email;
                document.getElementById('current-user').textContent = currentUserEmail;
                initializeAppLogic();
            } else {
                window.location.href = 'login.html?redirect=venda-balcao.html';
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        function showAlert(message) {
            const modal = document.getElementById('alert-modal');
            const messageEl = document.getElementById('alert-message');
            const okBtn = document.getElementById('alert-ok-btn');

            messageEl.textContent = message;
            modal.style.display = 'flex';

            const closeHandler = () => {
                modal.style.display = 'none';
            };

            const modalCloseHandler = (e) => {
                if (e.target === modal) {
                    closeHandler();
                }
            };
            
            okBtn.addEventListener('click', closeHandler, { once: true });
            modal.addEventListener('click', modalCloseHandler);
        }

        function showTemporaryFeedback(message) {
            const feedbackEl = document.createElement('div');
            feedbackEl.className = 'feedback-toast';
            feedbackEl.textContent = message;
            document.body.appendChild(feedbackEl);

            setTimeout(() => {
                feedbackEl.style.top = '30px';
                feedbackEl.style.opacity = '1';
            }, 100);

            setTimeout(() => {
                feedbackEl.style.opacity = '0';
                feedbackEl.style.top = '10px';
                setTimeout(() => feedbackEl.remove(), 300);
            }, pauseTime);
        }

        function showConfirm(message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirm-modal');
                const messageEl = document.getElementById('confirm-message');
                const yesBtn = document.getElementById('confirm-yes-btn');
                const noBtn = document.getElementById('confirm-no-btn');

                messageEl.textContent = message;
                modal.style.display = 'flex';

                const close = (result) => {
                    modal.style.display = 'none';
                    yesBtn.removeEventListener('click', yesHandler);
                    noBtn.removeEventListener('click', noHandler);
                    modal.removeEventListener('click', modalCloseHandler);
                    resolve(result);
                };

                const yesHandler = () => close(true);
                const noHandler = () => close(false);
                 const modalCloseHandler = (e) => {
                    if (e.target === modal) {
                        close(false);
                    }
                };

                yesBtn.addEventListener('click', yesHandler, { once: true });
                noBtn.addEventListener('click', noHandler, { once: true });
                modal.addEventListener('click', modalCloseHandler);
            });
        }


        async function initializeAppLogic() {
            listenToStatusChanges();
            await fetchMenu();
            renderCategories();
            renderProducts();
            setupEventListeners();
            setupPaymentModalListeners();
        }

        function listenToStatusChanges() {
            onSnapshot(doc(db, "config", "item_status"), (doc) => { itemStatus = doc.exists() ? doc.data() : {}; renderProducts(); });
            onSnapshot(doc(db, "config", "item_visibility"), (doc) => { itemVisibility = doc.exists() ? doc.data() : {}; renderProducts(); });
            onSnapshot(doc(db, "config", "item_extras_status"), (doc) => { itemExtrasStatus = doc.exists() ? doc.data() : {}; });
            onSnapshot(doc(db, "config", "pizza_half_status"), (doc) => { pizzaHalfStatus = doc.exists() ? doc.data() : {}; });
            onSnapshot(doc(db, "config", "ingredient_status"), (doc) => { ingredientStatus = doc.exists() ? doc.data() : {}; });
            onSnapshot(doc(db, "config", "ingredient_visibility"), (doc) => { ingredientVisibility = doc.exists() ? doc.data() : {}; });
            onSnapshot(doc(db, "config", "extra_status"), (doc) => { extraStatus = doc.exists() ? doc.data() : {}; });
            onSnapshot(doc(db, "config", "extra_visibility"), (doc) => { extraVisibility = doc.exists() ? doc.data() : {}; });
            onSnapshot(doc(db, "config", "system_settings"), (doc) => {
                if (doc.exists() && doc.data().pause_time) {
                    pauseTime = doc.data().pause_time * 1000;
                }
            });
        }

        async function fetchMenu() {
            try {
                const response = await fetch('/api/menu');
                const data = await response.json();
                
                const promotionsWithCategory = (data.promocoes || []).map(promo => {
                    const originalItem = data.cardapio.find(item => item.id === promo.itemId);
                    return { ...promo, category: 'Promocionais', isPizza: originalItem ? originalItem.isPizza : false, isCustomizable: false, basePrice: promo.promoPrice };
                });
                
                allItems = [...(data.cardapio || []), ...promotionsWithCategory];
                
                const rawBurgerIngredients = data.ingredientesHamburguer || [];
                allIngredients = rawBurgerIngredients.reduce((acc, current) => {
                    const category = current.category || 'Outros';
                    if (!acc[category]) acc[category] = [];
                    acc[category].push(current);
                    return acc;
                }, {});
                
                const rawPizzaExtras = data.ingredientesPizza || [];
                allPizzaExtras = rawPizzaExtras.reduce((acc, current) => {
                    const category = current.category || 'Adicionais';
                    if (!acc[category]) acc[category] = [];
                    acc[category].push(current);
                    return acc;
                }, {});
                
                allDeliveryFees = data.deliveryFees || [];
                populateNeighborhoods();

            } catch (error) {
                console.error("Erro ao buscar cardápio:", error);
                showAlert("Não foi possível carregar o cardápio.");
            }
        }
        
        function populateNeighborhoods() {
            const select = document.getElementById('client-modal-neighborhood');
            select.innerHTML = '<option value="">Selecione o bairro</option>';
            allDeliveryFees.forEach(fee => {
                const option = document.createElement('option');
                option.value = fee.neighborhood;
                option.dataset.fee = fee.deliveryFee;
                option.textContent = `${fee.neighborhood} - R$ ${fee.deliveryFee.toFixed(2).replace('.', ',')}`;
                select.appendChild(option);
            });
        }
        
        function capitalizeFirstLetter(string) {
            if (!string) return '';
            return string.charAt(0).toUpperCase() + string.slice(1).toLowerCase();
        }

        function formatCategoryName(category) {
            if (category === 'Todos') return 'Todos';
            const isPizzaCategory = allItems.some(item => item.category === category && item.isPizza);
            return isPizzaCategory ? `Pizzas ${capitalizeFirstLetter(category)}` : capitalizeFirstLetter(category);
        }

        function renderCategories() {
            const categoryContainer = document.getElementById('category-list');
            const categories = ['Todos', ...new Set(allItems.map(item => item.category).filter(Boolean))];
            
            categoryContainer.innerHTML = categories.map((cat, index) => `
                <button class="category-btn w-full p-4 text-sm font-bold rounded-md ${index === 0 ? 'active' : ''}" data-category="${cat}">
                    ${formatCategoryName(cat)}
                </button>
            `).join('');

            categoryContainer.querySelectorAll('.category-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    categoryContainer.querySelector('.active').classList.remove('active');
                    btn.classList.add('active');
                    renderProducts();
                });
            });
        }

        function renderProducts() {
            const productGrid = document.getElementById('product-grid');
            const activeCategoryBtn = document.querySelector('#category-list .active');
            if (!activeCategoryBtn) return;
            
            const activeCategory = activeCategoryBtn.dataset.category;
            const searchTerm = document.getElementById('search-product').value.toLowerCase();

            const filteredMenu = allItems.filter(item => {
                const categoryMatch = activeCategory === 'Todos' || item.category === activeCategory;
                const searchMatch = !searchTerm || item.name.toLowerCase().includes(searchTerm);
                const isVisible = itemVisibility[item.id] !== false;
                return categoryMatch && searchMatch && isVisible;
            });

            if(filteredMenu.length === 0) {
                productGrid.innerHTML = `<p class="text-center text-gray-500 col-span-full mt-8">Nenhum produto encontrado para esta categoria.</p>`;
                return;
            }

            productGrid.innerHTML = filteredMenu.map(item => {
                const isUnavailable = itemStatus[item.id] === false;
                return `
                <div class="product-card ${isUnavailable ? 'unavailable' : ''}" data-item-id="${item.id}">
                    <img src="${item.imageUrl || 'https://placehold.co/100x60/d1d5db/374151?text=S%C3%A2mia'}" alt="${item.name}">
                    <span class="text-xs font-bold text-gray-800 mt-2">${item.name}</span>
                    <span class="text-sm font-bold text-blue-600">R$ ${(item.basePrice || item.price4Slices || 0).toFixed(2).replace('.', ',')}</span>
                </div>
            `}).join('');

             productGrid.querySelectorAll('.product-card:not(.unavailable)').forEach(card => {
                card.addEventListener('click', () => {
                    const itemId = card.dataset.itemId;
                    const product = allItems.find(p => p.id === itemId);
                    if (product) {
                        handleProductSelection(product);
                    }
                });
            });
        }
        
        function handleProductSelection(product) {
            if (isSelectingHalfPizza) {
                 if (!product.isPizza || pizzaHalfStatus[product.id] === false) {
                    showAlert('Por favor, escolha um sabor de pizza válido para a segunda metade.');
                    return;
                }
                
                const isSecondHalfPromotional = (product.category || '').trim().toLowerCase().replace('ç', 'c') === 'promocionais';

                if (firstHalfPizza.isPromotional && !isSecondHalfPromotional) {
                    showAlert('ERRO: Você selecionou uma pizza promocional. A segunda metade também deve ser da categoria "Promocionais".');
                    return;
                }

                if (!firstHalfPizza.isPromotional && isSecondHalfPromotional) {
                    showAlert('ERRO: Você selecionou uma pizza comum. A segunda metade não pode ser da categoria "Promocionais".');
                    return;
                }

                const priceKey = firstHalfPizza.selectedSize.priceKey;
                if(!product[priceKey] || product[priceKey] <= 0){
                    showAlert(`O sabor "${product.name}" não está disponível no tamanho de ${firstHalfPizza.selectedSize.label}.`);
                    return;
                }

                const secondHalfPrice = product[priceKey] / 2;
                const combinedPrice = firstHalfPizza.price + secondHalfPrice;
                const combinedName = `${firstHalfPizza.selectedSize.label}: Meia ${firstHalfPizza.name} & Meia ${product.name}`;

                addToOrder({
                    ...product,
                    id: `${firstHalfPizza.id}+${product.id}-${firstHalfPizza.selectedSize.slices}`,
                    name: combinedName,
                    price: combinedPrice,
                    type: 'split',
                    firstHalfData: firstHalfPizza,
                    secondHalfData: { ...product, price: secondHalfPrice, selectedSize: firstHalfPizza.selectedSize }
                });

                isSelectingHalfPizza = false;
                firstHalfPizza = null;
                document.getElementById('product-display').classList.remove('half-pizza-selection-active');
            } else {
                if (product.isPizza) {
                    openPizzaOptionsModal(product);
                } else if (product.isCustomizable) {
                    openBurgerBuilderModal(product);
                } else {
                    addToOrder({ ...product, price: product.basePrice, type: 'full' });
                }
            }
        }
        
        function addToOrder(product) {
            const uniqueId = product.uniqueId || `${product.id}-${Date.now()}`;
            
            let acceptsExtras = false;
            if (product.type === 'split') {
                const firstHalfOriginal = allItems.find(i => i.id === product.firstHalfData.id);
                const secondHalfOriginal = allItems.find(i => i.id === product.secondHalfData.id);
                
                const firstHalfAccepts = firstHalfOriginal ? (itemExtrasStatus[firstHalfOriginal.id] === undefined ? firstHalfOriginal.isPizza : itemExtrasStatus[firstHalfOriginal.id]) : false;
                const secondHalfAccepts = secondHalfOriginal ? (itemExtrasStatus[secondHalfOriginal.id] === undefined ? secondHalfOriginal.isPizza : itemExtrasStatus[secondHalfOriginal.id]) : false;
                
                acceptsExtras = firstHalfAccepts || secondHalfAccepts;
            } else {
                 const originalItem = allItems.find(i => i.id === product.id);
                 acceptsExtras = originalItem ? (itemExtrasStatus[originalItem.id] === undefined ? originalItem.isPizza : itemExtrasStatus[originalItem.id]) : false;
            }

            const itemWithId = { ...product, uniqueId, quantity: 1, extras: [], acceptsExtras };
            
            order.push(itemWithId);
            updateOrderDisplay();
            
            if(acceptsExtras && (product.type === 'full' || product.type === 'split')){
                setTimeout(() => {
                    const askModal = document.getElementById('ask-pizza-extras-modal');
                    askModal.dataset.uniqueId = uniqueId;
                    askModal.style.display = 'flex';
                }, 100);
            }
        }

        function openPizzaOptionsModal(pizza) {
            document.getElementById('modal-pizza-name').textContent = pizza.name;
            const sizeContainer = document.getElementById('pizza-size-options');
            sizeContainer.innerHTML = '';

            const sizes = [
                { slices: 4, label: '4 Fatias', priceKey: 'price4Slices' },
                { slices: 6, label: '6 Fatias', priceKey: 'price6Slices' },
                { slices: 8, label: '8 Fatias', priceKey: 'basePrice' },
                { slices: 10, label: '10 Fatias', priceKey: 'price10Slices' }
            ];

            sizes.forEach(size => {
                if (pizza[size.priceKey] > 0) {
                    const allowsHalf = pizzaHalfStatus[pizza.id] !== false;
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'p-3 border rounded-lg flex justify-between items-center';
                    optionDiv.innerHTML = `
                        <div>
                            <span class="font-bold">${size.label}</span>
                            <span class="text-gray-600 ml-2">R$ ${pizza[size.priceKey].toFixed(2).replace('.', ',')}</span>
                        </div>
                        <div class="flex gap-2">
                           <button class="add-full-pizza-btn px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600">Inteira</button>
                           <button class="add-half-pizza-btn px-3 py-1 ${allowsHalf ? 'bg-green-500 hover:bg-green-600' : 'bg-gray-400 cursor-not-allowed'} text-white text-xs rounded" ${!allowsHalf ? 'disabled' : ''}>Meia</button>
                        </div>
                    `;
                    optionDiv.querySelector('.add-full-pizza-btn').addEventListener('click', () => {
                         addToOrder({
                            ...pizza,
                            id: pizza.id,
                            name: `${size.label}: ${pizza.name}`,
                            price: pizza[size.priceKey],
                            type: 'full'
                        });
                        document.getElementById('pizza-option-modal').style.display = 'none';
                    });

                    if(allowsHalf) {
                        optionDiv.querySelector('.add-half-pizza-btn').addEventListener('click', () => {
                            isSelectingHalfPizza = true;
                            const isPromotional = (pizza.category || '').trim().toLowerCase().replace('ç', 'c') === 'promocionais';
                            firstHalfPizza = { ...pizza, selectedSize: size, price: pizza[size.priceKey] / 2, isPromotional: isPromotional };
                            document.getElementById('product-display').classList.add('half-pizza-selection-active');
                            showTemporaryFeedback(`Primeira metade: ${pizza.name}. Selecione a segunda metade.`);
                            document.getElementById('pizza-option-modal').style.display = 'none';
                        });
                    }
                    sizeContainer.appendChild(optionDiv);
                }
            });
            document.getElementById('pizza-option-modal').style.display = 'flex';
        }
        
        function openBurgerBuilderModal(burger, editIndex = null, existingItem = null) {
            const modal = document.getElementById('burger-builder-modal');
            modal.dataset.burgerId = burger.id;
            const ingredientsContainer = modal.querySelector('#burger-ingredients-container');
            ingredientsContainer.innerHTML = '';

            for (const categoryName in allIngredients) {
                const ingredients = allIngredients[categoryName].filter(ing => ingredientVisibility[ing.id] !== false);
                 if (ingredients.length === 0) continue;
                
                const firstIngredient = ingredients[0] || {};
                const isSingleChoice = firstIngredient.isSingleChoice;
                const categoryLimit = firstIngredient.limit || Infinity;
                const isRequired = firstIngredient.isRequired || false;

                let categoryHtml = `<div class="mb-4 ingredient-category" data-limit="${categoryLimit}" data-category-name="${categoryName}"><h4 class="font-bold border-b pb-1 mb-2">${capitalizeFirstLetter(categoryName)} ${isRequired ? '(Obrigatório)' : ''} ${categoryLimit !== Infinity ? `(Escolha até ${categoryLimit})` : ''}</h4>`;
                
                ingredients.forEach(ing => {
                    const isUnavailable = ingredientStatus[ing.id] === false;
                    const priceDisplay = ing.price > 0 ? `+ R$ ${ing.price.toFixed(2).replace('.', ',')}` : '';
                    if (isSingleChoice) {
                        const isChecked = existingItem && existingItem.ingredients.some(i => i.name === ing.name);
                        categoryHtml += `
                            <label class="ingredient-option ${isUnavailable ? 'opacity-50 cursor-not-allowed' : ''}">
                                <div>
                                    <input type="radio" name="${categoryName}" class="form-radio" data-price="${ing.price}" value="${ing.name}" ${isUnavailable ? 'disabled' : ''} ${isChecked ? 'checked' : ''}>
                                    <span class="ml-2">${ing.name}</span>
                                </div>
                                <span class="font-medium text-sm">${priceDisplay}</span>
                            </label>`;
                    } else {
                        const ingredientLimit = ing.ingredientLimit || 1;
                        let quantity = 0;
                        if (existingItem && existingItem.ingredients) {
                            const existingIng = existingItem.ingredients.find(i => i.name.startsWith(ing.name));
                            if(existingIng) {
                                quantity = existingIng.name.includes('(x') ? parseInt(existingIng.name.match(/\(x(\d+)\)/)[1]) : 1;
                            }
                        }
                         categoryHtml += `
                            <div class="ingredient-option ${isUnavailable ? 'opacity-50' : ''}">
                                <div class="flex-grow">
                                    <span class="ml-2">${ing.name}</span>
                                </div>
                               <div class="flex items-center space-x-2">
                                    <span class="font-medium text-sm">${priceDisplay}</span>
                                    <div class="flex items-center space-x-2" data-ingredient-id="${ing.id}" data-price="${ing.price}" data-limit="${ingredientLimit}">
                                        <button type="button" class="quantity-btn minus-btn" ${isUnavailable ? 'disabled' : ''}>-</button>
                                        <span class="quantity-display font-bold text-base w-6 text-center">${quantity}</span>
                                        <button type="button" class="quantity-btn plus-btn" ${isUnavailable ? 'disabled' : ''}>+</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });
                categoryHtml += `</div>`;
                ingredientsContainer.innerHTML += categoryHtml;
            }

            const addBtn = modal.querySelector('#add-custom-burger-btn');
            addBtn.onclick = () => addCustomBurgerToOrder(editIndex);
            addBtn.textContent = editIndex !== null ? 'Atualizar Hambúrguer' : 'Adicionar ao Pedido';
            
            updateBurgerPrice();
            modal.style.display = 'flex';
        }
        
        function updateBurgerPrice() {
            const modal = document.getElementById('burger-builder-modal');
            const burgerId = modal.dataset.burgerId;
            const burger = allItems.find(item => item.id === burgerId);
            let total = burger.basePrice;

            modal.querySelectorAll('.quantity-display').forEach(display => {
                const quantity = parseInt(display.textContent);
                if (quantity > 0) {
                    const container = display.closest('[data-ingredient-id]');
                    total += quantity * parseFloat(container.dataset.price);
                }
            });
            modal.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
                total += parseFloat(radio.dataset.price);
            });
            
            modal.querySelector('#burger-total-price').textContent = `R$ ${total.toFixed(2).replace('.',',')}`;
        }

        function addCustomBurgerToOrder(editIndex = null) {
            const modal = document.getElementById('burger-builder-modal');
            const burgerId = modal.dataset.burgerId;
            const burger = allItems.find(item => item.id === burgerId);
            const selectedIngredients = [];
            let ingredientsPrice = 0;
            
            let allRequiredCategoriesFilled = true;
            for (const categoryName in allIngredients) {
                 const ingredients = allIngredients[categoryName];
                if (ingredients.length > 0 && ingredients[0].isRequired) {
                    const categoryDiv = modal.querySelector(`.ingredient-category[data-category-name="${categoryName}"]`);
                    const radioChecked = categoryDiv.querySelector(`input[type="radio"]:checked`);
                    let quantitySelected = false;
                    categoryDiv.querySelectorAll('.quantity-display').forEach(display => {
                        if (parseInt(display.textContent) > 0) quantitySelected = true;
                    });
                    if (!radioChecked && !quantitySelected) {
                        showAlert(`Por favor, escolha uma opção na categoria obrigatória: ${categoryName}`);
                        allRequiredCategoriesFilled = false;
                        break; 
                    }
                }
            }
            if (!allRequiredCategoriesFilled) return;


            modal.querySelectorAll('.quantity-display').forEach(display => {
                const quantity = parseInt(display.textContent);
                if (quantity > 0) {
                     const container = display.closest('[data-ingredient-id]');
                     const ingredientName = container.parentElement.parentElement.querySelector('.flex-grow span').textContent;
                     const price = parseFloat(container.dataset.price);
                     selectedIngredients.push({ name: `${ingredientName} (x${quantity})`, price: price * quantity});
                     ingredientsPrice += price * quantity;
                }
            });
             modal.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
                const price = parseFloat(radio.dataset.price);
                selectedIngredients.push({ name: radio.value, price: price });
                ingredientsPrice += price;
            });
            
            const finalPrice = burger.basePrice + ingredientsPrice;
            
            const newBurger = {
                ...burger,
                id: editIndex !== null ? order[editIndex].id : `${burger.id}-${Date.now()}`,
                uniqueId: editIndex !== null ? order[editIndex].uniqueId : `${burger.id}-${Date.now()}`,
                name: `Hambúrguer Montável`,
                price: finalPrice,
                ingredients: selectedIngredients,
                type: 'custom_burger',
                originalItem: burger,
                quantity: 1
            };

            if (editIndex !== null) {
                order[editIndex] = newBurger;
            } else {
                addToOrder(newBurger);
            }

            modal.style.display = 'none';
            updateOrderDisplay();
        }

        function openPizzaExtrasBuilderModal(uniqueId) {
            const orderIndex = order.findIndex(item => item.uniqueId === uniqueId);
            if (orderIndex === -1) return;

            const pizzaItem = order[orderIndex];
            const modal = document.getElementById('pizza-extras-builder-modal');
            modal.dataset.orderIndex = orderIndex;
            const scopeButtonsContainer = modal.querySelector('#pizza-extras-scope-buttons');
            scopeButtonsContainer.innerHTML = '';
            
            currentPizzaExtrasState = { metade1: [], metade2: [], toda: [] };
            if (pizzaItem.extras && pizzaItem.extras.length > 0) {
                pizzaItem.extras.forEach(extra => {
                    let placement = 'toda';
                    if (extra.placement.includes('1ª Metade')) placement = 'metade1';
                    else if (extra.placement.includes('2ª Metade')) placement = 'metade2';
                    if (currentPizzaExtrasState[placement]) currentPizzaExtrasState[placement].push({ ...extra });
                });
            }

            if (pizzaItem.type === 'split') {
                const half1Name = pizzaItem.firstHalfData.name;
                const half2Name = pizzaItem.secondHalfData.name;
                scopeButtonsContainer.innerHTML = `
                    <button class="scope-button" data-scope="metade1">1ª Metade: ${half1Name}</button>
                    <button class="scope-button" data-scope="metade2">2ª Metade: ${half2Name}</button>
                    <button class="scope-button active" data-scope="toda">Pizza Toda</button>
                `;
                scopeButtonsContainer.querySelectorAll('.scope-button').forEach(btn => {
                    btn.addEventListener('click', () => {
                        scopeButtonsContainer.querySelector('.active').classList.remove('active');
                        btn.classList.add('active');
                        renderPizzaExtrasList(orderIndex);
                    });
                });
            }

            renderPizzaExtrasList(orderIndex);
            updatePizzaExtrasPrice(orderIndex);
            modal.style.display = 'flex';
        }
        
        function renderPizzaExtrasList(orderIndex) {
            const activeScope = document.querySelector('#pizza-extras-scope-buttons .active')?.dataset.scope || 'toda';
            const container = document.getElementById('pizza-extras-ingredients-container');
            container.innerHTML = '';
             for (const categoryName in allPizzaExtras) {
                const extras = allPizzaExtras[categoryName].filter(ext => extraVisibility[ext.id] !== false);
                 if (extras.length === 0) continue;
                
                const firstExtra = extras[0] || {};
                const categoryLimit = firstExtra.categoryLimit || Infinity;

                let categoryHtml = `<div class="mb-4 ingredient-category" data-limit="${categoryLimit}"><h4 class="font-bold border-b pb-1 mb-2">${capitalizeFirstLetter(categoryName)} ${categoryLimit !== Infinity ? `(Escolha até ${categoryLimit})` : ''}</h4>`;
                
                extras.forEach(extra => {
                    const isUnavailable = extraStatus[extra.id] === false;
                    const priceDisplay = extra.price > 0 ? `+ R$ ${extra.price.toFixed(2).replace('.', ',')}` : '';
                    const existingExtra = currentPizzaExtrasState[activeScope]?.find(e => e.name === extra.name);
                    const quantity = existingExtra ? existingExtra.quantity : 0;
                    const individualLimit = extra.limit || 1;
                    
                    categoryHtml += `
                        <div class="ingredient-option ${isUnavailable ? 'opacity-50' : ''}">
                            <div class="flex-grow">
                                <span class="ml-2">${extra.name}</span>
                            </div>
                           <div class="flex items-center space-x-2">
                                <span class="font-medium text-sm">${priceDisplay}</span>
                                <div class="flex items-center space-x-2" data-name="${extra.name}" data-price="${extra.price}" data-limit="${individualLimit}">
                                    <button type="button" class="quantity-btn minus-btn" ${isUnavailable ? 'disabled' : ''}>-</button>
                                    <span class="quantity-display font-bold text-base w-6 text-center">${quantity}</span>
                                    <button type="button" class="quantity-btn plus-btn" ${isUnavailable ? 'disabled' : ''}>+</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                categoryHtml += `</div>`;
                container.innerHTML += categoryHtml;
            }
        }

        function updatePizzaExtrasPrice(orderIndex) {
            const pizzaItem = order[orderIndex];
            
            let basePrice = pizzaItem.price;
            if (pizzaItem.extras && pizzaItem.extras.length > 0) {
                pizzaItem.extras.forEach(extra => {
                    basePrice -= (extra.price * extra.quantity);
                });
            }

            let totalExtrasPrice = 0;
            for (const scope in currentPizzaExtrasState) {
                currentPizzaExtrasState[scope].forEach(extra => {
                    totalExtrasPrice += (extra.price * extra.quantity);
                });
            }

            document.getElementById('pizza-extras-total-price').textContent = `R$ ${(basePrice + totalExtrasPrice).toFixed(2).replace('.', ',')}`;
        }
        
        function confirmPizzaExtras() {
            const orderIndex = parseInt(document.getElementById('pizza-extras-builder-modal').dataset.orderIndex);
            if (isNaN(orderIndex)) return;
            
            const pizzaItem = order[orderIndex];
            let basePrice = pizzaItem.price;
             if (pizzaItem.extras && pizzaItem.extras.length > 0) {
                pizzaItem.extras.forEach(extra => { basePrice -= (extra.price * extra.quantity); });
            }
            
            const finalExtras = [];
            let finalExtrasPrice = 0;
            
            for (const scope in currentPizzaExtrasState) {
                currentPizzaExtrasState[scope].forEach(extra => {
                    if(extra.quantity > 0) {
                        finalExtras.push(extra);
                        finalExtrasPrice += (extra.price * extra.quantity);
                    }
                });
            }
            
            pizzaItem.extras = finalExtras;
            pizzaItem.price = basePrice + finalExtrasPrice;
            
            updateOrderDisplay();
            document.getElementById('pizza-extras-builder-modal').style.display = 'none';
        }

        function updateOrderDisplay() {
            const container = document.getElementById('order-items-container');
            const totalValueEl = document.getElementById('total-value');
            const totalItemsEl = document.getElementById('total-items');
            const deliveryFeeSummary = document.getElementById('delivery-fee-summary');
            const deliveryFeeValue = document.getElementById('delivery-fee-value');
            
            let subtotal = 0;
            let totalItems = 0;

            container.innerHTML = ''; 

            if (order.length === 0) {
                container.innerHTML = `
                     <div id="empty-cart-message" class="text-center text-gray-400 p-10 flex flex-col items-center justify-center h-full">
                        <i class="fas fa-shopping-cart fa-3x mb-4"></i>
                        <p class="font-medium">Carrinho Vazio</p>
                    </div>`;
            } else {
                const itemsByCategory = order.reduce((acc, item) => {
                    const rawCategory = item.isPizza ? `Pizzas ${item.category}` : item.category;
                    const category = formatCategoryName(rawCategory || 'Outros');
                    if (!acc[category]) {
                        acc[category] = [];
                    }
                    acc[category].push(item);
                    return acc;
                }, {});

                Object.keys(itemsByCategory).forEach(category => {
                    const categoryTitle = document.createElement('h4');
                    categoryTitle.className = 'text-sm font-bold text-gray-500 uppercase tracking-wider pb-1 border-b mb-2';
                    categoryTitle.textContent = category;
                    container.appendChild(categoryTitle);

                    itemsByCategory[category].forEach(item => {
                        const currentSubtotal = item.price * item.quantity;
                        subtotal += currentSubtotal;
                        totalItems += item.quantity;

                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'py-2';

                        let detailsHtml = '';
                        if (item.extras && item.extras.length > 0) {
                            detailsHtml += `<ul class="text-xs text-gray-600 pl-4 mt-1 space-y-px">${item.extras.map(extra => {
                                const quantityText = extra.quantity > 1 ? ` (x${extra.quantity})` : '';
                                const priceText = extra.price > 0 ? ` +R$ ${(extra.price * extra.quantity).toFixed(2).replace('.',',')}` : '';
                                return `<li>• ${extra.name} (${extra.placement})${quantityText}${priceText}</li>`;
                            }).join('')}</ul>`;
                        } else if (item.ingredients && item.ingredients.length > 0) {
                            detailsHtml += `<ul class="text-xs text-gray-600 pl-4 mt-1 space-y-px">${item.ingredients.map(ing => `<li>• ${ing.name}</li>`).join('')}</ul>`;
                        }
                        
                        let actionButtonHtml = '';
                        if (item.acceptsExtras) {
                            const hasExtras = item.extras && item.extras.length > 0;
                            const buttonText = hasExtras ? 'Editar Adicionais' : 'Incluir Adicionais';
                            const iconClass = hasExtras ? 'fas fa-pencil-alt' : 'fas fa-plus';
                            actionButtonHtml = `<button class="edit-extras-btn mt-2 px-3 py-1 bg-blue-100 text-blue-800 rounded-full hover:bg-blue-200 text-xs font-semibold inline-flex items-center gap-2 transition-colors" data-unique-id="${item.uniqueId}">
                                <i class="${iconClass} fa-fw"></i>
                                <span>${buttonText}</span>
                            </button>`;
                        } else if (item.type === 'custom_burger') {
                            actionButtonHtml = `<button class="edit-burger-btn mt-2 px-3 py-1 bg-blue-100 text-blue-800 rounded-full hover:bg-blue-200 text-xs font-semibold inline-flex items-center gap-2 transition-colors" data-unique-id="${item.uniqueId}">
                                <i class="fas fa-pencil-alt fa-fw"></i>
                                <span>Editar Hambúrguer</span>
                            </button>`;
                        }

                        itemDiv.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div class="flex-1 pr-2">
                                    <p class="font-semibold text-gray-800">${item.name}</p>
                                    ${detailsHtml}
                                </div>
                                <div class="flex items-center">
                                    <p class="font-bold text-gray-900 mr-4">R$ ${currentSubtotal.toFixed(2).replace('.',',')}</p>
                                    <button class="remove-item-btn text-red-500 hover:text-red-700" data-unique-id="${item.uniqueId}"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            </div>
                            ${actionButtonHtml}
                        `;
                        container.appendChild(itemDiv);
                    });
                });
            }
            
            let deliveryFee = 0;
            if (currentOrderType === 'Delivery' && clientData.address) {
                const selectedFee = allDeliveryFees.find(fee => fee.neighborhood === clientData.address.neighborhood);
                if(selectedFee) {
                    deliveryFee = selectedFee.deliveryFee;
                }
            }
            
            if (deliveryFee > 0) {
                deliveryFeeValue.textContent = `R$ ${deliveryFee.toFixed(2).replace('.',',')}`;
                deliveryFeeSummary.classList.remove('hidden');
            } else {
                deliveryFeeSummary.classList.add('hidden');
            }

            const total = subtotal + deliveryFee;
            totalValueEl.textContent = `R$ ${total.toFixed(2).replace('.',',')}`;
            totalItemsEl.textContent = totalItems;
            
            // Re-attach event listeners for dynamic elements
            if (order.length > 0) {
                container.querySelectorAll('.remove-item-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const uniqueId = btn.dataset.uniqueId;
                        order = order.filter(item => item.uniqueId !== uniqueId);
                        updateOrderDisplay();
                    });
                });
                container.querySelectorAll('.edit-extras-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const uniqueId = btn.dataset.uniqueId;
                        openPizzaExtrasBuilderModal(uniqueId);
                    });
                });
                container.querySelectorAll('.edit-burger-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const uniqueId = btn.dataset.uniqueId;
                        const index = order.findIndex(item => item.uniqueId === uniqueId);
                        if (index !== -1) {
                            const itemToEdit = order[index];
                            if (itemToEdit.originalItem) {
                                openBurgerBuilderModal(itemToEdit.originalItem, index, itemToEdit);
                            }
                        }
                    });
                });
            }
        }
        
        async function setupEventListeners() {
            const mainContainer = document.querySelector('.main-container');
            const sidebar = document.querySelector('.sidebar-nav');
            const mainContent = document.querySelector('.main-content');
            const trocoParaInput = document.getElementById('modal-trocoPara');
            const trocoTotalDisplay = document.getElementById('modal-trocoTotalDisplay');

            document.addEventListener('mousemove', (e) => {
                if (e.clientX < 20) {
                    mainContainer.classList.add('sidebar-open');
                }
            });

            sidebar.addEventListener('mouseleave', () => {
                mainContainer.classList.remove('sidebar-open');
            });
            
            mainContent.addEventListener('mouseenter', () => {
                mainContainer.classList.remove('sidebar-open');
            });

            document.getElementById('search-product').addEventListener('input', renderProducts);
            document.getElementById('cancel-order-btn').addEventListener('click', async () => {
                if (order.length > 0 || clientData.name || clientData.table) {
                    const confirmed = await showConfirm('Deseja cancelar o pedido atual e limpar os dados do cliente?');
                    if (confirmed) {
                        order = [];
                        clientData = { name: null, contact: null, address: null, table: null, observation: null };
                        paymentMethod = null; // NEW: Reset payment method
                        isSelectingHalfPizza = false;
                        firstHalfPizza = null;
                        document.getElementById('product-display').classList.remove('half-pizza-selection-active');
                        updateOrderDisplay();
                        updateClientDataSummary();
                    }
                }
            });
            
            document.getElementById('finalize-order-btn').addEventListener('click', finalizeOrderCheck);
            
            const pizzaModal = document.getElementById('pizza-option-modal');
            document.getElementById('close-pizza-modal-btn').addEventListener('click', () => pizzaModal.style.display = 'none');
            
            const burgerModal = document.getElementById('burger-builder-modal');
            document.getElementById('close-burger-modal-btn').addEventListener('click', () => burgerModal.style.display = 'none');
            document.getElementById('cancel-burger-btn').addEventListener('click', () => burgerModal.style.display = 'none');
            
            const extrasModal = document.getElementById('pizza-extras-builder-modal');
            document.getElementById('close-pizza-extras-builder-modal').addEventListener('click', () => extrasModal.style.display = 'none');
            document.getElementById('add-pizza-with-extras-btn').addEventListener('click', confirmPizzaExtras);
            
            const askExtrasModal = document.getElementById('ask-pizza-extras-modal');
            document.getElementById('ask-extras-no-btn').addEventListener('click', () => askExtrasModal.style.display = 'none');
            document.getElementById('ask-extras-yes-btn').addEventListener('click', () => {
                const uniqueId = askExtrasModal.dataset.uniqueId;
                openPizzaExtrasBuilderModal(uniqueId);
                askExtrasModal.style.display = 'none';
            });
            
             document.getElementById('order-type-selector').addEventListener('change', (e) => {
                currentOrderType = e.target.value;
                clientData = { name: null, contact: null, address: null, table: null, observation: null };
                paymentMethod = null; // NEW: Reset payment method
                updateClientDataSummary();
                updateOrderDisplay();
            });
            
            document.getElementById('open-client-data-modal-btn').addEventListener('click', openClientDataModal);


            window.addEventListener('click', (e) => {
                const clientModal = document.getElementById('client-data-modal');
                if (e.target === pizzaModal) pizzaModal.style.display = 'none';
                if (e.target === burgerModal) burgerModal.style.display = 'none';
                if (e.target === extrasModal) extrasModal.style.display = 'none';
                if (e.target === askExtrasModal) askExtrasModal.style.display = 'none';
                if (e.target === clientModal) clientModal.style.display = 'none';
            });
            
            document.getElementById('burger-ingredients-container').addEventListener('click', handleBurgerIngredientClick);
            document.getElementById('pizza-extras-ingredients-container').addEventListener('click', handlePizzaExtrasIngredientClick);

            document.getElementById('close-client-modal-btn').addEventListener('click', () => document.getElementById('client-data-modal').style.display = 'none');
            document.getElementById('cancel-client-data-btn').addEventListener('click', () => document.getElementById('client-data-modal').style.display = 'none');
            document.getElementById('confirm-client-data-btn').addEventListener('click', confirmClientData);
            
            // NEW: Payment method listeners inside the modal
            document.getElementById('payment-options-container').addEventListener('click', (e) => {
                const label = e.target.closest('.payment-option');
                if (label) {
                    document.querySelectorAll('.payment-option').forEach(opt => opt.classList.remove('selected'));
                    label.classList.add('selected');

                    const method = label.dataset.method;
                    const isCash = method === 'Dinheiro';

                    document.getElementById('troco-input-container').classList.toggle('hidden', !isCash);

                    // Clear troco data if not cash
                    if (!isCash) {
                        trocoParaInput.value = '';
                        trocoTotalDisplay.textContent = 'R$ 0,00';
                    } else {
                        // Calculate troco immediately if cash is selected and there's an input value
                        calculateTroco();
                    }
                }
            });

            // NEW: Troco input listener
            trocoParaInput.addEventListener('input', calculateTroco);
        }
        
        function handleBurgerIngredientClick(e) {
            const quantityBtn = e.target.closest('.quantity-btn');
            const radioInput = e.target.closest('.ingredient-option')?.querySelector('input[type="radio"]');

            if (quantityBtn) {
                e.stopPropagation();
                const container = quantityBtn.closest('[data-ingredient-id]');
                const display = container.querySelector('.quantity-display');
                const ingredientLimit = parseInt(container.dataset.limit);
                let quantity = parseInt(display.textContent);

                const categoryDiv = container.closest('.ingredient-category');
                const categoryLimit = parseInt(categoryDiv.dataset.limit);
                
                if (quantityBtn.classList.contains('plus-btn')) {
                    if (quantity === 0) { 
                        let currentVarietyCount = 0;
                        categoryDiv.querySelectorAll('.ingredient-option').forEach(opt => {
                            const radio = opt.querySelector('input[type="radio"]');
                            const qtyDisplay = opt.querySelector('.quantity-display');
                            if ((radio && radio.checked) || (qtyDisplay && parseInt(qtyDisplay.textContent) > 0)) {
                                currentVarietyCount++;
                            }
                        });

                        if (currentVarietyCount >= categoryLimit) {
                           showAlert(`Você pode escolher no máximo ${categoryLimit} variedades nesta categoria.`);
                            return;
                        }
                    }
                    if (quantity < ingredientLimit) {
                        quantity++;
                    }
                } else if (quantity > 0) {
                    quantity--;
                }
                display.textContent = quantity;
                container.closest('.ingredient-option').classList.toggle('selected-ingredient', quantity > 0);
                updateBurgerPrice();

            } else if (radioInput) {
                if (radioInput.disabled) return;
                
                const categoryDiv = radioInput.closest('.ingredient-category');
                const categoryLimit = parseInt(categoryDiv.dataset.limit);
                const isReplacing = categoryDiv.querySelector(`input[name="${radioInput.name}"]:checked`);

                if (!isReplacing) {
                    let currentVarietyCount = 0;
                    categoryDiv.querySelectorAll('.quantity-display').forEach(d => {
                        if (parseInt(d.textContent) > 0) currentVarietyCount++;
                    });
                    
                    categoryDiv.querySelectorAll('input[type="radio"]:checked').forEach(() => currentVarietyCount++);

                    if ((currentVarietyCount + 1) > categoryLimit) {
                        showAlert(`Você pode escolher no máximo ${categoryLimit} variedades nesta categoria.`);
                        e.preventDefault();
                        return;
                    }
                }
                
                setTimeout(() => {
                    const categoryName = radioInput.name;
                    document.querySelectorAll(`input[name="${categoryName}"]`).forEach(r => {
                        r.closest('.ingredient-option').classList.toggle('selected-ingredient', r.checked);
                    });
                    updateBurgerPrice();
                }, 0);
            }
        }

        function handlePizzaExtrasIngredientClick(e) {
            const target = e.target.closest('.quantity-btn');
            if (!target) return;

            const orderIndex = parseInt(document.getElementById('pizza-extras-builder-modal').dataset.orderIndex);
            const display = target.parentElement.querySelector('.quantity-display');
            const extraContainer = target.closest('[data-name]');
            const ingredientLimit = parseInt(extraContainer.dataset.limit);

            let quantity = parseInt(display.textContent);

            const categoryDiv = extraContainer.closest('.ingredient-category');
            const categoryLimit = parseInt(categoryDiv.dataset.limit);
            let currentCategoryVarietyCount = 0;
            categoryDiv.querySelectorAll('.quantity-display').forEach(d => {
                if (parseInt(d.textContent) > 0) {
                    currentCategoryVarietyCount++;
                }
            });

            if (target.classList.contains('plus-btn')) {
                if (quantity >= ingredientLimit) {
                    showAlert(`O limite para este adicional é ${ingredientLimit}.`);
                    return;
                }
                if (quantity === 0 && currentCategoryVarietyCount >= categoryLimit) {
                    showAlert(`Você pode escolher no máximo ${categoryLimit} variedades nesta categoria.`);
                    return;
                }
                quantity++;
            } else if (target.classList.contains('minus-btn')) {
                if (quantity > 0) {
                    quantity--;
                }
            }
            display.textContent = quantity;

            const activeScope = document.querySelector('#pizza-extras-scope-buttons .active')?.dataset.scope || 'toda';
            const extraName = extraContainer.dataset.name;
            const extraPrice = parseFloat(extraContainer.dataset.price);

            const existingExtraIndex = currentPizzaExtrasState[activeScope].findIndex(ex => ex.name === extraName);
            
            if (quantity > 0) {
                const placementText = activeScope === 'toda' ? 'Toda' : (activeScope === 'metade1' ? '1ª Metade' : '2ª Metade');
                if (existingExtraIndex > -1) {
                    currentPizzaExtrasState[activeScope][existingExtraIndex].quantity = quantity;
                } else {
                    currentPizzaExtrasState[activeScope].push({ name: extraName, price: extraPrice, placement: placementText, quantity: quantity });
                }
            } else {
                if (existingExtraIndex > -1) {
                    currentPizzaExtrasState[activeScope].splice(existingExtraIndex, 1);
                }
            }
            updatePizzaExtrasPrice(orderIndex);
        }
        
        function openClientDataModal() {
            const modal = document.getElementById('client-data-modal');
            const errorDiv = document.getElementById('client-modal-error-message');
            errorDiv.classList.add('hidden');
            
            document.getElementById('client-modal-title').textContent = currentOrderType === 'Delivery' 
                ? 'Dados do Cliente e Pagamento (Delivery)' 
                : (currentOrderType === 'Retirada' 
                    ? 'Dados do Cliente e Pagamento (Retirada)'
                    : 'Dados da Mesa e Pagamento');

            modal.querySelectorAll('#client-modal-retirada-fields, #client-modal-delivery-fields, #client-modal-mesa-fields').forEach(f => f.classList.add('hidden'));

            if (currentOrderType === 'Retirada') {
                document.getElementById('client-modal-retirada-fields').classList.remove('hidden');
                document.getElementById('client-modal-name-retirada').value = clientData.name || '';
                document.getElementById('client-modal-contact-retirada').value = clientData.contact || '';
            } else if (currentOrderType === 'Delivery') {
                document.getElementById('client-modal-delivery-fields').classList.remove('hidden');
                document.getElementById('client-modal-name-delivery').value = clientData.name || '';
                document.getElementById('client-modal-contact-delivery').value = clientData.contact || '';
                document.getElementById('client-modal-street').value = clientData.address ? clientData.address.street : '';
                document.getElementById('client-modal-number').value = clientData.address ? clientData.address.number : '';
                document.getElementById('client-modal-neighborhood').value = clientData.address ? clientData.address.neighborhood : '';
            } else { // Mesa
                document.getElementById('client-modal-mesa-fields').classList.remove('hidden');
                document.getElementById('client-modal-table-number').value = clientData.table || '';
                document.getElementById('client-modal-name-mesa').value = clientData.name || '';
            }
            
            // Populates Observation
            document.getElementById('client-modal-observation').value = clientData.observation || '';
            
            // Populates Payment Method
            const selectedMethod = paymentMethod ? (typeof paymentMethod === 'object' ? paymentMethod.method : paymentMethod) : 'Dinheiro';
            document.querySelector(`input[name="modalPaymentMethod"][value="${selectedMethod}"]`).checked = true;
            document.querySelectorAll('.payment-option').forEach(opt => opt.classList.remove('selected')); 
            document.querySelector(`input[name="modalPaymentMethod"]:checked`).closest('.payment-option').classList.add('selected');

            // Populates Troco
            const isCash = selectedMethod === 'Dinheiro';
            const trocoParaInput = document.getElementById('modal-trocoPara');
            const trocoTotalDisplay = document.getElementById('modal-trocoTotalDisplay');
            document.getElementById('troco-input-container').classList.toggle('hidden', !isCash);
            
            if (isCash && typeof paymentMethod === 'object' && paymentMethod.trocoPara) {
                trocoParaInput.value = paymentMethod.trocoPara;
            } else {
                trocoParaInput.value = '';
            }
            calculateTroco();

            // Set Total Value for summary
            const totalValue = order.reduce((sum, item) => sum + item.price, 0) + (currentOrderType === 'Delivery' && clientData.address ? clientData.address.deliveryFee : 0);
            document.getElementById('payment-modal-total').textContent = `R$ ${totalValue.toFixed(2).replace('.',',')}`;


            modal.style.display = 'flex';
        }
        
        function calculateTroco() {
            const trocoParaInput = document.getElementById('modal-trocoPara');
            const trocoTotalDisplay = document.getElementById('modal-trocoTotalDisplay');
            const totalValue = order.reduce((sum, item) => sum + item.price, 0) + (currentOrderType === 'Delivery' && clientData.address ? clientData.address.deliveryFee : 0);

            const trocoPara = parseFloat(trocoParaInput.value.replace(',', '.')) || 0;
            
            if (trocoPara > 0 && trocoPara >= totalValue) {
                const trocoTotal = trocoPara - totalValue;
                trocoTotalDisplay.textContent = `R$ ${trocoTotal.toFixed(2).replace('.', ',')}`;
                trocoTotalDisplay.classList.remove('text-red-600'); 
                trocoTotalDisplay.classList.add('text-green-600'); 
            } else {
                trocoTotalDisplay.textContent = 'R$ 0,00';
                trocoTotalDisplay.classList.remove('text-green-600');
                trocoTotalDisplay.classList.add('text-red-600'); 
            }
        }


        function confirmClientData() {
            if (order.length === 0) {
                showAlert("O carrinho está vazio.");
                return;
            }
            
            const errorDiv = document.getElementById('client-modal-error-message');
            errorDiv.classList.add('hidden');
            
            let currentClientData = {};
            
            // 1. Coleta Dados do Cliente/Mesa
            if (currentOrderType === 'Retirada') {
                currentClientData.name = document.getElementById('client-modal-name-retirada').value.trim();
                currentClientData.contact = document.getElementById('client-modal-contact-retirada').value.trim();
                if (!currentClientData.name) {
                    errorDiv.textContent = "Para Retirada, o nome do cliente é obrigatório.";
                    errorDiv.classList.remove('hidden');
                    return;
                }
            } else if (currentOrderType === 'Delivery') {
                currentClientData.name = document.getElementById('client-modal-name-delivery').value.trim();
                currentClientData.contact = document.getElementById('client-modal-contact-delivery').value.trim();
                const street = document.getElementById('client-modal-street').value.trim();
                const number = document.getElementById('client-modal-number').value.trim();
                const neighborhood = document.getElementById('client-modal-neighborhood').value;
                if (!currentClientData.name || !currentClientData.contact || !street || !number || !neighborhood) {
                    errorDiv.textContent = "Para Delivery, todos os campos são obrigatórios (Nome, Contato, Endereço).";
                    errorDiv.classList.remove('hidden');
                    return;
                }
                const selectedFee = allDeliveryFees.find(fee => fee.neighborhood === neighborhood);
                currentClientData.address = { 
                    street, 
                    number, 
                    neighborhood, 
                    deliveryFee: selectedFee ? selectedFee.deliveryFee : 0 
                };
            } else { // Mesa
                currentClientData.table = document.getElementById('client-modal-table-number').value.trim();
                currentClientData.name = document.getElementById('client-modal-name-mesa').value.trim();
                if (!currentClientData.table) {
                    errorDiv.textContent = "O número da mesa é obrigatório.";
                    errorDiv.classList.remove('hidden');
                    return;
                }
            }
            
            // Coleta Observação
            currentClientData.observation = document.getElementById('client-modal-observation').value.trim();

            // 2. Coleta Forma de Pagamento
            const selectedPaymentRadio = document.querySelector('input[name="modalPaymentMethod"]:checked');
            if (!selectedPaymentRadio) {
                errorDiv.textContent = "Selecione uma forma de pagamento.";
                errorDiv.classList.remove('hidden');
                return;
            }
            
            const method = selectedPaymentRadio.value;
            let finalPaymentData;
            const totalValue = order.reduce((sum, item) => sum + item.price, 0) + (currentOrderType === 'Delivery' && currentClientData.address ? currentClientData.address.deliveryFee : 0);

            if (method === 'Dinheiro') {
                const trocoPara = parseFloat(document.getElementById('modal-trocoPara').value.replace(',', '.')) || 0;
                if (trocoPara > 0 && trocoPara < totalValue) {
                    errorDiv.textContent = `O valor para troco (R$ ${trocoPara.toFixed(2).replace('.', ',')}) não pode ser menor que o total (R$ ${totalValue.toFixed(2).replace('.', ',')}).`;
                    errorDiv.classList.remove('hidden');
                    return;
                }
                const trocoTotal = trocoPara > 0 ? trocoPara - totalValue : 0;
                finalPaymentData = { method: 'Dinheiro', trocoPara: trocoPara, trocoTotal: trocoTotal };
            } else {
                finalPaymentData = method;
            }

            // Atualiza o estado global
            clientData = currentClientData;
            paymentMethod = finalPaymentData;

            document.getElementById('client-data-modal').style.display = 'none';
            updateClientDataSummary();
            updateOrderDisplay();
            
            // Tenta Finalizar o Pedido
            finalizeOrder();
        }

        function updateClientDataSummary() {
            const summaryDiv = document.getElementById('client-data-summary');
            if (!clientData.name && !clientData.table) {
                summaryDiv.classList.add('hidden');
                return;
            }

            let summaryHtml = '';
            
            // 1. Tipo e Nome
            if (currentOrderType === 'Mesa') {
                summaryHtml = `<strong>Mesa:</strong> ${clientData.table || 'N/A'}`;
                 if(clientData.name) {
                    summaryHtml += ` | <strong>Cliente:</strong> ${clientData.name}`;
                }
            } else {
                summaryHtml = `<strong>Cliente:</strong> ${clientData.name || 'N/A'}`;
            }

            // 2. Contato/Endereço
            if(clientData.contact) summaryHtml += ` | <strong>Contato:</strong> ${clientData.contact}`;
            if(currentOrderType === 'Delivery' && clientData.address) {
                summaryHtml += `<br><strong>Endereço:</strong> ${clientData.address.street}, ${clientData.address.number} - ${clientData.address.neighborhood}`;
            }

            // 3. Pagamento
            let paymentText = '';
            if (paymentMethod) {
                if (typeof paymentMethod === 'object' && paymentMethod.method === 'Dinheiro') {
                    paymentText = `Dinheiro (Troco p/ R$ ${paymentMethod.trocoPara.toFixed(2).replace('.', ',')})`;
                } else {
                    paymentText = paymentMethod;
                }
            } else {
                paymentText = 'A DEFINIR';
            }
            summaryHtml += `<br><strong>Pagamento:</strong> ${paymentText}`;

            // 4. Observação
            if (clientData.observation) {
                 summaryHtml += `<br><strong>Obs. Cliente:</strong> ${clientData.observation}`;
            }

            summaryDiv.innerHTML = summaryHtml;
            summaryDiv.classList.remove('hidden');
        }

        function finalizeOrderCheck() {
            if (order.length === 0) {
                showAlert("O carrinho está vazio.");
                return;
            }
            
            // Se os dados do cliente não estiverem completos (para o tipo de pedido), abre o modal.
            let isDataIncomplete = false;
            
            if (currentOrderType === 'Retirada' && !clientData.name) {
                isDataIncomplete = true;
            } else if (currentOrderType === 'Mesa' && !clientData.table) {
                isDataIncomplete = true;
            } else if (currentOrderType === 'Delivery' && (!clientData.name || !clientData.address)) {
                isDataIncomplete = true;
            }

            if (isDataIncomplete) {
                // Abre o modal de dados do cliente, que agora inclui o pagamento
                openClientDataModal();
                return;
            }
            
            // Se os dados estão no estado global, mas a forma de pagamento não está definida (o que pode acontecer se o atendente nunca abriu o modal)
            if (!paymentMethod) {
                 openClientDataModal();
                 return;
            }
            
            // Se tudo estiver OK, finaliza
            finalizeOrder();
        }


        async function finalizeOrder() {
            if(order.length === 0) {
                showAlert("O carrinho está vazio.");
                return;
            }
            
            // Revalida dados críticos antes de enviar
            if ( (currentOrderType === 'Mesa' && !clientData.table) || 
                 (currentOrderType === 'Retirada' && !clientData.name) || 
                 (currentOrderType === 'Delivery' && (!clientData.name || !clientData.address)) ||
                 (!paymentMethod) ) 
            {
                showAlert("Dados do cliente ou forma de pagamento incompletos. Tente novamente.");
                return;
            }


            let subtotal = order.reduce((sum, item) => sum + item.price, 0);
            let deliveryFee = 0;
            let endereco = {};
            let status = 'Novo'; 

            if(currentOrderType === 'Delivery') {
                deliveryFee = clientData.address.deliveryFee;
                endereco = { 
                    clientName: clientData.name, 
                    telefone: clientData.contact, 
                    rua: clientData.address.street, 
                    numero: clientData.address.number, 
                    bairro: clientData.address.neighborhood 
                };
            } else if (currentOrderType === 'Mesa') {
                let clientNameForOrder = `Mesa ${clientData.table}`;
                if (clientData.name) {
                    clientNameForOrder += ` (${clientData.name})`;
                }
                endereco = { clientName: clientNameForOrder, rua: 'Mesa' };
                status = 'Em Preparo';
            } else { // Retirada
                endereco = { 
                    clientName: clientData.name || 'Cliente Balcão', 
                    telefone: clientData.contact, 
                    rua: 'Retirada no Balcão' 
                };
            }
            
            const cleanedItems = JSON.parse(JSON.stringify(order, (key, value) => {
                const fieldsToExclude = ['originalItem', 'uniqueId', 'firstHalfData', 'secondHalfData', 'acceptsExtras'];
                if (fieldsToExclude.includes(key)) return undefined;
                return value;
            }));

            const newOrder = {
                itens: cleanedItems,
                endereco: endereco,
                total: { subtotal: subtotal, finalTotal: subtotal + deliveryFee, deliveryFee: deliveryFee, discount: 0 },
                pagamento: paymentMethod, // NEW: Usando o paymentMethod do estado
                status: status,
                criadoEm: serverTimestamp(),
                observacao: clientData.observation || `Venda de balcão por ${currentUserEmail}`
            };

            try {
                await addDoc(collection(db, "pedidos"), newOrder);
                showTemporaryFeedback(`Pedido para ${clientData.name || `Mesa ${clientData.table}`} finalizado com sucesso!`);
                
                // Reseta o estado
                order = [];
                clientData = { name: null, contact: null, address: null, table: null, observation: null };
                paymentMethod = null;
                updateOrderDisplay();
                updateClientDataSummary();
            } catch (error) {
                console.error("Erro ao finalizar pedido:", error);
                showAlert("Falha ao finalizar o pedido. Tente novamente.");
            }
        }
    </script>
</body>
</html>
