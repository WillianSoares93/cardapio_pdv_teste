<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDV - Sâmia Pizzaria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="https://raw.githubusercontent.com/WillianSoares93/cardapio_samia_PDV/refs/heads/main/logo.png" type="image/png">
    <style>
        body { font-family: 'Roboto', sans-serif; visibility: hidden; }
        .kanban-column { min-width: 300px; }
        .card { transition: transform 0.2s; }
        .card.dragging { transform: rotate(3deg); opacity: 0.8; }
        .card.expanded {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90vw;
            max-width: 600px;
            z-index: 100;
        }
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 99;
        }
        .card.expanded ~ .overlay {
            display: block;
        }
        .highlight {
            background-color: #e0f2fe; /* light-blue-100 */
            border: 2px dashed #38bdf8; /* light-blue-400 */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app-container" class="h-screen flex flex-col">
        <!-- Cabeçalho -->
        <header class="bg-white shadow-md p-4 flex justify-between items-center z-20">
            <h1 class="text-2xl font-bold">Quadro de Pedidos</h1>
            <div class="flex items-center space-x-4">
                <button id="abrir-caixa-btn" class="px-4 py-2 bg-green-500 text-white font-bold rounded-md hover:bg-green-600">Abrir Caixa</button>
                <button id="fechar-caixa-btn" class="px-4 py-2 bg-red-500 text-white font-bold rounded-md hover:bg-red-600" disabled>Fechar Caixa</button>
                <button id="sangria-btn" class="px-4 py-2 bg-yellow-500 text-white font-bold rounded-md hover:bg-yellow-600" disabled>Registrar Sangria</button>
                <span id="caixa-status" class="text-sm font-semibold text-red-600">CAIXA FECHADO</span>
                 <a href="editar-cardapio.html" class="px-4 py-2 bg-blue-600 text-white text-sm font-bold rounded-md hover:bg-blue-700 transition-colors">
                    <i class="fas fa-edit mr-2"></i>Gerenciar Cardápio
                </a>
                <button id="logout-btn" class="px-4 py-2 bg-gray-500 text-white font-bold rounded-md hover:bg-gray-600">Sair</button>
            </div>
        </header>

        <!-- Abas -->
        <div class="px-4 pt-4 bg-white border-b">
            <nav class="flex space-x-4">
                <button data-tab="delivery" class="tab-btn py-2 px-4 font-semibold text-gray-500 border-b-2 border-transparent hover:border-red-500 hover:text-red-500 active">Delivery/Retirada</button>
                <button data-tab="mesas" class="tab-btn py-2 px-4 font-semibold text-gray-500 border-b-2 border-transparent hover:border-red-500 hover:text-red-500">Mesas</button>
            </nav>
        </div>

        <!-- Conteúdo Principal -->
        <main class="flex-1 overflow-x-auto p-4">
            <!-- Painel Delivery/Retirada -->
            <div id="delivery-panel" class="tab-panel flex space-x-4">
                <div class="kanban-column bg-white rounded-lg shadow p-4" data-status="novo-pedido">
                    <h2 class="font-bold mb-4 text-center">Novos Pedidos (<span id="count-novo-pedido">0</span>)</h2>
                    <ul id="novos-pedidos-list" class="space-y-4 h-full"></ul>
                </div>
                <div class="kanban-column bg-white rounded-lg shadow p-4" data-status="em-preparo">
                    <h2 class="font-bold mb-4 text-center">Em Preparo (<span id="count-em-preparo">0</span>)</h2>
                    <ul id="em-preparo-list" class="space-y-4 h-full"></ul>
                </div>
                <div class="kanban-column bg-white rounded-lg shadow p-4" data-status="pronto-retirada">
                    <h2 class="font-bold mb-4 text-center">Pronto para Retirada (<span id="count-pronto-retirada">0</span>)</h2>
                    <ul id="pronto-retirada-list" class="space-y-4 h-full"></ul>
                </div>
                 <div class="kanban-column bg-white rounded-lg shadow p-4" data-status="saiu-entrega">
                    <h2 class="font-bold mb-4 text-center">Saiu para Entrega (<span id="count-saiu-entrega">0</span>)</h2>
                    <ul id="saiu-entrega-list" class="space-y-4 h-full"></ul>
                </div>
                <div class="kanban-column bg-green-50 rounded-lg shadow p-4" data-status="entregue">
                    <h2 class="font-bold mb-4 text-center">Entregues (<span id="count-entregue">0</span>)</h2>
                    <ul id="entregues-list" class="space-y-4 h-full"></ul>
                </div>
            </div>

            <!-- Painel Mesas -->
            <div id="mesas-panel" class="tab-panel flex space-x-4 hidden">
                 <div class="kanban-column bg-white rounded-lg shadow p-4" data-status="mesa-ocupada">
                    <h2 class="font-bold mb-4 text-center">Mesa Ocupada (<span id="count-mesa-ocupada">0</span>)</h2>
                    <ul id="mesas-ocupadas-list" class="space-y-4 h-full"></ul>
                </div>
                <div class="kanban-column bg-white rounded-lg shadow p-4" data-status="pedido-anotado">
                    <h2 class="font-bold mb-4 text-center">Pedido Anotado (<span id="count-pedido-anotado">0</span>)</h2>
                    <ul id="pedido-anotado-list" class="space-y-4 h-full"></ul>
                </div>
                <div class="kanban-column bg-white rounded-lg shadow p-4" data-status="servico-iniciado">
                    <h2 class="font-bold mb-4 text-center">Serviço Iniciado (<span id="count-servico-iniciado">0</span>)</h2>
                    <ul id="servico-iniciado-list" class="space-y-4 h-full"></ul>
                </div>
                 <div class="kanban-column bg-white rounded-lg shadow p-4" data-status="conta-solicitada">
                    <h2 class="font-bold mb-4 text-center">Conta Solicitada (<span id="count-conta-solicitada">0</span>)</h2>
                    <ul id="conta-solicitada-list" class="space-y-4 h-full"></ul>
                </div>
                <div class="kanban-column bg-green-50 rounded-lg shadow p-4" data-status="conta-fechada">
                    <h2 class="font-bold mb-4 text-center">Contas Fechadas (<span id="count-conta-fechada">0</span>)</h2>
                    <ul id="contas-fechadas-list" class="space-y-4 h-full"></ul>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Abrir Caixa -->
    <div id="abrir-caixa-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none; z-index: 50;">
        <div class="bg-white p-5 rounded-lg shadow-xl w-1/3">
            <h3 class="text-lg font-bold">Abrir Caixa</h3>
            <div class="mt-4">
                <label for="valor-inicial" class="block text-sm font-medium text-gray-700">Valor Inicial (Troco)</label>
                <input type="number" id="valor-inicial" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="0.00">
            </div>
            <div class="flex justify-end mt-4">
                <button id="cancel-abrir-caixa" class="px-4 py-2 bg-gray-300 rounded-md mr-2">Cancelar</button>
                <button id="confirm-abrir-caixa" class="px-4 py-2 bg-green-500 text-white rounded-md">Confirmar Abertura</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Fechar Caixa -->
    <div id="fechar-caixa-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none; z-index: 50;">
        <div class="bg-white p-5 rounded-lg shadow-xl w-1/3">
            <h3 class="text-lg font-bold">Fechar Caixa</h3>
            <div id="resumo-fechamento" class="mt-4 space-y-2 text-sm"></div>
            <div class="flex justify-end mt-6">
                <button id="cancel-fechar-caixa" class="px-4 py-2 bg-gray-300 rounded-md mr-2">Cancelar</button>
                <button id="confirm-fechar-caixa" class="px-4 py-2 bg-red-500 text-white rounded-md">Confirmar Fechamento</button>
            </div>
        </div>
    </div>

    <!-- Modal Registrar Sangria -->
    <div id="sangria-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none; z-index: 50;">
        <div class="bg-white p-5 rounded-lg shadow-xl w-1/3">
            <h3 class="text-lg font-bold">Registrar Sangria</h3>
            <div class="mt-4">
                <label for="valor-sangria" class="block text-sm font-medium text-gray-700">Valor da Retirada</label>
                <input type="number" id="valor-sangria" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="0.00">
            </div>
            <div class="mt-2">
                <label for="motivo-sangria" class="block text-sm font-medium text-gray-700">Motivo</label>
                <input type="text" id="motivo-sangria" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="Ex: Pagamento de fornecedor">
            </div>
            <div class="flex justify-end mt-4">
                <button id="cancel-sangria" class="px-4 py-2 bg-gray-300 rounded-md mr-2">Cancelar</button>
                <button id="confirm-sangria" class="px-4 py-2 bg-yellow-500 text-white rounded-md">Confirmar Sangria</button>
            </div>
        </div>
    </div>
    
    <!-- Custom Alert Modal -->
    <div id="custom-alert-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none; z-index: 100;">
      <div class="bg-white p-5 rounded-lg shadow-xl w-1/3 max-w-sm">
        <div class="flex justify-between items-center">
            <h3 class="text-lg font-bold text-gray-800">Atenção</h3>
            <button id="close-alert-modal" class="text-black text-2xl font-bold">&times;</button>
        </div>
        <div class="mt-4">
          <p id="custom-alert-message" class="text-sm text-gray-600">Message goes here.</p>
        </div>
        <div class="flex justify-end mt-6">
            <button id="ok-alert-modal" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">OK</button>
        </div>
      </div>
    </div>
    
    <div class="overlay"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        
        // --- Firebase Config and Initialization ---
        const firebaseConfig = {
           apiKey: "AIzaSyBJ44RVDGhBIlQBTx-pyIUp47XDKzRXk84",
           authDomain: "pizzaria-pdv.firebaseapp.com",
           projectId: "pizzaria-pdv",
           storageBucket: "pizzaria-pdv.firebasestorage.app",
           messagingSenderId: "304171744691",
           appId: "1:304171744691:web:e54d7f9fe55c7a75485fc6"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let draggedCard = null;

        // --- Authentication ---
        onAuthStateChanged(auth, user => {
            if (user) {
                document.body.style.visibility = 'visible';
                initializePDV();
            } else {
                window.location.href = `login.html?redirect=pdv.html`;
            }
        });
        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
        
        // --- UI Initialization and Event Listeners ---
        function initializePDV() {
            setupTabListeners();
            setupDragAndDropListeners();
            listenToOrders();
            listenToCashStatus();
            setupCashModals();
            setupCustomAlertModal();
        }

        function setupTabListeners() {
            document.querySelectorAll('.tab-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const tab = button.dataset.tab;
                    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.add('hidden'));
                    document.getElementById(`${tab}-panel`).classList.remove('hidden');
                });
            });
        }
        
        // --- Realtime Order Listening ---
        function listenToOrders() {
            const ordersRef = collection(db, "pedidos");
            onSnapshot(ordersRef, (snapshot) => {
                clearAllLists();
                snapshot.forEach(doc => {
                    const order = { id: doc.id, ...doc.data() };
                    const card = createOrderCard(order);
                    const listId = getListIdForStatus(order.status);
                    if (listId) {
                        document.getElementById(listId).appendChild(card);
                    }
                });
                updateAllCounts();
            });
        }
        
        // --- Card Creation and Rendering ---
        function createOrderCard(order) {
            const card = document.createElement('li');
            card.className = `card bg-white p-4 rounded-lg shadow-md border-l-4 ${getStatusColor(order.status)} cursor-pointer`;
            card.draggable = true;
            card.id = order.id;
            
            const deliveryType = order.isDelivery ? 'Entrega' : 'Retirada';
            const typeClass = order.isDelivery ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800';
            const paymentText = order.paymentMethod === 'machine' ? 'Maquininha' : `Dinheiro (Troco para R$${order.change || 0})`;
            const address = order.isDelivery ? `<p class="text-xs text-gray-500">${order.address.street}, ${order.address.number} - ${order.address.neighborhood}</p>` : '';
            const itemsSummary = order.items.map(item => `${item.quantity}x ${item.name}`).join(', ');

            card.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold">${order.customerName || `Mesa ${order.tableNumber}`}</h3>
                    <span class="text-xs font-semibold px-2 py-1 rounded-full ${typeClass}">${order.tableNumber ? 'Mesa' : deliveryType}</span>
                </div>
                <p class="text-sm font-semibold text-red-600">Total: R$${order.total.toFixed(2)}</p>
                <p class="text-xs text-gray-600">${paymentText}</p>
                ${address}
                <p class="text-xs mt-2 text-gray-500 truncate" title="${itemsSummary}">Itens: ${itemsSummary}</p>
                <div class="text-xs text-gray-400 mt-2 flex justify-between">
                    <span>#${order.orderNumber}</span>
                    <span>${new Date(order.timestamp?.seconds * 1000).toLocaleTimeString('pt-BR')}</span>
                </div>
                <button class="archive-btn text-xs text-white bg-gray-400 hover:bg-gray-500 rounded px-2 py-1 mt-2 ${order.status === 'entregue' || order.status === 'conta-fechada' ? '' : 'hidden'}">Arquivar</button>
            `;

            card.addEventListener('click', (e) => {
                if(e.target.classList.contains('archive-btn')) {
                    archiveOrder(order.id);
                } else {
                     // Toggle 'expanded' class logic
                }
            });
            return card;
        }
        
        async function archiveOrder(orderId) {
             try {
                const response = await fetch('/api/arquivar-pedido', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ orderId: orderId })
                });
                if (!response.ok) {
                    throw new Error('Falha ao arquivar pedido.');
                }
            } catch (error) {
                console.error("Erro ao arquivar pedido:", error);
                showCustomAlert("Erro ao arquivar pedido. Tente novamente.");
            }
        }

        // --- Drag and Drop Logic ---
        function setupDragAndDropListeners() {
            document.querySelectorAll('.card').forEach(card => {
                card.addEventListener('dragstart', dragStart);
                card.addEventListener('dragend', dragEnd);
            });
            
            document.querySelectorAll('.kanban-column ul').forEach(list => {
                list.addEventListener('dragover', dragOver);
                list.addEventListener('dragenter', dragEnter);
                list.addEventListener('dragleave', dragLeave);
                list.addEventListener('drop', drop);
            });
        }
        
        function dragStart(e) {
            draggedCard = e.target;
            setTimeout(() => e.target.classList.add('dragging'), 0);
        }

        function dragEnd(e) {
            e.target.classList.remove('dragging');
            draggedCard = null;
        }
        
        function dragOver(e) {
            e.preventDefault();
        }

        function dragEnter(e) {
            e.preventDefault();
            const list = e.target.closest('.kanban-column ul');
            if (list) list.parentElement.classList.add('highlight');
        }

        function dragLeave(e) {
             const list = e.target.closest('.kanban-column ul');
            if (list) list.parentElement.classList.remove('highlight');
        }
        
        async function drop(e) {
            e.preventDefault();
            const list = e.target.closest('.kanban-column ul');
            if (list && draggedCard) {
                const newStatus = list.parentElement.dataset.status;
                list.appendChild(draggedCard);
                list.parentElement.classList.remove('highlight');
                
                // Update Firestore
                const orderRef = doc(db, "pedidos", draggedCard.id);
                await updateDoc(orderRef, { status: newStatus });
                
                // Show/Hide archive button
                const archiveBtn = draggedCard.querySelector('.archive-btn');
                if (archiveBtn) {
                     archiveBtn.classList.toggle('hidden', newStatus !== 'entregue' && newStatus !== 'conta-fechada');
                }
            }
        }

        // --- Helper Functions ---
        function clearAllLists() {
            document.querySelectorAll('.kanban-column ul').forEach(list => list.innerHTML = '');
        }

        function updateAllCounts() {
            document.querySelectorAll('.kanban-column').forEach(col => {
                const status = col.dataset.status;
                const count = col.querySelector('ul').children.length;
                const countSpan = col.querySelector(`#count-${status}`);
                if (countSpan) countSpan.textContent = count;
            });
        }
        
        function getListIdForStatus(status) {
            const statusMap = {
                'novo-pedido': 'novos-pedidos-list',
                'em-preparo': 'em-preparo-list',
                'pronto-retirada': 'pronto-retirada-list',
                'saiu-entrega': 'saiu-entrega-list',
                'entregue': 'entregues-list',
                'mesa-ocupada': 'mesas-ocupadas-list',
                'pedido-anotado': 'pedido-anotado-list',
                'servico-iniciado': 'servico-iniciado-list',
                'conta-solicitada': 'conta-solicitada-list',
                'conta-fechada': 'contas-fechadas-list'
            };
            return statusMap[status];
        }

        function getStatusColor(status) {
            const colorMap = {
                'novo-pedido': 'border-blue-500',
                'em-preparo': 'border-yellow-500',
                'pronto-retirada': 'border-purple-500',
                'saiu-entrega': 'border-orange-500',
                'entregue': 'border-green-500',
                'mesa-ocupada': 'border-blue-500',
                'pedido-anotado': 'border-yellow-500',
                'servico-iniciado': 'border-purple-500',
                'conta-solicitada': 'border-orange-500',
                'conta-fechada': 'border-green-500',
            };
            return colorMap[status] || 'border-gray-300';
        }
        
        // --- Cash Management ---
        let currentCashData = null;
        
        function listenToCashStatus() {
            onSnapshot(doc(db, "caixa", "status"), (doc) => {
                const status = doc.exists() ? doc.data() : { isOpen: false };
                currentCashData = status;
                updateCashUI(status);
            });
        }

        function updateCashUI(status) {
            const statusSpan = document.getElementById('caixa-status');
            const abrirBtn = document.getElementById('abrir-caixa-btn');
            const fecharBtn = document.getElementById('fechar-caixa-btn');
            const sangriaBtn = document.getElementById('sangria-btn');

            if (status.isOpen) {
                statusSpan.textContent = 'CAIXA ABERTO';
                statusSpan.className = 'text-sm font-semibold text-green-600';
                abrirBtn.disabled = true;
                fecharBtn.disabled = false;
                sangriaBtn.disabled = false;
            } else {
                statusSpan.textContent = 'CAIXA FECHADO';
                statusSpan.className = 'text-sm font-semibold text-red-600';
                abrirBtn.disabled = false;
                fecharBtn.disabled = true;
                sangriaBtn.disabled = true;
            }
        }
        
        function setupCashModals() {
            // Abrir Caixa
            document.getElementById('abrir-caixa-btn').addEventListener('click', () => {
                document.getElementById('abrir-caixa-modal').style.display = 'flex';
            });
            document.getElementById('cancel-abrir-caixa').addEventListener('click', () => {
                document.getElementById('abrir-caixa-modal').style.display = 'none';
            });
            document.getElementById('confirm-abrir-caixa').addEventListener('click', async () => {
                const valorInicial = parseFloat(document.getElementById('valor-inicial').value) || 0;
                try {
                    await setDoc(doc(db, "caixa", "status"), {
                        isOpen: true,
                        abertoPor: auth.currentUser.email,
                        abertura: serverTimestamp(),
                        valorInicial: valorInicial,
                        entradas: {},
                        sangrias: [],
                        totalEntradas: 0
                    });
                     document.getElementById('abrir-caixa-modal').style.display = 'none';
                } catch (e) {
                    console.error("Erro ao abrir caixa: ", e);
                    showCustomAlert("Erro ao abrir o caixa.");
                }
            });

            // Fechar Caixa
            document.getElementById('fechar-caixa-btn').addEventListener('click', () => {
                // VERIFICAÇÃO DE PEDIDOS PENDENTES
                const pendingLists = [
                    'novos-pedidos-list', 'em-preparo-list', 'pronto-retirada-list', 'saiu-entrega-list',
                    'mesas-ocupadas-list', 'pedido-anotado-list', 'servico-iniciado-list', 'conta-solicitada-list'
                ];
                const hasPendingOrders = pendingLists.some(listId => document.getElementById(listId).children.length > 0);

                if (hasPendingOrders) {
                    showCustomAlert('Não é possível fechar o caixa. Ainda existem pedidos ou mesas em aberto. Finalize todos os pedidos antes de continuar.');
                    return;
                }
                
                // Se não houver pedidos pendentes, continua com o fechamento
                populateClosureSummary();
                document.getElementById('fechar-caixa-modal').style.display = 'flex';
            });
            document.getElementById('cancel-fechar-caixa').addEventListener('click', () => {
                document.getElementById('fechar-caixa-modal').style.display = 'none';
            });
             document.getElementById('confirm-fechar-caixa').addEventListener('click', async () => {
                 try {
                     const response = await fetch('/api/arquivar-fechamento', {
                         method: 'POST',
                         headers: { 'Content-Type': 'application/json' },
                     });
                     if (!response.ok) throw new Error('Falha ao arquivar fechamento');
                     
                     await setDoc(doc(db, "caixa", "status"), { isOpen: false });
                     document.getElementById('fechar-caixa-modal').style.display = 'none';
                 } catch(e) {
                      console.error("Erro ao fechar caixa: ", e);
                      showCustomAlert("Erro ao fechar o caixa.");
                 }
             });
            
             // Sangria
             document.getElementById('sangria-btn').addEventListener('click', () => {
                 document.getElementById('sangria-modal').style.display = 'flex';
             });
             document.getElementById('cancel-sangria').addEventListener('click', () => {
                 document.getElementById('sangria-modal').style.display = 'none';
             });
             document.getElementById('confirm-sangria').addEventListener('click', async () => {
                 const valor = parseFloat(document.getElementById('valor-sangria').value);
                 const motivo = document.getElementById('motivo-sangria').value;
                 if (!valor || !motivo) {
                     showCustomAlert("Por favor, preencha o valor e o motivo da sangria.");
                     return;
                 }
                 try {
                     const response = await fetch('/api/registrar-sangria', {
                         method: 'POST',
                         headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify({ valor, motivo, responsavel: auth.currentUser.email })
                     });
                      if (!response.ok) throw new Error('Falha ao registrar sangria');
                      document.getElementById('sangria-modal').style.display = 'none';
                      document.getElementById('valor-sangria').value = '';
                      document.getElementById('motivo-sangria').value = '';
                 } catch(e) {
                     console.error("Erro ao registrar sangria:", e);
                     showCustomAlert("Erro ao registrar a sangria.");
                 }
             });
        }
        
        function populateClosureSummary() {
            if (!currentCashData) return;
            const resumoDiv = document.getElementById('resumo-fechamento');
            const { valorInicial, entradas, sangrias } = currentCashData;
            
            let totalSangrias = sangrias ? sangrias.reduce((acc, s) => acc + s.valor, 0) : 0;
            let totalDinheiro = entradas?.dinheiro || 0;
            let totalPix = entradas?.pix || 0;
            let totalCartao = (entradas?.credito || 0) + (entradas?.debito || 0);
            
            let totalVendas = totalDinheiro + totalPix + totalCartao;
            let valorEmCaixa = (valorInicial + totalDinheiro) - totalSangrias;
            
            resumoDiv.innerHTML = `
                <p><strong>Valor Inicial:</strong> R$ ${valorInicial.toFixed(2)}</p>
                <hr class="my-2">
                <p><strong>Vendas em Dinheiro:</strong> R$ ${totalDinheiro.toFixed(2)}</p>
                <p><strong>Vendas em PIX:</strong> R$ ${totalPix.toFixed(2)}</p>
                <p><strong>Vendas em Cartão:</strong> R$ ${totalCartao.toFixed(2)}</p>
                <p class="font-bold"><strong>Total de Vendas:</strong> R$ ${totalVendas.toFixed(2)}</p>
                <hr class="my-2">
                <p><strong>Total de Sangrias:</strong> R$ ${totalSangrias.toFixed(2)}</p>
                <hr class="my-2">
                <p class="text-lg font-bold text-blue-600">Valor a ser retirado (Dinheiro): R$ ${valorEmCaixa.toFixed(2)}</p>
            `;
        }

        function setupCustomAlertModal() {
            const modal = document.getElementById('custom-alert-modal');
            modal.addEventListener('click', (e) => {
                if (e.target.id === 'custom-alert-modal' || e.target.id === 'close-alert-modal' || e.target.id === 'ok-alert-modal') {
                    modal.style.display = 'none';
                }
            });
        }
        
        function showCustomAlert(message) {
            document.getElementById('custom-alert-message').textContent = message;
            document.getElementById('custom-alert-modal').style.display = 'flex';
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
             // A inicialização agora acontece após a verificação de auth
        });
    </script>
</body>
</html>
