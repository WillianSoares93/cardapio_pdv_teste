<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lançar Pedido - Sâmia Pizzaria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="https://raw.githubusercontent.com/WillianSoares93/cardapio_samia_PDV/refs/heads/main/logo.png" type="image/png">
     <style>
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 p-8">

    <div class="max-w-4xl mx-auto bg-white p-8 rounded-lg shadow-lg">
        <h1 class="text-2xl font-bold text-gray-800 mb-6">Lançar Novo Pedido</h1>
        
        <form id="order-form">
            <!-- Tipo de Pedido -->
            <div class="mb-4">
                <label class="block text-gray-700 font-bold mb-2">Tipo de Pedido:</label>
                <div class="flex space-x-4">
                    <label class="inline-flex items-center">
                        <input type="radio" class="form-radio" name="orderType" value="Mesa" checked>
                        <span class="ml-2">Mesa</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" class="form-radio" name="orderType" value="Retirada">
                        <span class="ml-2">Retirada</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" class="form-radio" name="orderType" value="Delivery">
                        <span class="ml-2">Delivery</span>
                    </label>
                </div>
            </div>

            <!-- Detalhes do Cliente/Mesa -->
            <div id="details-section">
                <!-- Conteúdo dinâmico aqui -->
            </div>

            <!-- Itens do Pedido -->
            <div class="mb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-3">Itens do Pedido</h2>
                <div class="mb-4">
                    <input type="text" id="search-item" class="w-full p-2 border rounded-md" placeholder="Buscar item no cardápio...">
                    <div id="search-results" class="mt-1 border rounded-md bg-white shadow-lg z-10 hidden max-h-60 overflow-y-auto"></div>
                </div>
                <div id="order-items" class="space-y-2">
                    <!-- Itens adicionados aqui -->
                </div>
            </div>
            
            <div class="mb-4">
                <label for="observacao" class="block text-gray-700 font-bold mb-2">Observações:</label>
                <textarea id="observacao" class="w-full p-2 border rounded-md" rows="3"></textarea>
            </div>


            <!-- Botão de Envio -->
            <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-md hover:bg-green-700 transition-colors">
                Lançar Pedido
            </button>
        </form>
    </div>
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="loader"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp, doc, onSnapshot, getDoc, updateDoc, query, orderBy, where, writeBatch, getDocs, limit, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = {
           apiKey: "AIzaSyBJ44RVDGhBIlQBTx-pyIUp47XDKzRXk84",
           authDomain: "pizzaria-pdv.firebaseapp.com",
           projectId: "pizzaria-pdv",
           storageBucket: "pizzaria-pdv.firebasestorage.app",
           messagingSenderId: "304171744691",
           appId: "1:304171744691:web:e54d7f9fe55c7a75485fc6"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const orderForm = document.getElementById('order-form');
        const detailsSection = document.getElementById('details-section');
        const orderTypeRadios = document.querySelectorAll('input[name="orderType"]');
        const searchInput = document.getElementById('search-item');
        const searchResultsContainer = document.getElementById('search-results');
        const orderItemsContainer = document.getElementById('order-items');
        const loadingOverlay = document.getElementById('loading-overlay');
        const NUMERO_DE_MESAS = 12;

        let menuData = [];
        let deliveryFees = [];
        let orderItems = [];

        async function fetchMenu() {
            try {
                const response = await fetch('/api/menu');
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                menuData = Object.values(data.menu).flat();
                deliveryFees = data.deliveryFees;
                
                // Inicializa a UI após carregar o menu
                updateDetailsSection('Mesa');
            } catch (error) {
                console.error("Erro ao carregar o menu:", error);
                detailsSection.innerHTML = `<p class="text-red-500">Erro ao carregar dados. Tente recarregar a página.</p>`;
            }
        }

        async function updateTableSelect() {
            const select = document.getElementById('mesa-select');
            if (!select) return;
            select.innerHTML = ''; 

            const q = query(collection(db, "pedidos"), where("endereco.rua", "==", "Mesa"), where("status", "!=", "Fechado"), where("status", "!=", "Finalizado"));
            const querySnapshot = await getDocs(q);
            
            let occupiedTables = new Set();
            let openGroups = [];

            querySnapshot.forEach(doc => {
                const order = doc.data();
                if (order.grupoMesas && order.grupoMesas.length > 0) {
                    order.grupoMesas.forEach(tableNum => occupiedTables.add(tableNum));
                    openGroups.push({
                        text: `Mesas ${order.grupoMesas.join(' + ')}`,
                        value: doc.id
                    });
                } else {
                    const tableNum = parseInt((order.endereco.clientName || "").replace(/[^0-9]/g, ''));
                    if (!isNaN(tableNum)) {
                         occupiedTables.add(tableNum);
                    }
                }
            });

            const freeTables = Array.from({ length: NUMERO_DE_MESAS }, (_, i) => i + 1)
                                   .filter(num => !occupiedTables.has(num));

            // Adicionar Mesas Abertas (Grupos)
            if (openGroups.length > 0) {
                const groupOptgroup = document.createElement('optgroup');
                groupOptgroup.label = 'Mesas Ocupadas (Aguardando Pedido)';
                openGroups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group.value;
                    option.textContent = group.text;
                    option.dataset.type = 'group'; // Indica que é um grupo existente
                    groupOptgroup.appendChild(option);
                });
                select.appendChild(groupOptgroup);
            }

            // Adicionar Mesas Livres
            const freeOptgroup = document.createElement('optgroup');
            freeOptgroup.label = 'Mesas Livres';
            freeTables.forEach(num => {
                const option = document.createElement('option');
                option.value = num;
                option.textContent = `Mesa ${num}`;
                option.dataset.type = 'free'; // Indica que é uma mesa livre
                freeOptgroup.appendChild(option);
            });
            select.appendChild(freeOptgroup);

            // Tenta pré-selecionar baseado na URL
            const urlParams = new URLSearchParams(window.location.search);
            const mesaParam = urlParams.get('mesa');
            const grupoParam = urlParams.get('grupo');

            if (mesaParam && select.querySelector(`option[value="${mesaParam}"][data-type="free"]`)) {
                 select.value = mesaParam;
            } else if (grupoParam) {
                // Encontrar o pedido que corresponde a este grupo
                const groupQuery = query(collection(db, "pedidos"), where("grupoMesas", "==", grupoParam.split(',').map(Number)));
                const groupSnapshot = await getDocs(groupQuery);
                if(!groupSnapshot.empty){
                    const orderId = groupSnapshot.docs[0].id;
                    select.value = orderId;
                }
            }
        }

        function updateDetailsSection(orderType) {
            let html = '';
            if (orderType === 'Mesa') {
                html = `
                    <div class="mb-4">
                        <label for="mesa-select" class="block text-gray-700 font-bold mb-2">Mesa:</label>
                        <select id="mesa-select" class="w-full p-2 border rounded-md">
                            <option value="">Carregando mesas...</option>
                        </select>
                    </div>`;
                detailsSection.innerHTML = html;
                updateTableSelect(); // Carrega as mesas dinamicamente
            } else if (orderType === 'Retirada') {
                html = `
                    <div class="mb-4">
                        <label for="client-name" class="block text-gray-700 font-bold mb-2">Nome do Cliente:</label>
                        <input type="text" id="client-name" class="w-full p-2 border rounded-md" required>
                    </div>`;
            } else if (orderType === 'Delivery') {
                html = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="client-name" class="block text-gray-700 font-bold mb-2">Nome do Cliente:</label>
                            <input type="text" id="client-name" class="w-full p-2 border rounded-md" required>
                        </div>
                        <div>
                           <label for="client-phone" class="block text-gray-700 font-bold mb-2">Telefone:</label>
                           <input type="tel" id="client-phone" class="w-full p-2 border rounded-md" required>
                        </div>
                    </div>
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                         <div>
                            <label for="bairro" class="block text-gray-700 font-bold mb-2">Bairro:</label>
                            <select id="bairro" class="w-full p-2 border rounded-md" required>
                                <option value="">Selecione</option>
                                ${deliveryFees.map(fee => `<option value="${fee.neighborhood}">${fee.neighborhood}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label for="rua" class="block text-gray-700 font-bold mb-2">Rua:</label>
                            <input type="text" id="rua" class="w-full p-2 border rounded-md" required>
                        </div>
                         <div>
                            <label for="numero" class="block text-gray-700 font-bold mb-2">Número:</label>
                            <input type="text" id="numero" class="w-full p-2 border rounded-md" required>
                        </div>
                    </div>
                `;
            }
            detailsSection.innerHTML = html;
        }

        orderTypeRadios.forEach(radio => {
            radio.addEventListener('change', () => updateDetailsSection(radio.value));
        });

        // Lógica de busca de itens
        searchInput.addEventListener('input', () => {
            const query = searchInput.value.toLowerCase();
            if (query.length < 2) {
                searchResultsContainer.classList.add('hidden');
                return;
            }
            
            const results = menuData.filter(item => item.name.toLowerCase().includes(query));
            searchResultsContainer.innerHTML = '';
            
            if (results.length > 0) {
                results.forEach(item => {
                    const resultEl = document.createElement('div');
                    resultEl.className = 'p-2 hover:bg-gray-100 cursor-pointer';
                    resultEl.textContent = `${item.name} - R$ ${item.price}`;
                    resultEl.onclick = () => addItemToOrder(item);
                    searchResultsContainer.appendChild(resultEl);
                });
                searchResultsContainer.classList.remove('hidden');
            } else {
                searchResultsContainer.classList.add('hidden');
            }
        });

        function addItemToOrder(item) {
            orderItems.push({
                name: item.name,
                price: parseFloat(item.price),
                category: item.category
            });
            searchInput.value = '';
            searchResultsContainer.classList.add('hidden');
            renderOrderItems();
        }
        
        function renderOrderItems() {
            orderItemsContainer.innerHTML = '';
            orderItems.forEach((item, index) => {
                const itemEl = document.createElement('div');
                itemEl.className = 'flex justify-between items-center p-2 border rounded-md';
                itemEl.innerHTML = `
                    <span>${item.name}</span>
                    <div class="flex items-center">
                        <span class="mr-4">R$ ${item.price.toFixed(2).replace('.', ',')}</span>
                        <button type="button" data-index="${index}" class="remove-item text-red-500 hover:text-red-700">&times;</button>
                    </div>
                `;
                orderItemsContainer.appendChild(itemEl);
            });
        }
        
        orderItemsContainer.addEventListener('click', e => {
            if (e.target.classList.contains('remove-item')) {
                const index = e.target.dataset.index;
                orderItems.splice(index, 1);
                renderOrderItems();
            }
        });

        async function handleSubmit(e) {
            e.preventDefault();
            loadingOverlay.classList.remove('hidden');

            const orderType = document.querySelector('input[name="orderType"]:checked').value;
            const observacao = document.getElementById('observacao').value;

            let subtotal = orderItems.reduce((sum, item) => sum + item.price, 0);
            let finalTotal = subtotal;
            let deliveryFee = 0;
            let endereco = {};
            let isUpdating = false;
            let orderIdToUpdate = null;

            if (orderType === 'Mesa') {
                const mesaSelect = document.getElementById('mesa-select');
                const selectedOption = mesaSelect.options[mesaSelect.selectedIndex];
                if (!selectedOption || selectedOption.value === '') {
                    showCustomAlert("Por favor, selecione uma mesa.");
                    loadingOverlay.classList.add('hidden');
                    return;
                }
                
                if (selectedOption.dataset.type === 'group') {
                    isUpdating = true;
                    orderIdToUpdate = selectedOption.value;
                } else {
                    endereco.clientName = `Mesa ${selectedOption.value}`;
                }
                endereco.rua = "Mesa";

            } else if (orderType === 'Retirada') {
                 endereco.clientName = document.getElementById('client-name').value;
                 endereco.rua = "Retirada no Balcão";
            } else { // Delivery
                const bairro = document.getElementById('bairro').value;
                const feeData = deliveryFees.find(f => f.neighborhood === bairro);
                deliveryFee = feeData ? parseFloat(feeData.deliveryFee) : 0;
                finalTotal += deliveryFee;
                
                endereco = {
                    clientName: document.getElementById('client-name').value,
                    telefone: document.getElementById('client-phone').value,
                    bairro: bairro,
                    rua: document.getElementById('rua').value,
                    numero: document.getElementById('numero').value
                };
            }

            try {
                if (isUpdating) {
                    const orderRef = doc(db, "pedidos", orderIdToUpdate);
                    const docSnap = await getDoc(orderRef);
                    if (docSnap.exists()) {
                        const existingOrder = docSnap.data();
                        const updatedItems = [...existingOrder.itens, ...orderItems];
                        const newSubtotal = updatedItems.reduce((sum, item) => sum + item.price, 0);

                        await updateDoc(orderRef, {
                            itens: updatedItems,
                            total: {
                                subtotal: newSubtotal,
                                finalTotal: newSubtotal, // No delivery fee for tables
                                deliveryFee: 0,
                                discount: existingOrder.total.discount || 0
                            },
                            status: "Em Preparo", // Change status now that items are added
                            statusChangedAt: serverTimestamp(),
                            observacao: existingOrder.observacao ? `${existingOrder.observacao}\n${observacao}` : observacao
                        });
                    }
                } else {
                    const newOrder = {
                        itens: orderItems,
                        endereco: endereco,
                        total: {
                            subtotal: subtotal,
                            finalTotal: finalTotal,
                            deliveryFee: deliveryFee,
                            discount: 0
                        },
                        pagamento: 'A Definir',
                        status: 'Em Preparo',
                        criadoEm: serverTimestamp(),
                        statusChangedAt: serverTimestamp(),
                        observacao: observacao,
                        grupoMesas: null // Not a group if created from scratch
                    };
                    await addDoc(collection(db, "pedidos"), newOrder);
                }

                alert("Pedido lançado com sucesso!");
                window.close();
            } catch (error) {
                console.error("Erro ao lançar pedido: ", error);
                alert("Falha ao lançar o pedido. Tente novamente.");
            } finally {
                 loadingOverlay.classList.add('hidden');
            }
        }

        orderForm.addEventListener('submit', handleSubmit);
        
        // Iniciar
        fetchMenu();
    </script>
</body>
</html>
