<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDV - Sâmia Pizzaria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="https://raw.githubusercontent.com/WillianSoares93/cardapio_samia_PDV/refs/heads/main/logo.png" type="image/png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        body {
            font-family: 'Roboto', sans-serif;
            visibility: hidden;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
        }
        #pdv-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 999;
            display: none;
        }
        .details-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out;
        }
        .order-card.expanded .details-container {
            max-height: 1500px;
        }
        .toggle-checkbox:checked {
            right: 0;
            border-color: #4ade80;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #4ade80;
        }
        .status-filter-btn.active {
            background-color: #2563eb;
            color: white;
        }
        .main-tab-btn {
            transition: all 0.2s ease-in-out;
        }
        .main-tab-btn.active {
            border-bottom-color: #ef4444; /* red-500 */
            color: #ef4444;
            background-color: #fef2f2; /* red-50 */
        }
        .mesa-item {
            transition: all 0.2s ease-in-out;
            aspect-ratio: 1 / 1;
        }
        .mesa-item:hover:not(.joining-mode) {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .mesa-status-livre { background-color: #dcfce7; border-color: #22c55e; color: #166534; }
        .mesa-status-ocupada { background-color: #fee2e2; border-color: #ef4444; color: #991b1b; }
        .mesa-status-juntada { background-color: #e0e7ff; border-color: #4f46e5; color: #3730a3; }
        .mesa-item.selected-for-join {
            outline: 4px solid #3b82f6;
            outline-offset: 2px;
            transform: scale(1.05);
        }
        .joining-mode .mesa-item.mesa-status-livre {
            cursor: pointer;
        }
        .joining-mode .mesa-item:not(.mesa-status-livre) {
            cursor: not-allowed;
            opacity: 0.5;
        }
        .tab-btn.active {
            border-bottom-color: #3b82f6; /* blue-500 */
            color: #3b82f6;
        }
        .toggle-checkbox:disabled + .toggle-label {
            background-color: #d1d5db; /* gray-300 */
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="pdv-overlay"></div>

    <header class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">Painel de Pedidos - Sâmia Pizzaria</h1>
            <div class="flex items-center space-x-2">
                <a href="atendente.html" target="_blank" class="px-3 py-2 bg-purple-600 text-white text-xs font-bold rounded-md hover:bg-purple-700">Lançar Pedido</a>
                <button id="close-cash-register-btn" class="px-3 py-2 bg-green-600 text-white text-xs font-bold rounded-md hover:bg-green-700">Fechar Caixa</button>
                <a href="gerenciar.html" target="_blank" class="px-3 py-2 bg-blue-600 text-white text-xs font-bold rounded-md hover:bg-blue-700">Gerenciar Cardápio</a>
                <button id="clear-finished-btn" class="px-3 py-2 bg-gray-600 text-white text-xs font-bold rounded-md hover:bg-gray-700">Limpar Finalizados</button>
                <button id="logout-btn" class="px-3 py-2 bg-red-600 text-white text-xs font-bold rounded-md hover:bg-red-700">Sair</button>
                <div id="connection-status" class="text-sm font-medium text-gray-500">
                    <i class="fas fa-circle text-red-500 mr-2"></i>Conectando...
                </div>
            </div>
        </div>
    </header>

    <div class="bg-gray-800 text-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center py-4">
                <div><h3 class="text-sm font-medium text-gray-400">PEDIDOS HOJE</h3><p id="stats-total-orders" class="text-2xl font-bold">0</p></div>
                <div><h3 class="text-sm font-medium text-gray-400">FATURAMENTO TOTAL</h3><p id="stats-total-revenue" class="text-2xl font-bold">R$ 0,00</p></div>
                <div><h3 class="text-sm font-medium text-gray-400">TICKET MÉDIO</h3><p id="stats-avg-ticket" class="text-2xl font-bold">R$ 0,00</p></div>
            </div>
        </div>
    </div>

    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Abas Principais -->
        <div class="border-b border-gray-200 bg-white rounded-t-lg shadow-sm">
            <nav id="main-tabs" class="flex -mb-px" aria-label="Tabs">
                <button class="main-tab-btn active w-1/3 py-4 px-1 text-center border-b-4 font-medium text-lg" data-tab="delivery">
                    <i class="fas fa-motorcycle mr-2"></i> Delivery
                </button>
                <button class="main-tab-btn w-1/3 py-4 px-1 text-center border-b-4 border-transparent text-gray-500 hover:text-gray-700 font-medium text-lg" data-tab="retirada">
                    <i class="fas fa-shopping-bag mr-2"></i> Retirada
                </button>
                <button class="main-tab-btn w-1/3 py-4 px-1 text-center border-b-4 border-transparent text-gray-500 hover:text-gray-700 font-medium text-lg" data-tab="mesas">
                    <i class="fas fa-utensils mr-2"></i> Mesas
                </button>
            </nav>
        </div>

        <!-- Conteúdo das Abas -->
        <div id="tab-content-delivery" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mt-4">
                <div class="bg-red-50 rounded-lg shadow"><div class="p-4 border-b border-red-200"><h2 class="text-lg font-bold text-red-800">Novos Pedidos</h2></div><div id="col-delivery-novo" class="p-4 space-y-4 overflow-y-auto h-[calc(100vh-20rem)]"></div></div>
                <div class="bg-yellow-50 rounded-lg shadow"><div class="p-4 border-b border-yellow-200"><h2 class="text-lg font-bold text-yellow-800">Em Preparo</h2></div><div id="col-delivery-preparo" class="p-4 space-y-4 overflow-y-auto h-[calc(100vh-20rem)]"></div></div>
                <div class="bg-green-50 rounded-lg shadow"><div class="p-4 border-b border-green-200"><h2 class="text-lg font-bold text-green-800">Pronto para Entrega</h2></div><div id="col-delivery-entrega" class="p-4 space-y-4 overflow-y-auto h-[calc(100vh-20rem)]"></div></div>
                <div class="bg-gray-200 rounded-lg shadow"><div class="p-4 border-b border-gray-300"><h2 class="text-lg font-bold text-gray-800">Finalizados</h2></div><div id="col-delivery-finalizado" class="p-4 space-y-4 overflow-y-auto h-[calc(100vh-20rem)]"></div></div>
            </div>
        </div>

        <div id="tab-content-retirada" class="tab-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mt-4">
                <div class="bg-red-50 rounded-lg shadow"><div class="p-4 border-b border-red-200"><h2 class="text-lg font-bold text-red-800">Aguardando Retirada</h2></div><div id="col-retirada-novo" class="p-4 space-y-4 overflow-y-auto h-[calc(100vh-20rem)]"></div></div>
                <div class="bg-yellow-50 rounded-lg shadow"><div class="p-4 border-b border-yellow-200"><h2 class="text-lg font-bold text-yellow-800">Em Preparo</h2></div><div id="col-retirada-preparo" class="p-4 space-y-4 overflow-y-auto h-[calc(100vh-20rem)]"></div></div>
                <div class="bg-green-50 rounded-lg shadow"><div class="p-4 border-b border-green-200"><h2 class="text-lg font-bold text-green-800">Pronto para Retirada</h2></div><div id="col-retirada-pronto" class="p-4 space-y-4 overflow-y-auto h-[calc(100vh-20rem)]"></div></div>
                <div class="bg-gray-200 rounded-lg shadow"><div class="p-4 border-b border-gray-300"><h2 class="text-lg font-bold text-gray-800">Finalizados</h2></div><div id="col-retirada-finalizado" class="p-4 space-y-4 overflow-y-auto h-[calc(100vh-20rem)]"></div></div>
            </div>
        </div>

        <div id="tab-content-mesas" class="tab-content hidden">
            <div id="mesas-controls" class="mt-4 p-2 bg-white rounded-lg shadow-sm flex items-center justify-end space-x-2">
                <button id="join-tables-btn" class="px-4 py-2 bg-indigo-600 text-white text-sm font-bold rounded-md hover:bg-indigo-700">
                    <i class="fas fa-link mr-2"></i>Agrupar Mesas
                </button>
                <div id="joining-controls" class="hidden space-x-2">
                    <button id="confirm-join-btn" class="px-4 py-2 bg-green-600 text-white text-sm font-bold rounded-md hover:bg-green-700">Confirmar Agrupamento</button>
                    <button id="cancel-join-btn" class="px-4 py-2 bg-gray-500 text-white text-sm font-bold rounded-md hover:bg-gray-600">Cancelar</button>
                </div>
            </div>
            <div id="mesas-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-6 mt-4">
                <!-- As mesas serão inseridas aqui pelo JavaScript -->
            </div>
        </div>
    </main>

    <!-- Modal Abrir Caixa -->
    <div id="open-cash-modal" class="modal">
        <div class="modal-content">
            <div id="pending-cash-alert" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4" role="alert">
                <p class="font-bold">Caixa Pendente</p>
                <p id="pending-cash-message">Existe um caixa do dia anterior que não foi fechado. Por favor, feche o caixa anterior antes de continuar.</p>
            </div>
            <h3 id="open-cash-title" class="text-lg font-bold text-gray-900 mb-4">Abrir Caixa</h3>
            <p id="open-cash-instructions" class="text-sm text-gray-600 mb-4">Para iniciar as operações, por favor, informe o valor inicial do caixa (fundo de troco).</p>
            <form id="open-cash-form">
                <div class="mb-4">
                    <label for="initial-value" class="block text-sm font-medium text-gray-700 mb-1">Valor Inicial (R$)</label>
                    <input type="number" id="initial-value" step="0.01" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="Ex: 50,00">
                </div>
                <button type="submit" id="open-cash-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700">Abrir Caixa</button>
            </form>
            <div id="resolve-pending-cash-container" class="hidden mt-4">
                <button type="button" id="resolve-pending-cash-btn" class="w-full bg-yellow-500 text-white font-bold py-2 px-4 rounded-md hover:bg-yellow-600">
                    Resolver Pendência (Fechar Caixa Anterior)
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Fechar Caixa -->
    <div id="close-cash-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Fechamento de Caixa</h3>
            <div class="space-y-2 text-sm">
                <div class="flex justify-between"><span class="text-gray-600">Valor Inicial:</span> <span id="summary-initial" class="font-medium">R$ 0,00</span></div>
                <hr class="my-2">
                <h4 class="font-bold text-gray-700 text-md">Vendas por Tipo</h4>
                <div class="flex justify-between pl-2"><span class="text-gray-600">Delivery:</span> <span id="summary-delivery" class="font-medium">R$ 0,00</span></div>
                <div class="flex justify-between pl-2"><span class="text-gray-600">Retirada:</span> <span id="summary-retirada" class="font-medium">R$ 0,00</span></div>
                <div class="flex justify-between pl-2"><span class="text-gray-600">Mesas:</span> <span id="summary-mesas" class="font-medium">R$ 0,00</span></div>
                <div class="flex justify-between pl-2"><span class="text-gray-600">Taxas de Entrega:</span> <span id="summary-delivery-fees" class="font-medium">R$ 0,00</span></div>
                <hr class="my-2">
                <h4 class="font-bold text-gray-700 text-md">Vendas por Pagamento</h4>
                <div class="flex justify-between pl-2"><span class="text-gray-600">Dinheiro:</span> <span id="summary-cash" class="font-medium">R$ 0,00</span></div>
                <div class="flex justify-between pl-2"><span class="text-gray-600">Cartão:</span> <span id="summary-card" class="font-medium">R$ 0,00</span></div>
                <div class="flex justify-between pl-2"><span class="text-gray-600">Pix:</span> <span id="summary-pix" class="font-medium">R$ 0,00</span></div>
                <hr class="my-2">
                <div class="flex justify-between font-bold"><span class="text-gray-800">Total de Vendas:</span> <span id="summary-total-sales" class="text-gray-800">R$ 0,00</span></div>
                <hr class="my-2">
                <div class="flex justify-between font-bold"><span class="text-blue-700">Valor Esperado em Caixa:</span> <span id="summary-expected" class="text-blue-700">R$ 0,00</span></div>
            </div>
            <form id="close-cash-form" class="mt-6">
                <div class="mb-4">
                    <label for="final-value" class="block text-sm font-medium text-gray-700 mb-1">Valor Contado em Caixa (R$)</label>
                    <input type="number" id="final-value" step="0.01" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="Digite o valor contado">
                </div>
                <div id="summary-difference-section" class="text-center p-2 rounded-md mb-4 hidden">
                    <span class="font-bold">Diferença:</span> <span id="summary-difference" class="font-bold">R$ 0,00</span>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancel-close-cash-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancelar</button>
                    <button type="submit" id="confirm-close-cash-btn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Confirmar Fechamento</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- MODAL DE GERENCIAMENTO DE MESA -->
    <div id="manage-table-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4 pb-4 border-b">
                <h2 id="manage-table-title" class="text-xl font-bold">Gerenciar Mesa</h2>
                <button id="close-manage-table-modal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="manage-table-body" class="space-y-4">
                <div class="max-h-60 overflow-y-auto p-2 border rounded-md bg-gray-50">
                    <h4 class="font-bold mb-2">Itens Consumidos:</h4>
                    <ul id="table-order-items-list" class="text-sm space-y-1"></ul>
                </div>
                <div class="text-right font-bold text-lg">
                    Total: <span id="table-order-total">R$ 0,00</span>
                </div>
                <div class="grid grid-cols-2 gap-4 pt-4 border-t">
                    <button id="print-partial-btn" class="p-3 bg-blue-500 text-white rounded-md hover:bg-blue-600">Imprimir Parcial</button>
                    <button id="transfer-table-btn" class="p-3 bg-yellow-500 text-white rounded-md hover:bg-yellow-600">Transferir Mesa</button>
                    <button id="close-account-btn" class="col-span-2 p-3 bg-green-600 text-white rounded-md hover:bg-green-700 font-bold text-lg">Fechar Conta</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para Transferir Mesa -->
    <div id="transfer-table-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4">Transferir para qual mesa livre?</h3>
            <select id="free-tables-select" class="w-full p-2 border rounded-md"></select>
            <div class="flex justify-end gap-4 mt-4">
                <button id="cancel-transfer-btn" class="px-4 py-2 bg-gray-300 rounded-md">Cancelar</button>
                <button id="confirm-transfer-btn" class="px-4 py-2 bg-blue-500 text-white rounded-md">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="edit-order-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Gerenciar Pedido</h2>
                <button id="close-edit-modal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="edit-modal-body" class="space-y-4"></div>
        </div>
    </div>

    <div id="delete-confirm-modal" class="modal">
        <div class="modal-content bg-white p-6 rounded-lg shadow-lg max-w-sm mx-auto">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Confirmar Exclusão</h3>
            <p class="text-sm text-gray-600 mb-6">Tem certeza que deseja excluir este pedido? Esta ação não pode ser desfeita.</p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-delete-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancelar</button>
                <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Sim, Excluir</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, doc, onSnapshot, getDoc, updateDoc, query, orderBy, where, writeBatch, getDocs, limit, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

            // --- INÍCIO DA CONFIGURAÇÃO DO FIREBASE ---
        const firebaseConfig = {
           apiKey: "AIzaSyBJ44RVDGhBIlQBTx-pyIUp47XDKzRXk84",
           authDomain: "pizzaria-pdv.firebaseapp.com",
           projectId: "pizzaria-pdv",
           storageBucket: "pizzaria-pdv.firebasestorage.app",
           messagingSenderId: "304171744691",
           appId: "1:304171744691:web:e54d7f9fe55c7a75485fc6"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- LÓGICA DE AUTENTICAÇÃO E CAIXA ---
        let currentCashRegister = null;
        let detailedReportData = {}; // Para armazenar os dados do relatório detalhado

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.body.style.visibility = 'visible';
                checkCashRegisterStatus();
            } else {
                window.location.href = `login.html?redirect=pdv.html`;
            }
        });

        const logoutBtn = document.getElementById('logout-btn');
        logoutBtn.addEventListener('click', () => {
            signOut(auth).catch((error) => console.error("Erro ao fazer logout:", error));
        });
        
        const openCashModal = document.getElementById('open-cash-modal');
        const openCashForm = document.getElementById('open-cash-form');
        const pdvOverlay = document.getElementById('pdv-overlay');
        const resolvePendingContainer = document.getElementById('resolve-pending-cash-container');
        const resolvePendingBtn = document.getElementById('resolve-pending-cash-btn');

        async function checkCashRegisterStatus() {
            const q = query(collection(db, "caixas"), where("status", "==", "aberto"), limit(1));
            const querySnapshot = await getDocs(q);
            
            if (querySnapshot.empty) {
                document.getElementById('pending-cash-alert').classList.add('hidden');
                document.getElementById('open-cash-title').textContent = 'Abrir Caixa';
                openCashForm.style.display = 'block';
                resolvePendingContainer.classList.add('hidden');
                document.getElementById('open-cash-instructions').style.display = 'block';

                pdvOverlay.style.display = 'block';
                openCashModal.style.display = 'flex';
            } else {
                const cashDoc = querySnapshot.docs[0];
                currentCashRegister = { id: cashDoc.id, ...cashDoc.data() };

                const openDate = currentCashRegister.dataAbertura.toDate();
                const today = new Date();
                
                const isOpenDateFromYesterday = openDate.getFullYear() < today.getFullYear() ||
                                               openDate.getMonth() < today.getMonth() ||
                                               openDate.getDate() < today.getDate();

                if (isOpenDateFromYesterday) {
                    const formattedDate = openDate.toLocaleDateString('pt-BR');
                    document.getElementById('pending-cash-message').textContent = `Existe um caixa do dia ${formattedDate} que não foi fechado. Por favor, feche o caixa para poder continuar.`;
                    document.getElementById('pending-cash-alert').classList.remove('hidden');
                    document.getElementById('open-cash-title').textContent = 'Resolver Caixa Pendente';
                    
                    openCashForm.style.display = 'none';
                    resolvePendingContainer.classList.remove('hidden');
                    document.getElementById('open-cash-instructions').style.display = 'none';
                    
                    pdvOverlay.style.display = 'block';
                    openCashModal.style.display = 'flex';
                } else {
                    pdvOverlay.style.display = 'none';
                    openCashModal.style.display = 'none';
                    initializePDV();
                }
            }
        }

        openCashForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const initialValue = parseFloat(document.getElementById('initial-value').value);
            if (isNaN(initialValue) || initialValue < 0) {
                alert("Por favor, insira um valor inicial válido.");
                return;
            }

            try {
                await addDoc(collection(db, "caixas"), {
                    dataAbertura: serverTimestamp(),
                    usuarioAbertura: auth.currentUser.email,
                    valorInicial: initialValue,
                    status: 'aberto'
                });
                checkCashRegisterStatus();
            } catch (error) {
                console.error("Erro ao abrir o caixa:", error);
                alert("Não foi possível abrir o caixa. Tente novamente.");
            }
        });
        // --- FIM DA LÓGICA DE CAIXA ---

        const mainTabs = document.getElementById('main-tabs');
        const tabContents = document.querySelectorAll('.tab-content');
        const mesasGrid = document.getElementById('mesas-grid');
        const NUMERO_DE_MESAS = 12;

        // Colunas para Delivery
        const colDeliveryNovo = document.getElementById('col-delivery-novo');
        const colDeliveryPreparo = document.getElementById('col-delivery-preparo');
        const colDeliveryEntrega = document.getElementById('col-delivery-entrega');
        const colDeliveryFinalizado = document.getElementById('col-delivery-finalizado');

        // Colunas para Retirada
        const colRetiradaNovo = document.getElementById('col-retirada-novo');
        const colRetiradaPreparo = document.getElementById('col-retirada-preparo');
        const colRetiradaPronto = document.getElementById('col-retirada-pronto');
        const colRetiradaFinalizado = document.getElementById('col-retirada-finalizado');
        
        const connectionStatus = document.getElementById('connection-status');
        const editOrderModal = document.getElementById('edit-order-modal');
        const editModalBody = document.getElementById('edit-modal-body');
        const closeEditModalBtn = document.getElementById('close-edit-modal');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const clearFinishedBtn = document.getElementById('clear-finished-btn');
        const closeCashRegisterBtn = document.getElementById('close-cash-register-btn');
        const closeCashModal = document.getElementById('close-cash-modal');
        const closeCashForm = document.getElementById('close-cash-form');
        const cancelCloseCashBtn = document.getElementById('cancel-close-cash-btn');
        const finalValueInput = document.getElementById('final-value');
        
        let orderIdToDelete = null;
        let deliveryFeesData = [];

        const joinTablesBtn = document.getElementById('join-tables-btn');
        const joiningControls = document.getElementById('joining-controls');
        const confirmJoinBtn = document.getElementById('confirm-join-btn');
        const cancelJoinBtn = document.getElementById('cancel-join-btn');
        let isJoiningTables = false;
        let selectedTablesForJoining = [];

        const manageTableModal = document.getElementById('manage-table-modal');
        const closeManageTableModalBtn = document.getElementById('close-manage-table-modal');
        const transferTableModal = document.getElementById('transfer-table-modal');
        let currentManagingOrderId = null;
        let currentManagingOrderData = null;

        // Lógica de troca de abas
        mainTabs.addEventListener('click', (e) => {
            const tabButton = e.target.closest('.main-tab-btn');
            if (!tabButton) return;

            mainTabs.querySelector('.active').classList.remove('active');
            tabButton.classList.add('active');

            tabContents.forEach(content => content.classList.add('hidden'));
            const tabName = tabButton.dataset.tab;
            document.getElementById(`tab-content-${tabName}`).classList.remove('hidden');
        });

        // Inicializa as mesas
        function initializeMesas() {
            mesasGrid.innerHTML = '';
            for (let i = 1; i <= NUMERO_DE_MESAS; i++) {
                const mesaEl = document.createElement('div');
                mesaEl.id = `mesa-${i}`;
                mesaEl.className = 'mesa-item flex flex-col justify-center items-center p-4 border-2 rounded-lg cursor-pointer mesa-status-livre';
                mesaEl.dataset.status = 'livre';
                mesaEl.dataset.number = i;
                mesaEl.style.gridColumn = ''; // Reseta o span
                mesaEl.innerHTML = `
                    <span class="text-3xl font-bold">${i.toString().padStart(2, '0')}</span>
                    <span class="text-sm font-medium mt-2">Livre</span>
                `;
                mesaEl.addEventListener('click', () => handleMesaClick(i));
                mesasGrid.appendChild(mesaEl);
            }
        }

        function handleMesaClick(numeroMesa) {
            const mesaEl = document.getElementById(`mesa-${numeroMesa}`);
            if (!mesaEl) return;
            const status = mesaEl.dataset.status;
            
            if (isJoiningTables) {
                if (status === 'livre') {
                    const index = selectedTablesForJoining.indexOf(numeroMesa);
                    if (index > -1) {
                        selectedTablesForJoining.splice(index, 1);
                        mesaEl.classList.remove('selected-for-join');
                    } else {
                        selectedTablesForJoining.push(numeroMesa);
                        mesaEl.classList.add('selected-for-join');
                    }
                }
                return;
            }

            if (status === 'livre') {
                window.open(`atendente.html?mesa=${numeroMesa}`, '_blank');
            } else {
                const orderId = mesaEl.dataset.orderId;
                if (orderId) {
                    openManageTableModal(orderId);
                }
            }
        }
        
        async function openCloseCashModal() {
            if (!currentCashRegister) {
                alert("Nenhum caixa aberto para fechar.");
                return;
            }

            const ordersQuery = query(
                collection(db, "pedidos"),
                where("criadoEm", ">=", currentCashRegister.dataAbertura),
                where("status", "==", "Finalizado")
            );
            const ordersSnapshot = await getDocs(ordersQuery);

            let totalCash = 0, totalCard = 0, totalPix = 0;
            let totalDelivery = 0, totalRetirada = 0, totalMesas = 0, totalDeliveryFees = 0;

            ordersSnapshot.forEach(doc => {
                const order = doc.data();
                const total = order.total.finalTotal;
                const payment = order.pagamento;
                
                // Soma por tipo de pagamento
                if (typeof payment === 'object' && payment.method === 'Dinheiro') totalCash += total;
                else if (payment === 'Cartão de Crédito/Débito') totalCard += total;
                else if (payment === 'Pix') totalPix += total;
                
                // Soma por tipo de pedido
                const orderType = identifyOrderType(order);
                if (orderType === 'delivery') {
                    totalDelivery += total;
                    totalDeliveryFees += order.total.deliveryFee;
                } else if (orderType === 'retirada') {
                    totalRetirada += total;
                } else if (orderType === 'mesa') {
                    totalMesas += total;
                }
            });

            const totalSales = totalCash + totalCard + totalPix;
            const expectedInCash = currentCashRegister.valorInicial + totalCash;
            
            detailedReportData = { totalDelivery, totalRetirada, totalMesas, totalDeliveryFees, totalCash, totalCard, totalPix, totalSales };

            document.getElementById('summary-initial').textContent = `R$ ${currentCashRegister.valorInicial.toFixed(2).replace('.', ',')}`;
            document.getElementById('summary-delivery').textContent = `R$ ${totalDelivery.toFixed(2).replace('.', ',')}`;
            document.getElementById('summary-retirada').textContent = `R$ ${totalRetirada.toFixed(2).replace('.', ',')}`;
            document.getElementById('summary-mesas').textContent = `R$ ${totalMesas.toFixed(2).replace('.', ',')}`;
            document.getElementById('summary-delivery-fees').textContent = `R$ ${totalDeliveryFees.toFixed(2).replace('.', ',')}`;
            document.getElementById('summary-cash').textContent = `R$ ${totalCash.toFixed(2).replace('.', ',')}`;
            document.getElementById('summary-card').textContent = `R$ ${totalCard.toFixed(2).replace('.', ',')}`;
            document.getElementById('summary-pix').textContent = `R$ ${totalPix.toFixed(2).replace('.', ',')}`;
            document.getElementById('summary-total-sales').textContent = `R$ ${totalSales.toFixed(2).replace('.', ',')}`;
            document.getElementById('summary-expected').textContent = `R$ ${expectedInCash.toFixed(2).replace('.', ',')}`;

            closeCashModal.style.display = 'flex';
        }

        async function clearFinishedOrders() {
            if (!confirm("Tem certeza que deseja limpar todos os pedidos finalizados da tela? Eles serão arquivados.")) {
                return;
            }
            const q = query(collection(db, "pedidos"), where("status", "==", "Finalizado"));
            const snapshot = await getDocs(q);
            const batch = writeBatch(db);
            snapshot.docs.forEach(doc => {
                batch.update(doc.ref, { status: "Arquivado" });
            });
            await batch.commit();
        }
        
        closeCashRegisterBtn.addEventListener('click', openCloseCashModal);

        cancelCloseCashBtn.addEventListener('click', () => {
            closeCashModal.style.display = 'none';
        });

        finalValueInput.addEventListener('input', () => {
            const expectedText = document.getElementById('summary-expected').textContent;
            const expectedValue = parseFloat(expectedText.replace('R$ ', '').replace(',', '.'));
            const finalValue = parseFloat(finalValueInput.value);
            const differenceSection = document.getElementById('summary-difference-section');
            const differenceEl = document.getElementById('summary-difference');

            if (!isNaN(finalValue)) {
                const difference = finalValue - expectedValue;
                differenceEl.textContent = `R$ ${difference.toFixed(2).replace('.', ',')}`;
                if (difference < 0) {
                    differenceSection.className = 'text-center p-2 rounded-md mb-4 bg-red-100 text-red-700';
                } else if (difference > 0) {
                    differenceSection.className = 'text-center p-2 rounded-md mb-4 bg-yellow-100 text-yellow-700';
                } else {
                    differenceSection.className = 'text-center p-2 rounded-md mb-4 bg-green-100 text-green-700';
                }
                differenceSection.classList.remove('hidden');
            } else {
                differenceSection.classList.add('hidden');
            }
        });

        closeCashForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const finalValue = parseFloat(finalValueInput.value);
            if (isNaN(finalValue) || finalValue < 0) {
                alert("Por favor, insira um valor válido.");
                return;
            }
            
            const cashRegisterRef = doc(db, "caixas", currentCashRegister.id);
            const expectedValue = parseFloat(document.getElementById('summary-expected').textContent.replace('R$ ', '').replace(',', '.'));
            
            try {
                await updateDoc(cashRegisterRef, {
                    status: 'fechado',
                    dataFechamento: serverTimestamp(),
                    usuarioFechamento: auth.currentUser.email,
                    valorFinalContado: finalValue,
                    diferenca: finalValue - expectedValue,
                    totalVendas: detailedReportData.totalSales,
                    totalVendasDelivery: detailedReportData.totalDelivery,
                    totalVendasRetirada: detailedReportData.totalRetirada,
                    totalVendasMesas: detailedReportData.totalMesas,
                    totalTaxasEntrega: detailedReportData.totalDeliveryFees,
                    totalDinheiro: detailedReportData.totalCash,
                    totalCartao: detailedReportData.totalCard,
                    totalPix: detailedReportData.totalPix
                });
                alert("Caixa fechado com sucesso!");
                closeCashModal.style.display = 'none';
                checkCashRegisterStatus(); // Bloqueia a tela
            } catch (error) {
                console.error("Erro ao fechar o caixa:", error);
                alert("Não foi possível fechar o caixa. Tente novamente.");
            }
        });

        document.querySelector('main').addEventListener('click', function(e) {
            const moveBtn = e.target.closest('.move-btn');
            const manageBtn = e.target.closest('.manage-btn');
            const printBtn = e.target.closest('.print-btn');

            if (moveBtn) {
                const orderId = moveBtn.dataset.id;
                const newStatus = moveBtn.dataset.status;
                updateOrderStatus(orderId, newStatus);
            }
            if (manageBtn) {
                const orderId = manageBtn.dataset.id;
                const card = manageBtn.closest('.order-card');
                const orderType = identifyOrderTypeFromCard(card);
                if (orderType === 'mesa') {
                    openManageTableModal(orderId);
                } else {
                    openEditModal(orderId);
                }
            }
            if (printBtn) {
                const orderId = printBtn.dataset.id;
                const printType = printBtn.dataset.type;
                printOrder(orderId, printType);
            }

            const cardHeader = e.target.closest('.card-header');
            if (cardHeader) {
                const card = cardHeader.closest('.order-card');
                if (card) {
                    if (!e.target.closest('button, a')) {
                        card.classList.toggle('expanded');
                    }
                }
            }
        });

        function identifyOrderTypeFromCard(cardElement) {
            if (!cardElement) return null;
            if (cardElement.closest('#tab-content-mesas')) return 'mesa';
            if (cardElement.closest('#tab-content-retirada')) return 'retirada';
            return 'delivery';
        }

        closeEditModalBtn.addEventListener('click', () => {
            editOrderModal.style.display = 'none';
        });

        editModalBody.addEventListener('click', function(e) {
            if (e.target.id === 'save-changes-btn') {
                saveOrderChanges();
            }
            if (e.target.id === 'delete-order-btn') {
                showDeleteConfirmation();
            }
        });
        
        cancelDeleteBtn.addEventListener('click', () => {
            deleteConfirmModal.style.display = 'none';
            orderIdToDelete = null;
        });

        confirmDeleteBtn.addEventListener('click', executeDelete);
        clearFinishedBtn.addEventListener('click', clearFinishedOrders);
        
        function toggleJoinMode(active) {
            isJoiningTables = active;
            mesasGrid.classList.toggle('joining-mode', active);
            joinTablesBtn.classList.toggle('hidden', active);
            joiningControls.classList.toggle('hidden', !active);

            if (!active) {
                selectedTablesForJoining = [];
                document.querySelectorAll('.mesa-item.selected-for-join').forEach(el => el.classList.remove('selected-for-join'));
            }
        }

        joinTablesBtn.addEventListener('click', () => toggleJoinMode(true));
        cancelJoinBtn.addEventListener('click', () => toggleJoinMode(false));
        confirmJoinBtn.addEventListener('click', () => {
            if (selectedTablesForJoining.length < 2) {
                alert("Selecione pelo menos duas mesas para juntar.");
                return;
            }
            const sortedTables = selectedTablesForJoining.sort((a, b) => a - b);
            const tablesParam = sortedTables.join(',');
            
            window.open(`atendente.html?grupo=${tablesParam}`, '_blank');
            
            toggleJoinMode(false);
        });

        closeManageTableModalBtn.addEventListener('click', () => {
            manageTableModal.style.display = 'none';
        });

        resolvePendingBtn.addEventListener('click', () => {
            openCashModal.style.display = 'none';
            openCloseCashModal();
        });

    </script>
</body>
</html>

