<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Venda Balcão - Sâmia Pizzaria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="https://raw.githubusercontent.com/WillianSoares93/cardapio_samia_PDV/refs/heads/main/logo.png" type="image/png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
        html { scroll-behavior: smooth; }
        body { font-family: 'Poppins', sans-serif; background-color: #f8f4e9; visibility: hidden; }
        .flavor-card { transition: all 0.3s ease; }
        .flavor-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .btn-order { background: linear-gradient(135deg, #22c55e, #10b981); transition: all 0.3s ease; }
        .btn-order:hover { transform: scale(1.05); box-shadow: 0 5px 15px rgba(34, 197, 94, 0.4); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); justify-content: center; align-items: center; padding: 20px; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2); position: relative; animation: fadeIn 0.3s ease-out; }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; position: absolute; top: 10px; right: 20px; cursor: pointer; }
        .close-button:hover, .close-button:focus { color: black; text-decoration: none; cursor: pointer; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { transform: translateY(0); } }
        .pizza-size-option { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 12px; background-color: #f9fafb; border: 2px solid #e5e7eb; border-radius: 10px; transition: all 0.3s ease-in-out; text-align: center; flex-shrink: 0; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08); }
        .pizza-size-option:hover { border-color: #dc2626; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15); transform: translateY(-4px); }
        .no-image-placeholder { background-color: #dc2626; height: 160px; width: 100%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; text-align: center; padding: 10px; object-fit: cover; }
        .builder-modal { max-width: 600px; }
        .ingredient-category h4 { font-size: 1.25rem; font-weight: bold; color: #1f2937; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid #e5e7eb; }
        .ingredient-option { display: flex; justify-content: space-between; align-items: center; background-color: #f9fafb; padding: 10px 15px; border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s ease-in-out; border: 1px solid #e5e7eb; }
        .ingredient-option:hover { border-color: #dc2626; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08); }
        .ingredient-option.selected { background-color: #fee2e2; border-color: #dc2626; box-shadow: 0 2px 8px rgba(220, 38, 38, 0.2); }
        .scope-button { transition: all 0.2s ease-in-out; }
        .scope-button.active { background-color: #ef4444; color: white; font-weight: bold; }
    </style>
</head>
<body>
    <header class="bg-white shadow-sm z-10">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
             <div class="flex items-center space-x-4">
                <i class="fas fa-cash-register text-xl text-gray-600"></i>
                <h1 class="text-xl font-bold text-gray-800">VENDA BALCÃO</h1>
            </div>
            <div class="flex items-center space-x-4">
                <span id="current-user" class="text-sm font-medium text-gray-600"></span>
                <a href="pdv.html" class="px-3 py-2 bg-gray-600 text-white text-xs font-bold rounded-md hover:bg-gray-700">PAINEL PDV</a>
                <button id="logout-btn" class="px-3 py-2 bg-red-600 text-white text-xs font-bold rounded-md hover:bg-red-700">SAIR</button>
            </div>
        </div>
    </header>

    <section id="menu" class="py-8 px-4 max-w-6xl mx-auto">
        <div class="text-center mb-8">
            <h2 class="text-4xl font-bold text-gray-800 mb-4">Lançar Pedido de Balcão</h2>
        </div>
        <div id="category-buttons-container" class="flex space-x-2 mb-6 overflow-x-auto pb-2 lg:flex-wrap lg:justify-center"></div>
        <div id="pizza-list">
            <div id="dynamic-pizza-sections"></div>
        </div>
    </section>

    <button id="cart-button" class="fixed bottom-4 right-4 bg-red-600 text-white w-16 h-16 rounded-full flex items-center justify-center shadow-lg z-40">
        <i class="fas fa-shopping-cart text-2xl"></i>
        <span id="cartCount" class="absolute -top-1 -right-1 bg-yellow-400 text-red-700 text-xs font-bold rounded-full h-6 w-6 flex items-center justify-center border-2 border-white hidden">0</span>
    </button>
    
    <div id="orderSidebar" class="fixed top-0 right-0 h-full w-full max-w-md bg-white shadow-xl z-50 transform translate-x-full transition-transform duration-300 overflow-y-auto">
        <div class="p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">Pedido Atual</h3>
                <button id="close-sidebar-btn" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <div class="mb-4">
                <label for="clientNameInput" class="block text-gray-700 text-sm font-bold mb-2">Nome do Cliente (Opcional):</label>
                <input type="text" id="clientNameInput" placeholder="Cliente Balcão" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700">
            </div>

            <div id="orderItems" class="mb-6">
                <p class="text-gray-500 text-center py-8" id="emptyOrderMessage">Seu pedido está vazio</p>
            </div>
            
            <div class="border-t border-gray-200 pt-4 mb-6">
                <div class="flex justify-between mb-2">
                    <span class="text-gray-600">Subtotal:</span>
                    <span id="subtotal" class="font-bold">R$ 0,00</span>
                </div>
                <div class="flex justify-between text-lg font-bold">
                    <span>Total:</span>
                    <span id="total">R$ 0,00</span>
                </div>
            </div>
            <button id="back-to-menu-btn" class="w-full py-3 bg-gray-600 text-white font-bold rounded-full mb-4">Adicionar mais</button>
            <button id="checkoutButton" class="btn-order w-full py-3 text-white font-bold rounded-full mb-4">Finalizar Pedido</button>
        </div>
    </div>

    <div id="pizza-option-modal" class="modal"><div class="modal-content"><span class="close-button" id="close-pizza-option-modal">&times;</span><h3 class="text-xl font-bold text-gray-800 mb-4" id="modal-pizza-name"></h3><p class="text-gray-600 mb-6" id="modal-pizza-description"></p><div id="pizza-size-options" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div></div></div>
    <div id="burger-builder-modal" class="modal"><div class="modal-content builder-modal"><span class="close-button" id="close-burger-builder-modal">&times;</span><h3 class="text-xl font-bold text-gray-800 mb-4">Monte Seu Hambúrguer</h3><div id="burger-ingredients-container" class="mb-4"></div><div class="flex justify-between items-center bg-gray-100 p-4 rounded-lg mt-4"><span class="text-lg font-bold">Total:</span><span id="burger-total-price" class="text-2xl font-bold text-red-600">R$ 0,00</span></div><button id="add-custom-burger-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-full transition w-full">Adicionar ao Pedido</button></div></div>
    <div id="ask-pizza-extras-modal" class="modal"><div class="modal-content"><p class="text-lg font-semibold text-gray-800 mb-4" id="ask-extras-title"></p><div class="flex justify-center gap-4"><button id="ask-extras-no-btn" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-lg font-bold hover:bg-gray-400 transition">Não, obrigado</button><button id="ask-extras-yes-btn" class="px-6 py-2 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition">Sim, quero!</button></div></div></div>
    <div id="pizza-extras-builder-modal" class="modal"><div class="modal-content builder-modal"><span class="close-button" id="close-pizza-extras-builder-modal">&times;</span><h3 class="text-xl font-bold text-gray-800 mb-4" id="pizza-extras-builder-title"></h3><div id="pizza-extras-scope-buttons" class="flex flex-wrap gap-2 mb-4 border-b pb-4"></div><div id="pizza-extras-ingredients-container" class="mb-4 max-h-80 overflow-y-auto p-2"></div><div class="flex justify-between items-center bg-gray-100 p-4 rounded-lg mt-4"><span class="text-lg font-bold">Total da Pizza:</span><span id="pizza-extras-total-price" class="text-2xl font-bold text-red-600">R$ 0,00</span></div><button id="add-pizza-with-extras-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-full transition w-full mt-4">Confirmar Adicionais</button></div></div>
    <div id="alert-modal" class="modal"><div class="modal-content"><p id="alert-message" class="text-lg font-semibold text-gray-800 mb-4 text-center"></p><div class="flex justify-center"><button id="alert-ok-btn" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition">OK</button></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = {
           apiKey: "AIzaSyBJ44RVDGhBIlQBTx-pyIUp47XDKzRXk84",
           authDomain: "pizzaria-pdv.firebaseapp.com",
           projectId: "pizzaria-pdv",
           storageBucket: "pizzaria-pdv.firebasestorage.app",
           messagingSenderId: "304171744691",
           appId: "1:304171744691:web:e54d7f9fe55c7a75485fc6"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserEmail = '';
        let order = [];
        let allMenuData = [];
        let allBurgerIngredients = {};
        let allPizzaIngredients = {};
        let isSelectingHalfPizza = false;
        let firstHalfPizza = null;
        let currentPizzaData = {};
        let currentBurgerBasePrice = 0;
        let isFirstHalfPromotional = false;
        let itemVisibility = {}, unavailableItems = {}, ingredientVisibility = {}, ingredientStatus = {}, extraVisibility = {}, extraStatus = {}, pizzaHalfStatus = {}, itemExtrasStatus = {};
        let currentPizzaExtrasState = {};

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.body.style.visibility = 'visible';
                currentUserEmail = user.email;
                document.getElementById('current-user').textContent = currentUserEmail;
                initializeAppLogic();
            } else {
                window.location.href = 'login.html?redirect=venda-balcao.html';
            }
        });

        async function initializeAppLogic() {
            await loadMenuAndRender();
            listenToControls();
            setupEventListeners();
        }

        async function loadMenuAndRender() {
            try {
                const response = await fetch('/api/menu');
                if (!response.ok) throw new Error('Network error');
                const data = await response.json();
                
                const promotionsWithCategory = (data.promocoes || []).map(promo => {
                    const originalItem = data.cardapio.find(item => item.id === promo.itemId);
                    return { ...promo, category: 'Promocionais', isPizza: originalItem ? originalItem.isPizza : false, isCustomizable: false, basePrice: promo.promoPrice };
                });
                
                allMenuData = [...data.cardapio, ...promotionsWithCategory];

                const rawBurgerIngredients = data.ingredientesHamburguer;
                allBurgerIngredients = rawBurgerIngredients.reduce((acc, current) => {
                    if (!acc[current.category]) acc[current.category] = [];
                    acc[current.category].push(current);
                    return acc;
                }, {});
                
                const rawPizzaIngredients = data.ingredientesPizza || [];
                allPizzaIngredients = rawPizzaIngredients.reduce((acc, current) => {
                    const category = current.category || 'Adicionais';
                    if (!acc[category]) acc[category] = [];
                    acc[category].push(current);
                    return acc;
                }, {});

                updateUI();
            } catch (error) {
                console.error('Erro ao carregar cardápio:', error);
                showAlert('Não foi possível carregar o cardápio.');
            }
        }

        function listenToControls() {
            onSnapshot(doc(db, "config", "item_status"), (doc) => { unavailableItems = doc.exists() ? doc.data() : {}; updateUI(); });
            onSnapshot(doc(db, "config", "item_visibility"), (doc) => { itemVisibility = doc.exists() ? doc.data() : {}; updateUI(); });
            onSnapshot(doc(db, "config", "pizza_half_status"), (doc) => { pizzaHalfStatus = doc.exists() ? doc.data() : {}; });
            onSnapshot(doc(db, "config", "item_extras_status"), (doc) => { itemExtrasStatus = doc.exists() ? doc.data() : {}; });
            onSnapshot(doc(db, "config", "ingredient_status"), (doc) => { ingredientStatus = doc.exists() ? doc.data() : {}; });
            onSnapshot(doc(db, "config", "ingredient_visibility"), (doc) => { ingredientVisibility = doc.exists() ? doc.data() : {}; });
            onSnapshot(doc(db, "config", "extra_status"), (doc) => { extraStatus = doc.exists() ? doc.data() : {}; });
            onSnapshot(doc(db, "config", "extra_visibility"), (doc) => { extraVisibility = doc.exists() ? doc.data() : {}; });
        }
        
        function updateUI() {
            const visibleItems = allMenuData.filter(item => itemVisibility[item.id] !== false);
            const orderedCategories = [...new Set(visibleItems.map(item => item.category).filter(Boolean))];
            createCategoryButtons(orderedCategories);
            populateMenu(visibleItems, orderedCategories);
        }

        function populateMenu(menuItems, orderedCategories) {
            const dynamicSectionsContainer = document.getElementById('dynamic-pizza-sections');
            dynamicSectionsContainer.innerHTML = '';
            
            const itemsByCategory = menuItems.reduce((acc, item) => {
                if(item.category) {
                    if (!acc[item.category]) acc[item.category] = [];
                    acc[item.category].push(item);
                }
                return acc;
            }, {});

            orderedCategories.forEach(category => {
                const sectionId = `${category.toLowerCase().replace(/\s+/g, '-')}-section`;
                const sectionEl = document.createElement('div');
                sectionEl.id = sectionId;
                sectionEl.className = 'pizza-category-section mb-8';
                
                const isPizzaCategory = itemsByCategory[category] && itemsByCategory[category].some(item => item.isPizza);
                const title = isPizzaCategory ? `Pizzas ${capitalizeFirstLetter(category)}` : capitalizeFirstLetter(category);
                
                sectionEl.innerHTML = `<h3 class="text-xl font-bold text-white p-2 rounded-md bg-red-600 mb-6">${title}</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="${category}-items"></div>`;
                dynamicSectionsContainer.appendChild(sectionEl);

                const categoryItemsEl = document.getElementById(`${category}-items`);
                itemsByCategory[category].forEach(item => {
                    const isUnavailable = unavailableItems[item.id] === false;
                    const imageUrl = String(item.imageUrl || '').trim();
                    const imageElement = (!imageUrl || imageUrl.toLowerCase() === 'sem imagem') ? `<div class="no-image-placeholder">Sâmia</div>` : `<img src="${imageUrl}" alt="${item.name}" class="w-full h-40 object-cover" onerror="this.parentElement.innerHTML = '<div class=\\'no-image-placeholder\\'>Sâmia</div>';">`;
                    const buttonText = isUnavailable ? 'Esgotado' : (item.isCustomizable ? 'Montar' : 'Adicionar');
                    const buttonClasses = isUnavailable ? 'bg-gray-400 cursor-not-allowed' : 'bg-red-600 hover:bg-red-700';
                    
                    let pricesHtml = '';
                    if (item.isPizza) {
                        pricesHtml = ['price4Slices', 'price6Slices', 'basePrice', 'price10Slices'].map((pk, i) => {
                            if (item[pk] > 0) {
                                const label = [4, 6, 8, 10][i];
                                return `<div class="text-center px-1"><span class="text-xs text-gray-500">${label} Fatias</span><p class="font-bold text-red-600">R$ ${item[pk].toFixed(2).replace('.', ',')}</p></div>`;
                            }
                            return '';
                        }).join('');
                    } else {
                        pricesHtml = `<span class="font-bold text-red-600 text-lg">R$ ${item.basePrice.toFixed(2).replace('.', ',')}</span>`;
                    }
                    
                    const itemHtml = `
                        <div class="flavor-card bg-white rounded-xl overflow-hidden shadow-lg flex flex-col ${isUnavailable ? 'opacity-60' : ''}">
                            ${imageElement}
                            <div class="p-6 flex flex-col flex-grow">
                                <h3 class="text-xl font-bold text-gray-800 mb-2">${item.name}</h3>
                                <p class="text-gray-600 text-sm mb-4 flex-grow">${item.description}</p>
                                <div class="mt-auto pt-4 border-t border-gray-100">
                                    <div class="flex justify-between items-center">
                                        <div class="flex flex-wrap gap-2">${pricesHtml}</div>
                                        <button class="add-item-btn ${buttonClasses} text-white px-4 py-2 rounded-full text-sm font-medium transition duration-300" data-item-id="${item.id}" ${isUnavailable ? 'disabled' : ''}>${buttonText}</button>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    categoryItemsEl.insertAdjacentHTML('beforeend', itemHtml);
                });
            });
            attachAddButtonListeners();
        }

        function createCategoryButtons(categories) {
            const container = document.getElementById('category-buttons-container');
            container.innerHTML = '';
            categories.forEach(category => {
                const button = document.createElement('button');
                const isPizza = allMenuData.some(item => item.category === category && item.isPizza);
                button.textContent = isPizza ? `Pizzas ${capitalizeFirstLetter(category)}` : capitalizeFirstLetter(category);
                button.className = 'category-btn px-4 py-2 rounded-full bg-gray-200 text-gray-800 whitespace-nowrap';
                button.dataset.targetId = `${category.toLowerCase().replace(/\s+/g, '-')}-section`;
                button.addEventListener('click', () => {
                    document.getElementById(button.dataset.targetId)?.scrollIntoView({ behavior: 'smooth' });
                });
                container.appendChild(button);
            });
        }

        function attachAddButtonListeners() {
            document.querySelectorAll('.add-item-btn').forEach(button => {
                button.removeEventListener('click', handleAddButtonClick);
                button.addEventListener('click', handleAddButtonClick);
            });
        }

        function handleAddButtonClick(e) {
            const button = e.target;
            const itemId = button.dataset.itemId;
            const item = allMenuData.find(i => i.id === itemId);
            if (!item) return;

            if (item.isCustomizable) {
                openBurgerBuilderModal(item);
            } else if (item.isPizza) {
                openPizzaOptionsModal(item);
            } else {
                addToOrder({ ...item, type: 'full', price: item.basePrice });
            }
        }
        
        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1).toLowerCase();
        }

        function setupEventListeners() {
            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
            document.getElementById('cart-button').addEventListener('click', () => document.getElementById('orderSidebar').classList.remove('translate-x-full'));
            document.getElementById('close-sidebar-btn').addEventListener('click', () => document.getElementById('orderSidebar').classList.add('translate-x-full'));
            document.getElementById('back-to-menu-btn').addEventListener('click', () => document.getElementById('orderSidebar').classList.add('translate-x-full'));
            document.getElementById('checkoutButton').addEventListener('click', finalizeOrder);
            
            // Burger Builder Logic
            const burgerContainer = document.getElementById('burger-ingredients-container');
            burgerContainer.addEventListener('click', (e) => {
                const quantityBtn = e.target.closest('.quantity-btn');
                const radioInput = e.target.closest('.ingredient-option')?.querySelector('.form-radio');

                if (quantityBtn) {
                    e.stopPropagation();
                    const container = quantityBtn.closest('[data-ingredient-id]');
                    const display = container.querySelector('.quantity-display');
                    const ingredientLimit = parseInt(container.dataset.limit);
                    let quantity = parseInt(display.textContent);
                    const categoryDiv = container.closest('[data-limit]');
                    const categoryLimit = parseInt(categoryDiv.dataset.limit);
                    
                    if (quantityBtn.classList.contains('plus-btn')) {
                        if (quantity >= ingredientLimit) {
                            showAlert(`O limite para este ingrediente é ${ingredientLimit}.`); return;
                        }
                        if (quantity === 0) {
                            let currentVarietyCount = 0;
                            categoryDiv.querySelectorAll('.quantity-display').forEach(d => { if (parseInt(d.textContent) > 0) currentVarietyCount++; });
                            categoryDiv.querySelectorAll('input[type="radio"]:checked').forEach(() => currentVarietyCount++);
                            if (currentVarietyCount >= categoryLimit) {
                               showAlert(`Você pode escolher no máximo ${categoryLimit} variedades nesta categoria.`); return;
                            }
                        }
                        quantity++;
                    } else if (quantity > 0) {
                        quantity--;
                    }
                    display.textContent = quantity;
                    container.closest('.ingredient-option').classList.toggle('selected', quantity > 0);
                } else if (radioInput) {
                    if (radioInput.disabled) return;
                    if (!radioInput.checked) {
                        const categoryDiv = radioInput.closest('[data-limit]');
                        const categoryLimit = parseInt(categoryDiv.dataset.limit);
                        let currentVarietyCount = 0;
                        categoryDiv.querySelectorAll('.quantity-display').forEach(d => { if (parseInt(d.textContent) > 0) currentVarietyCount++; });
                        const isReplacingRadio = categoryDiv.querySelector('input[type="radio"]:checked');
                        if (!isReplacingRadio) currentVarietyCount++;
                        if (currentVarietyCount > categoryLimit) {
                            showAlert(`Você pode escolher no máximo ${categoryLimit} item(ns) nesta categoria.`);
                            e.preventDefault();
                            return;
                        }
                    }
                    setTimeout(() => {
                        document.querySelectorAll(`input[name="${radioInput.name}"]`).forEach(r => r.closest('.ingredient-option').classList.toggle('selected', r.checked));
                        updateBurgerPrice();
                    }, 0);
                }
                updateBurgerPrice();
            });

            // The rest of your event listeners from the original venda-balcao.html
             // ... (paste the other event listeners here, like pizza modals, etc.) ...
             document.getElementById('cancel-order-btn').addEventListener('click', async () => {
                if (order.length > 0) {
                    const confirmed = await showConfirm('Deseja cancelar o pedido atual?');
                    if (confirmed) {
                        order = [];
                        updateOrderDisplay();
                    }
                }
            });

             // Pizza Modals, etc.
            document.getElementById('close-pizza-modal-btn').addEventListener('click', () => document.getElementById('pizza-option-modal').style.display = 'none');
            document.getElementById('close-burger-modal-btn').addEventListener('click', () => document.getElementById('burger-builder-modal').style.display = 'none');
            document.getElementById('cancel-burger-btn').addEventListener('click', () => document.getElementById('burger-builder-modal').style.display = 'none');
            document.getElementById('add-custom-burger-btn').addEventListener('click', addCustomBurgerToOrder);
            document.getElementById('ask-extras-no-btn').addEventListener('click', () => document.getElementById('ask-pizza-extras-modal').style.display = 'none');
            document.getElementById('ask-extras-yes-btn').addEventListener('click', () => {
                openPizzaExtrasBuilderModal(document.getElementById('ask-pizza-extras-modal').dataset.uniqueId);
                document.getElementById('ask-pizza-extras-modal').style.display = 'none';
            });
            document.getElementById('close-pizza-extras-builder-modal').addEventListener('click', () => document.getElementById('pizza-extras-builder-modal').style.display = 'none');
            document.getElementById('add-pizza-with-extras-btn').addEventListener('click', confirmPizzaExtras);
        }
        
        async function finalizeOrder() {
            if (order.length === 0) {
                showAlert("O carrinho está vazio.");
                return;
            }
            const clientName = document.getElementById('clientNameInput').value || 'Cliente Balcão';
            const total = order.reduce((sum, item) => sum + item.price, 0);

            const cleanedItems = JSON.parse(JSON.stringify(order, (key, value) => {
                if (['originalItem', 'uniqueId', 'firstHalfData', 'secondHalfData'].includes(key)) return undefined;
                return value;
            }));

            const newOrder = {
                itens: cleanedItems,
                endereco: { clientName: clientName, rua: "Retirada no Balcão", bairro: "BALCÃO" },
                total: { subtotal: total, finalTotal: total, deliveryFee: 0, discount: 0 },
                pagamento: 'A Definir',
                status: 'Entregue', // Directly set as delivered for counter sales
                criadoEm: serverTimestamp(),
                observacao: `Venda de balcão por ${currentUserEmail}`
            };

            try {
                await addDoc(collection(db, "pedidos"), newOrder);
                showAlert(`Pedido para ${clientName} finalizado com sucesso!`);
                order = [];
                document.getElementById('clientNameInput').value = 'Cliente Balcão';
                updateOrderDisplay();
                document.getElementById('orderSidebar').classList.add('translate-x-full');
            } catch (error) {
                console.error("Erro ao finalizar pedido:", error);
                showAlert("Falha ao finalizar o pedido. Tente novamente.");
            }
        }
        
        // Include other helper functions from index.html that are still needed,
        // like updateOrderDisplay, updateCartCount, etc., but adapted for the new structure.
        // For example, updateOrderDisplay will now render into the sidebar.
        function updateOrderDisplay() {
            const orderItemsContainer = document.getElementById('orderItems');
            const emptyMsg = document.getElementById('emptyOrderMessage');
            let subtotal = 0;

            if (order.length === 0) {
                orderItemsContainer.innerHTML = '';
                emptyMsg.classList.remove('hidden');
            } else {
                emptyMsg.classList.add('hidden');
                orderItemsContainer.innerHTML = order.map((item, index) => {
                    subtotal += item.price;
                    // Simplified display for the sidebar
                    return `<div class="py-2 border-b border-gray-100 flex justify-between items-start">
                                <div class="flex-1">${item.name}</div>
                                <div class="font-medium">R$ ${item.price.toFixed(2).replace('.',',')}</div>
                                <button data-index="${index}" class="remove-item-btn text-red-500 ml-4">&times;</button>
                            </div>`;
                }).join('');

                orderItemsContainer.querySelectorAll('.remove-item-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        order.splice(parseInt(e.target.dataset.index), 1);
                        updateOrderDisplay();
                    });
                });
            }

            document.getElementById('subtotal').textContent = `R$ ${subtotal.toFixed(2).replace('.', ',')}`;
            document.getElementById('total').textContent = `R$ ${subtotal.toFixed(2).replace('.', ',')}`;
            updateCartCount();
        }

        function updateCartCount() {
            const count = order.length;
            const cartCountEl = document.getElementById('cartCount');
            if (count > 0) {
                cartCountEl.textContent = count;
                cartCountEl.classList.remove('hidden');
            } else {
                cartCountEl.classList.add('hidden');
            }
        }

    </script>
</body>
</html>

