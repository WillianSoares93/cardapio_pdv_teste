<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Venda Balcão - Sâmia Pizzaria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="https://raw.githubusercontent.com/WillianSoares93/cardapio_samia_PDV/refs/heads/main/logo.png" type="image/png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #DDE2E6;
            visibility: hidden;
            overflow: hidden;
        }
        .main-container {
            display: grid;
            grid-template-columns: 0px 1fr; /* Começa com a barra lateral escondida */
            height: 100vh;
            transition: grid-template-columns 0.3s ease-in-out;
        }
        .main-container.sidebar-open {
            grid-template-columns: 80px 1fr; /* Mostra a barra lateral */
        }
        .main-content {
            display: grid;
            grid-template-columns: 400px 1fr 180px;
            gap: 1rem;
            padding: 1rem;
            height: 100%;
            overflow: hidden;
        }
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
        }
        .product-card {
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.5rem;
            text-align: center;
            background-color: #ffffff;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            aspect-ratio: 1 / 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
        }
        .product-card.unavailable {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #f3f4f6;
        }
         .product-card.unavailable::after {
            content: 'Esgotado';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-15deg);
            background-color: rgba(185, 28, 28, 0.8);
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.875rem;
        }
        .product-card:hover:not(.unavailable) {
            transform: translateY(-4px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border-color: #3b82f6;
        }
        .category-btn {
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
            color: #374151;
            transition: all 0.2s ease-in-out;
        }
        .category-btn.active, .category-btn:hover {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        .sidebar-nav {
            background-color: #2C3E50;
            overflow: hidden;
        }
        .sidebar-btn {
            color: #BDC3C7;
            transition: all 0.2s ease-in-out;
        }
        .sidebar-btn:hover {
            background-color: #34495E;
            color: white;
        }
        .sidebar-btn.active {
            background-color: #3b82f6;
            color: white;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
             background-color: #fff;
             padding: 1.5rem;
             border-radius: 0.5rem;
             box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
             width: 90%;
             max-width: 500px;
        }
        .ingredient-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            border: 1px solid #d1d5db;
            transition: all 0.2s ease-in-out;
        }
        .ingredient-option:hover {
            background-color: #f9fafb;
            border-color: #3b82f6;
        }
        .ingredient-option.selected-ingredient {
            background-color: #dbeafe; /* blue-100 */
            border-color: #3b82f6; /* blue-500 */
        }
        .quantity-btn {
            background-color: #e5e7eb;
            color: #4b5563;
            transition: all 0.2s ease-in-out;
            width: 28px;
            height: 28px;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            font-weight: bold;
        }
        .quantity-btn:hover:not(:disabled) {
            background-color: #d1d5db;
        }
        .half-pizza-selection-active {
            background-color: #fef9c3; /* yellow-100 */
            border: 2px dashed #f59e0b; /* yellow-500 */
        }
        .scope-button {
            transition: all 0.2s ease-in-out;
            padding: 4px 12px;
            border-radius: 9999px;
            background-color: #e5e7eb;
            color: #4b5563;
            font-size: 0.875rem;
        }
        .scope-button.active {
            background-color: #3b82f6;
            color: white;
        }
        .feedback-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #22c55e;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            z-index: 2000;
            font-size: 0.875rem;
            font-weight: 500;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            opacity: 0;
            transition: opacity 0.3s ease-in-out, top 0.3s ease-in-out;
        }
        .payment-option {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .payment-option:hover {
            background-color: #f9fafb;
            border-color: #10b981;
        }
        .payment-option.selected {
            background-color: #e6ffed; /* green-50 */
            border-color: #10b981; /* green-600 */
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
        }
        .payment-option input[type="radio"] {
            margin-right: 12px;
            accent-color: #10b981;
        }
        .payment-option .icon {
            font-size: 1.5rem;
            margin-right: 12px;
            color: #4b5563;
        }
        .payment-option.selected .icon {
            color: #10b981;
        }
        .payment-option .text-content {
            flex-grow: 1;
        }
        .payment-option .text-content h4 {
            font-weight: 600;
            color: #1f2937;
        }
        .payment-option .text-content p {
            font-size: 0.875rem;
            color: #6b7280;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="main-container">
        <!-- Sidebar Vertical Esquerda -->
        <aside class="sidebar-nav flex flex-col justify-between py-4">
            <!-- Main Navigation -->
            <div>
                <a href="pdv.html" class="sidebar-btn w-full flex flex-col items-center p-3 text-xs" title="Painel de Pedidos">
                    <i class="fas fa-receipt fa-2x"></i>
                    <span>PEDIDOS</span>
                </a>
                <a href="atendente.html" target="_blank" class="sidebar-btn w-full flex flex-col items-center p-3 text-xs" title="Lançar Pedido">
                    <i class="fas fa-plus-circle fa-2x"></i>
                    <span>LANÇAR</span>
                </a>
                <a href="venda-balcao.html" class="sidebar-btn active w-full flex flex-col items-center p-3 text-xs" title="Venda Balcão">
                    <i class="fas fa-cash-register fa-2x"></i>
                    <span>BALCÃO</span>
                </a>
                <a href="editar-cardapio.html" class="sidebar-btn w-full flex flex-col items-center p-3 text-xs" title="Editar Cardápio">
                    <i class="fas fa-edit fa-2x"></i>
                    <span>EDITAR</span>
                </a>
                <a href="gerenciar.html" class="sidebar-btn w-full flex flex-col items-center p-3 text-xs" title="Gerenciar Itens">
                    <i class="fas fa-tasks fa-2x"></i>
                    <span>GERENCIAR</span>
                </a>
                <a href="relatorio.html" class="sidebar-btn w-full flex flex-col items-center p-3 text-xs" title="Relatórios">
                    <i class="fas fa-chart-line fa-2x"></i>
                    <span>RELATÓRIOS</span>
                </a>
            </div>
            <!-- Bottom Actions -->
            <div class="space-y-2">
                <!-- CORREÇÃO: Elemento para exibir o usuário logado adicionado -->
                <div class="text-center px-2 py-3 text-xs text-gray-400 overflow-hidden" title="Usuário Logado">
                    <i class="fas fa-user-circle fa-2x mb-1"></i>
                    <span id="current-user" class="block truncate"></span>
                </div>
                <button id="logout-btn" class="sidebar-btn w-full flex flex-col items-center p-3 text-xs" title="Sair">
                    <i class="fas fa-sign-out-alt fa-2x text-red-400"></i>
                    <span class="text-red-400">SAIR</span>
                </button>
            </div>
        </aside>

        <main class="main-content">
            <!-- Coluna da Esquerda: Pedido -->
            <section class="bg-white rounded-lg shadow-md flex flex-col overflow-hidden">
                <div class="flex-shrink-0">
                    <div class="p-4 border-b flex justify-between items-start">
                        <div>
                            <label class="text-sm font-medium text-gray-700 mb-2 block">Tipo de Pedido</label>
                            <div id="order-type-selector" class="flex space-x-4">
                                <label class="flex items-center">
                                    <input type="radio" name="orderType" value="Retirada" checked class="form-radio text-blue-600">
                                    <span class="ml-2">Retirada</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="orderType" value="Delivery" class="form-radio text-blue-600">
                                    <span class="ml-2">Delivery</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="orderType" value="Mesa" class="form-radio text-blue-600">
                                    <span class="ml-2">Mesa</span>
                                </label>
                            </div>
                        </div>
                        <button id="open-client-data-modal-btn" class="px-3 py-2 bg-blue-500 text-white font-bold rounded-md hover:bg-blue-600 text-sm whitespace-nowrap">Dados do Cliente</button>
                    </div>
                    <div id="client-data-summary" class="p-4 border-b hidden bg-blue-50 text-sm text-blue-800">
                        <!-- Summary of client data will go here -->
                    </div>
                </div>

                <div id="order-items-container" class="flex-grow overflow-y-auto p-4 space-y-4">
                     <div id="empty-cart-message" class="text-center text-gray-400 p-10 flex flex-col items-center justify-center h-full">
                        <i class="fas fa-shopping-cart fa-3x mb-4"></i>
                        <p class="font-medium">Carrinho Vazio</p>
                    </div>
                </div>
                
                <div class="flex-shrink-0 p-4 border-t bg-gray-50">
                    <div class="flex justify-between items-center text-gray-600 text-sm">
                        <span>Total de Itens</span>
                        <span id="total-items">0</span>
                    </div>
                     <div id="delivery-fee-summary" class="flex justify-between items-center text-gray-600 text-sm hidden">
                        <span>Taxa de Entrega</span>
                        <span id="delivery-fee-value">R$ 0,00</span>
                    </div>
                    <div class="flex justify-between items-center text-2xl font-bold text-gray-800 mt-2 pt-2 border-t">
                        <span>VALOR A PAGAR</span>
                        <span id="total-value">R$ 0,00</span>
                    </div>
                    <div class="mt-4 grid grid-cols-2 gap-4">
                        <button id="cancel-order-btn" class="w-full py-3 bg-red-600 text-white font-bold rounded-md hover:bg-red-700">Cancelar</button>
                        <button id="finalize-order-btn" class="w-full py-3 bg-green-600 text-white font-bold rounded-md hover:bg-green-700">Finalizar</button>
                    </div>
                </div>
            </section>

            <!-- Coluna do Meio: Produtos -->
            <section id="product-display" class="bg-white rounded-lg shadow-md flex flex-col p-4 overflow-hidden">
                 <div class="mb-4">
                    <input type="text" id="search-product" placeholder="Buscar produto..." class="w-full p-2 border rounded-md">
                </div>
                <div class="product-grid flex-grow overflow-y-auto pr-2" id="product-grid"></div>
            </section>

            <!-- Coluna da Direita: Categorias -->
            <section id="category-list" class="flex flex-col p-0 space-y-2 overflow-y-auto"></section>
        </main>
    </div>
    
    <!-- Modal de Opções de Pizza -->
    <div id="pizza-option-modal" class="modal">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <div class="flex justify-between items-center pb-3 border-b">
                <h3 id="modal-pizza-name" class="text-xl font-bold text-gray-900"></h3>
                <button id="close-pizza-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">&times;</button>
            </div>
            <div id="pizza-size-options" class="mt-4 space-y-2"></div>
        </div>
    </div>

    <!-- Modal de Montagem de Hambúrguer -->
    <div id="burger-builder-modal" class="modal">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl">
            <div class="flex justify-between items-center pb-3 border-b">
                <h3 id="modal-burger-name" class="text-xl font-bold text-gray-900">Monte seu Hambúrguer</h3>
                <button id="close-burger-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">&times;</button>
            </div>
            <div id="burger-ingredients-container" class="mt-4 mb-4 max-h-80 overflow-y-auto p-2 space-y-4"></div>
            <div class="flex justify-between items-center bg-gray-100 p-4 rounded-lg mt-4">
                <span class="text-lg font-bold">Total do Hambúrguer:</span>
                <span id="burger-total-price" class="text-2xl font-bold text-blue-600">R$ 0,00</span>
            </div>
            <div class="mt-6 flex justify-end space-x-4">
                <button id="cancel-burger-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancelar</button>
                <button id="add-custom-burger-btn" class="px-6 py-2 bg-green-600 text-white font-bold rounded-md hover:bg-green-700">Adicionar ao Pedido</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para Adicionais da Pizza -->
    <div id="pizza-extras-builder-modal" class="modal">
         <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl">
            <div class="flex justify-between items-center pb-3 border-b">
                <h3 id="pizza-extras-builder-title" class="text-xl font-bold text-gray-900">Adicionais para a Pizza</h3>
                <button id="close-pizza-extras-builder-modal" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">&times;</button>
            </div>
            <div id="pizza-extras-scope-buttons" class="flex flex-wrap gap-2 my-4 border-b pb-4"></div>
            <div id="pizza-extras-ingredients-container" class="mb-4 max-h-80 overflow-y-auto p-2"></div>
            <div class="flex justify-between items-center bg-gray-100 p-4 rounded-lg mt-4">
                <span class="text-lg font-bold">Total da Pizza:</span>
                <span id="pizza-extras-total-price" class="text-2xl font-bold text-blue-600">R$ 0,00</span>
            </div>
            <div class="mt-6 flex justify-end">
                <button id="add-pizza-with-extras-btn" class="px-6 py-2 bg-green-600 text-white font-bold rounded-md hover:bg-green-700">Confirmar Adicionais</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para perguntar sobre adicionais -->
    <div id="ask-pizza-extras-modal" class="modal">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
             <p class="text-lg font-semibold text-gray-800 mb-4 text-center">Deseja adicionar ingredientes extras?</p>
            <div class="flex justify-center gap-4">
                <button id="ask-extras-no-btn" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-lg font-bold hover:bg-gray-400 transition">Não, obrigado</button>
                <button id="ask-extras-yes-btn" class="px-6 py-2 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 transition">Sim, quero!</button>
            </div>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div id="alert-modal" class="modal">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
             <p id="alert-message" class="text-lg font-semibold text-gray-800 mb-4 text-center">Message goes here.</p>
            <div class="flex justify-center">
                <button id="alert-ok-btn" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition">OK</button>
            </div>
        </div>
    </div>

    <!-- Custom Confirm Modal -->
    <div id="confirm-modal" class="modal">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
             <p id="confirm-message" class="text-lg font-semibold text-gray-800 mb-6 text-center">Are you sure?</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-no-btn" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-lg font-bold hover:bg-gray-400 transition">Não</button>
                <button id="confirm-yes-btn" class="px-6 py-2 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition">Sim</button>
            </div>
        </div>
    </div>

    <!-- Client Data Modal -->
    <div id="client-data-modal" class="modal">
        <div class="modal-content max-h-[90vh] overflow-y-auto">
            
            <!-- HEADER (Fixed) -->
            <div class="flex justify-between items-center pb-3 border-b sticky top-0 bg-white z-20">
                <h3 id="client-modal-title" class="text-xl font-bold text-gray-900">Dados do Cliente e Pagamento</h3>
                <button id="close-client-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">&times;</button>
            </div>
            
            <!-- SCROLLABLE BODY -->
            <div class="pt-4">
                <div id="client-modal-error-message" class="hidden mt-0 p-3 bg-red-100 text-red-700 rounded-md text-sm"></div>
                <div class="mt-4 space-y-4">
                    <!-- Fields for Retirada -->
                    <div id="client-modal-retirada-fields" class="hidden space-y-4">
                        <div>
                            <label for="client-modal-name-retirada" class="text-sm font-medium text-gray-700">Nome do Cliente</label>
                            <input type="text" id="client-modal-name-retirada" class="w-full mt-1 p-2 border rounded-md">
                        </div>
                        <div>
                            <label for="client-modal-contact-retirada" class="text-sm font-medium text-gray-700">Contato (Opcional)</label>
                            <input type="tel" id="client-modal-contact-retirada" class="w-full mt-1 p-2 border rounded-md">
                        </div>
                    </div>
                    <!-- Fields for Delivery -->
                    <div id="client-modal-delivery-fields" class="hidden space-y-4">
                        <div>
                            <label for="client-modal-name-delivery" class="text-sm font-medium text-gray-700">Nome do Cliente</label>
                            <input type="text" id="client-modal-name-delivery" class="w-full mt-1 p-2 border rounded-md">
                        </div>
                        <div>
                            <label for="client-modal-contact-delivery" class="text-sm font-medium text-gray-700">Contato</label>
                            <input type="tel" id="client-modal-contact-delivery" class="w-full mt-1 p-2 border rounded-md">
                        </div>
                        <div>
                            <label for="client-modal-street" class="text-sm font-medium text-gray-700">Rua</label>
                            <input type="text" id="client-modal-street" class="w-full mt-1 p-2 border rounded-md">
                        </div>
                        <div>
                            <label for="client-modal-number" class="text-sm font-medium text-gray-700">Número</label>
                            <input type="text" id="client-modal-number" class="w-full mt-1 p-2 border rounded-md">
                        </div>
                        <div>
                            <label for="client-modal-neighborhood" class="text-sm font-medium text-gray-700">Bairro</label>
                            <select id="client-modal-neighborhood" class="w-full mt-1 p-2 border rounded-md"></select>
                        </div>
                    </div>
                    <!-- Fields for Mesa -->
                    <div id="client-modal-mesa-fields" class="hidden space-y-4">
                        <div>
                            <label for="client-modal-table-select" class="text-sm font-medium text-gray-700">Selecionar Mesa Livre</label>
                            <select id="client-modal-table-select" class="w-full mt-1 p-2 border rounded-md"></select>
                        </div>
                        <div>
                            <label for="client-modal-name-mesa" class="text-sm font-medium text-gray-700">Nome do Cliente (Opcional)</label>
                            <input type="text" id="client-modal-name-mesa" class="w-full mt-1 p-2 border rounded-md">
                        </div>
                    </div>
                    <!-- Observation Field for all -->
                     <div class="mt-4">
                        <label for="client-modal-observation" class="text-sm font-medium text-gray-700">Observação (Geral)</label>
                        <textarea id="client-modal-observation" rows="2" class="w-full mt-1 p-2 border rounded-md"></textarea>
                    </div>

                    <!-- Payment Method Fields (NEW SECTION) -->
                    <div class="pt-4 border-t border-gray-200">
                        <h4 class="text-md font-bold text-gray-800 mb-3">Forma de Pagamento</h4>
                        <div id="payment-options-container" class="flex flex-col gap-2">
                            <label class="payment-option selected" data-method="Dinheiro">
                                <input type="radio" name="modalPaymentMethod" value="Dinheiro" class="form-radio" checked>
                                <i class="fas fa-money-bill-wave icon"></i>
                                <div class="text-content">
                                    <h4>Dinheiro</h4>
                                </div>
                            </label>
                            <label class="payment-option" data-method="Cartão de Crédito/Débito">
                                <input type="radio" name="modalPaymentMethod" value="Cartão de Crédito/Débito" class="form-radio">
                                <i class="fas fa-credit-card icon"></i>
                                <div class="text-content">
                                    <h4>Cartão de Crédito/Débito</h4>
                                </div
                            ></label>
                            <label class="payment-option" data-method="Pix">
                                <input type="radio" name="modalPaymentMethod" value="Pix" class="form-radio">
                                <i class="fas fa-qrcode icon"></i>
                                <div class="text-content">
                                    <h4>Pix</h4>
                                </div>
                            </label>
                            <label class="payment-option" data-method="A Definir">
                                <input type="radio" name="modalPaymentMethod" value="A Definir" class="form-radio">
                                <i class="fas fa-question-circle icon"></i>
                                <div class="text-content">
                                    <h4>A Definir</h4>
                                </div>
                            </label>
                        </div>

                        <div id="troco-input-container" class="mt-4 p-3 border border-gray-300 rounded-lg bg-gray-50">
                            <label for="modal-trocoPara" class="block text-gray-700 text-sm font-medium mb-2">
                                Troco para (R$):
                            </label>
                            <input type="number" id="modal-trocoPara" step="0.01" min="0" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none mb-2" placeholder="0,00">
                            <p class="text-gray-600 text-sm">
                                Troco: <span id="modal-trocoTotalDisplay" class="font-bold text-green-600">R$ 0,00</span>
                            </p>
                        </div>
                    </div>
                </div>
            <!-- END OF SCROLLABLE BODY -->
            <div class="mt-6 flex justify-end space-x-4">
                <button id="cancel-client-data-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancelar</button>
                <button id="confirm-client-data-btn" class="px-6 py-2 bg-green-600 text-white font-bold rounded-md hover:bg-green-700">Confirmar e Finalizar</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, doc, onSnapshot, query, getDocs, deleteDoc, where, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        const firebaseConfig = {
           apiKey: "AIzaSyBJ44RVDGhBIlQBTx-pyIUp47XDKzRXk84",
           authDomain: "pizzaria-pdv.firebaseapp.com",
           projectId: "pizzaria-pdv",
           storageBucket: "pizzaria-pdv.firebasestorage.app",
           messagingSenderId: "304171744691",
           appId: "1:304171744691:web:e54d7f9fe55c7a75485fc6"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let allItems = [];
        let allIngredients = {};
        let allPizzaExtras = {};
        let allDeliveryFees = [];
        let order = [];
        let currentUserEmail = '';
        let currentOrderType = 'Retirada';
        let clientData = { name: null, contact: null, address: null, table: null, observation: null };
        let paymentMethod = null; 
        let pauseTime = 2000; 
        let initialUrlParamCheckDone = false; 

        // NOVA LÓGICA DE EDIÇÃO
        let currentOrderId = null;
        let isEditing = false;

        let itemStatus = {}, itemVisibility = {}, itemExtrasStatus = {}, pizzaHalfStatus = {};
        let ingredientStatus = {}, ingredientVisibility = {};
        let extraStatus = {}, extraVisibility = {};

        let isSelectingHalfPizza = false;
        let firstHalfPizza = null;
        let currentPizzaExtrasState = {};
        const NUMERO_DE_MESAS = 12;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.body.style.visibility = 'visible';
                currentUserEmail = user.email;
                const currentUserEl = document.getElementById('current-user');
                if (currentUserEl) {
                    currentUserEl.textContent = currentUserEmail;
                }
                initializeAppLogic();
            } else {
                window.location.href = 'login.html?redirect=venda-balcao.html';
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        function showAlert(message) {
            const modal = document.getElementById('alert-modal');
            const messageEl = document.getElementById('alert-message');
            const okBtn = document.getElementById('alert-ok-btn');

            messageEl.textContent = message;
            modal.style.display = 'flex';

            const closeHandler = () => {
                modal.style.display = 'none';
            };

            const modalCloseHandler = (e) => {
                if (e.target === modal) {
                    closeHandler();
                }
            };
            
            okBtn.addEventListener('click', closeHandler, { once: true });
            modal.addEventListener('click', modalCloseHandler);
        }

        function showTemporaryFeedback(message) {
            const feedbackEl = document.createElement('div');
            feedbackEl.className = 'feedback-toast';
            feedbackEl.textContent = message;
            document.body.appendChild(feedbackEl);

            setTimeout(() => {
                feedbackEl.style.top = '30px';
                feedbackEl.style.opacity = '1';
            }, 100);

            setTimeout(() => {
                feedbackEl.style.opacity = '0';
                feedbackEl.style.top = '10px';
                setTimeout(() => feedbackEl.remove(), 300);
            }, pauseTime);
        }

        function showConfirm(message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirm-modal');
                const messageEl = document.getElementById('confirm-message');
                const yesBtn = document.getElementById('confirm-yes-btn');
                const noBtn = document.getElementById('confirm-no-btn');

                messageEl.textContent = message;
                modal.style.display = 'flex';

                const close = (result) => {
                    modal.style.display = 'none';
                    yesBtn.removeEventListener('click', yesHandler);
                    noBtn.removeEventListener('click', noHandler);
                    modal.removeEventListener('click', modalCloseHandler);
                    resolve(result);
                };

                const yesHandler = () => close(true);
                const noHandler = () => close(false);
                 const modalCloseHandler = (e) => {
                    if (e.target === modal) {
                        close(false);
                    }
                };

                yesBtn.addEventListener('click', yesHandler, { once: true });
                noBtn.addEventListener('click', noHandler, { once: true });
                modal.addEventListener('click', modalCloseHandler);
            });
        }


        async function initializeAppLogic() {
            listenToStatusChanges();
            await fetchMenu();
            renderCategories();
            renderProducts();
            setupEventListeners();
            listenToTableStatus();
            
            // LÓGICA DE EDIÇÃO: Verifica se há um ID de pedido na URL
            const urlParams = new URLSearchParams(window.location.search);
            const orderIdFromUrl = urlParams.get('orderId');
            if (orderIdFromUrl) {
                loadOrderForEditing(orderIdFromUrl);
            }
        }
        
        // NOVA FUNÇÃO: Carrega um pedido existente para edição
        async function loadOrderForEditing(orderId) {
            isEditing = true;
            currentOrderId = orderId;

            try {
                const orderRef = doc(db, "pedidos", orderId);
                const docSnap = await getDoc(orderRef);

                if (docSnap.exists()) {
                    const orderData = docSnap.data();
                    order = orderData.itens || [];
                    paymentMethod = orderData.pagamento || null;

                    if (orderData.endereco.rua === "Mesa") {
                        currentOrderType = 'Mesa';
                        document.querySelector('input[name="orderType"][value="Mesa"]').checked = true;
                        
                        const mesaText = orderData.endereco.clientName || '';
                        clientData.table = mesaText.match(/\d+/)?.[0]; // Pega o número da mesa
                        const clientNameMatch = mesaText.match(/\((.*?)\)/); // Pega o nome entre parênteses
                        clientData.name = clientNameMatch ? clientNameMatch[1] : '';
                    
                    } else if (orderData.endereco.rua === "Retirada no Balcão") {
                        currentOrderType = 'Retirada';
                        document.querySelector('input[name="orderType"][value="Retirada"]').checked = true;
                        clientData.name = orderData.endereco.clientName;
                        clientData.contact = orderData.endereco.telefone;
                    } else {
                        currentOrderType = 'Delivery';
                        document.querySelector('input[name="orderType"][value="Delivery"]').checked = true;
                        clientData.name = orderData.endereco.clientName;
                        clientData.contact = orderData.endereco.telefone;
                        clientData.address = {
                            street: orderData.endereco.rua,
                            number: orderData.endereco.numero,
                            neighborhood: orderData.endereco.bairro,
                            deliveryFee: orderData.total.deliveryFee || 0
                        };
                    }
                    clientData.observation = orderData.observacao || '';

                    document.title = `Editando Pedido #${orderId.substring(0, 5)}`;
                    document.getElementById('finalize-order-btn').textContent = 'Atualizar Pedido';
                    document.getElementById('cancel-order-btn').textContent = 'Fechar';
                    
                    updateOrderDisplay();
                    updateClientDataSummary();
                    showTemporaryFeedback('Pedido carregado para edição.');
                } else {
                    showAlert('Erro: Pedido não encontrado. Esta janela pode ser fechada.');
                    document.getElementById('finalize-order-btn').disabled = true;
                }
            } catch (error) {
                console.error("Erro ao carregar pedido para edição:", error);
                showAlert(`Ocorreu um erro ao carregar o pedido: ${error.message}`);
                document.getElementById('finalize-order-btn').disabled = true;
            }
        }


        function listenToTableStatus() {
            const q = query(collection(db, "pedidos"));
            onSnapshot(q, (snapshot) => {
                const activeOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateTableSelector(activeOrders);
            });
        }

        function updateTableSelector(activeOrders) {
            const tableSelector = document.getElementById('client-modal-table-select');
            const occupiedTables = new Set();
            const allGroupedTables = new Set();

            activeOrders
                .filter(order => order.status !== 'Finalizado' && order.itens && order.itens.length > 0)
                .forEach(order => {
                    const tableNumbers = order.grupoMesas && order.grupoMesas.length > 0
                        ? order.grupoMesas
                        : [parseInt((order.endereco.clientName || "").replace(/[^0-9]/g, ''))];
                    
                    tableNumbers.forEach(num => num && occupiedTables.add(num));
                });

            const emptyGroups = activeOrders.filter(order =>
                order.grupoMesas && order.grupoMesas.length > 0 &&
                (!order.itens || order.itens.length === 0)
            );
            emptyGroups.forEach(order => order.grupoMesas.forEach(tableNum => allGroupedTables.add(tableNum)));
            
            tableSelector.innerHTML = '<option value="">Selecione uma mesa...</option>';

            emptyGroups.forEach(groupOrder => {
                const sortedGroup = groupOrder.grupoMesas.sort((a, b) => a - b);
                const option = document.createElement('option');
                option.value = `group_${groupOrder.id}`; // Special value format
                option.textContent = `Mesas ${sortedGroup.join(' + ')}`;
                tableSelector.appendChild(option);
            });

            for (let i = 1; i <= NUMERO_DE_MESAS; i++) {
                if (!allGroupedTables.has(i)) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `Mesa ${i.toString().padStart(2, '0')}`;
                     if (occupiedTables.has(i) && String(i) !== clientData.table) { // Don't disable the currently edited table
                        option.disabled = true;
                        option.textContent += ' (Ocupada)';
                    }
                    tableSelector.appendChild(option);
                }
            }

            if (!initialUrlParamCheckDone) {
                initialUrlParamCheckDone = true; 
                const urlParams = new URLSearchParams(window.location.search);
                const mesaParam = urlParams.get('mesa');
                if (mesaParam && !isEditing) {
                    const mesaRadio = document.querySelector('input[name="orderType"][value="Mesa"]');
                    if (mesaRadio) {
                        mesaRadio.checked = true;
                        currentOrderType = 'Mesa';
                        clientData.table = mesaParam;
                        updateClientDataSummary();
                    }
                }
            }
        }

        function setupPaymentModalListeners() {
            // ... (código existente sem alterações) ...
        }

        function listenToStatusChanges() {
            // ... (código existente sem alterações) ...
        }

        async function fetchMenu() {
            // ... (código existente sem alterações) ...
        }
        
        function populateNeighborhoods() {
            // ... (código existente sem alterações) ...
        }
        
        function capitalizeFirstLetter(string) {
            // ... (código existente sem alterações) ...
        }

        function formatCategoryName(category) {
            // ... (código existente sem alterações) ...
        }

        function renderCategories() {
            // ... (código existente sem alterações) ...
        }

        function renderProducts() {
            // ... (código existente sem alterações) ...
        }
        
        function handleProductSelection(product) {
            // ... (código existente sem alterações) ...
        }
        
        function addToOrder(product) {
            // ... (código existente sem alterações) ...
        }

        function openPizzaOptionsModal(pizza) {
            // ... (código existente sem alterações) ...
        }
        
        function openBurgerBuilderModal(burger, editIndex = null, existingItem = null) {
            // ... (código existente sem alterações) ...
        }
        
        function updateBurgerPrice() {
            // ... (código existente sem alterações) ...
        }

        function addCustomBurgerToOrder(editIndex = null) {
            // ... (código existente sem alterações) ...
        }

        function openPizzaExtrasBuilderModal(uniqueId) {
            // ... (código existente sem alterações) ...
        }
        
        function renderPizzaExtrasList(orderIndex) {
            // ... (código existente sem alterações) ...
        }

        function updatePizzaExtrasPrice(orderIndex) {
            // ... (código existente sem alterações) ...
        }
        
        function confirmPizzaExtras() {
            // ... (código existente sem alterações) ...
        }

        function updateOrderDisplay() {
            // ... (código existente sem alterações) ...
        }
        
        async function setupEventListeners() {
            // ... (código existente sem alterações) ...
            
            document.getElementById('cancel-order-btn').addEventListener('click', async () => {
                // ALTERAÇÃO: Se estiver editando, apenas fecha a janela.
                if (isEditing) {
                    window.close();
                    return;
                }
                
                if (order.length > 0 || clientData.name || clientData.table) {
                    const confirmed = await showConfirm('Deseja cancelar o pedido atual e limpar os dados do cliente?');
                    if (confirmed) {
                        order = [];
                        clientData = { name: null, contact: null, address: null, table: null, observation: null };
                        paymentMethod = null;
                        isSelectingHalfPizza = false;
                        firstHalfPizza = null;
                        document.getElementById('product-display').classList.remove('half-pizza-selection-active');
                        updateOrderDisplay();
                        updateClientDataSummary();
                        document.getElementById('client-modal-table-select').value = '';
                    }
                }
            });
            
            // ... (restante do código da função existente) ...
        }
        
        function handleBurgerIngredientClick(e) {
            // ... (código existente sem alterações) ...
        }

        function handlePizzaExtrasIngredientClick(e) {
            // ... (código existente sem alterações) ...
        }
        
        function openClientDataModal() {
            // ... (código existente sem alterações) ...
        }
        
        function calculateTroco() {
            // ... (código existente sem alterações) ...
        }

        async function confirmClientData() {
            if (order.length === 0) {
                showAlert("O carrinho está vazio.");
                return;
            }
            
            const errorDiv = document.getElementById('client-modal-error-message');
            errorDiv.classList.add('hidden');
            
            let currentClientData = {};
            
            if (currentOrderType === 'Retirada') {
                currentClientData.name = document.getElementById('client-modal-name-retirada').value.trim();
                currentClientData.contact = document.getElementById('client-modal-contact-retirada').value.trim();
                if (!currentClientData.name) {
                    errorDiv.textContent = "Para Retirada, o nome do cliente é obrigatório.";
                    errorDiv.classList.remove('hidden');
                    return;
                }
            } else if (currentOrderType === 'Delivery') {
                currentClientData.name = document.getElementById('client-modal-name-delivery').value.trim();
                currentClientData.contact = document.getElementById('client-modal-contact-delivery').value.trim();
                const street = document.getElementById('client-modal-street').value.trim();
                const number = document.getElementById('client-modal-number').value.trim();
                const neighborhood = document.getElementById('client-modal-neighborhood').value;
                if (!currentClientData.name || !currentClientData.contact || !street || !number || !neighborhood) {
                    errorDiv.textContent = "Para Delivery, todos os campos são obrigatórios (Nome, Contato, Endereço).";
                    errorDiv.classList.remove('hidden');
                    return;
                }
                const selectedFee = allDeliveryFees.find(fee => fee.neighborhood === neighborhood);
                currentClientData.address = { 
                    street, 
                    number, 
                    neighborhood, 
                    deliveryFee: selectedFee ? selectedFee.deliveryFee : 0 
                };
            } else { // Mesa
                currentClientData.table = document.getElementById('client-modal-table-select').value;
                currentClientData.name = document.getElementById('client-modal-name-mesa').value.trim();
                if (!currentClientData.table) {
                    errorDiv.textContent = "O número da mesa é obrigatório.";
                    errorDiv.classList.remove('hidden');
                    return;
                }
            }
            
            currentClientData.observation = document.getElementById('client-modal-observation').value.trim();

            const selectedPaymentRadio = document.querySelector('input[name="modalPaymentMethod"]:checked');
            if (!selectedPaymentRadio) {
                errorDiv.textContent = "Selecione uma forma de pagamento.";
                errorDiv.classList.remove('hidden');
                return;
            }
            
            const method = selectedPaymentRadio.value;
            let finalPaymentData;
            const totalValue = order.reduce((sum, item) => sum + item.price, 0) + (currentOrderType === 'Delivery' && currentClientData.address ? currentClientData.address.deliveryFee : 0);

            if (method === 'Dinheiro') {
                const trocoPara = parseFloat(document.getElementById('modal-trocoPara').value.replace(',', '.')) || 0;
                if (totalValue > 0 && trocoPara > 0 && trocoPara < totalValue) {
                    errorDiv.textContent = `O valor para troco (R$ ${trocoPara.toFixed(2).replace('.', ',')}) não pode ser menor que o total (R$ ${totalValue.toFixed(2).replace('.', ',')}).`;
                    errorDiv.classList.remove('hidden');
                    return;
                } else if (totalValue > 0 && trocoPara === 0) {
                     errorDiv.textContent = `Por favor, insira o valor para troco ou um valor igual ao total.`;
                     errorDiv.classList.remove('hidden');
                     return;
                }
                const trocoTotal = trocoPara > 0 ? trocoPara - totalValue : 0;
                finalPaymentData = { method: 'Dinheiro', trocoPara: trocoPara, trocoTotal: trocoTotal };
            } else {
                finalPaymentData = method;
            }

            clientData = currentClientData;
            paymentMethod = finalPaymentData;

            document.getElementById('client-data-modal').style.display = 'none';
            updateClientDataSummary();
            updateOrderDisplay();
            
            await finalizeOrder();
        }

        function updateClientDataSummary() {
            // ... (código existente sem alterações) ...
        }

        function finalizeOrderCheck() {
            // ... (código existente sem alterações) ...
        }

        async function finalizeOrder() {
            if(order.length === 0) {
                showAlert("O carrinho está vazio.");
                return;
            }
            
            let isMesaGroupUpdate = false;
            if (isEditing) {
                // No need to re-validate, data is already loaded.
            } else {
                 if ( (currentOrderType === 'Mesa' && !clientData.table) || 
                     (currentOrderType === 'Retirada' && !clientData.name) || 
                     (currentOrderType === 'Delivery' && (!clientData.name || !clientData.address)) ||
                     (!paymentMethod) ) 
                {
                    showAlert("Dados do cliente ou forma de pagamento incompletos. Tente novamente.");
                    return;
                }
                
                if (currentOrderType === 'Mesa' && clientData.table && clientData.table.startsWith('group_')) {
                    isMesaGroupUpdate = true;
                }
            }


            let subtotal = order.reduce((sum, item) => sum + item.price, 0);
            let deliveryFee = 0;
            let endereco = {};
            let status = 'Novo'; 

            if(currentOrderType === 'Delivery') {
                deliveryFee = clientData.address.deliveryFee;
                endereco = { 
                    clientName: clientData.name, 
                    telefone: clientData.contact, 
                    rua: clientData.address.street, 
                    numero: clientData.address.number, 
                    bairro: clientData.address.neighborhood 
                };
            } else if (currentOrderType === 'Mesa') {
                let clientNameForOrder = `Mesa ${clientData.table}`;
                if (clientData.name) {
                    clientNameForOrder += ` (${clientData.name})`;
                }
                endereco = { clientName: clientNameForOrder, rua: 'Mesa' };
                status = 'Em Preparo';
            } else { // Retirada
                endereco = { 
                    clientName: clientData.name || 'Cliente Balcão', 
                    telefone: clientData.contact, 
                    rua: 'Retirada no Balcão' 
                };
            }
            
            const cleanedItems = JSON.parse(JSON.stringify(order, (key, value) => {
                const fieldsToExclude = ['originalItem', 'uniqueId', 'firstHalfData', 'secondHalfData', 'acceptsExtras'];
                if (fieldsToExclude.includes(key)) return undefined;
                return value;
            }));
            
            const finalTotal = subtotal + deliveryFee;

            try {
                if (isEditing && currentOrderId) {
                    const orderRef = doc(db, "pedidos", currentOrderId);
                    await updateDoc(orderRef, {
                        itens: cleanedItems,
                        endereco: endereco,
                        total: { subtotal, finalTotal, deliveryFee, discount: 0 },
                        pagamento: paymentMethod,
                        observacao: clientData.observation || `Pedido atualizado por ${currentUserEmail}`
                    });

                    showTemporaryFeedback(`Pedido #${currentOrderId.substring(0,5)} atualizado com sucesso!`);
                    setTimeout(() => window.close(), 1500);

                } else if (isMesaGroupUpdate) {
                    const orderIdToUpdate = clientData.table.replace('group_', '');
                    const orderRef = doc(db, "pedidos", orderIdToUpdate);
                    await updateDoc(orderRef, {
                        itens: cleanedItems,
                        total: { subtotal: subtotal, finalTotal: subtotal, deliveryFee: 0, discount: 0 },
                        pagamento: paymentMethod,
                        status: 'Em Preparo',
                        observacao: clientData.observation || `Venda de balcão por ${currentUserEmail}`
                    });
                    showTemporaryFeedback(`Itens adicionados às Mesas Agrupadas!`);
                    resetOrderState();
                } else {
                    const newOrder = {
                        itens: cleanedItems,
                        endereco: endereco,
                        total: { subtotal, finalTotal, deliveryFee, discount: 0 },
                        pagamento: paymentMethod,
                        status: status,
                        criadoEm: serverTimestamp(),
                        observacao: clientData.observation || `Venda de balcão por ${currentUserEmail}`
                    };
                    await addDoc(collection(db, "pedidos"), newOrder);
                    showTemporaryFeedback(`Pedido para ${clientData.name || `Mesa ${clientData.table}`} finalizado com sucesso!`);
                    resetOrderState();
                }
            } catch (error) {
                console.error("Erro ao finalizar/atualizar pedido:", error);
                showAlert("Falha ao processar o pedido. Tente novamente.");
            }
        }
        
        function resetOrderState() {
            order = [];
            clientData = { name: null, contact: null, address: null, table: null, observation: null };
            paymentMethod = null;
            updateOrderDisplay();
            updateClientDataSummary();
        }

    </script>
</body>
</html>
