<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Venda Balcão - Sâmia Pizzaria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="https://raw.githubusercontent.com/WillianSoares93/cardapio_samia_PDV/refs/heads/main/logo.png" type="image/png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #DDE2E6;
            visibility: hidden;
            overflow: hidden;
        }
        .main-container {
            display: grid;
            grid-template-columns: 80px 1fr;
            height: calc(100vh - 57px);
        }
        .main-content {
            display: grid;
            grid-template-columns: 400px 1fr 180px;
            gap: 1rem;
            padding: 1rem;
            height: 100%;
            overflow: hidden;
        }
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
        }
        .product-card {
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.5rem;
            text-align: center;
            background-color: #ffffff;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            aspect-ratio: 1 / 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
        }
        .product-card.unavailable {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #f3f4f6;
        }
         .product-card.unavailable::after {
            content: 'Esgotado';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-15deg);
            background-color: rgba(185, 28, 28, 0.8);
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.875rem;
        }
        .product-card:hover:not(.unavailable) {
            transform: translateY(-4px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border-color: #3b82f6;
        }
        .product-card img {
            max-height: 50px;
            object-fit: contain;
            margin: 0.5rem auto;
        }
        .category-btn {
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
            color: #374151;
            transition: all 0.2s ease-in-out;
        }
        .category-btn.active, .category-btn:hover {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        .sidebar-nav {
            background-color: #2C3E50;
        }
        .sidebar-btn {
            color: #BDC3C7;
            transition: all 0.2s ease-in-out;
        }
        .sidebar-btn:hover {
            background-color: #34495E;
            color: white;
        }
        .sidebar-btn.active {
            background-color: #3b82f6;
            color: white;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .ingredient-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            border: 1px solid #d1d5db;
            transition: all 0.2s ease-in-out;
        }
        .ingredient-option:hover {
            background-color: #f9fafb;
            border-color: #3b82f6;
        }
        .ingredient-option.selected-ingredient {
            background-color: #dbeafe; /* blue-100 */
            border-color: #3b82f6; /* blue-500 */
        }
        .quantity-btn {
            background-color: #e5e7eb;
            color: #4b5563;
            transition: all 0.2s ease-in-out;
            width: 28px;
            height: 28px;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            font-weight: bold;
        }
        .quantity-btn:hover:not(:disabled) {
            background-color: #d1d5db;
        }
        .half-pizza-selection-active {
            background-color: #fef9c3; /* yellow-100 */
            border: 2px dashed #f59e0b; /* yellow-500 */
        }
        .scope-button {
            transition: all 0.2s ease-in-out;
            padding: 4px 12px;
            border-radius: 9999px;
            background-color: #e5e7eb;
            color: #4b5563;
            font-size: 0.875rem;
        }
        .scope-button.active {
            background-color: #3b82f6;
            color: white;
        }
    </style>
</head>
<body class="h-screen flex flex-col">

    <header class="bg-white shadow-sm z-10">
        <div class="max-w-full mx-auto px-4 py-3 flex justify-between items-center">
             <div class="flex items-center space-x-4">
                <i class="fas fa-bars text-xl text-gray-600"></i>
                <h1 class="text-xl font-bold text-gray-800">VENDA BALCÃO</h1>
            </div>
            <div class="flex items-center space-x-4">
                <span id="current-user" class="text-sm font-medium text-gray-600"></span>
                <a href="pdv.html" class="px-3 py-2 bg-gray-600 text-white text-xs font-bold rounded-md hover:bg-gray-700">PAINEL PDV</a>
                <button id="logout-btn" class="px-3 py-2 bg-red-600 text-white text-xs font-bold rounded-md hover:bg-red-700">SAIR</button>
            </div>
        </div>
    </header>

    <div class="main-container">
        <!-- Sidebar Vertical Esquerda -->
        <aside class="sidebar-nav flex flex-col items-center py-4 space-y-4">
            <a href="#" class="sidebar-btn w-full flex flex-col items-center p-3 text-xs">
                <i class="fas fa-motorcycle fa-2x"></i>
                <span>DELIVERY</span>
            </a>
            <a href="#" class="sidebar-btn w-full flex flex-col items-center p-3 text-xs">
                <i class="fas fa-utensils fa-2x"></i>
                <span>MESAS</span>
            </a>
             <a href="#" class="sidebar-btn w-full flex flex-col items-center p-3 text-xs">
                <i class="fas fa-file-invoice fa-2x"></i>
                <span>COMANDAS</span>
            </a>
            <a href="#" class="sidebar-btn active w-full flex flex-col items-center p-3 text-xs">
                <i class="fas fa-cash-register fa-2x"></i>
                <span>BALCÃO</span>
            </a>
        </aside>

        <main class="main-content">
            <!-- Coluna da Esquerda: Pedido -->
            <section class="bg-white rounded-lg shadow-md flex flex-col">
                <div class="p-4 border-b">
                    <label for="client-name" class="text-sm font-medium text-gray-700">Cliente Padrão</label>
                    <input type="text" id="client-name" class="w-full p-2 border rounded-md mt-1" value="Cliente Balcão">
                </div>
                <div class="flex-grow overflow-y-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="p-2 text-left font-medium text-gray-600">Produto</th>
                                <th class="p-2 text-center font-medium text-gray-600 w-20">Qtd</th>
                                <th class="p-2 text-right font-medium text-gray-600 w-24">Subtotal</th>
                                <th class="p-2 w-10"></th>
                            </tr>
                        </thead>
                        <tbody id="order-items-table"></tbody>
                    </table>
                     <div id="empty-cart-message" class="text-center text-gray-400 p-10 flex flex-col items-center justify-center h-full">
                        <i class="fas fa-shopping-cart fa-3x mb-4"></i>
                        <p class="font-medium">Carrinho Vazio</p>
                    </div>
                </div>
                <div class="p-4 border-t bg-gray-50">
                    <div class="flex justify-between items-center text-gray-600 text-sm">
                        <span>Total de Itens</span>
                        <span id="total-items">0</span>
                    </div>
                    <div class="flex justify-between items-center text-2xl font-bold text-gray-800 mt-2 pt-2 border-t">
                        <span>VALOR A PAGAR</span>
                        <span id="total-value">R$ 0,00</span>
                    </div>
                    <div class="mt-4 grid grid-cols-2 gap-4">
                        <button id="cancel-order-btn" class="w-full py-3 bg-red-600 text-white font-bold rounded-md hover:bg-red-700">Cancelar</button>
                        <button id="finalize-order-btn" class="w-full py-3 bg-green-600 text-white font-bold rounded-md hover:bg-green-700">Finalizar</button>
                    </div>
                </div>
            </section>

            <!-- Coluna do Meio: Produtos -->
            <section id="product-display" class="bg-white rounded-lg shadow-md flex flex-col p-4 overflow-hidden">
                 <div class="mb-4">
                    <input type="text" id="search-product" placeholder="Buscar produto..." class="w-full p-2 border rounded-md">
                </div>
                <div class="product-grid flex-grow overflow-y-auto pr-2" id="product-grid"></div>
            </section>

            <!-- Coluna da Direita: Categorias -->
            <section id="category-list" class="flex flex-col p-0 space-y-2 overflow-y-auto"></section>
        </main>
    </div>
    
    <!-- Modal de Opções de Pizza -->
    <div id="pizza-option-modal" class="modal">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <div class="flex justify-between items-center pb-3 border-b">
                <h3 id="modal-pizza-name" class="text-xl font-bold text-gray-900"></h3>
                <button id="close-pizza-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">&times;</button>
            </div>
            <div id="pizza-size-options" class="mt-4 space-y-2"></div>
        </div>
    </div>

    <!-- Modal de Montagem de Hambúrguer -->
    <div id="burger-builder-modal" class="modal">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl">
            <div class="flex justify-between items-center pb-3 border-b">
                <h3 id="modal-burger-name" class="text-xl font-bold text-gray-900">Monte seu Hambúrguer</h3>
                <button id="close-burger-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">&times;</button>
            </div>
            <div id="burger-ingredients-container" class="mt-4 mb-4 max-h-80 overflow-y-auto p-2 space-y-4"></div>
            <div class="flex justify-between items-center bg-gray-100 p-4 rounded-lg mt-4">
                <span class="text-lg font-bold">Total do Hambúrguer:</span>
                <span id="burger-total-price" class="text-2xl font-bold text-blue-600">R$ 0,00</span>
            </div>
            <div class="mt-6 flex justify-end space-x-4">
                <button id="cancel-burger-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancelar</button>
                <button id="add-custom-burger-btn" class="px-6 py-2 bg-green-600 text-white font-bold rounded-md hover:bg-green-700">Adicionar ao Pedido</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para Adicionais da Pizza -->
    <div id="pizza-extras-builder-modal" class="modal">
         <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl">
            <div class="flex justify-between items-center pb-3 border-b">
                <h3 id="pizza-extras-builder-title" class="text-xl font-bold text-gray-900">Adicionais para a Pizza</h3>
                <button id="close-pizza-extras-builder-modal" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">&times;</button>
            </div>
            <div id="pizza-extras-scope-buttons" class="flex flex-wrap gap-2 my-4 border-b pb-4"></div>
            <div id="pizza-extras-ingredients-container" class="mb-4 max-h-80 overflow-y-auto p-2"></div>
            <div class="flex justify-between items-center bg-gray-100 p-4 rounded-lg mt-4">
                <span class="text-lg font-bold">Total da Pizza:</span>
                <span id="pizza-extras-total-price" class="text-2xl font-bold text-blue-600">R$ 0,00</span>
            </div>
            <div class="mt-6 flex justify-end">
                <button id="add-pizza-with-extras-btn" class="px-6 py-2 bg-green-600 text-white font-bold rounded-md hover:bg-green-700">Confirmar Adicionais</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para perguntar sobre adicionais -->
    <div id="ask-pizza-extras-modal" class="modal">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
             <p class="text-lg font-semibold text-gray-800 mb-4 text-center">Deseja adicionar ingredientes extras?</p>
            <div class="flex justify-center gap-4">
                <button id="ask-extras-no-btn" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-lg font-bold hover:bg-gray-400 transition">Não, obrigado</button>
                <button id="ask-extras-yes-btn" class="px-6 py-2 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 transition">Sim, quero!</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = {
           apiKey: "AIzaSyBJ44RVDGhBIlQBTx-pyIUp47XDKzRXk84",
           authDomain: "pizzaria-pdv.firebaseapp.com",
           projectId: "pizzaria-pdv",
           storageBucket: "pizzaria-pdv.firebasestorage.app",
           messagingSenderId: "304171744691",
           appId: "1:304171744691:web:e54d7f9fe55c7a75485fc6"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let allItems = [];
        let allIngredients = {};
        let allPizzaExtras = {};
        let order = [];
        let currentUserEmail = '';

        let itemStatus = {}, itemVisibility = {}, itemExtrasStatus = {}, pizzaHalfStatus = {};
        let ingredientStatus = {}, ingredientVisibility = {};
        let extraStatus = {}, extraVisibility = {};

        let isSelectingHalfPizza = false;
        let firstHalfPizza = null;
        let currentPizzaExtrasState = {};

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.body.style.visibility = 'visible';
                currentUserEmail = user.email;
                document.getElementById('current-user').textContent = currentUserEmail;
                initializeAppLogic();
            } else {
                window.location.href = 'login.html?redirect=venda-balcao.html';
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        async function initializeAppLogic() {
            listenToStatusChanges();
            await fetchMenu();
            renderCategories();
            renderProducts();
            setupEventListeners();
        }

        function listenToStatusChanges() {
            onSnapshot(doc(db, "config", "item_status"), (doc) => { itemStatus = doc.exists() ? doc.data() : {}; renderProducts(); });
            onSnapshot(doc(db, "config", "item_visibility"), (doc) => { itemVisibility = doc.exists() ? doc.data() : {}; renderProducts(); });
            onSnapshot(doc(db, "config", "item_extras_status"), (doc) => { itemExtrasStatus = doc.exists() ? doc.data() : {}; });
            onSnapshot(doc(db, "config", "pizza_half_status"), (doc) => { pizzaHalfStatus = doc.exists() ? doc.data() : {}; });
            onSnapshot(doc(db, "config", "ingredient_status"), (doc) => { ingredientStatus = doc.exists() ? doc.data() : {}; });
            onSnapshot(doc(db, "config", "ingredient_visibility"), (doc) => { ingredientVisibility = doc.exists() ? doc.data() : {}; });
            onSnapshot(doc(db, "config", "extra_status"), (doc) => { extraStatus = doc.exists() ? doc.data() : {}; });
            onSnapshot(doc(db, "config", "extra_visibility"), (doc) => { extraVisibility = doc.exists() ? doc.data() : {}; });
        }

        async function fetchMenu() {
            try {
                const response = await fetch('/api/menu');
                const data = await response.json();
                
                const promotionsWithCategory = (data.promocoes || []).map(promo => {
                    const originalItem = data.cardapio.find(item => item.id === promo.itemId);
                    return { ...promo, category: originalItem ? originalItem.category : 'Promoções', isPizza: originalItem ? originalItem.isPizza : false, isCustomizable: false, basePrice: promo.promoPrice };
                });
                
                allItems = [...(data.cardapio || []), ...promotionsWithCategory];
                
                const rawBurgerIngredients = data.ingredientesHamburguer || [];
                allIngredients = rawBurgerIngredients.reduce((acc, current) => {
                    const category = current.category || 'Outros';
                    if (!acc[category]) acc[category] = [];
                    acc[category].push(current);
                    return acc;
                }, {});
                
                const rawPizzaExtras = data.ingredientesPizza || [];
                allPizzaExtras = rawPizzaExtras.reduce((acc, current) => {
                    const category = current.category || 'Adicionais';
                    if (!acc[category]) acc[category] = [];
                    acc[category].push(current);
                    return acc;
                }, {});

            } catch (error) {
                console.error("Erro ao buscar cardápio:", error);
                alert("Não foi possível carregar o cardápio.");
            }
        }
        
        function capitalizeFirstLetter(string) {
            if (!string) return '';
            return string.charAt(0).toUpperCase() + string.slice(1).toLowerCase();
        }

        function formatCategoryName(category) {
            if (category === 'Todos') return 'Todos';
            const isPizzaCategory = allItems.some(item => item.category === category && item.isPizza);
            return isPizzaCategory ? `Pizzas ${capitalizeFirstLetter(category)}` : capitalizeFirstLetter(category);
        }

        function renderCategories() {
            const categoryContainer = document.getElementById('category-list');
            const categories = ['Todos', ...new Set(allItems.map(item => item.category).filter(Boolean))];
            
            categoryContainer.innerHTML = categories.map((cat, index) => `
                <button class="category-btn w-full p-4 text-sm font-bold rounded-md ${index === 0 ? 'active' : ''}" data-category="${cat}">
                    ${formatCategoryName(cat)}
                </button>
            `).join('');

            categoryContainer.querySelectorAll('.category-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    categoryContainer.querySelector('.active').classList.remove('active');
                    btn.classList.add('active');
                    renderProducts();
                });
            });
        }

        function renderProducts() {
            const productGrid = document.getElementById('product-grid');
            const activeCategoryBtn = document.querySelector('#category-list .active');
            if (!activeCategoryBtn) return;
            
            const activeCategory = activeCategoryBtn.dataset.category;
            const searchTerm = document.getElementById('search-product').value.toLowerCase();

            const filteredMenu = allItems.filter(item => {
                const categoryMatch = activeCategory === 'Todos' || item.category === activeCategory;
                const searchMatch = !searchTerm || item.name.toLowerCase().includes(searchTerm);
                const isVisible = itemVisibility[item.id] !== false;
                return categoryMatch && searchMatch && isVisible;
            });

            if(filteredMenu.length === 0) {
                productGrid.innerHTML = `<p class="text-center text-gray-500 col-span-full mt-8">Nenhum produto encontrado para esta categoria.</p>`;
                return;
            }

            productGrid.innerHTML = filteredMenu.map(item => {
                const isUnavailable = itemStatus[item.id] === false;
                return `
                <div class="product-card ${isUnavailable ? 'unavailable' : ''}" data-item-id="${item.id}">
                    <img src="${item.imageUrl || 'https://placehold.co/100x60/d1d5db/374151?text=S%C3%A2mia'}" alt="${item.name}">
                    <span class="text-xs font-bold text-gray-800 mt-2">${item.name}</span>
                    <span class="text-sm font-bold text-blue-600">R$ ${(item.basePrice || item.price4Slices || 0).toFixed(2).replace('.', ',')}</span>
                </div>
            `}).join('');

             productGrid.querySelectorAll('.product-card:not(.unavailable)').forEach(card => {
                card.addEventListener('click', () => {
                    const itemId = card.dataset.itemId;
                    const product = allItems.find(p => p.id === itemId);
                    if (product) {
                        handleProductSelection(product);
                    }
                });
            });
        }
        
        function handleProductSelection(product) {
            if (isSelectingHalfPizza) {
                 if (!product.isPizza || pizzaHalfStatus[product.id] === false) {
                    alert('Por favor, escolha um sabor de pizza válido para a segunda metade.');
                    return;
                }
                const isSecondHalfPromotional = product.category.toLowerCase() === 'promocionais';
                if(firstHalfPizza.isPromotional !== isSecondHalfPromotional) {
                    alert('Não é possível combinar uma pizza promocional com uma não promocional.');
                    return;
                }
                const priceKey = firstHalfPizza.selectedSize.priceKey;
                if(!product[priceKey] || product[priceKey] <= 0){
                    alert(`O sabor "${product.name}" não está disponível no tamanho de ${firstHalfPizza.selectedSize.label}.`);
                    return;
                }

                const secondHalfPrice = product[priceKey] / 2;
                const combinedPrice = firstHalfPizza.price + secondHalfPrice;
                const combinedName = `${firstHalfPizza.selectedSize.label}: Meia ${firstHalfPizza.name} & Meia ${product.name}`;

                addToOrder({
                    ...product,
                    id: `${firstHalfPizza.id}+${product.id}-${firstHalfPizza.selectedSize.slices}`,
                    name: combinedName,
                    price: combinedPrice,
                    type: 'split',
                    firstHalfData: firstHalfPizza,
                    secondHalfData: { ...product, price: secondHalfPrice, selectedSize: firstHalfPizza.selectedSize }
                });

                isSelectingHalfPizza = false;
                firstHalfPizza = null;
                document.getElementById('product-display').classList.remove('half-pizza-selection-active');
            } else {
                if (product.isPizza) {
                    openPizzaOptionsModal(product);
                } else if (product.isCustomizable) {
                    openBurgerBuilderModal(product);
                } else {
                    addToOrder({ ...product, price: product.basePrice, type: 'full' });
                }
            }
        }
        
        function addToOrder(product) {
            const uniqueId = product.uniqueId || `${product.id}-${Date.now()}`;
            const itemWithId = { ...product, uniqueId, quantity: 1, extras: [] };
            
            order.push(itemWithId);
            updateOrderDisplay();
            
            const originalItemId = (product.type === 'split' ? product.firstHalfData.id : product.id);
            const originalItem = allItems.find(i => i.id === originalItemId);
            if (originalItem) {
                const acceptsExtras = itemExtrasStatus[originalItem.id] === undefined ? originalItem.isPizza : itemExtrasStatus[originalItem.id];
                if(acceptsExtras && (product.type === 'full' || product.type === 'split')){
                    setTimeout(() => {
                        const askModal = document.getElementById('ask-pizza-extras-modal');
                        askModal.dataset.uniqueId = uniqueId;
                        askModal.style.display = 'flex';
                    }, 100);
                }
            }
        }

        function openPizzaOptionsModal(pizza) {
            document.getElementById('modal-pizza-name').textContent = pizza.name;
            const sizeContainer = document.getElementById('pizza-size-options');
            sizeContainer.innerHTML = '';

            const sizes = [
                { slices: 4, label: '4 Fatias', priceKey: 'price4Slices' },
                { slices: 6, label: '6 Fatias', priceKey: 'price6Slices' },
                { slices: 8, label: '8 Fatias', priceKey: 'basePrice' },
                { slices: 10, label: '10 Fatias', priceKey: 'price10Slices' }
            ];

            sizes.forEach(size => {
                if (pizza[size.priceKey] > 0) {
                    const allowsHalf = pizzaHalfStatus[pizza.id] !== false;
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'p-3 border rounded-lg flex justify-between items-center';
                    optionDiv.innerHTML = `
                        <div>
                            <span class="font-bold">${size.label}</span>
                            <span class="text-gray-600 ml-2">R$ ${pizza[size.priceKey].toFixed(2).replace('.', ',')}</span>
                        </div>
                        <div class="flex gap-2">
                           <button class="add-full-pizza-btn px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600">Inteira</button>
                           <button class="add-half-pizza-btn px-3 py-1 ${allowsHalf ? 'bg-green-500 hover:bg-green-600' : 'bg-gray-400 cursor-not-allowed'} text-white text-xs rounded" ${!allowsHalf ? 'disabled' : ''}>Meia</button>
                        </div>
                    `;
                    optionDiv.querySelector('.add-full-pizza-btn').addEventListener('click', () => {
                         addToOrder({
                            ...pizza,
                            id: pizza.id,
                            name: `${pizza.name} (${size.label})`,
                            price: pizza[size.priceKey],
                            type: 'full'
                        });
                        document.getElementById('pizza-option-modal').style.display = 'none';
                    });

                    if(allowsHalf) {
                        optionDiv.querySelector('.add-half-pizza-btn').addEventListener('click', () => {
                            isSelectingHalfPizza = true;
                            firstHalfPizza = { ...pizza, selectedSize: size, price: pizza[size.priceKey] / 2, isPromotional: pizza.category.toLowerCase() === 'promoções' };
                            document.getElementById('product-display').classList.add('half-pizza-selection-active');
                            alert(`Primeira metade: ${pizza.name}. Selecione a segunda metade.`);
                            document.getElementById('pizza-option-modal').style.display = 'none';
                        });
                    }
                    sizeContainer.appendChild(optionDiv);
                }
            });
            document.getElementById('pizza-option-modal').style.display = 'flex';
        }
        
        function openBurgerBuilderModal(burger) {
            const modal = document.getElementById('burger-builder-modal');
            modal.dataset.burgerId = burger.id;
            const ingredientsContainer = modal.querySelector('#burger-ingredients-container');
            ingredientsContainer.innerHTML = '';

            for (const categoryName in allIngredients) {
                const ingredients = allIngredients[categoryName].filter(ing => ingredientVisibility[ing.id] !== false);
                 if (ingredients.length === 0) continue;
                
                const firstIngredient = ingredients[0] || {};
                const isSingleChoice = firstIngredient.isSingleChoice;
                const limit = firstIngredient.limit || Infinity;
                const isRequired = firstIngredient.isRequired || false;

                let categoryHtml = `<div class="mb-4" data-limit="${limit}" data-category-name="${categoryName}"><h4 class="font-bold border-b pb-1 mb-2">${capitalizeFirstLetter(categoryName)} ${isRequired ? '(Obrigatório)' : ''} ${!isSingleChoice && limit !== Infinity ? `(Escolha até ${limit})` : ''}</h4>`;
                
                ingredients.forEach(ing => {
                    const isUnavailable = ingredientStatus[ing.id] === false;
                    const priceDisplay = ing.price > 0 ? `+ R$ ${ing.price.toFixed(2).replace('.', ',')}` : '';
                    if (isSingleChoice) {
                        categoryHtml += `
                            <label class="ingredient-option ${isUnavailable ? 'opacity-50 cursor-not-allowed' : ''}">
                                <div>
                                    <input type="radio" name="${categoryName}" class="form-radio" data-price="${ing.price}" value="${ing.name}" ${isUnavailable ? 'disabled' : ''}>
                                    <span class="ml-2">${ing.name}</span>
                                </div>
                                <span class="font-medium text-sm">${priceDisplay}</span>
                            </label>`;
                    } else {
                         categoryHtml += `
                            <div class="ingredient-option ${isUnavailable ? 'opacity-50' : ''}">
                                <div class="flex-grow">
                                    <span class="ml-2">${ing.name}</span>
                                </div>
                               <div class="flex items-center space-x-2">
                                    <span class="font-medium text-sm">${priceDisplay}</span>
                                    <div class="flex items-center space-x-2" data-ingredient-id="${ing.id}" data-price="${ing.price}" data-limit="${ing.ingredientLimit || 1}">
                                        <button type="button" class="quantity-btn minus-btn" ${isUnavailable ? 'disabled' : ''}>-</button>
                                        <span class="quantity-display font-bold text-base w-6 text-center">0</span>
                                        <button type="button" class="quantity-btn plus-btn" ${isUnavailable ? 'disabled' : ''}>+</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });
                categoryHtml += `</div>`;
                ingredientsContainer.innerHTML += categoryHtml;
            }
            
            updateBurgerPrice();
            modal.style.display = 'flex';

            ingredientsContainer.querySelectorAll('.quantity-btn, .form-radio').forEach(el => {
                el.addEventListener('click', (e) => {
                    if(e.target.classList.contains('quantity-btn')){
                        const container = e.target.closest('[data-ingredient-id]');
                        const display = container.querySelector('.quantity-display');
                        const ingredientLimit = parseInt(container.dataset.limit);
                        
                        let quantity = parseInt(display.textContent);

                        const categoryDiv = container.closest('[data-limit]');
                        const categoryLimit = parseInt(categoryDiv.dataset.limit);
                        let currentCategoryCount = 0;
                        categoryDiv.querySelectorAll('.quantity-display').forEach(d => {
                            if(parseInt(d.textContent) > 0) currentCategoryCount++;
                        });

                        if(e.target.classList.contains('plus-btn')) {
                            if (quantity < ingredientLimit) {
                                if (quantity === 0 && currentCategoryCount >= categoryLimit) {
                                    alert(`Você pode escolher no máximo ${categoryLimit} variedades nesta categoria.`);
                                    return;
                                }
                                quantity++;
                            }
                        }
                        else if (quantity > 0) {
                            quantity--;
                        }
                        display.textContent = quantity;
                    }
                    updateBurgerPrice();
                });
            });
        }
        
        function updateBurgerPrice() {
            const modal = document.getElementById('burger-builder-modal');
            const burgerId = modal.dataset.burgerId;
            const burger = allItems.find(item => item.id === burgerId);
            let total = burger.basePrice;

            modal.querySelectorAll('.quantity-display').forEach(display => {
                const quantity = parseInt(display.textContent);
                if (quantity > 0) {
                    const container = display.parentElement;
                    total += quantity * parseFloat(container.dataset.price);
                }
            });
            modal.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
                total += parseFloat(radio.dataset.price);
            });
            
            modal.querySelector('#burger-total-price').textContent = `R$ ${total.toFixed(2).replace('.',',')}`;
        }

        function addCustomBurgerToOrder() {
            const modal = document.getElementById('burger-builder-modal');
            const burgerId = modal.dataset.burgerId;
            const burger = allItems.find(item => item.id === burgerId);
            const selectedIngredients = [];
            let ingredientsPrice = 0;

            modal.querySelectorAll('.quantity-display').forEach(display => {
                const quantity = parseInt(display.textContent);
                if (quantity > 0) {
                     const container = display.closest('[data-ingredient-id]');
                     const ingredientName = container.parentElement.parentElement.querySelector('.flex-grow span').textContent;
                     const price = parseFloat(container.dataset.price);
                     selectedIngredients.push({ name: `${ingredientName} (x${quantity})`, price: price * quantity});
                     ingredientsPrice += price * quantity;
                }
            });
             modal.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
                const price = parseFloat(radio.dataset.price);
                selectedIngredients.push({ name: radio.value, price: price });
                ingredientsPrice += price;
            });
            
            const finalPrice = burger.basePrice + ingredientsPrice;
            
            addToOrder({
                ...burger,
                id: `${burger.id}-${Date.now()}`,
                name: `Hambúrguer Montável`,
                price: finalPrice,
                ingredients: selectedIngredients,
                type: 'custom_burger'
            });

            modal.style.display = 'none';
        }

        function openPizzaExtrasBuilderModal(uniqueId) {
             const orderIndex = order.findIndex(item => item.uniqueId === uniqueId);
            if (orderIndex === -1) return;

            const pizzaItem = order[orderIndex];
            const modal = document.getElementById('pizza-extras-builder-modal');
            modal.dataset.orderIndex = orderIndex;
            const scopeButtonsContainer = modal.querySelector('#pizza-extras-scope-buttons');
            scopeButtonsContainer.innerHTML = '';
            
            currentPizzaExtrasState = { metade1: [], metade2: [], toda: [] };
            if (pizzaItem.extras && pizzaItem.extras.length > 0) {
                pizzaItem.extras.forEach(extra => {
                    let placement = 'toda';
                    if (extra.placement.includes('1ª Metade')) placement = 'metade1';
                    else if (extra.placement.includes('2ª Metade')) placement = 'metade2';
                    if (currentPizzaExtrasState[placement]) currentPizzaExtrasState[placement].push({ ...extra });
                });
            }

            if (pizzaItem.type === 'split') {
                const half1Name = pizzaItem.firstHalfData.name;
                const half2Name = pizzaItem.secondHalfData.name;
                scopeButtonsContainer.innerHTML = `
                    <button class="scope-button px-3 py-1" data-scope="metade1">1ª Metade: ${half1Name}</button>
                    <button class="scope-button px-3 py-1" data-scope="metade2">2ª Metade: ${half2Name}</button>
                    <button class="scope-button px-3 py-1 active" data-scope="toda">Pizza Toda</button>
                `;
                scopeButtonsContainer.querySelectorAll('.scope-button').forEach(btn => {
                    btn.addEventListener('click', () => {
                        scopeButtonsContainer.querySelector('.active').classList.remove('active');
                        btn.classList.add('active');
                        renderPizzaExtrasList(orderIndex);
                    });
                });
            }

            renderPizzaExtrasList(orderIndex);
            updatePizzaExtrasPrice(orderIndex);
            modal.style.display = 'flex';
        }
        
        function renderPizzaExtrasList(orderIndex) {
            const activeScope = document.querySelector('#pizza-extras-scope-buttons .active')?.dataset.scope || 'toda';
            const container = document.getElementById('pizza-extras-ingredients-container');
            container.innerHTML = '';
            // Lógica para renderizar os extras
        }

        function updatePizzaExtrasPrice(orderIndex) {
             // Lógica para atualizar preço com extras
        }
        
        function confirmPizzaExtras() {
             // Lógica para confirmar e salvar os extras
        }

        function updateOrderDisplay() {
            const tableBody = document.getElementById('order-items-table');
            const totalValueEl = document.getElementById('total-value');
            const totalItemsEl = document.getElementById('total-items');
            const emptyCartMsg = document.getElementById('empty-cart-message');
            let total = 0;
            let totalItems = 0;

            if (order.length === 0) {
                tableBody.innerHTML = '';
                emptyCartMsg.style.display = 'flex';
            } else {
                emptyCartMsg.style.display = 'none';
                tableBody.innerHTML = order.map((item, index) => {
                    const subtotal = item.price * item.quantity;
                    total += subtotal;
                    totalItems += item.quantity;
                    let detailsHtml = '';
                    if ((item.ingredients && item.ingredients.length > 0) || (item.extras && item.extras.length > 0)) {
                        const allExtras = [...(item.ingredients || []), ...(item.extras || [])];
                        detailsHtml = `<ul class="text-xs text-gray-500 pl-4 list-disc">${allExtras.map(ing => `<li>${ing.name}</li>`).join('')}</ul>`;
                    }
                    return `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="p-2 font-medium">${item.name}${detailsHtml}</td>
                            <td class="p-2 text-center">${item.quantity}</td>
                            <td class="p-2 text-right font-medium">R$ ${subtotal.toFixed(2).replace('.',',')}</td>
                            <td class="p-2 text-center">
                                <button class="remove-item-btn text-red-500 hover:text-red-700" data-index="${index}"><i class="fas fa-trash-alt"></i></button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            totalValueEl.textContent = `R$ ${total.toFixed(2).replace('.',',')}`;
            totalItemsEl.textContent = totalItems;

            document.querySelectorAll('.remove-item-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const index = parseInt(btn.dataset.index);
                    order.splice(index, 1);
                    updateOrderDisplay();
                });
            });
        }
        
        function setupEventListeners() {
            document.getElementById('search-product').addEventListener('input', renderProducts);
            document.getElementById('cancel-order-btn').addEventListener('click', () => {
                if (order.length > 0 && confirm('Deseja cancelar o pedido atual?')) {
                    order = [];
                    isSelectingHalfPizza = false;
                    firstHalfPizza = null;
                    document.getElementById('product-display').classList.remove('half-pizza-selection-active');
                    updateOrderDisplay();
                }
            });
            document.getElementById('finalize-order-btn').addEventListener('click', finalizeOrder);
            
            const pizzaModal = document.getElementById('pizza-option-modal');
            document.getElementById('close-pizza-modal-btn').addEventListener('click', () => pizzaModal.style.display = 'none');
            
            const burgerModal = document.getElementById('burger-builder-modal');
            document.getElementById('close-burger-modal-btn').addEventListener('click', () => burgerModal.style.display = 'none');
            document.getElementById('cancel-burger-btn').addEventListener('click', () => burgerModal.style.display = 'none');
            document.getElementById('add-custom-burger-btn').addEventListener('click', addCustomBurgerToOrder);
            
            const extrasModal = document.getElementById('pizza-extras-builder-modal');
            document.getElementById('close-pizza-extras-builder-modal').addEventListener('click', () => extrasModal.style.display = 'none');
            document.getElementById('add-pizza-with-extras-btn').addEventListener('click', confirmPizzaExtras);
            
            const askExtrasModal = document.getElementById('ask-pizza-extras-modal');
            document.getElementById('ask-extras-no-btn').addEventListener('click', () => askExtrasModal.style.display = 'none');
            document.getElementById('ask-extras-yes-btn').addEventListener('click', () => {
                const uniqueId = askExtrasModal.dataset.uniqueId;
                openPizzaExtrasBuilderModal(uniqueId);
                askExtrasModal.style.display = 'none';
            });

            window.addEventListener('click', (e) => {
                if (e.target === pizzaModal) pizzaModal.style.display = 'none';
                if (e.target === burgerModal) burgerModal.style.display = 'none';
                if (e.target === extrasModal) extrasModal.style.display = 'none';
                if (e.target === askExtrasModal) askExtrasModal.style.display = 'none';
            });
        }

        async function finalizeOrder() {
            if(order.length === 0) {
                alert("O carrinho está vazio.");
                return;
            }

            const clientName = document.getElementById('client-name').value || 'Cliente Balcão';
            const total = order.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            const cleanedItems = JSON.parse(JSON.stringify(order, (key, value) => {
                const fieldsToExclude = ['originalItem', 'uniqueId', 'firstHalfData', 'secondHalfData'];
                if (fieldsToExclude.includes(key)) return undefined;
                return value;
            }));

            const newOrder = {
                itens: cleanedItems,
                endereco: { clientName: clientName, rua: "Retirada no Balcão", bairro: "BALCÃO" },
                total: { subtotal: total, finalTotal: total, deliveryFee: 0, discount: 0 },
                pagamento: 'A Definir',
                status: 'Entregue',
                criadoEm: serverTimestamp(),
                observacao: `Venda de balcão por ${currentUserEmail}`
            };

            try {
                await addDoc(collection(db, "pedidos"), newOrder);
                alert(`Pedido para ${clientName} finalizado com sucesso!`);
                order = [];
                updateOrderDisplay();
            } catch (error) {
                console.error("Erro ao finalizar pedido:", error);
                alert("Falha ao finalizar o pedido. Tente novamente.");
            }
        }
    </script>
</body>
</html>

