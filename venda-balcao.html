<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Venda Balcão - Sâmia Pizzaria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="https://raw.githubusercontent.com/WillianSoares93/cardapio_samia_PDV/refs/heads/main/logo.png" type="image/png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #DDE2E6;
            visibility: hidden;
            overflow: hidden;
        }
        .main-container {
            display: grid;
            grid-template-columns: 0px 1fr;
            height: 100vh;
            transition: grid-template-columns 0.3s ease-in-out;
        }
        .main-container.sidebar-open {
            grid-template-columns: 80px 1fr;
        }
        .main-content {
            display: grid;
            grid-template-columns: 400px 1fr 180px;
            gap: 1rem;
            padding: 1rem;
            height: 100%;
            overflow: hidden;
        }
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
        }
        .product-card {
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.5rem;
            text-align: center;
            background-color: #ffffff;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            aspect-ratio: 1 / 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
        }
        .product-card.unavailable {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #f3f4f6;
        }
         .product-card.unavailable::after {
            content: 'Esgotado';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-15deg);
            background-color: rgba(185, 28, 28, 0.8);
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.875rem;
        }
        .product-card:hover:not(.unavailable) {
            transform: translateY(-4px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border-color: #3b82f6;
        }
        .category-btn {
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
            color: #374151;
            transition: all 0.2s ease-in-out;
        }
        .category-btn.active, .category-btn:hover {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        .sidebar-nav {
            background-color: #2C3E50;
            overflow: hidden;
        }
        .sidebar-btn {
            color: #BDC3C7;
            transition: all 0.2s ease-in-out;
        }
        .sidebar-btn:hover {
            background-color: #34495E;
            color: white;
        }
        .sidebar-btn.active {
            background-color: #3b82f6;
            color: white;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
             background-color: #fff;
             padding: 1.5rem;
             border-radius: 0.5rem;
             box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
             width: 90%;
             max-width: 500px;
        }
        .ingredient-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            border: 1px solid #d1d5db;
            transition: all 0.2s ease-in-out;
        }
        .ingredient-option:hover {
            background-color: #f9fafb;
            border-color: #3b82f6;
        }
        .ingredient-option.selected-ingredient {
            background-color: #dbeafe;
            border-color: #3b82f6;
        }
        .quantity-btn {
            background-color: #e5e7eb;
            color: #4b5563;
            transition: all 0.2s ease-in-out;
            width: 28px;
            height: 28px;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            font-weight: bold;
        }
        .quantity-btn:hover:not(:disabled) {
            background-color: #d1d5db;
        }
        .half-pizza-selection-active {
            background-color: #fef9c3;
            border: 2px dashed #f59e0b;
        }
        .scope-button {
            transition: all 0.2s ease-in-out;
            padding: 4px 12px;
            border-radius: 9999px;
            background-color: #e5e7eb;
            color: #4b5563;
            font-size: 0.875rem;
        }
        .scope-button.active {
            background-color: #3b82f6;
            color: white;
        }
        .feedback-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #22c55e;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            z-index: 2000;
            font-size: 0.875rem;
            font-weight: 500;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            opacity: 0;
            transition: opacity 0.3s ease-in-out, top 0.3s ease-in-out;
        }
        .payment-option {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .payment-option:hover {
            background-color: #f9fafb;
            border-color: #10b981;
        }
        .payment-option.selected {
            background-color: #e6ffed;
            border-color: #10b981;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
        }
        .payment-option input[type="radio"] {
            margin-right: 12px;
            accent-color: #10b981;
        }
        .payment-option .icon {
            font-size: 1.5rem;
            margin-right: 12px;
            color: #4b5563;
        }
        .payment-option.selected .icon {
            color: #10b981;
        }
        .payment-option .text-content {
            flex-grow: 1;
        }
        .payment-option .text-content h4 {
            font-weight: 600;
            color: #1f2937;
        }
        .payment-option .text-content p {
            font-size: 0.875rem;
            color: #6b7280;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="main-container">
        <aside class="sidebar-nav flex flex-col justify-between py-4">
            <div>
                <a href="pdv.html" class="sidebar-btn w-full flex flex-col items-center p-3 text-xs" title="Painel de Pedidos">
                    <i class="fas fa-receipt fa-2x"></i>
                    <span>PEDIDOS</span>
                </a>
                <a href="venda-balcao.html" class="sidebar-btn active w-full flex flex-col items-center p-3 text-xs" title="Venda Balcão">
                    <i class="fas fa-cash-register fa-2x"></i>
                    <span>BALCÃO</span>
                </a>
                <a href="editar-cardapio.html" class="sidebar-btn w-full flex flex-col items-center p-3 text-xs" title="Editar Cardápio">
                    <i class="fas fa-edit fa-2x"></i>
                    <span>EDITAR</span>
                </a>
                <a href="gerenciar.html" class="sidebar-btn w-full flex flex-col items-center p-3 text-xs" title="Gerenciar Itens">
                    <i class="fas fa-tasks fa-2x"></i>
                    <span>GERENCIAR</span>
                </a>
                <a href="relatorio.html" class="sidebar-btn w-full flex flex-col items-center p-3 text-xs" title="Relatórios">
                    <i class="fas fa-chart-line fa-2x"></i>
                    <span>RELATÓRIOS</span>
                </a>
            </div>
            <div class="space-y-2">
                <div class="text-center px-2 py-3 text-xs text-gray-400 overflow-hidden" title="Usuário Logado">
                    <i class="fas fa-user-circle fa-2x mb-1"></i>
                    <span id="current-user" class="block truncate"></span>
                </div>
                <button id="logout-btn" class="sidebar-btn w-full flex flex-col items-center p-3 text-xs" title="Sair">
                    <i class="fas fa-sign-out-alt fa-2x text-red-400"></i>
                    <span class="text-red-400">SAIR</span>
                </button>
            </div>
        </aside>

        <div class="flex flex-col h-screen overflow-hidden">
             <header class="bg-white shadow-md">
                <div class="max-w-7xl mx-auto py-2 px-4 sm:px-6 lg:px-8 flex justify-start items-center">
                    <h1 class="text-xl font-bold text-gray-800">Venda Balcão</h1>
                </div>
            </header>
            <main class="main-content flex-grow">
                <section class="bg-white rounded-lg shadow-md flex flex-col overflow-hidden">
                    <div class="flex-shrink-0">
                        <div class="p-4 border-b flex justify-between items-start">
                            <div>
                                <label class="text-sm font-medium text-gray-700 mb-2 block">Tipo de Pedido</label>
                                <div id="order-type-selector" class="flex space-x-4">
                                    <label class="flex items-center">
                                        <input type="radio" name="orderType" value="Retirada" checked class="form-radio text-blue-600">
                                        <span class="ml-2">Retirada</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="orderType" value="Delivery" class="form-radio text-blue-600">
                                        <span class="ml-2">Delivery</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="orderType" value="Mesa" class="form-radio text-blue-600">
                                        <span class="ml-2">Mesa</span>
                                    </label>
                                </div>
                            </div>
                            <div class="flex flex-col space-y-2">
                                <button id="open-client-data-modal-btn" class="px-3 py-2 bg-blue-500 text-white font-bold rounded-md hover:bg-blue-600 text-sm whitespace-nowrap">
                                    <i class="fas fa-user mr-1"></i> Dados do Cliente
                                </button>
                                <button id="open-ai-modal-btn" class="px-3 py-2 bg-purple-600 text-white font-bold rounded-md hover:bg-purple-700 text-sm whitespace-nowrap">
                                    <i class="fas fa-robot mr-1"></i> Pedido com IA
                                </button>
                            </div>
                        </div>
                        <div id="client-data-summary" class="p-4 border-b hidden bg-blue-50 text-sm text-blue-800">
                        </div>
                    </div>

                    <div id="order-items-container" class="flex-grow overflow-y-auto p-4 space-y-4">
                         <div id="empty-cart-message" class="text-center text-gray-400 p-10 flex flex-col items-center justify-center h-full">
                            <i class="fas fa-shopping-cart fa-3x mb-4"></i>
                            <p class="font-medium">Carrinho Vazio</p>
                        </div>
                    </div>
                    
                    <div class="flex-shrink-0 p-4 border-t bg-gray-50">
                        <div class="flex justify-between items-center text-gray-600 text-sm">
                            <span>Total de Itens</span>
                            <span id="total-items">0</span>
                        </div>
                         <div id="delivery-fee-summary" class="flex justify-between items-center text-gray-600 text-sm hidden">
                            <span>Taxa de Entrega</span>
                            <span id="delivery-fee-value">R$ 0,00</span>
                        </div>
                        <div class="flex justify-between items-center text-2xl font-bold text-gray-800 mt-2 pt-2 border-t">
                            <span>VALOR A PAGAR</span>
                            <span id="total-value">R$ 0,00</span>
                        </div>
                        <div class="mt-4 grid grid-cols-2 gap-4">
                            <button id="cancel-order-btn" class="w-full py-3 bg-red-600 text-white font-bold rounded-md hover:bg-red-700">Cancelar</button>
                            <button id="finalize-order-btn" class="w-full py-3 bg-green-600 text-white font-bold rounded-md hover:bg-green-700">Finalizar</button>
                        </div>
                    </div>
                </section>

                <section id="product-display" class="bg-white rounded-lg shadow-md flex flex-col p-4 overflow-hidden">
                     <div class="mb-4">
                        <input type="text" id="search-product" placeholder="Buscar produto..." class="w-full p-2 border rounded-md">
                    </div>
                    <div class="product-grid flex-grow overflow-y-auto pr-2" id="product-grid"></div>
                </section>

                <section id="category-list" class="flex flex-col p-0 space-y-2 overflow-y-auto"></section>
            </main>
        </div>
    </div>
    
    <!-- Modal de Opções de Pizza -->
    <div id="pizza-option-modal" class="modal">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <div class="flex justify-between items-center pb-3 border-b">
                <h3 id="modal-pizza-name" class="text-xl font-bold text-gray-900"></h3>
                <button class="text-gray-400 hover:text-gray-600 text-2xl font-bold" onclick="this.closest('.modal').style.display='none'">&times;</button>
            </div>
            <div id="pizza-size-options" class="mt-4 space-y-2"></div>
        </div>
    </div>

    <!-- Modal de Montagem de Hambúrguer -->
    <div id="burger-builder-modal" class="modal">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl">
            <div class="flex justify-between items-center pb-3 border-b">
                <h3 id="modal-burger-name" class="text-xl font-bold text-gray-900">Monte seu Hambúrguer</h3>
                <button class="text-gray-400 hover:text-gray-600 text-2xl font-bold" onclick="this.closest('.modal').style.display='none'">&times;</button>
            </div>
            <div id="burger-ingredients-container" class="mt-4 mb-4 max-h-80 overflow-y-auto p-2 space-y-4"></div>
            <div class="flex justify-between items-center bg-gray-100 p-4 rounded-lg mt-4">
                <span class="text-lg font-bold">Total do Hambúrguer:</span>
                <span id="burger-total-price" class="text-2xl font-bold text-blue-600">R$ 0,00</span>
            </div>
            <div class="mt-6 flex justify-end space-x-4">
                <button class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300" onclick="this.closest('.modal').style.display='none'">Cancelar</button>
                <button id="add-custom-burger-btn" class="px-6 py-2 bg-green-600 text-white font-bold rounded-md hover:bg-green-700">Adicionar ao Pedido</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para Adicionais da Pizza -->
    <div id="pizza-extras-builder-modal" class="modal">
         <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl">
            <div class="flex justify-between items-center pb-3 border-b">
                <h3 id="pizza-extras-builder-title" class="text-xl font-bold text-gray-900">Adicionais para a Pizza</h3>
                <button class="text-gray-400 hover:text-gray-600 text-2xl font-bold" onclick="this.closest('.modal').style.display='none'">&times;</button>
            </div>
            <div id="pizza-extras-scope-buttons" class="flex flex-wrap gap-2 my-4 border-b pb-4"></div>
            <div id="pizza-extras-ingredients-container" class="mb-4 max-h-80 overflow-y-auto p-2"></div>
            <div class="flex justify-between items-center bg-gray-100 p-4 rounded-lg mt-4">
                <span class="text-lg font-bold">Total da Pizza:</span>
                <span id="pizza-extras-total-price" class="text-2xl font-bold text-blue-600">R$ 0,00</span>
            </div>
            <div class="mt-6 flex justify-end">
                <button id="add-pizza-with-extras-btn" class="px-6 py-2 bg-green-600 text-white font-bold rounded-md hover:bg-green-700">Confirmar Adicionais</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para perguntar sobre adicionais -->
    <div id="ask-pizza-extras-modal" class="modal">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
             <p class="text-lg font-semibold text-gray-800 mb-4 text-center">Deseja adicionar ingredientes extras?</p>
            <div class="flex justify-center gap-4">
                <button class="px-6 py-2 bg-gray-300 text-gray-800 rounded-lg font-bold hover:bg-gray-400 transition" onclick="this.closest('.modal').style.display='none'">Não, obrigado</button>
                <button id="ask-extras-yes-btn" class="px-6 py-2 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 transition">Sim, quero!</button>
            </div>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div id="alert-modal" class="modal">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
             <p id="alert-message" class="text-lg font-semibold text-gray-800 mb-4 text-center">Message goes here.</p>
            <div class="flex justify-center">
                <button id="alert-ok-btn" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition">OK</button>
            </div>
        </div>
    </div>

    <!-- Custom Confirm Modal -->
    <div id="confirm-modal" class="modal">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
             <p id="confirm-message" class="text-lg font-semibold text-gray-800 mb-6 text-center">Are you sure?</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-no-btn" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-lg font-bold hover:bg-gray-400 transition">Não</button>
                <button id="confirm-yes-btn" class="px-6 py-2 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition">Sim</button>
            </div>
        </div>
    </div>

    <!-- Client Data Modal -->
    <div id="client-data-modal" class="modal">
        <div class="modal-content max-h-[90vh] overflow-y-auto">
            
            <div class="flex justify-between items-center pb-3 border-b sticky top-0 bg-white z-20">
                <h3 id="client-modal-title" class="text-xl font-bold text-gray-900">Dados do Cliente e Pagamento</h3>
                <button class="text-gray-400 hover:text-gray-600 text-2xl font-bold" onclick="this.closest('.modal').style.display='none'">&times;</button>
            </div>
            
            <div class="pt-4">
                <div id="client-modal-error-message" class="hidden mt-0 p-3 bg-red-100 text-red-700 rounded-md text-sm"></div>
                <div class="mt-4 space-y-4">
                    <div id="client-modal-retirada-fields" class="hidden space-y-4">
                        <div>
                            <label for="client-modal-name-retirada" class="text-sm font-medium text-gray-700">Nome do Cliente</label>
                            <input type="text" id="client-modal-name-retirada" class="w-full mt-1 p-2 border rounded-md">
                        </div>
                        <div>
                            <label for="client-modal-contact-retirada" class="text-sm font-medium text-gray-700">Contato (Opcional)</label>
                            <input type="tel" id="client-modal-contact-retirada" class="w-full mt-1 p-2 border rounded-md">
                        </div>
                    </div>
                    <div id="client-modal-delivery-fields" class="hidden space-y-4">
                        <div>
                            <label for="client-modal-name-delivery" class="text-sm font-medium text-gray-700">Nome do Cliente</label>
                            <input type="text" id="client-modal-name-delivery" class="w-full mt-1 p-2 border rounded-md">
                        </div>
                        <div>
                            <label for="client-modal-contact-delivery" class="text-sm font-medium text-gray-700">Contato</label>
                            <input type="tel" id="client-modal-contact-delivery" class="w-full mt-1 p-2 border rounded-md">
                        </div>
                        <div>
                            <label for="client-modal-street" class="text-sm font-medium text-gray-700">Rua</label>
                            <input type="text" id="client-modal-street" class="w-full mt-1 p-2 border rounded-md">
                        </div>
                        <div>
                            <label for="client-modal-number" class="text-sm font-medium text-gray-700">Número</label>
                            <input type="text" id="client-modal-number" class="w-full mt-1 p-2 border rounded-md">
                        </div>
                        <div>
                            <label for="client-modal-neighborhood" class="text-sm font-medium text-gray-700">Bairro</label>
                            <select id="client-modal-neighborhood" class="w-full mt-1 p-2 border rounded-md"></select>
                        </div>
                    </div>
                    <div id="client-modal-mesa-fields" class="hidden space-y-4">
                        <div>
                            <label for="client-modal-table-select" class="text-sm font-medium text-gray-700">Selecionar Mesa Livre</label>
                            <select id="client-modal-table-select" class="w-full mt-1 p-2 border rounded-md"></select>
                        </div>
                        <div>
                            <label for="client-modal-name-mesa" class="text-sm font-medium text-gray-700">Nome do Cliente (Opcional)</label>
                            <input type="text" id="client-modal-name-mesa" class="w-full mt-1 p-2 border rounded-md">
                        </div>
                    </div>
                    <div class="mt-4">
                        <label for="client-modal-observation" class="text-sm font-medium text-gray-700">Observação (Geral)</label>
                        <textarea id="client-modal-observation" rows="2" class="w-full mt-1 p-2 border rounded-md"></textarea>
                    </div>

                    <div class="pt-4 border-t border-gray-200">
                        <h4 class="text-md font-bold text-gray-800 mb-3">Forma de Pagamento</h4>
                        <div id="payment-options-container" class="flex flex-col gap-2">
                            <label class="payment-option selected" data-method="Dinheiro">
                                <input type="radio" name="modalPaymentMethod" value="Dinheiro" class="form-radio" checked>
                                <i class="fas fa-money-bill-wave icon"></i>
                                <div class="text-content">
                                    <h4>Dinheiro</h4>
                                </div>
                            </label>
                            <label class="payment-option" data-method="Cartão de Crédito/Débito">
                                <input type="radio" name="modalPaymentMethod" value="Cartão de Crédito/Débito" class="form-radio">
                                <i class="fas fa-credit-card icon"></i>
                                <div class="text-content">
                                    <h4>Cartão de Crédito/Débito</h4>
                                </div>
                            </label>
                            <label class="payment-option" data-method="Pix">
                                <input type="radio" name="modalPaymentMethod" value="Pix" class="form-radio">
                                <i class="fas fa-qrcode icon"></i>
                                <div class="text-content">
                                    <h4>Pix</h4>
                                </div>
                            </label>
                            <label class="payment-option" data-method="A Definir">
                                <input type="radio" name="modalPaymentMethod" value="A Definir" class="form-radio">
                                <i class="fas fa-question-circle icon"></i>
                                <div class="text-content">
                                    <h4>A Definir</h4>
                                </div>
                            </label>
                        </div>

                        <div id="troco-input-container" class="mt-4 p-3 border border-gray-300 rounded-lg bg-gray-50">
                            <label for="modal-trocoPara" class="block text-gray-700 text-sm font-medium mb-2">
                                Troco para (R$):
                            </label>
                            <input type="number" id="modal-trocoPara" step="0.01" min="0" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none mb-2" placeholder="0,00">
                            <p class="text-gray-600 text-sm">
                                Troco: <span id="modal-trocoTotalDisplay" class="font-bold text-green-600">R$ 0,00</span>
                            </p>
                        </div>
                    </div>
                </div>
            <div class="mt-6 flex justify-end space-x-4">
                <button class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300" onclick="this.closest('.modal').style.display='none'">Cancelar</button>
                <button id="confirm-client-data-btn" class="px-6 py-2 bg-green-600 text-white font-bold rounded-md hover:bg-green-700">Confirmar Dados</button>
            </div>
        </div>
        </div>
    </div>
    
    <!-- Modal Pedido com IA -->
    <div id="ai-order-modal" class="modal">
        <div class="modal-content !max-w-3xl">
            <div class="flex justify-between items-center pb-3 border-b">
                <h3 class="text-xl font-bold text-gray-900">Montar Pedido com IA</h3>
                <button class="text-gray-400 hover:text-gray-600 text-2xl font-bold" onclick="this.closest('.modal').style.display='none'">&times;</button>
            </div>
            <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="whatsapp-paste-area" class="block text-sm font-medium text-gray-700 mb-2">Cole a conversa do WhatsApp aqui:</label>
                    <textarea id="whatsapp-paste-area" rows="10" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-purple-500" placeholder="Ex: Olá, gostaria de uma pizza grande de calabresa e um refrigerante..."></textarea>
                    <button id="analyze-ai-btn" class="mt-4 w-full py-2 bg-purple-600 text-white font-bold rounded-md hover:bg-purple-700 flex items-center justify-center">
                        <i class="fas fa-magic mr-2"></i> Analisar Pedido
                    </button>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Pedido Interpretado:</label>
                    <div id="ai-result-area" class="p-4 border rounded-md bg-gray-50 min-h-[240px]">
                        <div id="ai-loading" class="hidden text-center text-gray-500">
                            <i class="fas fa-spinner fa-spin text-2xl"></i>
                            <p class="mt-2">Analisando conversa...</p>
                        </div>
                        <div id="ai-result-content">
                             <p class="text-gray-400">Aguardando análise...</p>
                        </div>
                    </div>
                    <button id="confirm-ai-order-btn" class="mt-4 w-full py-2 bg-green-600 text-white font-bold rounded-md hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                        <i class="fas fa-check mr-2"></i> Confirmar e Adicionar
                    </button>
                </div>
            </div>
            <div id="ai-error-message" class="mt-4 hidden p-3 bg-red-100 text-red-700 rounded-md text-sm"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, doc, onSnapshot, query, getDocs, deleteDoc, where, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = {
           apiKey: "AIzaSyBJ44RVDGhBIlQBTx-pyIUp47XDKzRXk84",
           authDomain: "pizzaria-pdv.firebaseapp.com",
           projectId: "pizzaria-pdv",
           storageBucket: "pizzaria-pdv.firebasestorage.app",
           messagingSenderId: "304171744691",
           appId: "1:304171744691:web:e54d7f9fe55c7a75485fc6"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let allItems = [];
        let allIngredients = {};
        let allPizzaExtras = {};
        let allDeliveryFees = [];
        let order = [];
        let currentUserEmail = '';
        let currentOrderType = 'Retirada';
        let clientData = { name: null, contact: null, address: null, table: null, observation: null };
        let paymentMethod = null; 
        let pauseTime = 2000; 
        let initialUrlParamCheckDone = false; 
        let currentOrderId = null;
        let isEditing = false;
        let itemStatus = {}, itemVisibility = {}, itemExtrasStatus = {}, pizzaHalfStatus = {};
        let ingredientStatus = {}, ingredientVisibility = {};
        let extraStatus = {}, extraVisibility = {};
        let isSelectingHalfPizza = false;
        let firstHalfPizza = null;
        let currentPizzaExtrasState = {};
        const NUMERO_DE_MESAS = 12;
        let parsedAiOrder = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.body.style.visibility = 'visible';
                currentUserEmail = user.email;
                const currentUserEl = document.getElementById('current-user');
                if (currentUserEl) {
                    currentUserEl.textContent = currentUserEmail;
                }
                initializeAppLogic();
            } else {
                window.location.href = 'login.html?redirect=venda-balcao.html';
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        async function initializeAppLogic() {
            listenToStatusChanges();
            await fetchMenu();
            renderCategories();
            renderProducts();
            setupEventListeners();
            listenToTableStatus();
            
            const urlParams = new URLSearchParams(window.location.search);
            const orderIdFromUrl = urlParams.get('orderId');
            if (orderIdFromUrl) {
                loadOrderForEditing(orderIdFromUrl);
            }
        }

        async function fetchMenu() {
            try {
                const response = await fetch('/api/menu'); // Assumindo que você tem um endpoint /api/menu
                const data = await response.json();
                
                const promotionsWithCategory = (data.promocoes || []).map(promo => {
                    const originalItem = data.cardapio.find(item => item.id === promo.itemId);
                    return { ...promo, category: 'Promocional', isPizza: originalItem ? originalItem.isPizza : false, isCustomizable: false, price: promo.promoPrice, basePrice: promo.promoPrice }; // Adiciona price e basePrice
                });
                
                allItems = [...(data.cardapio || []), ...promotionsWithCategory];
                
                // Estrutura de ingredientes reorganizada por categoria
                const rawBurgerIngredients = data.ingredientesHamburguer || [];
                allIngredients = rawBurgerIngredients.reduce((acc, current) => {
                    const category = current.category || 'Outros';
                    if (!acc[category]) acc[category] = [];
                    acc[category].push(current);
                    return acc;
                }, {});
                
                // Estrutura de ingredientes pizza reorganizada por categoria
                const rawPizzaExtras = data.ingredientesPizza || [];
                allPizzaExtras = rawPizzaExtras.reduce((acc, current) => {
                    const category = current.category || 'Adicionais';
                    if (!acc[category]) acc[category] = [];
                    acc[category].push(current);
                    return acc;
                }, {});
                
                allDeliveryFees = data.deliveryFees || [];
                populateNeighborhoods(); // Chama a função para preencher os bairros

            } catch (error) {
                console.error("Erro ao buscar cardápio:", error);
                showAlert("Não foi possível carregar o cardápio. Por favor, verifique sua conexão e tente novamente.");
            }
        }
        
        function populateNeighborhoods() {
            const select = document.getElementById('client-modal-neighborhood');
            if (!select) return;
            select.innerHTML = '<option value="">Selecione o bairro</option>';
            
            // Obtém bairros únicos dos dados de entrega
            const uniqueNeighborhoods = [...new Set(allDeliveryFees.map(fee => fee.neighborhood))].sort();
            
            uniqueNeighborhoods.forEach(neighborhood => {
                const feeData = allDeliveryFees.find(fee => fee.neighborhood === neighborhood);
                const option = document.createElement('option');
                option.value = neighborhood;
                option.dataset.fee = feeData ? feeData.deliveryFee : 0;
                option.textContent = `${neighborhood} - R$ ${feeData ? feeData.deliveryFee.toFixed(2).replace('.', ',') : '0,00'}`;
                select.appendChild(option);
            });
        }
        
        function capitalizeFirstLetter(string) {
            if (!string) return '';
            return string.charAt(0).toUpperCase() + string.slice(1).toLowerCase();
        }

        function formatCategoryName(category) {
            if (category === 'Todos') return 'Todos';
            // Verifica se a categoria contém alguma pizza para formatar de forma diferente
            const isPizzaCategory = allItems.some(item => item.category === category && item.isPizza);
            return isPizzaCategory ? `Pizzas ${capitalizeFirstLetter(category)}` : capitalizeFirstLetter(category);
        }

        function renderCategories() {
            const categoryContainer = document.getElementById('category-list');
            if (!categoryContainer) return;
            
            // Cria uma lista de categorias únicas, incluindo 'Todos' e ordenando
            const categories = ['Todos', ...new Set(allItems.map(item => item.category).filter(Boolean))].sort((a, b) => {
                if (a === 'Todos') return -1;
                if (b === 'Todos') return 1;
                return a.localeCompare(b);
            });
            
            categoryContainer.innerHTML = categories.map((cat, index) => `
                <button class="category-btn w-full p-4 text-sm font-bold rounded-md ${index === 0 ? 'active' : ''}" data-category="${cat}">
                    ${formatCategoryName(cat)}
                </button>
            `).join('');

            categoryContainer.querySelectorAll('.category-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const activeBtn = categoryContainer.querySelector('.active');
                    if (activeBtn) activeBtn.classList.remove('active');
                    btn.classList.add('active');
                    renderProducts(); // Chama renderProducts sem argumento para usar a categoria ativa
                });
            });
        }

        // Função renderProducts atualizada para considerar a categoria ativa
        function renderProducts(selectedCategory = null) {
            const productGridEl = document.getElementById('product-grid');
            if (!productGridEl) return;

            productGridEl.innerHTML = ''; // Limpa o grid de produtos anterior

            const searchInput = document.getElementById('search-product');
            const searchTerm = searchInput.value.toLowerCase();

            let filteredItems = allItems;

            // Determina a categoria a ser filtrada
            const activeCategoryBtn = document.querySelector('.category-btn.active');
            const currentCategory = activeCategoryBtn ? activeCategoryBtn.dataset.category : 'Todos';
            
            if (currentCategory !== 'Todos') {
                filteredItems = filteredItems.filter(item => item.category === currentCategory);
            }

            if (searchTerm) {
                filteredItems = filteredItems.filter(item => 
                    item.name.toLowerCase().includes(searchTerm) ||
                    (item.category && item.category.toLowerCase().includes(searchTerm)) // Verifica se item.category existe
                );
            }
            
            // Se não houver produtos para exibir, mostra mensagem
            if (filteredItems.length === 0) {
                productGridEl.innerHTML = '<p class="text-center text-gray-400 p-10 col-span-full">Nenhum produto encontrado.</p>';
                return;
            }

            filteredItems.forEach(item => {
                // Ignora itens indisponíveis ou ocultos, a menos que sejam promoções
                if (itemStatus[item.id] === 'unavailable' && !item.isPromotion) return; // Mantém promoções mesmo se o item base estiver indisponível
                if (itemVisibility[item.id] === false && !item.isPromotion) return;

                const card = document.createElement('div');
                card.classList.add('product-card');
                if (itemStatus[item.id] === 'unavailable') {
                    card.classList.add('unavailable');
                }

                card.innerHTML = `
                    <img src="${item.imageUrl || 'https://via.placeholder.com/120'}" alt="${item.name}" class="w-full h-24 object-cover rounded-t-md">
                    <div class="p-2 flex-grow flex flex-col justify-between">
                        <h4 class="text-xs font-bold text-gray-800 truncate">${item.name}</h4>
                        <p class="text-xs text-gray-500">${item.category}</p>
                        <p class="text-sm font-bold text-green-600 mt-1">R$ ${item.price.toFixed(2).replace('.', ',')}</p>
                    </div>
                `;

                if (itemStatus[item.id] !== 'unavailable') {
                    card.addEventListener('click', () => {
                        handleProductClick(item);
                    });
                }
                productGridEl.appendChild(card);
            });
        }

        function handleProductClick(item) {
            if (item.isCustomizable) {
                if (item.isBurger) {
                    openBurgerBuilderModal(item);
                } else if (item.isPizza) { // Pizza customizável (com metades ou adicionais)
                    // Se a pizza tiver a opção de metades, abre o modal de adicionais para configurar
                    if (item.hasHalfOption) {
                         openPizzaExtrasBuilderModal(null, item);
                    } else {
                        // Se não tiver metades, trata como item simples (ou pode abrir adicionais gerais se houver)
                        addItemToOrder(item);
                    }
                }
            } else if (item.isPizza) { // Pizzas pré-definidas com tamanhos
                openPizzaOptionModal(item);
            } else { // Itens simples
                addItemToOrder(item);
            }
        }

        async function addItemToOrder(item, quantity = 1, options = {}) {
            // Se o item for uma promoção, usa o preço e ID da promoção
            const itemToAdd = item.isPromotion ? { ...item, id: item.id, name: item.name, price: item.promoPrice, uniqueId: `${item.id}-${Date.now()}` } :
                              { ...item, uniqueId: item.uniqueId || `${item.id}-${Date.now()}` }; // Usa uniqueId se já existir (edição)

            // Se estiver editando um item existente (uniqueId já existe)
            const existingItemIndex = order.findIndex(o => o.uniqueId === itemToAdd.uniqueId);

            if (existingItemIndex !== -1) {
                // Atualiza a quantidade e opções do item existente
                order[existingItemIndex].quantity += quantity;
                // Mescla opções se necessário, ou substitui
                order[existingItemIndex].options = { ...order[existingItemIndex].options, ...options };
                
                 // Se o item é customizável, o preço pode precisar ser recalculado
                 if (itemToAdd.isCustomizable || itemToAdd.isPizza) {
                     // Recalcula o preço unitário base (importante para pizzas com metades/adicionais)
                     let basePriceForRecalc = itemToAdd.price; // Preço base do item (seja pizza, burger, etc.)
                     
                     if (options.halfPizzas && options.halfPizzas.length > 0) {
                         options.halfPizzas.forEach(half => basePriceForRecalc += half.price);
                     }
                     if (options.ingredients && options.ingredients.length > 0) {
                          options.ingredients.forEach(extra => basePriceForRecalc += extra.price);
                     }
                     // Adiciona preço de ingredientes de hambúrguer se houver
                     if (options.burgerIngredients && options.burgerIngredients.length > 0) {
                         options.burgerIngredients.forEach(ing => basePriceForRecalc += ing.price * ing.quantity);
                     }
                     order[existingItemIndex].price = basePriceForRecalc;
                 }

            } else {
                // Adiciona novo item
                const newItemInstance = {
                    ...itemToAdd,
                    quantity: quantity,
                    price: itemToAdd.price, // Preço unitário
                    options: options || {},
                    isCustomizable: itemToAdd.isCustomizable || false, // Garante que as flags estejam presentes
                    isPizza: itemToAdd.isPizza || false,
                    isBurger: itemToAdd.isBurger || false,
                    category: itemToAdd.category || (itemInMenu ? itemInMenu.category : 'Outros'),
                    imageUrl: itemToAdd.imageUrl || (itemInMenu ? itemInMenu.imageUrl : undefined)
                };
                
                // Define o preço unitário corretamente para pizzas customizáveis
                if ((newItemInstance.isPizza || newItemInstance.isCustomizable) && newItemInstance.price === undefined) {
                    // Tenta pegar o preço do tamanho selecionado ou o preço base do item
                    let defaultPizzaPrice = itemToAdd.price || 0; // Tenta pegar o preço do item base
                    // Se for uma pizza com tamanhos pré-definidos, pega o preço do tamanho
                    if (itemToAdd.sizes && itemToAdd.sizes.length > 0) {
                        const selectedSize = itemToAdd.sizes.find(s => s.name === itemToAdd.size); // Assumindo que o tamanho está setado
                        if (selectedSize) defaultPizzaPrice = selectedSize.price;
                    }
                     newItemInstance.price = defaultPizzaPrice;
                }

                order.push(newItemInstance);
            }
            
            updateOrderDisplay();
            showTemporaryFeedback(`${item.name} adicionado ao pedido.`);
        }

        function updateOrderDisplay() {
            const orderItemsContainer = document.getElementById('order-items-container');
            const totalItemsEl = document.getElementById('total-items');
            const totalValueEl = document.getElementById('total-value');
            const emptyCartMessage = document.getElementById('empty-cart-message');
            const deliveryFeeSummaryEl = document.getElementById('delivery-fee-summary');
            const deliveryFeeValueEl = document.getElementById('delivery-fee-value');

            orderItemsContainer.innerHTML = ''; // Limpa a lista de itens do pedido

            let totalItems = 0;
            let totalPrice = 0;
            let deliveryFee = 0;

            if (order.length === 0) {
                emptyCartMessage.classList.remove('hidden');
                totalItemsEl.textContent = '0';
                totalValueEl.textContent = 'R$ 0,00';
                deliveryFeeSummaryEl.classList.add('hidden');
                return;
            } else {
                emptyCartMessage.classList.add('hidden');
            }

            order.forEach((item, index) => {
                totalItems += item.quantity;
                let itemTotalPrice = item.price * item.quantity;
                totalPrice += itemTotalPrice;

                const itemElement = document.createElement('div');
                itemElement.classList.add('flex', 'justify-between', 'items-center', 'p-4', 'bg-white', 'rounded-lg', 'shadow-sm', 'border');

                let itemDetailsHtml = `
                    <div class="flex-grow mr-4">
                        <p class="font-medium text-gray-800">${item.name}${item.options.observation ? ` (${item.options.observation})` : ''}</p>
                        <p class="text-xs text-gray-500">${item.quantity}x - R$ ${item.price.toFixed(2).replace('.', ',')}</p>
                `;

                // Adiciona detalhes de adicionais ou customizações
                if (item.options.ingredients && item.options.ingredients.length > 0) {
                    itemDetailsHtml += `<div class="text-xs text-green-600 mt-1">Adicionais: ${item.options.ingredients.map(ing => ing.name).join(', ')}</div>`;
                }
                if (item.options.halfPizzas && item.options.halfPizzas.length > 0) {
                    item.options.halfPizzas.forEach(half => {
                        itemDetailsHtml += `<div class="text-xs text-blue-600 mt-1">${half.side === 'left' ? 'Esquerda' : 'Direita'}: ${half.item ? half.item.name : 'Vazio'} (R$ ${half.price.toFixed(2).replace('.', ',')})</div>`;
                    });
                }
                 if (item.options.burgerIngredients && item.options.burgerIngredients.length > 0) {
                    itemDetailsHtml += `<div class="text-xs text-purple-600 mt-1">Ingredientes: ${item.options.burgerIngredients.map(ing => `${ing.name} (${ing.quantity})`).join(', ')}</div>`;
                }

                itemDetailsHtml += `</div>`;

                itemElement.innerHTML = `
                    ${itemDetailsHtml}
                    <div class="flex items-center space-x-3">
                        <span class="font-bold text-gray-900">R$ ${(itemTotalPrice).toFixed(2).replace('.', ',')}</span>
                        <div class="flex items-center space-x-1">
                            <button class="quantity-btn px-1" data-action="decrease" data-unique-id="${item.uniqueId}">-</button>
                            <span class="px-2 font-medium">${item.quantity}</span>
                            <button class="quantity-btn px-1" data-action="increase" data-unique-id="${item.uniqueId}">+</button>
                        </div>
                        ${(item.isCustomizable || item.isPizza) ? `
                            <button class="text-blue-500 hover:text-blue-700 edit-item-btn" data-unique-id="${item.uniqueId}" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                        ` : ''}
                        <button class="text-red-500 hover:text-red-700 remove-item-btn" data-unique-id="${item.uniqueId}" title="Remover Item">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `;

                orderItemsContainer.appendChild(itemElement);
            });

            // Calcula a taxa de entrega se o tipo for delivery e houver bairro selecionado
            if (currentOrderType === 'Delivery') {
                const selectedNeighborhood = document.getElementById('client-modal-neighborhood')?.value;
                if (selectedNeighborhood) {
                    const feeData = allDeliveryFees.find(fee => fee.neighborhood === selectedNeighborhood);
                    if (feeData) {
                        deliveryFee = feeData.deliveryFee;
                    }
                }
            }

            totalItemsEl.textContent = totalItems;
            deliveryFeeValueEl.textContent = `R$ ${deliveryFee.toFixed(2).replace('.', ',')}`;
            if (deliveryFee > 0) {
                 deliveryFeeSummaryEl.classList.remove('hidden');
            } else {
                 deliveryFeeSummaryEl.classList.add('hidden');
            }
            totalValueEl.textContent = `R$ ${(totalPrice + deliveryFee).toFixed(2).replace('.', ',')}`;

            // Adiciona listener para botões de quantidade e remover dentro do loop
            document.querySelectorAll('.remove-item-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const uniqueId = btn.dataset.uniqueId;
                    order = order.filter(item => item.uniqueId !== uniqueId);
                    updateOrderDisplay();
                });
            });

            document.querySelectorAll('.quantity-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const uniqueId = btn.dataset.uniqueId;
                    const action = btn.dataset.action;
                    const itemIndex = order.findIndex(item => item.uniqueId === uniqueId);

                    if (itemIndex !== -1) {
                        if (action === 'increase') {
                            order[itemIndex].quantity++;
                        } else if (action === 'decrease' && order[itemIndex].quantity > 1) {
                            order[itemIndex].quantity--;
                        }
                        updateOrderDisplay();
                    }
                });
            });

            document.querySelectorAll('.edit-item-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const uniqueId = btn.dataset.uniqueId;
                    const itemToEdit = order.find(o => o.uniqueId === uniqueId);
                    if (itemToEdit) {
                        // Abre o modal apropriado dependendo do tipo de item
                        if (itemToEdit.isBurger) {
                             const baseBurgerItem = allItems.find(i => i.id === itemToEdit.id); // Encontra o item base original
                             if(baseBurgerItem) openBurgerBuilderModal(baseBurgerItem, index, itemToEdit);
                        } else if (itemToEdit.isPizza || itemToEdit.isCustomizable) {
                            // Se for uma pizza customizável ou com metades/adicionais
                            openPizzaExtrasBuilderModal(uniqueId);
                        } else {
                            // Outros itens customizáveis (se houver)
                            addItemToOrder(itemToEdit, 1, itemToEdit.options); // Simplesmente re-adiciona, pode ser refatorado
                        }
                    }
                });
            });
        }

        function openPizzaOptionModal(pizza) {
            const modal = document.getElementById('pizza-option-modal');
            const modalNameEl = document.getElementById('modal-pizza-name');
            const sizeOptionsEl = document.getElementById('pizza-size-options');
            
            modalNameEl.textContent = pizza.name;
            sizeOptionsEl.innerHTML = '';

            // Filtra apenas os tamanhos disponíveis e os ordena
            const availableSizes = pizza.sizes.filter(size => size.available !== false).sort((a, b) => (a.order || Infinity) - (b.order || Infinity));

            availableSizes.forEach(size => {
                const sizeButton = document.createElement('button');
                sizeButton.classList.add('px-4', 'py-2', 'bg-blue-100', 'text-blue-800', 'font-medium', 'rounded-md', 'hover:bg-blue-200', 'w-full', 'text-left');
                sizeButton.textContent = `${size.name} - R$ ${size.price.toFixed(2).replace('.', ',')}`;
                
                sizeButton.addEventListener('click', () => {
                    const selectedPizzaData = {
                        ...pizza, // Mantém todas as propriedades originais da pizza
                        price: size.price, // Preço do tamanho selecionado
                        size: size.name, // Nome do tamanho selecionado
                        uniqueId: `${pizza.id}-${size.name}-${Date.now()}` // Cria um ID único
                    };
                    
                    // Verifica se a pizza customizável precisa de adicionais
                    if (pizza.hasExtras) {
                        // Passa os dados da pizza selecionada para o modal de adicionais
                        openPizzaExtrasBuilderModal(null, selectedPizzaData);
                    } else {
                        addItemToOrder(selectedPizzaData); // Adiciona diretamente ao pedido
                    }
                    modal.style.display = 'none';
                });
                sizeOptionsEl.appendChild(sizeButton);
            });

            modal.style.display = 'flex';
        }

        function openBurgerBuilderModal(burgerItem, editIndex = null, existingItem = null) {
            const modal = document.getElementById('burger-builder-modal');
            const modalNameEl = document.getElementById('modal-burger-name');
            const ingredientsContainer = document.getElementById('burger-ingredients-container');
            const totalPriceEl = document.getElementById('burger-total-price');
            const addBtn = document.getElementById('add-custom-burger-btn');

            modalNameEl.textContent = `Monte seu ${burgerItem.name}`;
            ingredientsContainer.innerHTML = '';
            
            // Guarda o índice para saber se estamos editando
            if (editIndex !== null) {
                modal.dataset.editIndex = editIndex;
            } else {
                delete modal.dataset.editIndex;
            }

            // Inicializa ou recupera o estado dos ingredientes para este burger
            const burgerStateKey = burgerItem.id; // Usa o ID do burger como chave
            if (!currentPizzaExtrasState[burgerStateKey]) { // Reutilizando a estrutura para estado
                currentPizzaExtrasState[burgerStateKey] = {
                    selectedIngredients: [], // Ingredientes selecionados para este burger
                    basePrice: existingItem ? existingItem.price / existingItem.quantity : burgerItem.price, // Preço base unitário
                    burgerItem: burgerItem, // Referência ao item base
                    quantity: existingItem ? existingItem.quantity : 1
                };
            }
            
            const state = currentPizzaExtrasState[burgerStateKey];
            
            // Se estiver editando, carrega os ingredientes do item existente
            if (existingItem && existingItem.options.burgerIngredients) {
                state.selectedIngredients = existingItem.options.burgerIngredients.map(ing => ({ ...ing })); // Copia os ingredientes
            } else {
                // Se for um novo burger, adiciona os ingredientes base
                if (burgerItem.ingredients && burgerItem.ingredients.length > 0) {
                    burgerItem.ingredients.forEach(ingId => {
                        const ingredient = allIngredients[ingId]; // Busca o ingrediente completo
                        if (ingredient && !state.selectedIngredients.some(ing => ing.id === ingredient.id)) {
                            state.selectedIngredients.push({ ...ingredient, quantity: 1 });
                        }
                    });
                }
            }
            
            // Renderiza os ingredientes e atualiza o preço
            renderBurgerIngredients(burgerStateKey, ingredientsContainer, totalPriceEl, addBtn, state);
            
            modal.style.display = 'flex';
        }

        function renderBurgerIngredients(burgerId, container, totalPriceEl, addBtn, state) {
            container.innerHTML = ''; // Limpa o container
            let currentTotal = state.basePrice * state.quantity; // Começa com o preço base * quantidade
            const burgerItem = state.burgerItem; // Item base do burger

            // Filtra e ordena os ingredientes disponíveis para o burger
            const availableIngredients = Object.values(allIngredients).flat().filter(ing => ing.available).sort((a, b) => a.name.localeCompare(b.name));

            availableIngredients.forEach(ingredient => {
                const ingredientElement = document.createElement('div');
                ingredientElement.classList.add('ingredient-option');
                
                const isIncluded = state.selectedIngredients.some(selIng => selIng.id === ingredient.id);
                const isOptional = burgerItem.optionalIngredients?.includes(ingredient.id); // Verifica se o ingrediente é opcional para este burger
                const ingredientQuantity = state.selectedIngredients.find(ing => ing.id === ingredient.id)?.quantity || 0;
                const ingredientPrice = ingredient.price || 0;

                if (isIncluded) {
                    if (isOptional) {
                        currentTotal += ingredientPrice * ingredientQuantity;
                    } else {
                        // Ingredientes base não adicionam preço adicional
                    }
                }
                
                ingredientElement.innerHTML = `
                    <span class="font-medium text-gray-700">${ingredient.name}${isOptional ? ` (+R$ ${ingredientPrice.toFixed(2).replace('.', ',')})` : ''}</span>
                    <div class="flex items-center space-x-2">
                        ${isOptional ? `
                            <div class="flex items-center space-x-1">
                                <button class="quantity-btn px-1" data-ingredient-id="${ingredient.id}" data-burger-id="${burgerId}" data-action="decrease-burger-ing">-</button>
                                <span class="px-2 font-medium">${ingredientQuantity}</span>
                                <button class="quantity-btn px-1" data-ingredient-id="${ingredient.id}" data-burger-id="${burgerId}" data-action="increase-burger-ing">+</button>
                            </div>
                        ` : ''}
                        <i class="${isIncluded ? 'fas fa-check-circle text-green-500' : 'far fa-circle text-gray-400'} cursor-pointer text-xl"></i>
                    </div>
                `;

                ingredientElement.querySelector('i').addEventListener('click', () => {
                    if (isIncluded) {
                        if (isOptional) { // Remove se for opcional
                            state.selectedIngredients = state.selectedIngredients.filter(ing => ing.id !== ingredient.id);
                        }
                    } else {
                        if (isOptional) { // Adiciona se for opcional e não estiver incluído
                             state.selectedIngredients.push({ ...ingredient, quantity: 1 });
                        } else {
                            // Se não for opcional, mas o item base não foi adicionado (pode acontecer se for um ingrediente base não listado explicitamente)
                            const isBaseIngredient = burgerItem.ingredients?.includes(ingredient.id);
                            if (isBaseIngredient) {
                                state.selectedIngredients.push({ ...ingredient, quantity: 1 });
                            }
                        }
                    }
                    renderBurgerIngredients(burgerId, container, totalPriceEl, addBtn, state); // Renderiza novamente para atualizar a UI e o preço
                });
                
                container.appendChild(ingredientElement);
            });

            // Adiciona listeners para os botões de quantidade de ingredientes
             container.querySelectorAll('.quantity-btn[data-action="decrease-burger-ing"], .quantity-btn[data-action="increase-burger-ing"]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const ingredientId = btn.dataset.ingredientId;
                    const action = btn.dataset.action;
                    const ingIndex = state.selectedIngredients.findIndex(ing => ing.id === ingredientId);

                    if (ingIndex !== -1) {
                        if (action === 'increase-burger-ing') {
                            state.selectedIngredients[ingIndex].quantity++;
                        } else if (action === 'decrease-burger-ing' && state.selectedIngredients[ingIndex].quantity > 1) {
                            state.selectedIngredients[ingIndex].quantity--;
                        }
                        renderBurgerIngredients(burgerId, container, totalPriceEl, addBtn, state); // Atualiza UI e preço
                    }
                });
            });
            
            // Atualiza o preço total exibido e o handler do botão de adicionar
            totalPriceEl.textContent = `R$ ${currentTotal.toFixed(2).replace('.', ',')}`;
            
            addBtn.onclick = () => addCustomBurgerToOrder(burgerId); // Usa o burgerId como chave do estado
        }

        function addCustomBurgerToOrder(burgerStateKey) {
            const state = currentPizzaExtrasState[burgerStateKey];
            const burgerItem = state.burgerItem;
            const editIndex = parseInt(document.getElementById('burger-builder-modal').dataset.editIndex);

            const finalPrice = parseFloat(document.getElementById('burger-total-price').textContent.replace('R$ ', '').replace(',', '.'));

            const burgerToAdd = {
                ...burgerItem,
                uniqueId: editIndex !== null ? order[editIndex].uniqueId : `${burgerItem.id}-${Date.now()}`,
                quantity: state.quantity, // Usa a quantidade do estado (pode ser > 1 se estiver editando)
                price: finalPrice / state.quantity, // Preço unitário final
                options: {
                    burgerIngredients: state.selectedIngredients.map(ing => ({ id: ing.id, name: ing.name, quantity: ing.quantity })),
                    observation: document.getElementById('burger-builder-modal')?.querySelector('#burger-observation')?.value || ''
                }
            };
            
            if (editIndex !== null) {
                order[editIndex] = burgerToAdd;
            } else {
                order.push(burgerToAdd);
            }
            
            // Limpa o estado do modal para o próximo uso
            delete currentPizzaExtrasState[burgerStateKey];
            delete document.getElementById('burger-builder-modal').dataset.editIndex;

            document.getElementById('burger-builder-modal').style.display = 'none';
            updateOrderDisplay();
            showTemporaryFeedback(`${burgerItem.name} adicionado ao pedido.`);
        }

        function openPizzaExtrasBuilderModal(uniqueId = null, pizzaToAdd = null) {
            const modal = document.getElementById('pizza-extras-builder-modal');
            const titleEl = document.getElementById('pizza-extras-builder-title');
            const scopeButtonsEl = document.getElementById('pizza-extras-scope-buttons');
            const ingredientsContainer = document.getElementById('pizza-extras-ingredients-container');
            const totalPriceEl = document.getElementById('pizza-extras-total-price');
            const confirmBtn = document.getElementById('add-pizza-with-extras-btn');

            let currentItem = null;
            let basePrice = 0; // Preço base da pizza (do tamanho selecionado ou item base)
            const stateKey = uniqueId || (pizzaToAdd ? `${pizzaToAdd.id}-${pizzaToAdd.size || 'default'}-${Date.now()}` : `new-${Date.now()}`); // Cria uma chave única para o estado

            // Inicializa ou recupera o estado para esta pizza
            if (!currentPizzaExtrasState[stateKey]) {
                currentPizzaExtrasState[stateKey] = {
                    selectedExtras: [], // Adicionais para a pizza inteira ou metades
                    halfPizzas: {}, // { side: 'left'/'right', pizzaItem: { ... }, price: ... }
                    scope: 'full' // 'full', 'left', 'right'
                };
            }
            const state = currentPizzaExtrasState[stateKey];

            if (uniqueId) { // Editando um item existente
                currentItem = order.find(item => item.uniqueId === uniqueId);
                if (!currentItem) {
                    console.error("Item não encontrado para edição de adicionais:", uniqueId);
                    modal.style.display = 'none';
                    return;
                }
                basePrice = currentItem.price; // Preço total do item que já inclui tamanho/metades/etc.
                titleEl.textContent = `Adicionais para ${currentItem.name}`;
                modal.dataset.editUniqueId = uniqueId; // Guarda o ID para edição
                
                // Carrega os adicionais e metades existentes
                if (currentItem.options.ingredients) {
                    state.selectedExtras = [...currentItem.options.ingredients];
                }
                if (currentItem.options.halfPizzas) {
                    state.halfPizzas = {}; // Limpa o estado anterior para reconstruir
                    currentItem.options.halfPizzas.forEach(half => {
                        state.halfPizzas[half.side] = { pizzaItem: half.item, price: half.price, side: half.side };
                    });
                }
                // Define o escopo com base nas metades existentes
                if (state.halfPizzas.left || state.halfPizzas.right) {
                    state.scope = 'left'; // Define um escopo inicial se houver metades
                }

            } else if (pizzaToAdd) { // Adicionando uma nova pizza com possíveis adicionais
                currentItem = pizzaToAdd;
                basePrice = pizzaToAdd.price; // Preço do tamanho selecionado
                titleEl.textContent = `Adicionais para ${pizzaToAdd.name}`;
                modal.dataset.newPizzaStateKey = stateKey; // Guarda a chave do estado para adicionar depois
            } else {
                console.error("Nenhum item ou pizza fornecido para o modal de adicionais.");
                modal.style.display = 'none';
                return;
            }

            // Renderiza botões de escopo
            scopeButtonsEl.innerHTML = `
                <button class="scope-button ${state.scope === 'full' ? 'active' : ''}" data-scope="full">Pizza Inteira</button>
                ${currentItem.hasHalfOption ? `
                    <button class="scope-button ${state.scope === 'left' ? 'active' : ''}" data-scope="left">Metade Esquerda</button>
                    <button class="scope-button ${state.scope === 'right' ? 'active' : ''}" data-scope="right">Metade Direita</button>
                ` : ''}
            `;
            scopeButtonsEl.querySelectorAll('.scope-button').forEach(btn => {
                btn.addEventListener('click', () => {
                    state.scope = btn.dataset.scope;
                    renderPizzaExtrasIngredients(currentItem, basePrice, state, ingredientsContainer, totalPriceEl, confirmBtn, stateKey);
                    // Atualiza a classe active nos botões de escopo
                    scopeButtonsEl.querySelectorAll('.scope-button').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
            });
            
            renderPizzaExtrasIngredients(currentItem, basePrice, state, ingredientsContainer, totalPriceEl, confirmBtn, stateKey);
            
            confirmBtn.onclick = () => confirmPizzaExtras(stateKey);
            modal.style.display = 'flex';
        }

        function renderPizzaExtrasIngredients(item, basePrice, state, container, totalPriceEl, confirmBtn, stateKey) {
            container.innerHTML = ''; // Limpa o container de ingredientes
            let currentTotal = basePrice; // Começa com o preço base da pizza (tamanho selecionado)
            
            // Se estivermos selecionando metades, precisamos renderizar os ingredientes de forma diferente
            if (state.scope === 'left' || state.scope === 'right') {
                const side = state.scope;
                const existingHalf = state.halfPizzas[side];
                
                // Se não houver item selecionado para essa metade, oferece opções de pizzas para preencher a metade
                if (!existingHalf) {
                    container.innerHTML = `
                        <p class="text-gray-500 mb-4">Selecione o item para a ${side === 'left' ? 'metade esquerda' : 'metade direita'}:</p>
                        <div id="half-pizza-selection-container" class="grid grid-cols-2 gap-4"></div>
                    `;
                    const halfSelectionContainer = container.querySelector('#half-pizza-selection-container');
                    
                    // Lista de todas as pizzas disponíveis para escolher para a metade
                    const availablePizzasForHalf = allItems.filter(i => i.isPizza && !i.isCustomizable && i.hasHalfOption && i.available !== false).sort((a, b) => a.name.localeCompare(b.name));
                    
                    availablePizzasForHalf.forEach(pizza => {
                         const pizzaOption = document.createElement('button');
                         pizzaOption.classList.add('product-card', 'bg-white', 'p-3', 'text-center', 'cursor-pointer');
                         pizzaOption.innerHTML = `
                            <h4 class="text-xs font-bold text-gray-800 truncate mb-1">${pizza.name}</h4>
                            <p class="text-xs text-gray-500 mb-2">${pizza.category}</p>
                            <p class="text-sm font-bold text-green-600">R$ ${pizza.price.toFixed(2).replace('.', ',')}</p>
                         `;
                         pizzaOption.addEventListener('click', () => {
                             // Define o item selecionado para essa metade
                             state.halfPizzas[side] = { pizzaItem: pizza, price: pizza.price, side: side };
                             renderPizzaExtrasIngredients(item, basePrice, state, container, totalPriceEl, confirmBtn, stateKey); // Renderiza novamente com o item selecionado
                         });
                         halfSelectionContainer.appendChild(pizzaOption);
                    });
                    
                    // Se não houver pizzas disponíveis para metades, mostra mensagem
                    if (availablePizzasForHalf.length === 0) {
                         container.querySelector('#half-pizza-selection-container').innerHTML = '<p class="text-gray-400 col-span-full">Nenhuma pizza disponível para montar metades.</p>';
                    }
                    
                    // Preço total ainda é o base da pizza inteira até que as metades sejam definidas
                    totalPriceEl.textContent = `R$ ${basePrice.toFixed(2).replace('.', ',')}`;
                    confirmBtn.disabled = true; // Desabilita confirmar até que as metades sejam definidas
                    return;
                } else {
                    // Se já existe um item selecionado para essa metade, adiciona o preço dele ao total
                    const halfPizzaItem = existingHalf.pizzaItem;
                    currentTotal += existingHalf.price; // Adiciona o preço da metade selecionada

                    // Renderiza o nome da metade selecionada
                     const selectedHalfEl = document.createElement('div');
                     selectedHalfEl.classList.add('text-sm', 'font-medium', 'text-blue-700', 'mb-4', 'p-2', 'rounded-md', 'bg-blue-50', 'border', 'border-blue-200');
                     selectedHalfEl.innerHTML = `
                        <p>Metade ${side === 'left' ? 'Esquerda' : 'Direita'}: <strong>${halfPizzaItem.name}</strong> <span class="text-xs">(R$ ${existingHalf.price.toFixed(2).replace('.', ',')})</span></p>
                        <button class="text-red-500 hover:text-red-700 remove-half-btn ml-4" data-side="${side}">Remover</button>
                    `;
                    container.appendChild(selectedHalfEl);

                    // Adiciona listener para remover metade
                    selectedHalfEl.querySelector('.remove-half-btn').addEventListener('click', () => {
                        delete state.halfPizzas[side];
                        renderPizzaExtrasIngredients(item, basePrice, state, container, totalPriceEl, confirmBtn, stateKey); // Renderiza novamente
                    });

                    // Lista de adicionais disponíveis para esta metade
                    const availableExtras = Object.values(allPizzaExtras).flat().filter(extra => extra.available).sort((a, b) => a.name.localeCompare(b.name));
                    
                    availableExtras.forEach(extra => {
                        const extraElement = document.createElement('div');
                        extraElement.classList.add('ingredient-option');
                        
                        const isSelected = state.selectedExtras.some(selExtra => selExtra.id === extra.id && selExtra.side === side);
                        const extraPrice = extra.price || 0;
                        
                        if (isSelected) currentTotal += extraPrice;

                        extraElement.innerHTML = `
                            <span class="font-medium text-gray-700">${extra.name} (+R$ ${extraPrice.toFixed(2).replace('.', ',')})</span>
                            <i class="${isSelected ? 'fas fa-check-circle text-green-500' : 'far fa-circle text-gray-400'} cursor-pointer text-xl"></i>
                        `;

                        extraElement.querySelector('i').addEventListener('click', () => {
                            if (isSelected) {
                                // Remove o adicional
                                state.selectedExtras = state.selectedExtras.filter(selExtra => !(selExtra.id === extra.id && selExtra.side === side));
                            } else {
                                // Adiciona o adicional
                                state.selectedExtras.push({ id: extra.id, name: extra.name, price: extraPrice, side: side });
                            }
                            renderPizzaExtrasIngredients(item, basePrice, state, container, totalPriceEl, confirmBtn, stateKey);
                        });
                        container.appendChild(extraElement);
                    });
                }
            } else { // Se o escopo for 'full' (pizza inteira)
                const availableExtras = Object.values(allPizzaExtras).flat().filter(extra => extra.available).sort((a, b) => a.name.localeCompare(b.name));
                
                availableExtras.forEach(extra => {
                    const extraElement = document.createElement('div');
                    extraElement.classList.add('ingredient-option');
                    
                    const isSelected = state.selectedExtras.some(selExtra => selExtra.id === extra.id && selExtra.side === 'full');
                    const extraPrice = extra.price || 0;
                    
                    if (isSelected) currentTotal += extraPrice;

                    extraElement.innerHTML = `
                        <span class="font-medium text-gray-700">${extra.name} (+R$ ${extraPrice.toFixed(2).replace('.', ',')})</span>
                        <i class="${isSelected ? 'fas fa-check-circle text-green-500' : 'far fa-circle text-gray-400'} cursor-pointer text-xl"></i>
                    `;

                    extraElement.querySelector('i').addEventListener('click', () => {
                        if (isSelected) {
                            // Remove o adicional
                            state.selectedExtras = state.selectedExtras.filter(selExtra => !(selExtra.id === extra.id && selExtra.side === 'full'));
                        } else {
                            // Adiciona o adicional
                            state.selectedExtras.push({ id: extra.id, name: extra.name, price: extraPrice, side: 'full' });
                        }
                        renderPizzaExtrasIngredients(item, basePrice, state, container, totalPriceEl, confirmBtn, stateKey);
                    });
                    container.appendChild(extraElement);
                });
            }
            
            totalPriceEl.textContent = `R$ ${currentTotal.toFixed(2).replace('.', ',')}`;

            // Habilita/desabilita o botão de confirmar com base na seleção das metades
            const hasLeftHalf = state.halfPizzas.left;
            const hasRightHalf = state.halfPizzas.right;

            if (!hasLeftHalf && (state.scope === 'left' || state.scope === 'right')) { // Precisa ter metade esquerda se o escopo for 'left' ou 'right'
                confirmBtn.disabled = true;
            } else if (!hasRightHalf && (state.scope === 'left' || state.scope === 'right')) { // Precisa ter metade direita se o escopo for 'left' ou 'right'
                 confirmBtn.disabled = true;
            } else {
                confirmBtn.disabled = false; // Habilita se não houver restrições de metades ou se o escopo for 'full'
            }
        }

        function confirmPizzaExtras(stateKey) {
            const modal = document.getElementById('pizza-extras-builder-modal');
            const state = currentPizzaExtrasState[stateKey];
            const editUniqueId = modal.dataset.editUniqueId;
            const newPizzaStateKey = modal.dataset.newPizzaStateKey; // Chave do estado da nova pizza

            let finalItem = {};
            let finalPrice = parseFloat(document.getElementById('pizza-extras-total-price').textContent.replace('R$ ', '').replace(',', '.'));

            if (editUniqueId) { // Edição de item existente
                const itemIndex = order.findIndex(item => item.uniqueId === editUniqueId);
                if (itemIndex !== -1) {
                    finalItem = { ...order[itemIndex] };
                    
                    // Atualiza opções: adicionais e metades
                    finalItem.options.ingredients = state.selectedExtras;
                    finalItem.options.halfPizzas = Object.entries(state.halfPizzas).map(([side, half]) => ({
                        side: side,
                        item: half.pizzaItem, // Salva o item inteiro da metade
                        price: half.price
                    }));

                    finalItem.price = finalPrice; // Atualiza o preço total do item
                    order[itemIndex] = finalItem;
                }
            } else if (newPizzaStateKey) { // Adicionando nova pizza (com base no estado salvo)
                const pizzaBaseItem = currentPizzaExtrasState[newPizzaStateKey].burgerItem; // Recupera o item base do estado
                
                finalItem = {
                    ...pizzaBaseItem,
                    uniqueId: stateKey, // Usa a chave do estado como uniqueId para a nova pizza
                    quantity: 1,
                    price: finalPrice, // Preço total da pizza configurada
                    options: {
                        ingredients: state.selectedExtras, // Adicionais gerais
                        halfPizzas: Object.entries(state.halfPizzas).map(([side, half]) => ({
                            side: side,
                            item: half.pizzaItem,
                            price: half.price
                        })),
                        observation: '' // Pode adicionar um campo para observação específica da pizza
                    }
                };
                order.push(finalItem);
            }

            // Limpa o estado do modal
            delete currentPizzaExtrasState[stateKey];
            if (editUniqueId) delete modal.dataset.editUniqueId;
            if (newPizzaStateKey) delete modal.dataset.newPizzaStateKey;

            modal.style.display = 'none';
            updateOrderDisplay();
            showTemporaryFeedback(`Adicionais confirmados para ${finalItem.name}.`);
        }
        
        function openClientDataModal() {
            const modal = document.getElementById('client-data-modal');
            const modalTitleEl = document.getElementById('client-modal-title');
            const errorMessageEl = document.getElementById('client-modal-error-message');
            
            const retiradaFields = document.getElementById('client-modal-retirada-fields');
            const deliveryFields = document.getElementById('client-modal-delivery-fields');
            const mesaFields = document.getElementById('client-modal-mesa-fields');

            errorMessageEl.classList.add('hidden');
            errorMessageEl.textContent = '';

            // Define o título baseado no tipo de pedido
            modalTitleEl.textContent = `Dados do Cliente e Pagamento (${currentOrderType})`;

            // Mostra/esconde campos relevantes
            retiradaFields.classList.add('hidden');
            deliveryFields.classList.add('hidden');
            mesaFields.classList.add('hidden');

            switch (currentOrderType) {
                case 'Retirada':
                    retiradaFields.classList.remove('hidden');
                    break;
                case 'Delivery':
                    deliveryFields.classList.remove('hidden');
                    break;
                case 'Mesa':
                    mesaFields.classList.remove('hidden');
                    break;
            }

            // Preenche os campos com os dados atuais, se houver
            document.getElementById('client-modal-name-retirada').value = clientData.name || '';
            document.getElementById('client-modal-contact-retirada').value = clientData.contact || '';
            
            document.getElementById('client-modal-name-delivery').value = clientData.name || '';
            document.getElementById('client-modal-contact-delivery').value = clientData.contact || '';
            document.getElementById('client-modal-street').value = clientData.address?.street || '';
            document.getElementById('client-modal-number').value = clientData.address?.number || '';
            document.getElementById('client-modal-observation').value = clientData.observation || '';
            
            document.getElementById('client-modal-table-select').value = clientData.table || '';
            document.getElementById('client-modal-name-mesa').value = clientData.name || '';

            // Carrega bairros se for delivery
            if (currentOrderType === 'Delivery') {
                populateNeighborhoods(); // Garante que os bairros estejam atualizados
                // Seleciona o bairro correto se já tiver endereço
                if (clientData.address?.neighborhood) {
                    setTimeout(() => { // Pequeno delay para garantir que o select foi carregado
                        document.getElementById('client-modal-neighborhood').value = clientData.address.neighborhood;
                        // Atualiza a taxa de entrega se o bairro já estiver selecionado
                        updateDeliveryFeeDisplay(); 
                    }, 50);
                } else {
                    // Limpa o display da taxa de entrega se não houver bairro selecionado
                    document.getElementById('delivery-fee-value').textContent = 'R$ 0,00';
                }
            }
            
            // Preenche a forma de pagamento
            const paymentOptionsContainer = document.getElementById('payment-options-container');
            paymentOptionsContainer.querySelectorAll('.payment-option').forEach(option => {
                const radio = option.querySelector('input[type="radio"]');
                if (radio.value === paymentMethod) {
                    option.classList.add('selected');
                    radio.checked = true;
                    toggleTrocoInput(option); // Atualiza a visibilidade do campo de troco
                } else {
                    option.classList.remove('selected');
                }
            });

            // Preenche o campo de troco
            const trocoParaInput = document.getElementById('modal-trocoPara');
            trocoParaInput.value = clientData.changeFor || '';
            updateTrocoDisplay();

            modal.style.display = 'flex';
        }

        // Event listener para mudar a taxa de entrega ao selecionar bairro
        document.getElementById('client-modal-neighborhood').addEventListener('change', updateDeliveryFeeDisplay);

        function updateDeliveryFeeDisplay() {
            const selectedNeighborhood = document.getElementById('client-modal-neighborhood').value;
            const feeData = allDeliveryFees.find(fee => fee.neighborhood === selectedNeighborhood);
            const deliveryFeeValueEl = document.getElementById('delivery-fee-value');
            const deliveryFeeSummaryEl = document.getElementById('delivery-fee-summary');

            if (feeData && selectedNeighborhood) {
                deliveryFeeValueEl.textContent = `R$ ${feeData.deliveryFee.toFixed(2).replace('.', ',')}`;
                deliveryFeeSummaryEl.classList.remove('hidden');
                // Atualiza o total geral também
                updateOrderDisplay(); // Chama para recalcular o total com a nova taxa
            } else {
                deliveryFeeValueEl.textContent = 'R$ 0,00';
                deliveryFeeSummaryEl.classList.add('hidden');
                updateOrderDisplay(); // Chama para recalcular o total
            }
        }

        function toggleTrocoInput(selectedPaymentOption) {
            const trocoInputContainer = document.getElementById('troco-input-container');
            const paymentMethod = selectedPaymentOption.dataset.method;

            if (paymentMethod === 'Dinheiro') {
                trocoInputContainer.classList.remove('hidden');
            } else {
                trocoInputContainer.classList.add('hidden');
                document.getElementById('modal-trocoPara').value = ''; // Limpa o campo de troco
                updateTrocoDisplay(); // Atualiza o display do troco
            }
        }

        function updateTrocoDisplay() {
            const trocoParaInput = document.getElementById('modal-trocoPara');
            const trocoTotalDisplay = document.getElementById('modal-trocoTotalDisplay');
            const totalValue = parseFloat(document.getElementById('total-value').textContent.replace('R$ ', '').replace(',', '.'));
            const trocoPara = parseFloat(trocoParaInput.value || '0');

            let troco = 0;
            if (trocoPara >= totalValue) {
                troco = trocoPara - totalValue;
                trocoTotalDisplay.textContent = `R$ ${troco.toFixed(2).replace('.', ',')}`;
                trocoTotalDisplay.classList.remove('text-red-600');
                trocoTotalDisplay.classList.add('text-green-600');
            } else {
                trocoTotalDisplay.textContent = 'Valor insuficiente';
                trocoTotalDisplay.classList.remove('text-green-600');
                trocoTotalDisplay.classList.add('text-red-600');
            }
        }

        document.getElementById('modal-trocoPara').addEventListener('input', updateTrocoDisplay);

        document.getElementById('payment-options-container').addEventListener('click', (e) => {
            const targetLabel = e.target.closest('.payment-option');
            if (targetLabel) {
                document.querySelectorAll('.payment-option').forEach(opt => opt.classList.remove('selected'));
                targetLabel.classList.add('selected');
                toggleTrocoInput(targetLabel);
            }
        });


        async function confirmClientData() {
            const modal = document.getElementById('client-data-modal');
            const errorMessageEl = document.getElementById('client-modal-error-message');
            errorMessageEl.classList.add('hidden');
            errorMessageEl.textContent = '';

            let isValid = true;
            const selectedPaymentOption = document.querySelector('#payment-options-container .payment-option.selected');
            paymentMethod = selectedPaymentOption.dataset.method;

            // Limpa dados antigos para garantir consistência
            clientData = { name: null, contact: null, address: null, table: null, observation: null, changeFor: null }; // Reset changeFor
            clientData.observation = document.getElementById('client-modal-observation').value;
            if (selectedPaymentOption.dataset.method === 'Dinheiro') {
                clientData.changeFor = document.getElementById('modal-trocoPara').value;
            }

            // Coleta dados baseados no tipo de pedido
            switch (currentOrderType) {
                case 'Retirada':
                    clientData.name = document.getElementById('client-modal-name-retirada').value.trim();
                    clientData.contact = document.getElementById('client-modal-contact-retirada').value.trim();
                    if (!clientData.name) {
                        errorMessageEl.textContent = 'O nome do cliente é obrigatório.';
                        isValid = false;
                    }
                    break;
                case 'Delivery':
                    clientData.name = document.getElementById('client-modal-name-delivery').value.trim();
                    clientData.contact = document.getElementById('client-modal-contact-delivery').value.trim();
                    const street = document.getElementById('client-modal-street').value.trim();
                    const number = document.getElementById('client-modal-number').value.trim();
                    const neighborhood = document.getElementById('client-modal-neighborhood').value;
                    
                    if (!clientData.name) { errorMessageEl.textContent = 'O nome do cliente é obrigatório.'; isValid = false; }
                    if (!clientData.contact) { errorMessageEl.textContent += (errorMessageEl.textContent ? '\n' : '') + 'O contato é obrigatório.'; isValid = false; }
                    if (!street) { errorMessageEl.textContent += (errorMessageEl.textContent ? '\n' : '') + 'A rua é obrigatória.'; isValid = false; }
                    if (!number) { errorMessageEl.textContent += (errorMessageEl.textContent ? '\n' : '') + 'O número é obrigatório.'; isValid = false; }
                    if (!neighborhood) { errorMessageEl.textContent += (errorMessageEl.textContent ? '\n' : '') + 'O bairro é obrigatório.'; isValid = false; }
                    
                    if (isValid) {
                        clientData.address = { street, number, neighborhood };
                    }
                    break;
                case 'Mesa':
                    clientData.table = document.getElementById('client-modal-table-select').value;
                    clientData.name = document.getElementById('client-modal-name-mesa').value.trim(); // Nome opcional para mesa
                    if (!clientData.table) {
                        errorMessageEl.textContent = 'Selecione uma mesa.';
                        isValid = false;
                    }
                    break;
            }

            if (!isValid) {
                errorMessageEl.classList.remove('hidden');
                return;
            }

            // Se o total a pagar é zero (carrinho vazio e sem dados de cliente/mesa)
            const currentTotalValue = parseFloat(document.getElementById('total-value').textContent.replace('R$ ', '').replace(',', '.'));
            if (currentTotalValue === 0 && !clientData.name && !clientData.table && order.length === 0) {
                showAlert('Pedido vazio.');
                return;
            }

            // Atualiza o resumo do cliente
            updateClientDataSummary();
            modal.style.display = 'none';
            
            // Se o usuário clicou em "Confirmar e Finalizar" do botão principal
            if (document.getElementById('finalize-order-btn').textContent.includes('Finalizar')) {
                 await submitOrder(); // Procede para submeter o pedido
            }
        }

        function updateClientDataSummary() {
            const summaryEl = document.getElementById('client-data-summary');
            if (!summaryEl) return;

            let summaryText = '';
            if (clientData.name) summaryText += `<strong>Cliente:</strong> ${clientData.name}<br>`;
            if (clientData.contact) summaryText += `<strong>Contato:</strong> ${clientData.contact}<br>`;
            if (clientData.address) summaryText += `<strong>Endereço:</strong> ${clientData.address.street}, ${clientData.address.number} - ${clientData.address.neighborhood}<br>`;
            if (clientData.table) summaryText += `<strong>Mesa:</strong> ${clientData.table}<br>`;
            if (clientData.observation) summaryText += `<strong>Obs:</strong> ${clientData.observation}<br>`;
            if (paymentMethod) summaryText += `<strong>Pagamento:</strong> ${paymentMethod}<br>`;
            if (clientData.changeFor && paymentMethod === 'Dinheiro') summaryText += `<strong>Troco para:</strong> R$ ${parseFloat(clientData.changeFor).toFixed(2).replace('.', ',')}<br>`;

            if (summaryText) {
                summaryEl.innerHTML = summaryText;
                summaryEl.classList.remove('hidden');
            } else {
                summaryEl.classList.add('hidden');
            }
        }

        async function finalizeOrderCheck() {
            // Se o modal de dados do cliente estiver aberto, apenas o fecha após confirmar os dados
            if (document.getElementById('client-data-modal').style.display === 'flex') {
                 // O botão dentro do modal já tem a função de confirmar os dados
                 // Vamos simular o clique no botão de confirmar dados do modal
                 document.getElementById('confirm-client-data-btn').click();
                 return; // Retorna para que o confirmClientData possa finalizar o pedido
            }

            // Se os dados do cliente já estão preenchidos e o modal não está aberto, prossegue para a finalização
            const confirmed = await showConfirm('Tem certeza que deseja finalizar este pedido?');
            if (confirmed) {
                await submitOrder();
            }
        }

        async function submitOrder() {
            const orderData = {
                items: order,
                totalItems: parseInt(document.getElementById('total-items').textContent),
                totalValue: parseFloat(document.getElementById('total-value').textContent.replace('R$ ', '').replace(',', '.')),
                client: clientData,
                orderType: currentOrderType,
                paymentMethod: paymentMethod,
                timestamp: serverTimestamp(),
                status: 'Pending', // Novo status padrão
                createdBy: currentUserEmail
            };

            const deliveryFee = parseFloat(document.getElementById('delivery-fee-value').textContent.replace('R$ ', '').replace(',', '.'));
            if (deliveryFee > 0) {
                orderData.deliveryFee = deliveryFee;
                orderData.client.address = clientData.address || {}; // Garante que address exista
                orderData.client.address.deliveryFee = deliveryFee; // Adiciona a taxa ao endereço do cliente
            }

            try {
                let orderRef;
                if (isEditing && currentOrderId) {
                    orderRef = doc(db, 'orders', currentOrderId);
                    await updateDoc(orderRef, { ...orderData, status: 'Updated' }); // Atualiza o status se for edição
                    showTemporaryFeedback('Pedido atualizado com sucesso!');
                } else {
                    orderRef = await addDoc(collection(db, 'orders'), orderData);
                    currentOrderId = orderRef.id; // Guarda o ID para caso de edição posterior
                    showTemporaryFeedback('Pedido finalizado com sucesso!');
                }
                
                resetOrderState(); // Limpa o estado após o envio
            } catch (error) {
                console.error("Erro ao finalizar pedido:", error);
                showAlert('Ocorreu um erro ao finalizar o pedido. Por favor, tente novamente.');
            }
        }

        function resetOrderState() {
            order = [];
            clientData = { name: null, contact: null, address: null, table: null, observation: null, changeFor: null };
            paymentMethod = null;
            currentOrderId = null;
            isEditing = false;
            parsedAiOrder = null;
            
            updateOrderDisplay();
            updateClientDataSummary();
            
            // Limpa o modal de dados do cliente também
            const clientModal = document.getElementById('client-data-modal');
            if(clientModal) clientModal.style.display = 'none';
            document.getElementById('client-modal-name-retirada').value = '';
            document.getElementById('client-modal-contact-retirada').value = '';
            document.getElementById('client-modal-name-delivery').value = '';
            document.getElementById('client-modal-contact-delivery').value = '';
            document.getElementById('client-modal-street').value = '';
            document.getElementById('client-modal-number').value = '';
            document.getElementById('client-modal-neighborhood').value = '';
            document.getElementById('client-modal-observation').value = '';
            document.getElementById('client-modal-table-select').value = '';
            document.getElementById('client-modal-name-mesa').value = '';
            document.getElementById('modal-trocoPara').value = '';
            document.getElementById('troco-input-container').classList.add('hidden');
            
            // Reseta a forma de pagamento para Dinheiro (padrão)
            const defaultPaymentOption = document.querySelector('#payment-options-container .payment-option[data-method="Dinheiro"]');
            if(defaultPaymentOption) {
                document.querySelectorAll('.payment-option').forEach(opt => opt.classList.remove('selected'));
                defaultPaymentOption.classList.add('selected');
                defaultPaymentOption.querySelector('input[type="radio"]').checked = true;
                toggleTrocoInput(defaultPaymentOption);
            }
            
            // Reseta o texto do botão de confirmar dados
            document.getElementById('confirm-client-data-btn').textContent = 'Confirmar Dados'; 

            // Limpa o modal de IA
            const aiModal = document.getElementById('ai-order-modal');
            if (aiModal) {
                const pasteArea = aiModal.querySelector('#whatsapp-paste-area');
                const resultContent = aiModal.querySelector('#ai-result-content');
                const errorMessage = aiModal.querySelector('#ai-error-message');
                const confirmBtn = aiModal.querySelector('#confirm-ai-order-btn');
                if (pasteArea) pasteArea.value = '';
                if (resultContent) resultContent.innerHTML = '<p class="text-gray-400">Aguardando análise...</p>';
                if (errorMessage) errorMessage.classList.add('hidden');
                if (confirmBtn) confirmBtn.disabled = true;
            }
            
            // Limpa o estado de edição de pizza/burger
            currentPizzaExtrasState = {};
        }

        function listenToStatusChanges() {
            // Escuta mudanças em 'items' para status e visibilidade de produtos
            const itemsRef = collection(db, 'items');
            const unsubscribeItems = onSnapshot(itemsRef, (snapshot) => {
                snapshot.docChanges().forEach(change => {
                    const itemData = { id: change.doc.id, ...change.doc.data() };
                    if (change.type === 'modified') {
                        itemStatus[itemData.id] = itemData.status || 'available'; // 'available' or 'unavailable'
                        itemVisibility[itemData.id] = itemData.visible === undefined ? true : itemData.visible; // 'visible' or 'hidden'
                        renderProducts(); // Re-renderiza os produtos para refletir mudanças
                    }
                });
            });

            // Escuta mudanças em 'ingredients' para visibilidade
            const ingredientsRef = collection(db, 'ingredients');
            const unsubscribeIngredients = onSnapshot(ingredientsRef, (snapshot) => {
                snapshot.docChanges().forEach(change => {
                    const ingredientData = { id: change.doc.id, ...change.doc.data() };
                    if (change.type === 'modified') {
                        ingredientVisibility[ingredientData.id] = ingredientData.available === undefined ? true : ingredientData.available;
                    }
                });
            });

            // Escuta mudanças em 'pizzaExtras' para visibilidade
            const pizzaExtrasRef = collection(db, 'pizzaExtras');
            const unsubscribePizzaExtras = onSnapshot(pizzaExtrasRef, (snapshot) => {
                snapshot.docChanges().forEach(change => {
                    const extraData = { id: change.doc.id, ...change.doc.data() };
                    if (change.type === 'modified') {
                        extraVisibility[extraData.id] = extraData.available === undefined ? true : extraData.available;
                    }
                });
            });

            // Escuta mudanças em 'deliveryFees' para atualizar taxas de entrega
            const deliveryFeesRef = collection(db, 'deliveryFees');
            const unsubscribeDeliveryFees = onSnapshot(deliveryFeesRef, (snapshot) => {
                allDeliveryFees = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateNeighborhoods(); // Re-popula o dropdown de bairros
                updateDeliveryFeeDisplay(); // Atualiza a taxa de entrega exibida, se aplicável
            });

            // Cleanup listeners quando o componente for desmontado (se aplicável)
            // return () => {
            //     unsubscribeItems();
            //     unsubscribeIngredients();
            //     unsubscribePizzaExtras();
            //     unsubscribeDeliveryFees();
            // };
        }

        function listenToTableStatus() {
            const tableStatusContainer = document.getElementById('client-modal-table-select');
            if (!tableStatusContainer) return;

            // Preenche com mesas fixas
            tableStatusContainer.innerHTML = '<option value="">Selecionar Mesa...</option>';
            for (let i = 1; i <= NUMERO_DE_MESAS; i++) {
                const option = document.createElement('option');
                option.value = `Mesa ${i}`;
                option.textContent = `Mesa ${i}`;
                tableStatusContainer.appendChild(option);
            }
        }

        async function loadOrderForEditing(orderId) {
            isEditing = true;
            currentOrderId = orderId;
            const orderRef = doc(db, 'orders', orderId);
            try {
                const orderDoc = await getDoc(orderRef);
                if (orderDoc.exists()) {
                    const orderData = orderDoc.data();
                    
                    // Mapeia os itens carregados para o formato esperado na aplicação
                    order = orderData.items.map(item => ({
                        ...item,
                        id: item.id || item.itemId, // Usa o ID original do item
                        name: item.name,
                        price: item.price,
                        quantity: item.quantity,
                        options: item.options || {},
                        uniqueId: item.uniqueId || `${item.id}-${Date.now()}` // Garante um uniqueId
                    }));
                    
                    clientData = {
                        name: orderData.client?.name || null,
                        contact: orderData.client?.contact || null,
                        address: orderData.client?.address || null,
                        table: orderData.client?.table || null,
                        observation: orderData.client?.observation || null,
                        changeFor: orderData.client?.changeFor || null,
                    };
                    currentOrderType = orderData.orderType || 'Retirada';
                    paymentMethod = orderData.paymentMethod || null;

                    // Atualiza a UI com os dados carregados
                    updateOrderDisplay();
                    updateClientDataSummary();

                    // Define o tipo de pedido selecionado
                    const orderTypeInput = document.querySelector(`input[name="orderType"][value="${currentOrderType}"]`);
                    if (orderTypeInput) orderTypeInput.checked = true;
                    else document.querySelector(`input[name="orderType"][value="Retirada"]`).checked = true; // Fallback para Retirada

                    // Carrega o delivery fee se existir
                    if (orderData.deliveryFee) {
                        document.getElementById('delivery-fee-summary').classList.remove('hidden');
                        document.getElementById('delivery-fee-value').textContent = `R$ ${orderData.deliveryFee.toFixed(2).replace('.', ',')}`;
                        // Atualiza o endereço no clientData se ele já não estiver completo
                        if (clientData.address) {
                            clientData.address.deliveryFee = orderData.deliveryFee;
                        } else {
                            clientData.address = { deliveryFee: orderData.deliveryFee };
                        }
                    }

                    showTemporaryFeedback('Pedido carregado para edição.');
                } else {
                    showAlert('Pedido não encontrado.');
                    window.location.href = 'venda-balcao.html'; // Redireciona se o pedido não existir
                }
            } catch (error) {
                console.error("Erro ao carregar pedido para edição:", error);
                showAlert('Ocorreu um erro ao carregar o pedido. Por favor, tente novamente.');
                window.location.href = 'venda-balcao.html';
            }
        }
        
        // --- Funções de IA ---

        async function handleAnalyzeAI() {
            const pasteArea = document.getElementById('whatsapp-paste-area');
            const resultArea = document.getElementById('ai-result-area');
            const aiLoading = document.getElementById('ai-loading');
            const aiResultContent = document.getElementById('ai-result-content');
            const errorMessageEl = document.getElementById('ai-error-message');
            const confirmBtn = document.getElementById('confirm-ai-order-btn');

            const textToAnalyze = pasteArea.value.trim();
            if (!textToAnalyze) {
                errorMessageEl.textContent = 'Por favor, cole o texto da conversa para análise.';
                errorMessageEl.classList.remove('hidden');
                return;
            }

            errorMessageEl.classList.add('hidden');
            aiLoading.classList.remove('hidden');
            aiResultContent.classList.add('hidden');
            confirmBtn.disabled = true;

            try {
                // !!! IMPORTANTE: Substitua esta URL pela sua API de backend que processa o texto com um modelo de IA !!!
                // Exemplo: const response = await fetch('/api/analyze-whatsapp', { method: 'POST', body: JSON.stringify({ text: textToAnalyze }), headers: {'Content-Type': 'application/json'} });
                // const data = await response.json();
                // parsedAiOrder = data; 
                
                // Simulação de chamada de API e resposta
                await new Promise(resolve => setTimeout(resolve, 1500)); // Simula delay da API
                
                // Resposta simulada da API (formato esperado: { items: [{ name: 'Pizza Calabresa Grande', quantity: 1, price: 45.00, category: 'Pizzas' }, ...], orderType: 'Delivery', clientName: 'João Silva', ... })
                const simulatedApiResponse = {
                    items: [
                        { name: 'Pizza Grande Calabresa', quantity: 1, price: 45.00, category: 'Pizzas' },
                        { name: 'Refrigerante 2L', quantity: 1, price: 8.00, category: 'Bebidas' },
                        { name: 'Batata Frita Grande', quantity: 1, price: 25.00, category: 'Porções' }
                    ],
                    orderType: 'Delivery',
                    clientName: 'João Silva',
                    clientContact: '(11) 98765-4321',
                    address: { street: 'Rua das Flores', number: '123', neighborhood: 'Centro' },
                    observation: 'Entregar na portaria'
                };

                parsedAiOrder = simulatedApiResponse; // Armazena a resposta parseada

                if (parsedAiOrder && parsedAiOrder.items && parsedAiOrder.items.length > 0) {
                    let formattedResult = '<div class="space-y-2">';
                    formattedResult += `<p class="font-semibold">Tipo de Pedido: ${parsedAiOrder.orderType || 'Não especificado'}</p>`;
                    if (parsedAiOrder.clientName) formattedResult += `<p class="font-semibold">Cliente: ${parsedAiOrder.clientName}</p>`;
                    if (parsedAiOrder.clientContact) formattedResult += `<p class="font-semibold">Contato: ${parsedAiOrder.clientContact}</p>`;
                    if (parsedAiOrder.address) formattedResult += `<p class="font-semibold">Endereço: ${parsedAiOrder.address.street}, ${parsedAiOrder.address.number} - ${parsedAiOrder.address.neighborhood}</p>`;
                    if (parsedAiOrder.observation) formattedResult += `<p class="font-semibold">Observação: ${parsedAiOrder.observation}</p>`;
                    
                    formattedResult += '<h4 class="font-bold mt-4">Itens:</h4><ul class="list-disc list-inside">';
                    parsedAiOrder.items.forEach(item => {
                        formattedResult += `<li>${item.quantity}x ${item.name} (R$ ${item.price.toFixed(2).replace('.', ',')})</li>`;
                    });
                    formattedResult += '</ul>';
                    formattedResult += '</div>';
                    
                    aiResultContent.innerHTML = formattedResult;
                    confirmBtn.disabled = false;
                } else {
                    throw new Error('Nenhum item válido encontrado na análise.');
                }

            } catch (error) {
                console.error("Erro na análise de IA:", error);
                errorMessageEl.textContent = `Erro ao analisar o pedido: ${error.message}. Tente novamente ou insira manualmente.`;
                errorMessageEl.classList.remove('hidden');
                aiResultContent.innerHTML = '<p class="text-gray-400">Falha ao analisar.</p>';
            } finally {
                aiLoading.classList.add('hidden');
                aiResultContent.classList.remove('hidden');
            }
        }

        async function handleConfirmAIOrder() {
            if (!parsedAiOrder || !parsedAiOrder.items || parsedAiOrder.items.length === 0) {
                showAlert('Nenhum pedido válido da IA para confirmar.');
                return;
            }

            const aiOrder = parsedAiOrder;

            // Atualiza o tipo de pedido se especificado
            if (aiOrder.orderType) {
                currentOrderType = aiOrder.orderType;
                const orderTypeInput = document.querySelector(`input[name="orderType"][value="${currentOrderType}"]`);
                if (orderTypeInput) orderTypeInput.checked = true;
            }

            // Preenche dados do cliente e endereço se disponíveis
            clientData.name = aiOrder.clientName || clientData.name; // Usa o valor da IA se disponível, senão mantém o atual
            clientData.contact = aiOrder.clientContact || clientData.contact;
            clientData.address = aiOrder.address || clientData.address;
            clientData.observation = aiOrder.observation || clientData.observation;
            
            // Tenta encontrar os items correspondentes no cardápio e adiciona ao pedido
            let successfullyAddedCount = 0;
            for (const aiItem of aiOrder.items) {
                // Busca um item no cardápio que corresponda ao nome do item da IA
                const itemInMenu = allItems.find(menuItem => 
                    menuItem.name.toLowerCase().includes(aiItem.name.toLowerCase()) || 
                    aiItem.name.toLowerCase().includes(menuItem.name.toLowerCase()) ||
                    (menuItem.category && menuItem.category.toLowerCase() === aiItem.category?.toLowerCase()) // Tenta combinar categoria também
                );

                if (itemInMenu) {
                    // Cria um item para adicionar ao pedido
                    const newItem = {
                        ...itemInMenu, // Mantém todas as propriedades do item do cardápio
                        uniqueId: `${itemInMenu.id}-${Date.now()}`, // ID único temporário
                        quantity: aiItem.quantity,
                        price: itemInMenu.price, // Usa o preço do cardápio como base
                        options: { // Inicializa opções
                             // Tenta extrair adicionais ou detalhes se estiverem na descrição do AI
                             // Isso pode exigir processamento mais avançado da resposta da IA
                        }
                    };
                    
                    // Se o item da IA especifica um preço e é diferente do cardápio, pode haver uma consideração.
                    // Por segurança, usamos o preço do cardápio, a menos que seja uma promoção explícita.
                    if (aiItem.price && aiItem.price !== itemInMenu.price && !itemInMenu.isPromotion) {
                        console.warn(`Preço do item AI (${aiItem.name}) é diferente do cardápio. Usando preço do cardápio: R$ ${itemInMenu.price.toFixed(2).replace('.', ',')}`);
                        // Poderia habilitar o uso do preço da IA com confirmação, se necessário:
                        // newItem.price = aiItem.price;
                    } else if (aiItem.price && itemInMenu.isPromotion) {
                        // Se for promoção, usa o preço da promoção
                        newItem.price = aiItem.promoPrice || aiItem.price;
                    }

                    order.push(newItem);
                    successfullyAddedCount++;
                } else {
                    console.warn(`Item da IA "${aiItem.name}" não encontrado no cardápio.`);
                    // Poderia adicionar um item "genérico" ou notificar o usuário
                }
            }

            updateOrderDisplay();
            updateClientDataSummary(); // Atualiza o resumo com os dados do cliente da IA

            // Fecha o modal de IA
            document.getElementById('ai-order-modal').style.display = 'none';
            
            if (successfullyAddedCount > 0) {
                showTemporaryFeedback(`${successfullyAddedCount} item(ns) adicionado(s) do pedido da IA.`);
            } else {
                showTemporaryFeedback('Nenhum item da IA pôde ser adicionado automaticamente. Verifique o cardápio ou insira manualmente.');
            }

            // Limpa o estado da IA para o próximo uso
            parsedAiOrder = null;
            document.getElementById('whatsapp-paste-area').value = '';
            document.getElementById('ai-result-content').innerHTML = '<p class="text-gray-400">Aguardando análise...</p>';
            document.getElementById('confirm-ai-order-btn').disabled = true;
        }


        // --- Funções de Utilidade ---

        function showAlert(message) {
            const modal = document.getElementById('alert-modal');
            const messageEl = document.getElementById('alert-message');
            const okBtn = document.getElementById('alert-ok-btn');

            messageEl.textContent = message;
            modal.style.display = 'flex';

            const closeHandler = () => {
                modal.style.display = 'none';
                okBtn.removeEventListener('click', closeHandler);
                modal.removeEventListener('click', modalCloseHandler); // Remove listener global do modal
            };
            
            // Handler para fechar o modal clicando fora dele
            const modalCloseHandler = (e) => {
                if (e.target === modal) {
                    closeHandler();
                }
            };
            
            okBtn.addEventListener('click', closeHandler, { once: true });
            modal.addEventListener('click', modalCloseHandler); // Adiciona listener para o clique no fundo
        }

        function showTemporaryFeedback(message) {
            const feedbackEl = document.createElement('div');
            feedbackEl.className = 'feedback-toast';
            feedbackEl.textContent = message;
            document.body.appendChild(feedbackEl);

            // Fade-in
            setTimeout(() => {
                feedbackEl.style.top = '30px';
                feedbackEl.style.opacity = '1';
            }, 100);

            // Fade-out
            setTimeout(() => {
                feedbackEl.style.opacity = '0';
                feedbackEl.style.top = '10px';
                setTimeout(() => feedbackEl.remove(), 300); // Remove o elemento do DOM após o fade-out
            }, pauseTime);
        }

        function showConfirm(message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirm-modal');
                const messageEl = document.getElementById('confirm-message');
                const yesBtn = document.getElementById('confirm-yes-btn');
                const noBtn = document.getElementById('confirm-no-btn');

                messageEl.textContent = message;
                modal.style.display = 'flex';

                const close = (result) => {
                    modal.style.display = 'none';
                    yesBtn.removeEventListener('click', yesHandler);
                    noBtn.removeEventListener('click', noHandler);
                    modal.removeEventListener('click', modalCloseHandler); // Remove listener global do modal
                    resolve(result);
                };

                const yesHandler = () => close(true);
                const noHandler = () => close(false);
                 // Handler para fechar o modal clicando fora dele
                 const modalCloseHandler = (e) => {
                    if (e.target === modal) {
                        close(false); // Clicar no fundo fecha como 'Não'
                    }
                };

                yesBtn.addEventListener('click', yesHandler, { once: true });
                noBtn.addEventListener('click', noHandler, { once: true });
                modal.addEventListener('click', modalCloseHandler); // Adiciona listener para o clique no fundo
            });
        }

        function setupEventListeners() {
            const mainContainer = document.querySelector('.main-container');
            const sidebar = document.querySelector('.sidebar-nav');
            const mainContent = document.querySelector('.main-content');

            // --- Sidebar Logic ---
            document.addEventListener('mousemove', (e) => {
                // Se o mouse estiver a menos de 20px da borda esquerda, abre a sidebar
                if (e.clientX < 20) mainContainer.classList.add('sidebar-open');
            });
            sidebar.addEventListener('mouseleave', () => mainContainer.classList.remove('sidebar-open'));
            mainContent.addEventListener('mouseenter', () => mainContainer.classList.remove('sidebar-open')); // Fecha a sidebar quando o mouse entra no conteúdo principal

            // --- Main Page UI Listeners ---
            document.getElementById('search-product').addEventListener('input', renderProducts);
            document.getElementById('cancel-order-btn').addEventListener('click', async () => {
                if (isEditing) {
                    const confirmed = await showConfirm('Deseja descartar as alterações e fechar esta edição?');
                    if (confirmed) window.close(); // Fecha a aba/janela atual se for edição
                    return;
                }
                // Verifica se há algo no pedido ou nos dados do cliente para cancelar
                if (order.length > 0 || clientData.name || clientData.table || clientData.address) {
                    const confirmed = await showConfirm('Deseja cancelar o pedido atual e limpar os dados do cliente?');
                    if (confirmed) resetOrderState();
                } else {
                    showTemporaryFeedback('Nenhum pedido em andamento para cancelar.');
                }
            });
            document.getElementById('finalize-order-btn').addEventListener('click', finalizeOrderCheck);
            document.getElementById('order-type-selector').addEventListener('change', (e) => {
                const newOrderType = e.target.value;
                // Se o tipo de pedido mudar, limpa os dados do cliente para evitar inconsistências
                if (newOrderType !== currentOrderType && (order.length > 0 || clientData.name || clientData.address || clientData.table)) {
                    showConfirm(`Alterar o tipo de pedido para ${newOrderType} irá limpar os dados do cliente e do pedido atual. Deseja continuar?`).then(confirmed => {
                        if (confirmed) {
                            currentOrderType = newOrderType;
                            resetOrderState(); // Limpa tudo e começa um novo pedido
                        } else {
                            e.target.value = currentOrderType; // Reverte a seleção do radio button
                        }
                    });
                } else {
                    currentOrderType = newOrderType;
                    // Se não houver dados no pedido, apenas atualiza o tipo
                    updateClientDataSummary(); // Atualiza o resumo para refletir o novo tipo
                }
            });
            // Listener para o container de itens do pedido (usando delegação de eventos)
            document.getElementById('order-items-container').addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-item-btn');
                const editItemBtn = e.target.closest('.edit-item-btn'); // Botão genérico para editar
                const quantityBtn = e.target.closest('.quantity-btn'); // Botões de +/-

                if (removeBtn) {
                    const uniqueId = removeBtn.dataset.uniqueId;
                    order = order.filter(item => item.uniqueId !== uniqueId);
                    updateOrderDisplay();
                } else if (editItemBtn) {
                    const uniqueId = editItemBtn.dataset.uniqueId;
                    const itemIndex = order.findIndex(item => item.uniqueId === uniqueId);
                    if (itemIndex !== -1) {
                        const itemToEdit = order[itemIndex];
                        // Abre o modal apropriado dependendo do tipo de item
                        if (itemToEdit.isBurger) {
                            const baseBurgerItem = allItems.find(item => item.id === itemToEdit.id); // Encontra o item base original
                            if(baseBurgerItem) openBurgerBuilderModal(baseBurgerItem, itemIndex, itemToEdit);
                        } else if (itemToEdit.isPizza || itemToEdit.isCustomizable) {
                            // Se for uma pizza customizável ou com metades/adicionais
                            openPizzaExtrasBuilderModal(uniqueId);
                        } else {
                            // Outros itens customizáveis (se houver)
                            // Pode ser necessário um modal genérico de edição de item
                            console.warn("Edição de item simples não implementada.");
                        }
                    }
                } else if (quantityBtn) {
                    const uniqueId = quantityBtn.dataset.uniqueId;
                    const action = quantityBtn.dataset.action;
                    const itemIndex = order.findIndex(item => item.uniqueId === uniqueId);

                    if (itemIndex !== -1) {
                        if (action === 'increase') {
                            order[itemIndex].quantity++;
                        } else if (action === 'decrease' && order[itemIndex].quantity > 1) {
                            order[itemIndex].quantity--;
                        }
                        updateOrderDisplay();
                    }
                }
            });

            // --- Modal Buttons ---
            document.getElementById('open-client-data-modal-btn').addEventListener('click', openClientDataModal);
            
            // Modal IA
            const aiModalBtn = document.getElementById('open-ai-modal-btn');
            const aiModal = document.getElementById('ai-order-modal');
            if (aiModalBtn && aiModal) {
                aiModalBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Limpa o estado do modal de IA antes de abrir
                    const pasteArea = aiModal.querySelector('#whatsapp-paste-area');
                    const resultContent = aiModal.querySelector('#ai-result-content');
                    const errorMessage = aiModal.querySelector('#ai-error-message');
                    const confirmBtn = aiModal.querySelector('#confirm-ai-order-btn');
                    
                    if (pasteArea) pasteArea.value = '';
                    if (resultContent) resultContent.innerHTML = '<p class="text-gray-400">Aguardando análise...</p>';
                    if (errorMessage) errorMessage.classList.add('hidden');
                    if (confirmBtn) confirmBtn.disabled = true;
                    
                    parsedAiOrder = null; // Reseta os dados da última análise
                    
                    aiModal.style.display = 'flex';
                });
            } else {
                console.error("Botão ou modal de IA não encontrado.");
            }

            // --- Listeners for buttons INSIDE modals (that don't close them) ---
            document.getElementById('ask-extras-yes-btn').addEventListener('click', () => {
                const askModal = document.getElementById('ask-pizza-extras-modal');
                // Recupera o uniqueId ou a chave do estado guardada no dataset do modal
                const uniqueId = askModal.dataset.editUniqueId || askModal.dataset.newPizzaStateKey;
                openPizzaExtrasBuilderModal(uniqueId);
                askModal.style.display = 'none';
            });
            
            document.getElementById('add-custom-burger-btn').addEventListener('click', () => addCustomBurgerToOrder(document.getElementById('burger-builder-modal').dataset.editIndex !== undefined ? document.getElementById('burger-builder-modal').dataset.editIndex : null));
            document.getElementById('add-pizza-with-extras-btn').addEventListener('click', () => confirmPizzaExtras(document.getElementById('pizza-extras-builder-modal').dataset.editUniqueId || document.getElementById('pizza-extras-builder-modal').dataset.newPizzaStateKey));
            document.getElementById('confirm-client-data-btn').addEventListener('click', confirmClientData);
            document.getElementById('analyze-ai-btn').addEventListener('click', handleAnalyzeAI);
            document.getElementById('confirm-ai-order-btn').addEventListener('click', handleConfirmAIOrder);

            // --- Global listener para fechar qualquer modal clicando no fundo ---
            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                    // Limpa dados temporários se necessário ao fechar um modal específico
                    if (e.target.id === 'ai-order-modal') {
                        parsedAiOrder = null; // Limpa os dados da IA se fechar o modal sem confirmar
                    }
                }
            });
        }

        // Inicializa a aplicação quando o DOM estiver pronto e o Firebase estiver configurado
        document.addEventListener('DOMContentLoaded', () => {
            // O onAuthStateChanged já lida com a inicialização principal após o login
        });

    </script>
</body>
</html>
