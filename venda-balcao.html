<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Venda Balcão - Sâmia Pizzaria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="https://raw.githubusercontent.com/WillianSoares93/cardapio_samia_PDV/refs/heads/main/logo.png" type="image/png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #DDE2E6;
            visibility: hidden;
            overflow: hidden;
        }
        .main-container {
            display: grid;
            grid-template-columns: 0px 1fr;
            height: 100vh;
            transition: grid-template-columns 0.3s ease-in-out;
        }
        .main-container.sidebar-open {
            grid-template-columns: 80px 1fr;
        }
        .main-content {
            display: grid;
            grid-template-columns: 400px 1fr 180px;
            gap: 1rem;
            padding: 1rem;
            height: 100%;
            overflow: hidden;
        }
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
        }
        .product-card {
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.5rem;
            text-align: center;
            background-color: #ffffff;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            aspect-ratio: 1 / 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
        }
        .product-card.unavailable {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #f3f4f6;
        }
         .product-card.unavailable::after {
            content: 'Esgotado';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-15deg);
            background-color: rgba(185, 28, 28, 0.8);
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.875rem;
        }
        .product-card:hover:not(.unavailable) {
            transform: translateY(-4px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border-color: #3b82f6;
        }
        .category-btn {
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
            color: #374151;
            transition: all 0.2s ease-in-out;
        }
        .category-btn.active, .category-btn:hover {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        .sidebar-nav {
            background-color: #2C3E50;
            overflow: hidden;
        }
        .sidebar-btn {
            color: #BDC3C7;
            transition: all 0.2s ease-in-out;
        }
        .sidebar-btn:hover {
            background-color: #34495E;
            color: white;
        }
        .sidebar-btn.active {
            background-color: #3b82f6;
            color: white;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
             background-color: #fff;
             padding: 1.5rem;
             border-radius: 0.5rem;
             box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
             width: 90%;
             max-width: 500px;
        }
        .ingredient-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            border: 1px solid #d1d5db;
            transition: all 0.2s ease-in-out;
        }
        .ingredient-option:hover {
            background-color: #f9fafb;
            border-color: #3b82f6;
        }
        .ingredient-option.selected-ingredient {
            background-color: #dbeafe;
            border-color: #3b82f6;
        }
        .quantity-btn {
            background-color: #e5e7eb;
            color: #4b5563;
            transition: all 0.2s ease-in-out;
            width: 28px;
            height: 28px;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            font-weight: bold;
        }
        .quantity-btn:hover:not(:disabled) {
            background-color: #d1d5db;
        }
        .half-pizza-selection-active {
            background-color: #fef9c3;
            border: 2px dashed #f59e0b;
        }
        .scope-button {
            transition: all 0.2s ease-in-out;
            padding: 4px 12px;
            border-radius: 9999px;
            background-color: #e5e7eb;
            color: #4b5563;
            font-size: 0.875rem;
        }
        .scope-button.active {
            background-color: #3b82f6;
            color: white;
        }
        .feedback-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #22c55e;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            z-index: 2000;
            font-size: 0.875rem;
            font-weight: 500;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            opacity: 0;
            transition: opacity 0.3s ease-in-out, top 0.3s ease-in-out;
        }
        .payment-option {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .payment-option:hover {
            background-color: #f9fafb;
            border-color: #10b981;
        }
        .payment-option.selected {
            background-color: #e6ffed;
            border-color: #10b981;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
        }
        .payment-option input[type="radio"] {
            margin-right: 12px;
            accent-color: #10b981;
        }
        .payment-option .icon {
            font-size: 1.5rem;
            margin-right: 12px;
            color: #4b5563;
        }
        .payment-option.selected .icon {
            color: #10b981;
        }
        .payment-option .text-content {
            flex-grow: 1;
        }
        .payment-option .text-content h4 {
            font-weight: 600;
            color: #1f2937;
        }
        .payment-option .text-content p {
            font-size: 0.875rem;
            color: #6b7280;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="main-container">
        <aside class="sidebar-nav flex flex-col justify-between py-4">
            <div>
                <a href="pdv.html" class="sidebar-btn w-full flex flex-col items-center p-3 text-xs" title="Painel de Pedidos">
                    <i class="fas fa-receipt fa-2x"></i>
                    <span>PEDIDOS</span>
                </a>
                <a href="venda-balcao.html" class="sidebar-btn active w-full flex flex-col items-center p-3 text-xs" title="Venda Balcão">
                    <i class="fas fa-cash-register fa-2x"></i>
                    <span>BALCÃO</span>
                </a>
                <a href="editar-cardapio.html" class="sidebar-btn w-full flex flex-col items-center p-3 text-xs" title="Editar Cardápio">
                    <i class="fas fa-edit fa-2x"></i>
                    <span>EDITAR</span>
                </a>
                <a href="gerenciar.html" class="sidebar-btn w-full flex flex-col items-center p-3 text-xs" title="Gerenciar Itens">
                    <i class="fas fa-tasks fa-2x"></i>
                    <span>GERENCIAR</span>
                </a>
                <a href="relatorio.html" class="sidebar-btn w-full flex flex-col items-center p-3 text-xs" title="Relatórios">
                    <i class="fas fa-chart-line fa-2x"></i>
                    <span>RELATÓRIOS</span>
                </a>
            </div>
            <div class="space-y-2">
                <div class="text-center px-2 py-3 text-xs text-gray-400 overflow-hidden" title="Usuário Logado">
                    <i class="fas fa-user-circle fa-2x mb-1"></i>
                    <span id="current-user" class="block truncate"></span>
                </div>
                <button id="logout-btn" class="sidebar-btn w-full flex flex-col items-center p-3 text-xs" title="Sair">
                    <i class="fas fa-sign-out-alt fa-2x text-red-400"></i>
                    <span class="text-red-400">SAIR</span>
                </button>
            </div>
        </aside>

        <div class="flex flex-col h-screen overflow-hidden">
             <header class="bg-white shadow-md">
                <div class="max-w-7xl mx-auto py-2 px-4 sm:px-6 lg:px-8 flex justify-start items-center">
                    <h1 class="text-xl font-bold text-gray-800">Venda Balcão</h1>
                </div>
            </header>
            <main class="main-content flex-grow">
                <section class="bg-white rounded-lg shadow-md flex flex-col overflow-hidden">
                    <div class="flex-shrink-0">
                        <div class="p-4 border-b flex justify-between items-start">
                            <div>
                                <label class="text-sm font-medium text-gray-700 mb-2 block">Tipo de Pedido</label>
                                <div id="order-type-selector" class="flex space-x-4">
                                    <label class="flex items-center">
                                        <input type="radio" name="orderType" value="Retirada" checked class="form-radio text-blue-600">
                                        <span class="ml-2">Retirada</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="orderType" value="Delivery" class="form-radio text-blue-600">
                                        <span class="ml-2">Delivery</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="orderType" value="Mesa" class="form-radio text-blue-600">
                                        <span class="ml-2">Mesa</span>
                                    </label>
                                </div>
                            </div>
                            <div class="flex flex-col space-y-2">
                                <button id="open-client-data-modal-btn" class="px-3 py-2 bg-blue-500 text-white font-bold rounded-md hover:bg-blue-600 text-sm whitespace-nowrap">
                                    <i class="fas fa-user mr-1"></i> Dados do Cliente
                                </button>
                                <button id="open-ai-modal-btn" class="px-3 py-2 bg-purple-600 text-white font-bold rounded-md hover:bg-purple-700 text-sm whitespace-nowrap">
                                    <i class="fas fa-robot mr-1"></i> Pedido com IA
                                </button>
                            </div>
                        </div>
                        <div id="client-data-summary" class="p-4 border-b hidden bg-blue-50 text-sm text-blue-800">
                        </div>
                    </div>

                    <div id="order-items-container" class="flex-grow overflow-y-auto p-4 space-y-4">
                         <div id="empty-cart-message" class="text-center text-gray-400 p-10 flex flex-col items-center justify-center h-full">
                            <i class="fas fa-shopping-cart fa-3x mb-4"></i>
                            <p class="font-medium">Carrinho Vazio</p>
                        </div>
                    </div>
                    
                    <div class="flex-shrink-0 p-4 border-t bg-gray-50">
                        <div class="flex justify-between items-center text-gray-600 text-sm">
                            <span>Total de Itens</span>
                            <span id="total-items">0</span>
                        </div>
                         <div id="delivery-fee-summary" class="flex justify-between items-center text-gray-600 text-sm hidden">
                            <span>Taxa de Entrega</span>
                            <span id="delivery-fee-value">R$ 0,00</span>
                        </div>
                        <div class="flex justify-between items-center text-2xl font-bold text-gray-800 mt-2 pt-2 border-t">
                            <span>VALOR A PAGAR</span>
                            <span id="total-value">R$ 0,00</span>
                        </div>
                        <div class="mt-4 grid grid-cols-2 gap-4">
                            <button id="cancel-order-btn" class="w-full py-3 bg-red-600 text-white font-bold rounded-md hover:bg-red-700">Cancelar</button>
                            <button id="finalize-order-btn" class="w-full py-3 bg-green-600 text-white font-bold rounded-md hover:bg-green-700">Finalizar</button>
                        </div>
                    </div>
                </section>

                <section id="product-display" class="bg-white rounded-lg shadow-md flex flex-col p-4 overflow-hidden">
                     <div class="mb-4">
                        <input type="text" id="search-product" placeholder="Buscar produto..." class="w-full p-2 border rounded-md">
                    </div>
                    <div class="product-grid flex-grow overflow-y-auto pr-2" id="product-grid"></div>
                </section>

                <section id="category-list" class="flex flex-col p-0 space-y-2 overflow-y-auto"></section>
            </main>
        </div>
    </div>
    
    <!-- Modal de Opções de Pizza -->
    <div id="pizza-option-modal" class="modal">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <div class="flex justify-between items-center pb-3 border-b">
                <h3 id="modal-pizza-name" class="text-xl font-bold text-gray-900"></h3>
                <button class="text-gray-400 hover:text-gray-600 text-2xl font-bold" onclick="this.closest('.modal').style.display='none'">&times;</button>
            </div>
            <div id="pizza-size-options" class="mt-4 space-y-2"></div>
        </div>
    </div>

    <!-- Modal de Montagem de Hambúrguer -->
    <div id="burger-builder-modal" class="modal">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl">
            <div class="flex justify-between items-center pb-3 border-b">
                <h3 id="modal-burger-name" class="text-xl font-bold text-gray-900">Monte seu Hambúrguer</h3>
                <button class="text-gray-400 hover:text-gray-600 text-2xl font-bold" onclick="this.closest('.modal').style.display='none'">&times;</button>
            </div>
            <div id="burger-ingredients-container" class="mt-4 mb-4 max-h-80 overflow-y-auto p-2 space-y-4"></div>
            <div class="flex justify-between items-center bg-gray-100 p-4 rounded-lg mt-4">
                <span class="text-lg font-bold">Total do Hambúrguer:</span>
                <span id="burger-total-price" class="text-2xl font-bold text-blue-600">R$ 0,00</span>
            </div>
            <div class="mt-6 flex justify-end space-x-4">
                <button class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300" onclick="this.closest('.modal').style.display='none'">Cancelar</button>
                <button id="add-custom-burger-btn" class="px-6 py-2 bg-green-600 text-white font-bold rounded-md hover:bg-green-700">Adicionar ao Pedido</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para Adicionais da Pizza -->
    <div id="pizza-extras-builder-modal" class="modal">
         <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl">
            <div class="flex justify-between items-center pb-3 border-b">
                <h3 id="pizza-extras-builder-title" class="text-xl font-bold text-gray-900">Adicionais para a Pizza</h3>
                <button class="text-gray-400 hover:text-gray-600 text-2xl font-bold" onclick="this.closest('.modal').style.display='none'">&times;</button>
            </div>
            <div id="pizza-extras-scope-buttons" class="flex flex-wrap gap-2 my-4 border-b pb-4"></div>
            <div id="pizza-extras-ingredients-container" class="mb-4 max-h-80 overflow-y-auto p-2"></div>
            <div class="flex justify-between items-center bg-gray-100 p-4 rounded-lg mt-4">
                <span class="text-lg font-bold">Total da Pizza:</span>
                <span id="pizza-extras-total-price" class="text-2xl font-bold text-blue-600">R$ 0,00</span>
            </div>
            <div class="mt-6 flex justify-end">
                <button id="add-pizza-with-extras-btn" class="px-6 py-2 bg-green-600 text-white font-bold rounded-md hover:bg-green-700">Confirmar Adicionais</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para perguntar sobre adicionais -->
    <div id="ask-pizza-extras-modal" class="modal">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
             <p class="text-lg font-semibold text-gray-800 mb-4 text-center">Deseja adicionar ingredientes extras?</p>
            <div class="flex justify-center gap-4">
                <button class="px-6 py-2 bg-gray-300 text-gray-800 rounded-lg font-bold hover:bg-gray-400 transition" onclick="this.closest('.modal').style.display='none'">Não, obrigado</button>
                <button id="ask-extras-yes-btn" class="px-6 py-2 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 transition">Sim, quero!</button>
            </div>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div id="alert-modal" class="modal">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
             <p id="alert-message" class="text-lg font-semibold text-gray-800 mb-4 text-center">Message goes here.</p>
            <div class="flex justify-center">
                <button id="alert-ok-btn" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition">OK</button>
            </div>
        </div>
    </div>

    <!-- Custom Confirm Modal -->
    <div id="confirm-modal" class="modal">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
             <p id="confirm-message" class="text-lg font-semibold text-gray-800 mb-6 text-center">Are you sure?</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-no-btn" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-lg font-bold hover:bg-gray-400 transition">Não</button>
                <button id="confirm-yes-btn" class="px-6 py-2 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition">Sim</button>
            </div>
        </div>
    </div>

    <!-- Client Data Modal -->
    <div id="client-data-modal" class="modal">
        <div class="modal-content max-h-[90vh] overflow-y-auto">
            
            <div class="flex justify-between items-center pb-3 border-b sticky top-0 bg-white z-20">
                <h3 id="client-modal-title" class="text-xl font-bold text-gray-900">Dados do Cliente e Pagamento</h3>
                <button class="text-gray-400 hover:text-gray-600 text-2xl font-bold" onclick="this.closest('.modal').style.display='none'">&times;</button>
            </div>
            
            <div class="pt-4">
                <div id="client-modal-error-message" class="hidden mt-0 p-3 bg-red-100 text-red-700 rounded-md text-sm"></div>
                <div class="mt-4 space-y-4">
                    <div id="client-modal-retirada-fields" class="hidden space-y-4">
                        <div>
                            <label for="client-modal-name-retirada" class="text-sm font-medium text-gray-700">Nome do Cliente</label>
                            <input type="text" id="client-modal-name-retirada" class="w-full mt-1 p-2 border rounded-md">
                        </div>
                        <div>
                            <label for="client-modal-contact-retirada" class="text-sm font-medium text-gray-700">Contato (Opcional)</label>
                            <input type="tel" id="client-modal-contact-retirada" class="w-full mt-1 p-2 border rounded-md">
                        </div>
                    </div>
                    <div id="client-modal-delivery-fields" class="hidden space-y-4">
                        <div>
                            <label for="client-modal-name-delivery" class="text-sm font-medium text-gray-700">Nome do Cliente</label>
                            <input type="text" id="client-modal-name-delivery" class="w-full mt-1 p-2 border rounded-md">
                        </div>
                        <div>
                            <label for="client-modal-contact-delivery" class="text-sm font-medium text-gray-700">Contato</label>
                            <input type="tel" id="client-modal-contact-delivery" class="w-full mt-1 p-2 border rounded-md">
                        </div>
                        <div>
                            <label for="client-modal-street" class="text-sm font-medium text-gray-700">Rua</label>
                            <input type="text" id="client-modal-street" class="w-full mt-1 p-2 border rounded-md">
                        </div>
                        <div>
                            <label for="client-modal-number" class="text-sm font-medium text-gray-700">Número</label>
                            <input type="text" id="client-modal-number" class="w-full mt-1 p-2 border rounded-md">
                        </div>
                        <div>
                            <label for="client-modal-neighborhood" class="text-sm font-medium text-gray-700">Bairro</label>
                            <select id="client-modal-neighborhood" class="w-full mt-1 p-2 border rounded-md"></select>
                        </div>
                    </div>
                    <div id="client-modal-mesa-fields" class="hidden space-y-4">
                        <div>
                            <label for="client-modal-table-select" class="text-sm font-medium text-gray-700">Selecionar Mesa Livre</label>
                            <select id="client-modal-table-select" class="w-full mt-1 p-2 border rounded-md"></select>
                        </div>
                        <div>
                            <label for="client-modal-name-mesa" class="text-sm font-medium text-gray-700">Nome do Cliente (Opcional)</label>
                            <input type="text" id="client-modal-name-mesa" class="w-full mt-1 p-2 border rounded-md">
                        </div>
                    </div>
                    <div class="mt-4">
                        <label for="client-modal-observation" class="text-sm font-medium text-gray-700">Observação (Geral)</label>
                        <textarea id="client-modal-observation" rows="2" class="w-full mt-1 p-2 border rounded-md"></textarea>
                    </div>

                    <div class="pt-4 border-t border-gray-200">
                        <h4 class="text-md font-bold text-gray-800 mb-3">Forma de Pagamento</h4>
                        <div id="payment-options-container" class="flex flex-col gap-2">
                            <label class="payment-option selected" data-method="Dinheiro">
                                <input type="radio" name="modalPaymentMethod" value="Dinheiro" class="form-radio" checked>
                                <i class="fas fa-money-bill-wave icon"></i>
                                <div class="text-content">
                                    <h4>Dinheiro</h4>
                                </div>
                            </label>
                            <label class="payment-option" data-method="Cartão de Crédito/Débito">
                                <input type="radio" name="modalPaymentMethod" value="Cartão de Crédito/Débito" class="form-radio">
                                <i class="fas fa-credit-card icon"></i>
                                <div class="text-content">
                                    <h4>Cartão de Crédito/Débito</h4>
                                </div>
                            </label>
                            <label class="payment-option" data-method="Pix">
                                <input type="radio" name="modalPaymentMethod" value="Pix" class="form-radio">
                                <i class="fas fa-qrcode icon"></i>
                                <div class="text-content">
                                    <h4>Pix</h4>
                                </div>
                            </label>
                            <label class="payment-option" data-method="A Definir">
                                <input type="radio" name="modalPaymentMethod" value="A Definir" class="form-radio">
                                <i class="fas fa-question-circle icon"></i>
                                <div class="text-content">
                                    <h4>A Definir</h4>
                                </div>
                            </label>
                        </div>

                        <div id="troco-input-container" class="mt-4 p-3 border border-gray-300 rounded-lg bg-gray-50">
                            <label for="modal-trocoPara" class="block text-gray-700 text-sm font-medium mb-2">
                                Troco para (R$):
                            </label>
                            <input type="number" id="modal-trocoPara" step="0.01" min="0" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none mb-2" placeholder="0,00">
                            <p class="text-gray-600 text-sm">
                                Troco: <span id="modal-trocoTotalDisplay" class="font-bold text-green-600">R$ 0,00</span>
                            </p>
                        </div>
                    </div>
                </div>
            <div class="mt-6 flex justify-end space-x-4">
                <button class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300" onclick="this.closest('.modal').style.display='none'">Cancelar</button>
                <button id="confirm-client-data-btn" class="px-6 py-2 bg-green-600 text-white font-bold rounded-md hover:bg-green-700">Confirmar e Finalizar</button>
            </div>
        </div>
        </div>
    </div>
    
    <!-- Modal Pedido com IA -->
    <div id="ai-order-modal" class="modal">
        <div class="modal-content !max-w-3xl">
            <div class="flex justify-between items-center pb-3 border-b">
                <h3 class="text-xl font-bold text-gray-900">Montar Pedido com IA</h3>
                <button class="text-gray-400 hover:text-gray-600 text-2xl font-bold" onclick="this.closest('.modal').style.display='none'">&times;</button>
            </div>
            <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="whatsapp-paste-area" class="block text-sm font-medium text-gray-700 mb-2">Cole a conversa do WhatsApp aqui:</label>
                    <textarea id="whatsapp-paste-area" rows="10" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-purple-500" placeholder="Ex: Olá, gostaria de uma pizza grande de calabresa e um refrigerante..."></textarea>
                    <button id="analyze-ai-btn" class="mt-4 w-full py-2 bg-purple-600 text-white font-bold rounded-md hover:bg-purple-700 flex items-center justify-center">
                        <i class="fas fa-magic mr-2"></i> Analisar Pedido
                    </button>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Pedido Interpretado:</label>
                    <div id="ai-result-area" class="p-4 border rounded-md bg-gray-50 min-h-[240px]">
                        <div id="ai-loading" class="hidden text-center text-gray-500">
                            <i class="fas fa-spinner fa-spin text-2xl"></i>
                            <p class="mt-2">Analisando conversa...</p>
                        </div>
                        <div id="ai-result-content">
                             <p class="text-gray-400">Aguardando análise...</p>
                        </div>
                    </div>
                    <button id="confirm-ai-order-btn" class="mt-4 w-full py-2 bg-green-600 text-white font-bold rounded-md hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                        <i class="fas fa-check mr-2"></i> Confirmar e Adicionar
                    </button>
                </div>
            </div>
            <div id="ai-error-message" class="mt-4 hidden p-3 bg-red-100 text-red-700 rounded-md text-sm"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, doc, onSnapshot, query, getDocs, deleteDoc, where, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = {
           apiKey: "AIzaSyBJ44RVDGhBIlQBTx-pyIUp47XDKzRXk84",
           authDomain: "pizzaria-pdv.firebaseapp.com",
           projectId: "pizzaria-pdv",
           storageBucket: "pizzaria-pdv.firebasestorage.app",
           messagingSenderId: "304171744691",
           appId: "1:304171744691:web:e54d7f9fe55c7a75485fc6"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let allItems = [];
        let allIngredients = {};
        let allPizzaExtras = {};
        let allDeliveryFees = [];
        let order = [];
        let currentUserEmail = '';
        let currentOrderType = 'Retirada';
        let clientData = { name: null, contact: null, address: null, table: null, observation: null };
        let paymentMethod = null; 
        let pauseTime = 2000; 
        let initialUrlParamCheckDone = false; 
        let currentOrderId = null;
        let isEditing = false;
        let itemStatus = {}, itemVisibility = {}, itemExtrasStatus = {}, pizzaHalfStatus = {};
        let ingredientStatus = {}, ingredientVisibility = {};
        let extraStatus = {}, extraVisibility = {};
        let isSelectingHalfPizza = false;
        let firstHalfPizza = null;
        let currentPizzaExtrasState = {};
        const NUMERO_DE_MESAS = 12;
        let parsedAiOrder = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.body.style.visibility = 'visible';
                currentUserEmail = user.email;
                const currentUserEl = document.getElementById('current-user');
                if (currentUserEl) {
                    currentUserEl.textContent = currentUserEmail;
                }
                initializeAppLogic();
            } else {
                window.location.href = 'login.html?redirect=venda-balcao.html';
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        async function initializeAppLogic() {
            listenToStatusChanges();
            await fetchMenu();
            renderCategories();
            renderProducts();
            setupEventListeners();
            listenToTableStatus();
            
            const urlParams = new URLSearchParams(window.location.search);
            const orderIdFromUrl = urlParams.get('orderId');
            if (orderIdFromUrl) {
                loadOrderForEditing(orderIdFromUrl);
            }
        }

        async function fetchMenu() {
            try {
                const itemsCollection = collection(db, 'items');
                const ingredientsCollection = collection(db, 'ingredients');
                const pizzaExtrasCollection = collection(db, 'pizzaExtras');
                const deliveryFeesCollection = collection(db, 'deliveryFees');

                const [itemsSnapshot, ingredientsSnapshot, pizzaExtrasSnapshot, deliveryFeesSnapshot] = await Promise.all([
                    getDocs(itemsCollection),
                    getDocs(ingredientsCollection),
                    getDocs(pizzaExtrasCollection),
                    getDocs(deliveryFeesCollection)
                ]);

                allItems = itemsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                ingredientsSnapshot.docs.forEach(doc => {
                    allIngredients[doc.id] = { id: doc.id, ...doc.data() };
                });

                pizzaExtrasSnapshot.docs.forEach(doc => {
                    allPizzaExtras[doc.id] = { id: doc.id, ...doc.data() };
                });

                allDeliveryFees = deliveryFeesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            } catch (error) {
                console.error("Erro ao buscar cardápio:", error);
                showAlert("Não foi possível carregar o cardápio. Por favor, verifique sua conexão e tente novamente.");
            }
        }

        function renderCategories() {
            const categoryListEl = document.getElementById('category-list');
            if (!categoryListEl) return;

            const categories = [...new Set(allItems.map(item => item.category))].sort();
            
            categoryListEl.innerHTML = ''; // Limpa categorias anteriores

            categories.forEach(category => {
                const button = document.createElement('button');
                button.textContent = category;
                button.classList.add('category-btn', 'w-full', 'p-3', 'text-left', 'rounded-md', 'font-medium', 'text-sm');
                button.dataset.category = category;
                categoryListEl.appendChild(button);

                button.addEventListener('click', () => {
                    document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    renderProducts(category);
                });
            });

            // Ativa a primeira categoria por padrão se houver alguma
            if (categories.length > 0) {
                const firstCategoryButton = categoryListEl.querySelector(`[data-category="${categories[0]}"]`);
                if (firstCategoryButton) {
                    firstCategoryButton.classList.add('active');
                    renderProducts(categories[0]);
                }
            } else {
                 // Se não houver categorias, exibe mensagem
                 categoryListEl.innerHTML = '<p class="text-center text-gray-400 p-4">Nenhuma categoria encontrada.</p>';
            }
        }

        function renderProducts(selectedCategory = null) {
            const productGridEl = document.getElementById('product-grid');
            if (!productGridEl) return;

            productGridEl.innerHTML = ''; // Limpa o grid de produtos anterior

            const searchInput = document.getElementById('search-product');
            const searchTerm = searchInput.value.toLowerCase();

            let filteredItems = allItems;

            if (selectedCategory) {
                filteredItems = filteredItems.filter(item => item.category === selectedCategory);
            }

            if (searchTerm) {
                filteredItems = filteredItems.filter(item => 
                    item.name.toLowerCase().includes(searchTerm) ||
                    item.category.toLowerCase().includes(searchTerm)
                );
            }
            
            // Se não houver produtos para exibir, mostra mensagem
            if (filteredItems.length === 0) {
                productGridEl.innerHTML = '<p class="text-center text-gray-400 p-10 col-span-full">Nenhum produto encontrado.</p>';
                return;
            }

            filteredItems.forEach(item => {
                const card = document.createElement('div');
                card.classList.add('product-card');
                if (itemStatus[item.id] === 'unavailable') {
                    card.classList.add('unavailable');
                }

                card.innerHTML = `
                    <img src="${item.imageUrl || 'https://via.placeholder.com/120'}" alt="${item.name}" class="w-full h-24 object-cover rounded-t-md">
                    <div class="p-2 flex-grow flex flex-col justify-between">
                        <h4 class="text-xs font-bold text-gray-800 truncate">${item.name}</h4>
                        <p class="text-xs text-gray-500">${item.category}</p>
                        <p class="text-sm font-bold text-green-600 mt-1">R$ ${item.price.toFixed(2)}</p>
                    </div>
                `;

                if (itemStatus[item.id] !== 'unavailable') {
                    card.addEventListener('click', () => {
                        handleProductClick(item);
                    });
                }
                productGridEl.appendChild(card);
            });
        }

        function handleProductClick(item) {
            if (item.isCustomizable) {
                if (item.isBurger) {
                    openBurgerBuilderModal(item);
                } else {
                    // Pode ser uma pizza customizável que não seja hambúrguer
                    openPizzaExtrasBuilderModal(null, item); 
                }
            } else if (item.isPizza) {
                openPizzaOptionModal(item);
            } else {
                addItemToOrder(item);
            }
        }

        async function addItemToOrder(item, quantity = 1, options = {}) {
            const uniqueId = `${item.id}-${Date.now()}`; // Cria um ID único para cada item no pedido
            const newItem = {
                ...item,
                uniqueId,
                quantity,
                options: options || {} // Para guardar adicionais, observações específicas do item, etc.
            };

            // Verifica se é um item customizável e se precisa ser adicionado com configurações
            if (item.isCustomizable && !item.isBurger) { // Para pizzas customizáveis, mas não hambúrgueres (já tratados)
                 const existingItemIndex = order.findIndex(o => o.uniqueId === uniqueId); // Tenta encontrar se é uma edição
                if (existingItemIndex !== -1) {
                    order[existingItemIndex] = newItem;
                } else {
                     order.push(newItem);
                }
            } else {
                order.push(newItem);
            }
            
            updateOrderDisplay();
            showTemporaryFeedback(`${item.name} adicionado ao pedido.`);
        }

        function updateOrderDisplay() {
            const orderItemsContainer = document.getElementById('order-items-container');
            const totalItemsEl = document.getElementById('total-items');
            const totalValueEl = document.getElementById('total-value');
            const emptyCartMessage = document.getElementById('empty-cart-message');

            orderItemsContainer.innerHTML = ''; // Limpa a lista de itens do pedido

            let totalItems = 0;
            let totalPrice = 0;

            if (order.length === 0) {
                emptyCartMessage.classList.remove('hidden');
                totalItemsEl.textContent = '0';
                totalValueEl.textContent = 'R$ 0,00';
                return;
            } else {
                emptyCartMessage.classList.add('hidden');
            }

            order.forEach((item, index) => {
                totalItems += item.quantity;
                let itemPrice = item.price * item.quantity;

                const itemElement = document.createElement('div');
                itemElement.classList.add('flex', 'justify-between', 'items-center', 'p-4', 'bg-white', 'rounded-lg', 'shadow-sm', 'border');

                let itemDetailsHtml = `
                    <div class="flex-grow mr-4">
                        <p class="font-medium text-gray-800">${item.name}${item.options.observation ? ` (${item.options.observation})` : ''}</p>
                        <p class="text-xs text-gray-500">${item.quantity}x - R$ ${item.price.toFixed(2)}</p>
                `;

                // Adiciona detalhes de adicionais ou customizações
                if (item.options.ingredients && item.options.ingredients.length > 0) {
                    itemDetailsHtml += `<div class="text-xs text-green-600 mt-1">Adicionais: ${item.options.ingredients.map(ing => ing.name).join(', ')}</div>`;
                }
                if (item.options.halfPizzas && item.options.halfPizzas.length > 0) {
                    item.options.halfPizzas.forEach(half => {
                        itemDetailsHtml += `<div class="text-xs text-blue-600 mt-1">${half.side}: ${half.item ? half.item.name : 'Vazio'}</div>`;
                    });
                }
                 if (item.options.burgerIngredients && item.options.burgerIngredients.length > 0) {
                    itemDetailsHtml += `<div class="text-xs text-purple-600 mt-1">Ingredientes: ${item.options.burgerIngredients.map(ing => ing.name).join(', ')}</div>`;
                }

                itemDetailsHtml += `</div>`;

                itemElement.innerHTML = `
                    ${itemDetailsHtml}
                    <div class="flex items-center space-x-3">
                        <span class="font-bold text-gray-900">R$ ${(itemPrice).toFixed(2)}</span>
                        <div class="flex items-center space-x-1">
                            <button class="quantity-btn px-1" data-action="decrease" data-unique-id="${item.uniqueId}">-</button>
                            <span class="px-2 font-medium">${item.quantity}</span>
                            <button class="quantity-btn px-1" data-action="increase" data-unique-id="${item.uniqueId}">+</button>
                        </div>
                        ${(item.isCustomizable || item.isPizza) ? `
                            <button class="text-blue-500 hover:text-blue-700 edit-extras-btn" data-unique-id="${item.uniqueId}" title="Editar Adicionais/Montagem">
                                <i class="fas fa-edit"></i>
                            </button>
                        ` : ''}
                        <button class="text-red-500 hover:text-red-700 remove-item-btn" data-unique-id="${item.uniqueId}" title="Remover Item">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `;

                orderItemsContainer.appendChild(itemElement);
                totalPrice += itemPrice;
            });

            totalItemsEl.textContent = totalItems;
            totalValueEl.textContent = `R$ ${totalPrice.toFixed(2)}`;

            // Adiciona listener para botões de quantidade e remover dentro do loop
            document.querySelectorAll('.remove-item-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const uniqueId = btn.dataset.uniqueId;
                    order = order.filter(item => item.uniqueId !== uniqueId);
                    updateOrderDisplay();
                });
            });

            document.querySelectorAll('.quantity-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const uniqueId = btn.dataset.uniqueId;
                    const action = btn.dataset.action;
                    const itemIndex = order.findIndex(item => item.uniqueId === uniqueId);

                    if (itemIndex !== -1) {
                        if (action === 'increase') {
                            order[itemIndex].quantity++;
                        } else if (action === 'decrease' && order[itemIndex].quantity > 1) {
                            order[itemIndex].quantity--;
                        }
                        updateOrderDisplay();
                    }
                });
            });

            document.querySelectorAll('.edit-extras-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const uniqueId = btn.dataset.uniqueId;
                    const item = order.find(o => o.uniqueId === uniqueId);
                    if (item) {
                        if (item.isBurger) {
                             const baseBurger = allItems.find(i => i.id === item.id); // Pega o item original para referência
                             if(baseBurger) openBurgerBuilderModal(baseBurger, order.findIndex(o => o.uniqueId === uniqueId), item);
                        } else if (item.isPizza) {
                            openPizzaExtrasBuilderModal(uniqueId);
                        }
                    }
                });
            });
        }

        function openPizzaOptionModal(pizza) {
            const modal = document.getElementById('pizza-option-modal');
            const modalNameEl = document.getElementById('modal-pizza-name');
            const sizeOptionsEl = document.getElementById('pizza-size-options');
            
            modalNameEl.textContent = pizza.name;
            sizeOptionsEl.innerHTML = '';

            pizza.sizes.forEach(size => {
                const sizeButton = document.createElement('button');
                sizeButton.classList.add('px-4', 'py-2', 'bg-blue-100', 'text-blue-800', 'font-medium', 'rounded-md', 'hover:bg-blue-200', 'w-full', 'text-left');
                sizeButton.textContent = `${size.name} - R$ ${size.price.toFixed(2)}`;
                
                sizeButton.addEventListener('click', () => {
                    const selectedPizza = { ...pizza, price: size.price, size: size.name };
                    
                    // Verifica se a pizza customizável precisa de adicionais
                    if (pizza.hasExtras) {
                        openPizzaExtrasBuilderModal(null, selectedPizza); // Passa a pizza selecionada para adicionar
                    } else {
                        addItemToOrder(selectedPizza);
                    }
                    modal.style.display = 'none';
                });
                sizeOptionsEl.appendChild(sizeButton);
            });

            modal.style.display = 'flex';
        }

        function openBurgerBuilderModal(burgerItem, editIndex = null, existingItem = null) {
            const modal = document.getElementById('burger-builder-modal');
            const modalNameEl = document.getElementById('modal-burger-name');
            const ingredientsContainer = document.getElementById('burger-ingredients-container');
            const totalPriceEl = document.getElementById('burger-total-price');
            const addBtn = document.getElementById('add-custom-burger-btn');

            modalNameEl.textContent = `Monte seu ${burgerItem.name}`;
            ingredientsContainer.innerHTML = '';
            
            // Guarda o índice para saber se estamos editando
            if (editIndex !== null) {
                modal.dataset.editIndex = editIndex;
            } else {
                delete modal.dataset.editIndex;
            }

            let currentBurgerPrice = existingItem ? existingItem.price : burgerItem.price;
            let currentBurgerIngredients = existingItem ? [...existingItem.options.burgerIngredients] : []; // Copia para não modificar o original

            // Inicializa o estado dos ingredientes
            if (!ingredientStatus[burgerItem.id]) {
                ingredientStatus[burgerItem.id] = {};
                ingredientVisibility[burgerItem.id] = {};
            }
            
            // Limpa o estado anterior para este hambúrguer específico, se não estiver editando
            if (editIndex === null) {
                for (const ingredientId in ingredientStatus[burgerItem.id]) {
                    delete ingredientStatus[burgerItem.id][ingredientId];
                    delete ingredientVisibility[burgerItem.id][ingredientId];
                }
            }
            
            // Adiciona os ingredientes base do hambúrguer, se não estiverem já presentes
            if (burgerItem.ingredients && burgerItem.ingredients.length > 0) {
                burgerItem.ingredients.forEach(ingId => {
                    const ingredient = allIngredients[ingId];
                    if (ingredient) {
                        // Verifica se o ingrediente já está na lista de ingredientes do item existente
                        const alreadyAdded = currentBurgerIngredients.some(addedIng => addedIng.id === ingredient.id);
                        if (!alreadyAdded) {
                            currentBurgerIngredients.push({ ...ingredient, quantity: 1 });
                            if (!ingredientStatus[burgerItem.id][ingredient.id]) ingredientStatus[burgerItem.id][ingredient.id] = 'included';
                            if (!ingredientVisibility[burgerItem.id][ingredient.id]) ingredientVisibility[burgerItem.id][ingredient.id] = true;
                        }
                    }
                });
            }
            
            // Garante que ingredientes existentes estejam marcados
            if (existingItem && existingItem.options.burgerIngredients) {
                existingItem.options.burgerIngredients.forEach(ing => {
                    if (!ingredientStatus[burgerItem.id][ing.id]) ingredientStatus[burgerItem.id][ing.id] = 'included';
                    if (!ingredientVisibility[burgerItem.id][ing.id]) ingredientVisibility[burgerItem.id][ing.id] = true;
                });
            }
            
            // Carrega os ingredientes disponíveis para o hambúrguer
            const availableIngredients = Object.values(allIngredients)
                .filter(ing => ing.available) // Apenas ingredientes disponíveis
                .sort((a, b) => a.name.localeCompare(b.name)); // Ordena alfabeticamente
                
            availableIngredients.forEach(ingredient => {
                const ingredientElement = document.createElement('div');
                ingredientElement.classList.add('ingredient-option');
                
                const isIncluded = ingredientStatus[burgerItem.id]?.[ingredient.id] === 'included';
                const isOptional = burgerItem.optionalIngredients?.includes(ingredient.id);

                const quantity = currentBurgerIngredients.find(ing => ing.id === ingredient.id)?.quantity || 0;

                ingredientElement.innerHTML = `
                    <span class="font-medium text-gray-700">${ingredient.name}</span>
                    <div class="flex items-center space-x-2">
                        ${isOptional ? `
                            <div class="flex items-center space-x-1">
                                <button class="quantity-btn px-1" data-ingredient-id="${ingredient.id}" data-burger-id="${burgerItem.id}" data-action="decrease-burger-ing">-</button>
                                <span class="px-2 font-medium">${quantity}</span>
                                <button class="quantity-btn px-1" data-ingredient-id="${ingredient.id}" data-burger-id="${burgerItem.id}" data-action="increase-burger-ing">+</button>
                            </div>
                        ` : ''}
                        <i class="${isIncluded ? 'fas fa-check-circle text-green-500' : 'far fa-circle text-gray-400'} cursor-pointer text-xl"></i>
                    </div>
                `;
                
                ingredientElement.querySelector('i').addEventListener('click', () => {
                    const currentStatus = ingredientStatus[burgerItem.id]?.[ingredient.id] || 'excluded';
                    
                    if (currentStatus === 'excluded') {
                        if (isOptional) { // Só adiciona se for opcional e puder ser adicionado
                             ingredientStatus[burgerItem.id][ingredient.id] = 'included';
                             currentBurgerIngredients.push({ ...ingredient, quantity: 1 });
                             updateBurgerPriceAndDisplay(burgerItem.id, ingredientsContainer, totalPriceEl, addBtn, currentBurgerIngredients, burgerItem.price, null, existingItem);
                        } else {
                            // Tenta adicionar ingredientes base que não foram adicionados
                            const isBaseIngredient = burgerItem.ingredients?.includes(ingredient.id);
                            if (isBaseIngredient) {
                                ingredientStatus[burgerItem.id][ingredient.id] = 'included';
                                currentBurgerIngredients.push({ ...ingredient, quantity: 1 });
                                updateBurgerPriceAndDisplay(burgerItem.id, ingredientsContainer, totalPriceEl, addBtn, currentBurgerIngredients, burgerItem.price, null, existingItem);
                            }
                        }
                    } else {
                        // Remove o ingrediente (se for opcional)
                        if (isOptional) {
                            ingredientStatus[burgerItem.id][ingredient.id] = 'excluded';
                            currentBurgerIngredients = currentBurgerIngredients.filter(ing => ing.id !== ingredient.id);
                            updateBurgerPriceAndDisplay(burgerItem.id, ingredientsContainer, totalPriceEl, addBtn, currentBurgerIngredients, burgerItem.price, null, existingItem);
                        }
                    }
                     renderBurgerIngredients(burgerItem.id, ingredientsContainer, totalPriceEl, addBtn, currentBurgerIngredients, burgerItem.price, null, existingItem);
                });

                ingredientsContainer.appendChild(ingredientElement);
            });

            totalPriceEl.textContent = `R$ ${currentBurgerPrice.toFixed(2)}`;
            addBtn.onclick = () => addCustomBurgerToOrder(editIndex, burgerItem, currentBurgerIngredients);
            modal.style.display = 'flex';
        }

        function renderBurgerIngredients(burgerId, container, totalPriceEl, addBtn, currentIngredients, basePrice, editIndex, existingItem) {
            container.innerHTML = ''; // Limpa o container
            let currentTotal = basePrice;
            
            const availableIngredients = Object.values(allIngredients).filter(ing => ing.available).sort((a, b) => a.name.localeCompare(b.name));

            availableIngredients.forEach(ingredient => {
                 const ingredientElement = document.createElement('div');
                 ingredientElement.classList.add('ingredient-option');

                const isIncluded = ingredientStatus[burgerId]?.[ingredient.id] === 'included';
                const isOptional = burgerItem.optionalIngredients?.includes(ingredient.id); // Assume burgerItem is accessible or passed
                const quantity = currentIngredients.find(ing => ing.id === ingredient.id)?.quantity || 0;
                
                const ingredientPrice = ingredient.price || 0;

                if (isIncluded) {
                    if (isOptional) {
                         currentTotal += ingredientPrice * quantity;
                    } else {
                        // Ingredientes base que não tem preço adicional
                    }
                }
                
                ingredientElement.innerHTML = `
                    <span class="font-medium text-gray-700">${ingredient.name}${isOptional ? ` (+R$ ${ingredientPrice.toFixed(2)})` : ''}</span>
                    <div class="flex items-center space-x-2">
                        ${isOptional ? `
                            <div class="flex items-center space-x-1">
                                <button class="quantity-btn px-1" data-ingredient-id="${ingredient.id}" data-burger-id="${burgerId}" data-action="decrease-burger-ing">-</button>
                                <span class="px-2 font-medium">${quantity}</span>
                                <button class="quantity-btn px-1" data-ingredient-id="${ingredient.id}" data-burger-id="${burgerId}" data-action="increase-burger-ing">+</button>
                            </div>
                        ` : ''}
                        <i class="${isIncluded ? 'fas fa-check-circle text-green-500' : 'far fa-circle text-gray-400'} cursor-pointer text-xl"></i>
                    </div>
                `;

                ingredientElement.querySelector('i').addEventListener('click', () => {
                    const currentStatus = ingredientStatus[burgerId]?.[ingredient.id] || 'excluded';
                    
                    if (currentStatus === 'excluded') {
                        if (isOptional) {
                             ingredientStatus[burgerId][ingredient.id] = 'included';
                             currentIngredients.push({ ...ingredient, quantity: 1 });
                        } else {
                            const isBaseIngredient = burgerItem.ingredients?.includes(ingredient.id);
                            if (isBaseIngredient) {
                                ingredientStatus[burgerId][ingredient.id] = 'included';
                                currentIngredients.push({ ...ingredient, quantity: 1 });
                            }
                        }
                    } else {
                        if (isOptional) {
                            ingredientStatus[burgerId][ingredient.id] = 'excluded';
                            currentIngredients = currentIngredients.filter(ing => ing.id !== ingredient.id);
                        }
                    }
                     renderBurgerIngredients(burgerId, container, totalPriceEl, addBtn, currentIngredients, basePrice, editIndex, existingItem);
                });
                
                container.appendChild(ingredientElement);
            });

            // Adiciona listeners para os botões de quantidade de ingredientes
             container.querySelectorAll('.quantity-btn[data-action="decrease-burger-ing"], .quantity-btn[data-action="increase-burger-ing"]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const ingredientId = btn.dataset.ingredientId;
                    const action = btn.dataset.action;
                    const ingIndex = currentIngredients.findIndex(ing => ing.id === ingredientId);

                    if (ingIndex !== -1) {
                        if (action === 'increase-burger-ing') {
                            currentIngredients[ingIndex].quantity++;
                        } else if (action === 'decrease-burger-ing' && currentIngredients[ingIndex].quantity > 1) {
                            currentIngredients[ingIndex].quantity--;
                        }
                        updateBurgerPriceAndDisplay(burgerId, container, totalPriceEl, addBtn, currentIngredients, basePrice, editIndex, existingItem);
                    }
                });
            });
            
            updateBurgerPriceAndDisplay(burgerId, container, totalPriceEl, addBtn, currentIngredients, basePrice, editIndex, existingItem);
        }

        function updateBurgerPriceAndDisplay(burgerId, container, totalPriceEl, addBtn, currentBurgerIngredients, basePrice, editIndex, existingItem) {
            let currentTotal = basePrice;
            const currentBurgerItem = existingItem || allItems.find(item => item.id === burgerId); // Tenta encontrar o item original

            currentBurgerIngredients.forEach(ing => {
                const ingredient = allIngredients[ing.id];
                if (ingredient) {
                    currentTotal += (ingredient.price || 0) * ing.quantity;
                }
            });

            totalPriceEl.textContent = `R$ ${currentTotal.toFixed(2)}`;
            
            // Atualiza o botão de adicionar se estivermos editando
            if (editIndex !== null) {
                addBtn.onclick = () => addCustomBurgerToOrder(editIndex, currentBurgerItem, currentBurgerIngredients, currentTotal);
            } else {
                addBtn.onclick = () => addCustomBurgerToOrder(null, currentBurgerItem, currentBurgerIngredients, currentTotal);
            }
        }

        function addCustomBurgerToOrder(editIndex, burgerItem, ingredients, finalPrice = null) {
            const burgerToAdd = {
                ...burgerItem,
                uniqueId: editIndex !== null ? order[editIndex].uniqueId : `${burgerItem.id}-${Date.now()}`,
                quantity: 1,
                price: finalPrice || burgerItem.price, // Usa o preço final calculado ou o base
                options: {
                    ...order[editIndex]?.options, // Mantém observações se estiver editando
                    burgerIngredients: ingredients.map(ing => ({ id: ing.id, name: ing.name, quantity: ing.quantity })),
                    observation: document.getElementById('burger-builder-modal')?.querySelector('#burger-observation')?.value || ''
                }
            };
            
            if (editIndex !== null) {
                order[editIndex] = burgerToAdd;
            } else {
                order.push(burgerToAdd);
            }
            
            // Limpa o estado do modal para o próximo uso
            delete modal.dataset.editIndex;
            ingredientStatus[burgerItem.id] = {};
            ingredientVisibility[burgerItem.id] = {};

            document.getElementById('burger-builder-modal').style.display = 'none';
            updateOrderDisplay();
            showTemporaryFeedback(`${burgerItem.name} adicionado ao pedido.`);
        }

        function openPizzaExtrasBuilderModal(uniqueId = null, pizzaToAdd = null) {
            const modal = document.getElementById('pizza-extras-builder-modal');
            const titleEl = document.getElementById('pizza-extras-builder-title');
            const scopeButtonsEl = document.getElementById('pizza-extras-scope-buttons');
            const ingredientsContainer = document.getElementById('pizza-extras-ingredients-container');
            const totalPriceEl = document.getElementById('pizza-extras-total-price');
            const confirmBtn = document.getElementById('add-pizza-with-extras-btn');

            let currentItem = null;
            let basePrice = 0;

            if (uniqueId) { // Editando um item existente
                currentItem = order.find(item => item.uniqueId === uniqueId);
                if (!currentItem) {
                    console.error("Item não encontrado para edição de adicionais:", uniqueId);
                    modal.style.display = 'none';
                    return;
                }
                basePrice = currentItem.price / currentItem.quantity; // Preço unitário base
                titleEl.textContent = `Adicionais para ${currentItem.name}`;
                modal.dataset.editUniqueId = uniqueId; // Guarda o ID para edição
            } else if (pizzaToAdd) { // Adicionando uma nova pizza com possíveis adicionais
                currentItem = pizzaToAdd;
                basePrice = pizzaToAdd.price;
                titleEl.textContent = `Adicionais para ${pizzaToAdd.name}`;
                modal.dataset.newPizza = JSON.stringify(pizzaToAdd); // Guarda a pizza para adicionar depois
            } else {
                console.error("Nenhum item ou pizza fornecido para o modal de adicionais.");
                modal.style.display = 'none';
                return;
            }

            // Limpa o estado anterior para este item
            if (!currentPizzaExtrasState[currentItem.uniqueId || modal.dataset.newPizza]) {
                currentPizzaExtrasState[currentItem.uniqueId || modal.dataset.newPizza] = {
                    selectedExtras: [],
                    halfPizzas: {}, // { side: 'left'/'right', pizzaItem: { ... } }
                    scope: 'full' // 'full', 'left', 'right'
                };
            }
            
            const state = currentPizzaExtrasState[currentItem.uniqueId || modal.dataset.newPizza];

            // Carrega adicionais existentes se estiver editando
            if (currentItem.options?.ingredients) {
                state.selectedExtras = [...currentItem.options.ingredients];
            }
            if (currentItem.options?.halfPizzas) {
                state.halfPizzas = { ...currentItem.options.halfPizzas };
            }
            
            // Reseta o escopo se for uma nova pizza ou se não houver metade selecionada
            if (!state.halfPizzas.left && !state.halfPizzas.right) {
                 state.scope = 'full';
            } else {
                 // Se já tem metades, mantém o escopo
            }

            // Renderiza botões de escopo
            scopeButtonsEl.innerHTML = `
                <button class="scope-button ${state.scope === 'full' ? 'active' : ''}" data-scope="full">Pizza Inteira</button>
                ${currentItem.hasHalfOption ? `
                    <button class="scope-button ${state.scope === 'left' ? 'active' : ''}" data-scope="left">Metade Esquerda</button>
                    <button class="scope-button ${state.scope === 'right' ? 'active' : ''}" data-scope="right">Metade Direita</button>
                ` : ''}
            `;
            scopeButtonsEl.querySelectorAll('.scope-button').forEach(btn => {
                btn.addEventListener('click', () => {
                    state.scope = btn.dataset.scope;
                    renderPizzaExtrasIngredients(currentItem, basePrice, state, ingredientsContainer, totalPriceEl, confirmBtn);
                    // Atualiza a classe active nos botões de escopo
                    scopeButtonsEl.querySelectorAll('.scope-button').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
            });
            
            renderPizzaExtrasIngredients(currentItem, basePrice, state, ingredientsContainer, totalPriceEl, confirmBtn);
            
            confirmBtn.onclick = () => confirmPizzaExtras(currentItem.uniqueId || modal.dataset.newPizza);
            modal.style.display = 'flex';
        }

        function renderPizzaExtrasIngredients(item, basePrice, state, container, totalPriceEl, confirmBtn) {
            container.innerHTML = ''; // Limpa o container de ingredientes
            let currentTotal = basePrice;
            
            // Se estivermos selecionando metades, precisamos renderizar os ingredientes de forma diferente
            if (state.scope === 'left' || state.scope === 'right') {
                const side = state.scope;
                const existingHalf = state.halfPizzas[side];
                
                // Se não houver item selecionado para essa metade, oferece opções
                if (!existingHalf) {
                    container.innerHTML = `
                        <p class="text-gray-500 mb-4">Selecione o item para a ${side === 'left' ? 'metade esquerda' : 'metade direita'}:</p>
                        <div id="half-pizza-selection-container" class="grid grid-cols-2 gap-4"></div>
                    `;
                    const halfSelectionContainer = container.querySelector('#half-pizza-selection-container');
                    
                    // Lista de todas as pizzas para escolher
                    Object.values(allItems).filter(i => i.isPizza && !i.isCustomizable && i.hasHalfOption).forEach(pizza => {
                         const pizzaOption = document.createElement('button');
                         pizzaOption.classList.add('product-card', 'bg-white', 'p-3', 'text-center', 'cursor-pointer');
                         pizzaOption.innerHTML = `
                            <h4 class="text-xs font-bold text-gray-800 truncate mb-1">${pizza.name}</h4>
                            <p class="text-xs text-gray-500 mb-2">${pizza.category}</p>
                            <p class="text-sm font-bold text-green-600">R$ ${pizza.price.toFixed(2)}</p>
                         `;
                         pizzaOption.addEventListener('click', () => {
                             state.halfPizzas[side] = { pizzaItem: pizza, price: pizza.price };
                             renderPizzaExtrasIngredients(item, basePrice, state, container, totalPriceEl, confirmBtn); // Renderiza novamente com o item selecionado
                         });
                         halfSelectionContainer.appendChild(pizzaOption);
                    });
                    
                    // Limpa o preço total, pois ainda não foi definido
                    totalPriceEl.textContent = `R$ ${basePrice.toFixed(2)}`; // Mostra o preço base da pizza inteira
                    confirmBtn.disabled = true; // Desabilita confirmar até que as metades sejam definidas
                    return;
                } else {
                    // Renderiza os adicionais para a metade selecionada
                    const halfPizzaItem = existingHalf.pizzaItem;
                    currentTotal = basePrice + existingHalf.price; // Preço base da pizza inteira + preço da metade

                    // Renderiza o nome da metade selecionada
                     const selectedHalfEl = document.createElement('div');
                     selectedHalfEl.classList.add('text-sm', 'font-medium', 'text-blue-700', 'mb-4', 'p-2', 'rounded-md', 'bg-blue-50', 'border', 'border-blue-200');
                     selectedHalfEl.innerHTML = `
                        <p>Metade ${side === 'left' ? 'Esquerda' : 'Direita'}: <strong>${halfPizzaItem.name}</strong> <span class="text-xs">(R$ ${existingHalf.price.toFixed(2)})</span></p>
                        <button class="text-red-500 hover:text-red-700 remove-half-btn ml-4" data-side="${side}">Remover</button>
                    `;
                    container.appendChild(selectedHalfEl);

                    // Adiciona listener para remover metade
                    selectedHalfEl.querySelector('.remove-half-btn').addEventListener('click', () => {
                        delete state.halfPizzas[side];
                        renderPizzaExtrasIngredients(item, basePrice, state, container, totalPriceEl, confirmBtn); // Renderiza novamente
                    });

                    const availableExtras = Object.values(allPizzaExtras).filter(extra => extra.available).sort((a, b) => a.name.localeCompare(b.name));
                    
                    availableExtras.forEach(extra => {
                        const extraElement = document.createElement('div');
                        extraElement.classList.add('ingredient-option');
                        
                        const isSelected = state.selectedExtras.some(selExtra => selExtra.id === extra.id && selExtra.side === side);
                        const extraPrice = extra.price || 0;
                        
                        if (isSelected) currentTotal += extraPrice;

                        extraElement.innerHTML = `
                            <span class="font-medium text-gray-700">${extra.name} (+R$ ${extraPrice.toFixed(2)})</span>
                            <i class="${isSelected ? 'fas fa-check-circle text-green-500' : 'far fa-circle text-gray-400'} cursor-pointer text-xl"></i>
                        `;

                        extraElement.querySelector('i').addEventListener('click', () => {
                            if (isSelected) {
                                state.selectedExtras = state.selectedExtras.filter(selExtra => !(selExtra.id === extra.id && selExtra.side === side));
                            } else {
                                state.selectedExtras.push({ id: extra.id, name: extra.name, price: extraPrice, side: side });
                            }
                            renderPizzaExtrasIngredients(item, basePrice, state, container, totalPriceEl, confirmBtn);
                        });
                        container.appendChild(extraElement);
                    });
                }
            } else { // Se o escopo for 'full'
                const availableExtras = Object.values(allPizzaExtras).filter(extra => extra.available).sort((a, b) => a.name.localeCompare(b.name));
                
                availableExtras.forEach(extra => {
                    const extraElement = document.createElement('div');
                    extraElement.classList.add('ingredient-option');
                    
                    const isSelected = state.selectedExtras.some(selExtra => selExtra.id === extra.id && selExtra.side === 'full');
                    const extraPrice = extra.price || 0;
                    
                    if (isSelected) currentTotal += extraPrice;

                    extraElement.innerHTML = `
                        <span class="font-medium text-gray-700">${extra.name} (+R$ ${extraPrice.toFixed(2)})</span>
                        <i class="${isSelected ? 'fas fa-check-circle text-green-500' : 'far fa-circle text-gray-400'} cursor-pointer text-xl"></i>
                    `;

                    extraElement.querySelector('i').addEventListener('click', () => {
                        if (isSelected) {
                            state.selectedExtras = state.selectedExtras.filter(selExtra => !(selExtra.id === extra.id && selExtra.side === 'full'));
                        } else {
                            state.selectedExtras.push({ id: extra.id, name: extra.name, price: extraPrice, side: 'full' });
                        }
                        renderPizzaExtrasIngredients(item, basePrice, state, container, totalPriceEl, confirmBtn);
                    });
                    container.appendChild(extraElement);
                });
            }
            
            totalPriceEl.textContent = `R$ ${currentTotal.toFixed(2)}`;

            // Habilita/desabilita o botão de confirmar
            const hasLeftHalf = state.halfPizzas.left;
            const hasRightHalf = state.halfPizzas.right;

            if (!hasLeftHalf && (state.scope === 'left' || state.scope === 'right')) {
                confirmBtn.disabled = true;
            } else if (!hasRightHalf && (state.scope === 'left' || state.scope === 'right')) {
                 confirmBtn.disabled = true;
            } else {
                confirmBtn.disabled = false;
            }
        }

        function confirmPizzaExtras(stateKey) {
            const modal = document.getElementById('pizza-extras-builder-modal');
            const state = currentPizzaExtrasState[stateKey];
            const editUniqueId = modal.dataset.editUniqueId;
            const newPizzaData = modal.dataset.newPizza ? JSON.parse(modal.dataset.newPizza) : null;

            let finalItem = {};
            let finalPrice = 0;

            if (editUniqueId) { // Edição de item existente
                const itemIndex = order.findIndex(item => item.uniqueId === editUniqueId);
                if (itemIndex !== -1) {
                    finalItem = { ...order[itemIndex] };
                    finalPrice = parseFloat(document.getElementById('pizza-extras-total-price').textContent.replace('R$ ', '').replace(',', '.'));
                    
                    // Atualiza opções
                    finalItem.options.ingredients = state.selectedExtras;
                    finalItem.options.halfPizzas = Object.values(state.halfPizzas).map(half => ({
                        side: half.side,
                        item: half.pizzaItem, // Salva o item inteiro da metade
                        price: half.price
                    }));

                    finalItem.price = finalPrice; // Atualiza o preço total do item
                    order[itemIndex] = finalItem;
                }
            } else if (newPizzaData) { // Adicionando nova pizza
                finalPrice = parseFloat(document.getElementById('pizza-extras-total-price').textContent.replace('R$ ', '').replace(',', '.'));
                
                finalItem = {
                    ...newPizzaData,
                    uniqueId: `${newPizzaData.id}-${Date.now()}`,
                    quantity: 1,
                    price: finalPrice,
                    options: {
                        ingredients: state.selectedExtras,
                        halfPizzas: Object.values(state.halfPizzas).map(half => ({
                            side: half.side,
                            item: half.pizzaItem,
                            price: half.price
                        })),
                        observation: '' // Pode adicionar um campo para observação específica da pizza
                    }
                };
                order.push(finalItem);
            }

            // Limpa o estado do modal
            delete currentPizzaExtrasState[stateKey];
            delete modal.dataset.editUniqueId;
            delete modal.dataset.newPizza;

            modal.style.display = 'none';
            updateOrderDisplay();
            showTemporaryFeedback(`Adicionais confirmados para ${finalItem.name}.`);
        }
        
        function openClientDataModal() {
            const modal = document.getElementById('client-data-modal');
            const modalTitleEl = document.getElementById('client-modal-title');
            const errorMessageEl = document.getElementById('client-modal-error-message');
            
            const retiradaFields = document.getElementById('client-modal-retirada-fields');
            const deliveryFields = document.getElementById('client-modal-delivery-fields');
            const mesaFields = document.getElementById('client-modal-mesa-fields');

            errorMessageEl.classList.add('hidden');
            errorMessageEl.textContent = '';

            // Define o título baseado no tipo de pedido
            modalTitleEl.textContent = `Dados do Cliente e Pagamento (${currentOrderType})`;

            // Mostra/esconde campos relevantes
            retiradaFields.classList.add('hidden');
            deliveryFields.classList.add('hidden');
            mesaFields.classList.add('hidden');

            switch (currentOrderType) {
                case 'Retirada':
                    retiradaFields.classList.remove('hidden');
                    break;
                case 'Delivery':
                    deliveryFields.classList.remove('hidden');
                    break;
                case 'Mesa':
                    mesaFields.classList.remove('hidden');
                    break;
            }

            // Preenche os campos com os dados atuais, se houver
            document.getElementById('client-modal-name-retirada').value = clientData.name || '';
            document.getElementById('client-modal-contact-retirada').value = clientData.contact || '';
            
            document.getElementById('client-modal-name-delivery').value = clientData.name || '';
            document.getElementById('client-modal-contact-delivery').value = clientData.contact || '';
            document.getElementById('client-modal-street').value = clientData.address?.street || '';
            document.getElementById('client-modal-number').value = clientData.address?.number || '';
            document.getElementById('client-modal-observation').value = clientData.observation || '';
            
            document.getElementById('client-modal-table-select').value = clientData.table || '';
            document.getElementById('client-modal-name-mesa').value = clientData.name || '';

            // Carrega bairros se for delivery
            if (currentOrderType === 'Delivery') {
                loadNeighborhoods();
                // Seleciona o bairro correto se já tiver endereço
                if (clientData.address?.neighborhood) {
                    setTimeout(() => { // Pequeno delay para garantir que o select foi carregado
                        document.getElementById('client-modal-neighborhood').value = clientData.address.neighborhood;
                    }, 50);
                }
            }
            
            // Preenche a forma de pagamento
            const paymentOptionsContainer = document.getElementById('payment-options-container');
            paymentOptionsContainer.querySelectorAll('.payment-option').forEach(option => {
                const radio = option.querySelector('input[type="radio"]');
                if (radio.value === paymentMethod) {
                    option.classList.add('selected');
                    radio.checked = true;
                    toggleTrocoInput(option); // Atualiza a visibilidade do campo de troco
                } else {
                    option.classList.remove('selected');
                }
            });

            // Preenche o campo de troco
            const trocoParaInput = document.getElementById('modal-trocoPara');
            trocoParaInput.value = clientData.changeFor || '';
            updateTrocoDisplay();

            modal.style.display = 'flex';
        }

        function loadNeighborhoods() {
            const selectEl = document.getElementById('client-modal-neighborhood');
            selectEl.innerHTML = '<option value="">Selecione um bairro...</option>';
            
            // Obtém bairros únicos dos dados de entrega
            const neighborhoods = [...new Set(allDeliveryFees.map(fee => fee.neighborhood))].sort();
            
            neighborhoods.forEach(neighborhood => {
                const option = document.createElement('option');
                option.value = neighborhood;
                option.textContent = neighborhood;
                selectEl.appendChild(option);
            });
        }

        function toggleTrocoInput(selectedPaymentOption) {
            const trocoInputContainer = document.getElementById('troco-input-container');
            const paymentMethod = selectedPaymentOption.dataset.method;

            if (paymentMethod === 'Dinheiro') {
                trocoInputContainer.classList.remove('hidden');
            } else {
                trocoInputContainer.classList.add('hidden');
                document.getElementById('modal-trocoPara').value = ''; // Limpa o campo de troco
                updateTrocoDisplay(); // Atualiza o display do troco
            }
        }

        function updateTrocoDisplay() {
            const trocoParaInput = document.getElementById('modal-trocoPara');
            const trocoTotalDisplay = document.getElementById('modal-trocoTotalDisplay');
            const totalValue = parseFloat(document.getElementById('total-value').textContent.replace('R$ ', '').replace(',', '.'));
            const trocoPara = parseFloat(trocoParaInput.value || '0');

            let troco = 0;
            if (trocoPara >= totalValue) {
                troco = trocoPara - totalValue;
                trocoTotalDisplay.textContent = `R$ ${troco.toFixed(2)}`;
                trocoTotalDisplay.classList.remove('text-red-600');
                trocoTotalDisplay.classList.add('text-green-600');
            } else {
                trocoTotalDisplay.textContent = 'Valor insuficiente';
                trocoTotalDisplay.classList.remove('text-green-600');
                trocoTotalDisplay.classList.add('text-red-600');
            }
        }

        document.getElementById('modal-trocoPara').addEventListener('input', updateTrocoDisplay);

        document.getElementById('payment-options-container').addEventListener('click', (e) => {
            const targetLabel = e.target.closest('.payment-option');
            if (targetLabel) {
                document.querySelectorAll('.payment-option').forEach(opt => opt.classList.remove('selected'));
                targetLabel.classList.add('selected');
                toggleTrocoInput(targetLabel);
            }
        });


        async function confirmClientData() {
            const modal = document.getElementById('client-data-modal');
            const errorMessageEl = document.getElementById('client-modal-error-message');
            errorMessageEl.classList.add('hidden');
            errorMessageEl.textContent = '';

            let isValid = true;
            const selectedPaymentOption = document.querySelector('#payment-options-container .payment-option.selected');
            paymentMethod = selectedPaymentOption.dataset.method;

            // Limpa dados antigos para garantir consistência
            clientData = { name: null, contact: null, address: null, table: null, observation: null };
            clientData.observation = document.getElementById('client-modal-observation').value;
            if (selectedPaymentOption.dataset.method === 'Dinheiro') {
                clientData.changeFor = document.getElementById('modal-trocoPara').value;
            }

            // Coleta dados baseados no tipo de pedido
            switch (currentOrderType) {
                case 'Retirada':
                    clientData.name = document.getElementById('client-modal-name-retirada').value.trim();
                    clientData.contact = document.getElementById('client-modal-contact-retirada').value.trim();
                    if (!clientData.name) {
                        errorMessageEl.textContent = 'O nome do cliente é obrigatório.';
                        isValid = false;
                    }
                    break;
                case 'Delivery':
                    clientData.name = document.getElementById('client-modal-name-delivery').value.trim();
                    clientData.contact = document.getElementById('client-modal-contact-delivery').value.trim();
                    const street = document.getElementById('client-modal-street').value.trim();
                    const number = document.getElementById('client-modal-number').value.trim();
                    const neighborhood = document.getElementById('client-modal-neighborhood').value;
                    
                    if (!clientData.name) { errorMessageEl.textContent = 'O nome do cliente é obrigatório.'; isValid = false; }
                    if (!clientData.contact) { errorMessageEl.textContent += (errorMessageEl.textContent ? '\n' : '') + 'O contato é obrigatório.'; isValid = false; }
                    if (!street) { errorMessageEl.textContent += (errorMessageEl.textContent ? '\n' : '') + 'A rua é obrigatória.'; isValid = false; }
                    if (!number) { errorMessageEl.textContent += (errorMessageEl.textContent ? '\n' : '') + 'O número é obrigatório.'; isValid = false; }
                    if (!neighborhood) { errorMessageEl.textContent += (errorMessageEl.textContent ? '\n' : '') + 'O bairro é obrigatório.'; isValid = false; }
                    
                    if (isValid) {
                        clientData.address = { street, number, neighborhood };
                    }
                    break;
                case 'Mesa':
                    clientData.table = document.getElementById('client-modal-table-select').value;
                    clientData.name = document.getElementById('client-modal-name-mesa').value.trim(); // Nome opcional para mesa
                    if (!clientData.table) {
                        errorMessageEl.textContent = 'Selecione uma mesa.';
                        isValid = false;
                    }
                    break;
            }

            if (!isValid) {
                errorMessageEl.classList.remove('hidden');
                return;
            }

            // Se tudo estiver válido, atualiza o resumo do cliente e fecha o modal
            updateClientDataSummary();
            modal.style.display = 'none';
            
            // Se o usuário clicar em "Confirmar e Finalizar" diretamente, chama a lógica de finalização
            if (document.getElementById('confirm-client-data-btn').textContent.includes('Finalizar')) {
                 finalizeOrderCheck();
            }
        }

        function updateClientDataSummary() {
            const summaryEl = document.getElementById('client-data-summary');
            if (!summaryEl) return;

            let summaryText = '';
            if (clientData.name) summaryText += `<strong>Cliente:</strong> ${clientData.name}<br>`;
            if (clientData.contact) summaryText += `<strong>Contato:</strong> ${clientData.contact}<br>`;
            if (clientData.address) summaryText += `<strong>Endereço:</strong> ${clientData.address.street}, ${clientData.address.number} - ${clientData.address.neighborhood}<br>`;
            if (clientData.table) summaryText += `<strong>Mesa:</strong> ${clientData.table}<br>`;
            if (clientData.observation) summaryText += `<strong>Obs:</strong> ${clientData.observation}<br>`;
            if (paymentMethod) summaryText += `<strong>Pagamento:</strong> ${paymentMethod}<br>`;
            if (clientData.changeFor) summaryText += `<strong>Troco para:</strong> R$ ${parseFloat(clientData.changeFor).toFixed(2)}<br>`;

            if (summaryText) {
                summaryEl.innerHTML = summaryText;
                summaryEl.classList.remove('hidden');
            } else {
                summaryEl.classList.add('hidden');
            }
        }

        async function finalizeOrderCheck() {
            if (order.length === 0 && !clientData.name && !clientData.table) {
                showAlert('Nenhum item no pedido ou dados de cliente/mesa informados.');
                return;
            }

            // Garante que os dados do cliente estejam completos antes de finalizar
            if (!clientData.name && !clientData.table && currentOrderType !== 'Retirada') { // Retirada não exige mesa/endereço
                 const confirmed = await showConfirm('Os dados do cliente não foram completamente preenchidos. Deseja preenchê-los agora?');
                 if (confirmed) {
                    // Abre o modal de dados do cliente, mas com foco em confirmar e finalizar
                    document.getElementById('confirm-client-data-btn').textContent = 'Confirmar e Finalizar'; // Mudando o texto para indicar a ação
                    openClientDataModal();
                 }
                 return; // Interrompe a finalização até que os dados sejam preenchidos
            }
            
            // Se o modal de cliente estiver aberto, apenas confirma os dados
            if (document.getElementById('client-data-modal').style.display === 'flex') {
                // O botão dentro do modal já tem a função de confirmar e finalizar
                // Apenas precisamos garantir que ele está com o texto correto
                document.getElementById('confirm-client-data-btn').textContent = 'Confirmar e Finalizar';
                return; 
            }

            // Se os dados do cliente já estão preenchidos e o modal não está aberto, prossegue para a finalização
            const confirmed = await showConfirm('Tem certeza que deseja finalizar este pedido?');
            if (confirmed) {
                await submitOrder();
            }
        }

        async function submitOrder() {
            const orderData = {
                items: order,
                totalItems: parseInt(document.getElementById('total-items').textContent),
                totalValue: parseFloat(document.getElementById('total-value').textContent.replace('R$ ', '').replace(',', '.')),
                client: clientData,
                orderType: currentOrderType,
                paymentMethod: paymentMethod,
                timestamp: serverTimestamp(),
                status: 'Pending', // Novo status padrão
                createdBy: currentUserEmail
            };

            if (document.getElementById('delivery-fee-summary').classList.contains('hidden') === false) {
                orderData.deliveryFee = parseFloat(document.getElementById('delivery-fee-value').textContent.replace('R$ ', '').replace(',', '.'));
            }

            try {
                let orderRef;
                if (isEditing && currentOrderId) {
                    orderRef = doc(db, 'orders', currentOrderId);
                    await updateDoc(orderRef, { ...orderData, status: 'Updated' }); // Atualiza o status se for edição
                    showTemporaryFeedback('Pedido atualizado com sucesso!');
                } else {
                    orderRef = await addDoc(collection(db, 'orders'), orderData);
                    currentOrderId = orderRef.id; // Guarda o ID para caso de edição posterior
                    showTemporaryFeedback('Pedido finalizado com sucesso!');
                }
                
                resetOrderState(); // Limpa o estado após o envio
                // Opcional: redirecionar para outra página ou mostrar um resumo
                // window.location.href = 'pdv.html'; 
            } catch (error) {
                console.error("Erro ao finalizar pedido:", error);
                showAlert('Ocorreu um erro ao finalizar o pedido. Por favor, tente novamente.');
            }
        }

        function resetOrderState() {
            order = [];
            clientData = { name: null, contact: null, address: null, table: null, observation: null };
            paymentMethod = null;
            currentOrderId = null;
            isEditing = false;
            parsedAiOrder = null;
            
            updateOrderDisplay();
            updateClientDataSummary();
            
            // Limpa o modal de dados do cliente também
            document.getElementById('client-data-modal').style.display = 'none';
            document.getElementById('client-modal-name-retirada').value = '';
            document.getElementById('client-modal-contact-retirada').value = '';
            document.getElementById('client-modal-name-delivery').value = '';
            document.getElementById('client-modal-contact-delivery').value = '';
            document.getElementById('client-modal-street').value = '';
            document.getElementById('client-modal-number').value = '';
            document.getElementById('client-modal-neighborhood').value = '';
            document.getElementById('client-modal-observation').value = '';
            document.getElementById('client-modal-table-select').value = '';
            document.getElementById('client-modal-name-mesa').value = '';
            document.getElementById('modal-trocoPara').value = '';
            document.getElementById('troco-input-container').classList.add('hidden');
            document.querySelector('#payment-options-container .payment-option[data-method="Dinheiro"]').classList.add('selected');
            document.querySelector('#payment-options-container .payment-option[data-method="Dinheiro"] input').checked = true;
            document.querySelector('#payment-options-container .payment-option[data-method="A Definir"]').classList.remove('selected');
            document.getElementById('confirm-client-data-btn').textContent = 'Confirmar Dados'; // Volta ao texto padrão

            // Limpa o modal de IA
            const aiModal = document.getElementById('ai-order-modal');
            if (aiModal) {
                const pasteArea = aiModal.querySelector('#whatsapp-paste-area');
                const resultContent = aiModal.querySelector('#ai-result-content');
                const errorMessage = aiModal.querySelector('#ai-error-message');
                const confirmBtn = aiModal.querySelector('#confirm-ai-order-btn');
                if (pasteArea) pasteArea.value = '';
                if (resultContent) resultContent.innerHTML = '<p class="text-gray-400">Aguardando análise...</p>';
                if (errorMessage) errorMessage.classList.add('hidden');
                if (confirmBtn) confirmBtn.disabled = true;
            }
        }

        function listenToStatusChanges() {
            const itemsRef = collection(db, 'items');
            const ingredientsRef = collection(db, 'ingredients');
            const pizzaExtrasRef = collection(db, 'pizzaExtras');

            const unsubscribeItems = onSnapshot(itemsRef, (snapshot) => {
                snapshot.docChanges().forEach(change => {
                    const itemData = { id: change.doc.id, ...change.doc.data() };
                    if (change.type === 'modified') {
                        itemStatus[itemData.id] = itemData.status; // 'available' or 'unavailable'
                        itemVisibility[itemData.id] = itemData.visible === undefined ? true : itemData.visible; // 'visible' or 'hidden'
                        renderProducts(); // Re-renderiza os produtos para refletir mudanças
                    }
                });
            });

            const unsubscribeIngredients = onSnapshot(ingredientsRef, (snapshot) => {
                snapshot.docChanges().forEach(change => {
                    const ingredientData = { id: change.doc.id, ...change.doc.data() };
                    if (change.type === 'modified') {
                        ingredientVisibility[ingredientData.id] = ingredientData.available === undefined ? true : ingredientData.available;
                    }
                });
            });

            const unsubscribePizzaExtras = onSnapshot(pizzaExtrasRef, (snapshot) => {
                snapshot.docChanges().forEach(change => {
                    const extraData = { id: change.doc.id, ...change.doc.data() };
                    if (change.type === 'modified') {
                        extraVisibility[extraData.id] = extraData.available === undefined ? true : extraData.available;
                    }
                });
            });

            // Cleanup listeners quando o componente for desmontado (se aplicável)
            // Em um SPA, você pode querer limpar isso ao sair da página
            // return () => {
            //     unsubscribeItems();
            //     unsubscribeIngredients();
            //     unsubscribePizzaExtras();
            // };
        }

        function listenToTableStatus() {
            // Implementação para observar o status das mesas (se necessário)
            // Pode envolver uma collection 'tables' no Firestore
            const tableStatusContainer = document.getElementById('client-modal-table-select');
            if (!tableStatusContainer) return;

            // Exemplo: Preencher com mesas fixas
            tableStatusContainer.innerHTML = '<option value="">Selecionar Mesa...</option>';
            for (let i = 1; i <= NUMERO_DE_MESAS; i++) {
                const option = document.createElement('option');
                option.value = `Mesa ${i}`;
                option.textContent = `Mesa ${i}`;
                tableStatusContainer.appendChild(option);
            }
        }

        async function loadOrderForEditing(orderId) {
            isEditing = true;
            currentOrderId = orderId;
            const orderRef = doc(db, 'orders', orderId);
            try {
                const orderDoc = await getDoc(orderRef);
                if (orderDoc.exists()) {
                    const orderData = orderDoc.data();
                    order = orderData.items.map(item => ({
                        ...item,
                        // Garante que os IDs e outras propriedades estejam corretos para a UI
                        id: item.id || item.id, // Assumindo que o ID original está presente
                        name: item.name,
                        price: item.price,
                        quantity: item.quantity,
                        options: item.options || {}
                    }));
                    clientData = {
                        name: orderData.client?.name || null,
                        contact: orderData.client?.contact || null,
                        address: orderData.client?.address || null,
                        table: orderData.client?.table || null,
                        observation: orderData.client?.observation || null,
                        changeFor: orderData.client?.changeFor || null,
                    };
                    currentOrderType = orderData.orderType || 'Retirada';
                    paymentMethod = orderData.paymentMethod || null;

                    // Atualiza a UI com os dados carregados
                    updateOrderDisplay();
                    updateClientDataSummary();

                    // Define o tipo de pedido selecionado
                    document.querySelector(`input[name="orderType"][value="${currentOrderType}"]`).checked = true;

                    // Carrega o delivery fee se existir
                    if (orderData.deliveryFee) {
                        document.getElementById('delivery-fee-summary').classList.remove('hidden');
                        document.getElementById('delivery-fee-value').textContent = `R$ ${orderData.deliveryFee.toFixed(2)}`;
                    }

                    showTemporaryFeedback('Pedido carregado para edição.');
                } else {
                    showAlert('Pedido não encontrado.');
                    window.location.href = 'venda-balcao.html'; // Redireciona se o pedido não existir
                }
            } catch (error) {
                console.error("Erro ao carregar pedido para edição:", error);
                showAlert('Ocorreu um erro ao carregar o pedido. Por favor, tente novamente.');
                window.location.href = 'venda-balcao.html';
            }
        }
        
        // --- Funções de IA ---

        async function handleAnalyzeAI() {
            const pasteArea = document.getElementById('whatsapp-paste-area');
            const resultArea = document.getElementById('ai-result-area');
            const aiLoading = document.getElementById('ai-loading');
            const aiResultContent = document.getElementById('ai-result-content');
            const errorMessageEl = document.getElementById('ai-error-message');
            const confirmBtn = document.getElementById('confirm-ai-order-btn');

            const textToAnalyze = pasteArea.value.trim();
            if (!textToAnalyze) {
                errorMessageEl.textContent = 'Por favor, cole o texto da conversa para análise.';
                errorMessageEl.classList.remove('hidden');
                return;
            }

            errorMessageEl.classList.add('hidden');
            aiLoading.classList.remove('hidden');
            aiResultContent.classList.add('hidden');
            confirmBtn.disabled = true;

            try {
                // Substitua esta URL pela sua API de backend que processa o texto com um modelo de IA
                // Exemplo: const response = await fetch('YOUR_BACKEND_API_URL/analyze-whatsapp', { ... });
                
                // Simulação de chamada de API
                await new Promise(resolve => setTimeout(resolve, 1500)); // Simula delay da API
                
                // Resposta simulada da API (formato esperado: { items: [{ name: 'Pizza Calabresa', quantity: 1, price: 45.00 }, ...], orderType: 'Delivery', clientName: 'João Silva', ... })
                const simulatedApiResponse = {
                    items: [
                        { name: 'Pizza Grande Calabresa', quantity: 1, price: 45.00, category: 'Pizzas' },
                        { name: 'Refrigerante 2L', quantity: 1, price: 8.00, category: 'Bebidas' },
                        { name: 'Batata Frita Grande', quantity: 1, price: 25.00, category: 'Porções' }
                    ],
                    orderType: 'Delivery',
                    clientName: 'João Silva',
                    clientContact: '(11) 98765-4321',
                    address: { street: 'Rua das Flores', number: '123', neighborhood: 'Centro' },
                    observation: 'Entregar na portaria'
                };

                parsedAiOrder = simulatedApiResponse; // Armazena a resposta parseada

                if (parsedAiOrder && parsedAiOrder.items && parsedAiOrder.items.length > 0) {
                    let formattedResult = '<div class="space-y-2">';
                    formattedResult += `<p class="font-semibold">Tipo de Pedido: ${parsedAiOrder.orderType || 'Não especificado'}</p>`;
                    if (parsedAiOrder.clientName) formattedResult += `<p class="font-semibold">Cliente: ${parsedAiOrder.clientName}</p>`;
                    if (parsedAiOrder.clientContact) formattedResult += `<p class="font-semibold">Contato: ${parsedAiOrder.clientContact}</p>`;
                    if (parsedAiOrder.address) formattedResult += `<p class="font-semibold">Endereço: ${parsedAiOrder.address.street}, ${parsedAiOrder.address.number} - ${parsedAiOrder.address.neighborhood}</p>`;
                    if (parsedAiOrder.observation) formattedResult += `<p class="font-semibold">Observação: ${parsedAiOrder.observation}</p>`;
                    
                    formattedResult += '<h4 class="font-bold mt-4">Itens:</h4><ul class="list-disc list-inside">';
                    parsedAiOrder.items.forEach(item => {
                        formattedResult += `<li>${item.quantity}x ${item.name} (R$ ${item.price.toFixed(2)})</li>`;
                    });
                    formattedResult += '</ul>';
                    formattedResult += '</div>';
                    
                    aiResultContent.innerHTML = formattedResult;
                    confirmBtn.disabled = false;
                } else {
                    throw new Error('Nenhum item válido encontrado na análise.');
                }

            } catch (error) {
                console.error("Erro na análise de IA:", error);
                errorMessageEl.textContent = `Erro ao analisar o pedido: ${error.message}. Tente novamente ou insira manualmente.`;
                errorMessageEl.classList.remove('hidden');
                aiResultContent.innerHTML = '<p class="text-gray-400">Falha ao analisar.</p>';
            } finally {
                aiLoading.classList.add('hidden');
                aiResultContent.classList.remove('hidden');
            }
        }

        async function handleConfirmAIOrder() {
            if (!parsedAiOrder || !parsedAiOrder.items || parsedAiOrder.items.length === 0) {
                showAlert('Nenhum pedido válido da IA para confirmar.');
                return;
            }

            // Tenta preencher os dados do cliente e do pedido
            const aiOrder = parsedAiOrder;

            // Atualiza o tipo de pedido se especificado
            if (aiOrder.orderType) {
                currentOrderType = aiOrder.orderType;
                document.querySelector(`input[name="orderType"][value="${currentOrderType}"]`).checked = true;
            }

            // Preenche dados do cliente
            clientData.name = aiOrder.clientName || null;
            clientData.contact = aiOrder.clientContact || null;
            clientData.address = aiOrder.address || null;
            clientData.observation = aiOrder.observation || null;
            
            // Tenta encontrar os items correspondentes no cardápio
            let successfullyAddedCount = 0;
            for (const aiItem of aiOrder.items) {
                const itemInMenu = allItems.find(menuItem => 
                    menuItem.name.toLowerCase().includes(aiItem.name.toLowerCase()) || // Busca aproximada pelo nome
                    aiItem.name.toLowerCase().includes(menuItem.name.toLowerCase())
                );

                if (itemInMenu) {
                    // Cria um item básico para adicionar ao pedido
                    const newItem = {
                        ...itemInMenu,
                        uniqueId: `${itemInMenu.id}-${Date.now()}`, // ID único temporário
                        quantity: aiItem.quantity,
                        price: itemInMenu.price, // Usa o preço do cardápio
                        options: {
                            // Tenta extrair adicionais ou detalhes se estiverem na descrição do AI
                            // Isso pode exigir processamento mais avançado da resposta da IA
                        }
                    };
                    
                    // Verifica se o item do AI especifica um preço diferente e se deve ser usado
                    // (Com cuidado para não permitir preços arbitrários)
                    if (aiItem.price && aiItem.price !== itemInMenu.price) {
                        console.warn(`Preço do item AI (${aiItem.name}) é diferente do cardápio. Usando preço do cardápio: R$ ${itemInMenu.price.toFixed(2)}`);
                        // newItem.price = aiItem.price; // Descomente com cautela se quiser usar o preço da IA
                    }

                    order.push(newItem);
                    successfullyAddedCount++;
                } else {
                    console.warn(`Item da IA "${aiItem.name}" não encontrado no cardápio.`);
                    // Poderia adicionar um item "genérico" ou notificar o usuário
                }
            }

            updateOrderDisplay();
            updateClientDataSummary(); // Atualiza o resumo com os dados do cliente da IA

            // Fecha o modal de IA
            document.getElementById('ai-order-modal').style.display = 'none';
            
            if (successfullyAddedCount > 0) {
                showTemporaryFeedback(`${successfullyAddedCount} item(ns) adicionado(s) do pedido da IA.`);
            } else {
                showTemporaryFeedback('Nenhum item da IA pôde ser adicionado automaticamente. Verifique o cardápio.');
            }

            // Limpa o estado da IA
            parsedAiOrder = null;
            document.getElementById('whatsapp-paste-area').value = '';
            document.getElementById('ai-result-content').innerHTML = '<p class="text-gray-400">Aguardando análise...</p>';
            document.getElementById('confirm-ai-order-btn').disabled = true;
        }


        // --- Funções de Utilidade ---

        function showAlert(message) {
            const modal = document.getElementById('alert-modal');
            const messageEl = document.getElementById('alert-message');
            const okBtn = document.getElementById('alert-ok-btn');

            messageEl.textContent = message;
            modal.style.display = 'flex';

            const closeHandler = () => {
                modal.style.display = 'none';
                okBtn.removeEventListener('click', closeHandler);
                modal.removeEventListener('click', modalCloseHandler);
            };
            
            const modalCloseHandler = (e) => {
                if (e.target === modal) {
                    closeHandler();
                }
            };
            
            okBtn.addEventListener('click', closeHandler, { once: true });
            modal.addEventListener('click', modalCloseHandler);
        }

        function showTemporaryFeedback(message) {
            const feedbackEl = document.createElement('div');
            feedbackEl.className = 'feedback-toast';
            feedbackEl.textContent = message;
            document.body.appendChild(feedbackEl);

            setTimeout(() => {
                feedbackEl.style.top = '30px';
                feedbackEl.style.opacity = '1';
            }, 100);

            setTimeout(() => {
                feedbackEl.style.opacity = '0';
                feedbackEl.style.top = '10px';
                setTimeout(() => feedbackEl.remove(), 300);
            }, pauseTime);
        }

        function showConfirm(message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirm-modal');
                const messageEl = document.getElementById('confirm-message');
                const yesBtn = document.getElementById('confirm-yes-btn');
                const noBtn = document.getElementById('confirm-no-btn');

                messageEl.textContent = message;
                modal.style.display = 'flex';

                const close = (result) => {
                    modal.style.display = 'none';
                    yesBtn.removeEventListener('click', yesHandler);
                    noBtn.removeEventListener('click', noHandler);
                    modal.removeEventListener('click', modalCloseHandler);
                    resolve(result);
                };

                const yesHandler = () => close(true);
                const noHandler = () => close(false);
                 const modalCloseHandler = (e) => {
                    if (e.target === modal) {
                        close(false);
                    }
                };

                yesBtn.addEventListener('click', yesHandler, { once: true });
                noBtn.addEventListener('click', noHandler, { once: true });
                modal.addEventListener('click', modalCloseHandler);
            });
        }

        function setupEventListeners() {
            const mainContainer = document.querySelector('.main-container');
            const sidebar = document.querySelector('.sidebar-nav');
            const mainContent = document.querySelector('.main-content');
            const orderItemsContainer = document.getElementById('order-items-container');

            // --- Sidebar Logic ---
            document.addEventListener('mousemove', (e) => {
                if (e.clientX < 20) mainContainer.classList.add('sidebar-open');
            });
            sidebar.addEventListener('mouseleave', () => mainContainer.classList.remove('sidebar-open'));
            mainContent.addEventListener('mouseenter', () => mainContainer.classList.remove('sidebar-open'));

            // --- Main Page UI Listeners ---
            document.getElementById('search-product').addEventListener('input', renderProducts);
            document.getElementById('cancel-order-btn').addEventListener('click', async () => {
                if (isEditing) {
                    const confirmed = await showConfirm('Deseja descartar as alterações e fechar esta edição?');
                    if (confirmed) window.close();
                    return;
                }
                if (order.length > 0 || clientData.name || clientData.table) {
                    const confirmed = await showConfirm('Deseja cancelar o pedido atual e limpar os dados do cliente?');
                    if (confirmed) resetOrderState();
                }
            });
            document.getElementById('finalize-order-btn').addEventListener('click', finalizeOrderCheck);
            document.getElementById('order-type-selector').addEventListener('change', (e) => {
                currentOrderType = e.target.value;
                clientData = { name: null, contact: null, address: null, table: null, observation: null };
                paymentMethod = null;
                updateClientDataSummary();
                updateOrderDisplay();
            });
            orderItemsContainer.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-item-btn');
                const editExtrasBtn = e.target.closest('.edit-extras-btn');
                const editBurgerBtn = e.target.closest('.edit-burger-btn'); // Botão para editar hambúrguer

                if (removeBtn) {
                    const uniqueId = removeBtn.dataset.uniqueId;
                    order = order.filter(item => item.uniqueId !== uniqueId);
                    updateOrderDisplay();
                } else if (editExtrasBtn) {
                    const uniqueId = editExtrasBtn.dataset.uniqueId;
                    openPizzaExtrasBuilderModal(uniqueId);
                } else if (editBurgerBtn) {
                    const uniqueId = editBurgerBtn.dataset.uniqueId;
                    const index = order.findIndex(item => item.uniqueId === uniqueId);
                    if (index !== -1) {
                        const itemToEdit = order[index];
                        const baseBurgerItem = allItems.find(item => item.id === itemToEdit.id); // Encontra o item base
                        if (baseBurgerItem) {
                            openBurgerBuilderModal(baseBurgerItem, index, itemToEdit);
                        }
                    }
                }
            });

            // --- SETUP ALL MODAL LISTENERS (Simplified) ---
            document.getElementById('open-client-data-modal-btn').addEventListener('click', openClientDataModal);
            
            const aiModalBtn = document.getElementById('open-ai-modal-btn');
            const aiModal = document.getElementById('ai-order-modal');
            
            if (aiModalBtn && aiModal) {
                aiModalBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Limpa o estado do modal
                    const pasteArea = aiModal.querySelector('#whatsapp-paste-area');
                    const resultContent = aiModal.querySelector('#ai-result-content');
                    const errorMessage = aiModal.querySelector('#ai-error-message');
                    const confirmBtn = aiModal.querySelector('#confirm-ai-order-btn');
                    
                    if (pasteArea) pasteArea.value = '';
                    if (resultContent) resultContent.innerHTML = '<p class="text-gray-400">Aguardando análise...</p>';
                    if (errorMessage) errorMessage.classList.add('hidden');
                    if (confirmBtn) confirmBtn.disabled = true;
                    
                    parsedAiOrder = null;
                    
                    // Abre o modal
                    aiModal.style.display = 'flex';
                    console.log('[v0] Modal de IA aberto');
                });
            } else {
                console.error('[v0] Botão ou modal de IA não encontrado');
            }

            // --- Listeners for buttons INSIDE modals (that don't close them) ---
            document.getElementById('ask-extras-yes-btn').addEventListener('click', () => {
                const askModal = document.getElementById('ask-pizza-extras-modal');
                const uniqueId = askModal.dataset.uniqueId;
                openPizzaExtrasBuilderModal(uniqueId);
                askModal.style.display = 'none';
            });
            
            document.getElementById('add-custom-burger-btn').addEventListener('click', () => addCustomBurgerToOrder(document.getElementById('burger-builder-modal').dataset.editIndex || null));
            document.getElementById('add-pizza-with-extras-btn').addEventListener('click', confirmPizzaExtras);
            document.getElementById('confirm-client-data-btn').addEventListener('click', confirmClientData);
            document.getElementById('analyze-ai-btn').addEventListener('click', handleAnalyzeAI);
            document.getElementById('confirm-ai-order-btn').addEventListener('click', handleConfirmAIOrder);

            // --- Other listeners for functionality inside modals ---
            document.getElementById('burger-ingredients-container').addEventListener('click', handleBurgerIngredientClick);
            document.getElementById('pizza-extras-ingredients-container').addEventListener('click', handlePizzaExtrasIngredientClick);
            setupPaymentModalListeners();
            
            // --- Global listener to close any modal when clicking its background ---
            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            });
        }

        // Placeholder for event handlers that might be defined elsewhere
        function handleBurgerIngredientClick(e) {
            // Implement logic for burger ingredients if needed
        }
        function handlePizzaExtrasIngredientClick(e) {
             // Implement logic for pizza extras ingredients if needed
        }
        function setupPaymentModalListeners() {
            // Implement logic for payment modal listeners if needed
        }

    </script>
</body>
</html>
