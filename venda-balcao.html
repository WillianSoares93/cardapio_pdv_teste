<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Venda Balcão - Sâmia Pizzaria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="https://raw.githubusercontent.com/WillianSoares93/cardapio_samia_PDV/refs/heads/main/logo.png" type="image/png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #DDE2E6;
            visibility: hidden;
            overflow: hidden;
        }
        .main-container {
            display: grid;
            grid-template-columns: 80px 1fr;
            height: calc(100vh - 57px);
        }
        .main-content {
            display: grid;
            grid-template-columns: 400px 1fr 180px;
            gap: 1rem;
            padding: 1rem;
            height: 100%;
            overflow: hidden;
        }
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
        }
        .product-card {
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.5rem;
            text-align: center;
            background-color: #ffffff;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            aspect-ratio: 1 / 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
        }
        .product-card.unavailable {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #f3f4f6;
        }
         .product-card.unavailable::after {
            content: 'Esgotado';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-15deg);
            background-color: rgba(185, 28, 28, 0.8);
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.875rem;
        }
        .product-card:hover:not(.unavailable) {
            transform: translateY(-4px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border-color: #3b82f6;
        }
        .product-card img {
            max-height: 50px;
            object-fit: contain;
            margin: 0.5rem auto;
        }
        .category-btn {
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
            color: #374151;
            transition: all 0.2s ease-in-out;
        }
        .category-btn.active, .category-btn:hover {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        .sidebar-nav {
            background-color: #2C3E50;
        }
        .sidebar-btn {
            color: #BDC3C7;
            transition: all 0.2s ease-in-out;
        }
        .sidebar-btn:hover {
            background-color: #34495E;
            color: white;
        }
        .sidebar-btn.active {
            background-color: #3b82f6;
            color: white;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
             background-color: #fff;
             padding: 1.5rem;
             border-radius: 0.5rem;
             box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
             width: 90%;
             max-width: 500px;
        }
        .ingredient-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            border: 1px solid #d1d5db;
            transition: all 0.2s ease-in-out;
        }
        .ingredient-option:hover {
            background-color: #f9fafb;
            border-color: #3b82f6;
        }
        .ingredient-option.selected {
            background-color: #dbeafe;
            border-color: #3b82f6;
        }
        .quantity-btn {
            background-color: #e5e7eb;
            color: #4b5563;
            transition: all 0.2s ease-in-out;
            width: 28px;
            height: 28px;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            font-weight: bold;
        }
        .quantity-btn:hover:not(:disabled) {
            background-color: #d1d5db;
        }
        .half-pizza-selection-active {
            background-color: #fef9c3; /* yellow-100 */
            border: 2px dashed #f59e0b; /* yellow-500 */
        }
        .scope-button {
            transition: all 0.2s ease-in-out;
            padding: 4px 12px;
            border-radius: 9999px;
            background-color: #e5e7eb;
            color: #4b5563;
            font-size: 0.875rem;
        }
        .scope-button.active {
            background-color: #3b82f6;
            color: white;
        }
        .builder-modal { max-width: 600px; }
        .ingredient-category h4 { font-size: 1.25rem; font-weight: bold; color: #1f2937; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid #e5e7eb; }

    </style>
</head>
<body class="h-screen flex flex-col">

    <header class="bg-white shadow-sm z-10">
        <div class="max-w-full mx-auto px-4 py-3 flex justify-between items-center">
             <div class="flex items-center space-x-4">
                <i class="fas fa-cash-register text-xl text-gray-600"></i>
                <h1 class="text-xl font-bold text-gray-800">VENDA BALCÃO</h1>
            </div>
            <div class="flex items-center space-x-4">
                <span id="current-user" class="text-sm font-medium text-gray-600"></span>
                <a href="pdv.html" class="px-3 py-2 bg-gray-600 text-white text-xs font-bold rounded-md hover:bg-gray-700">PAINEL PDV</a>
                <button id="logout-btn" class="px-3 py-2 bg-red-600 text-white text-xs font-bold rounded-md hover:bg-red-700">SAIR</button>
            </div>
        </div>
    </header>

    <div class="main-container">
        <!-- Sidebar Vertical Esquerda -->
        <aside class="sidebar-nav flex flex-col items-center py-4 space-y-4">
            <a href="atendente.html" class="sidebar-btn w-full flex flex-col items-center p-3 text-xs">
                <i class="fas fa-concierge-bell fa-2x"></i>
                <span>Atendente</span>
            </a>
            <a href="#" class="sidebar-btn active w-full flex flex-col items-center p-3 text-xs">
                <i class="fas fa-cash-register fa-2x"></i>
                <span>Balcão</span>
            </a>
        </aside>

        <main class="main-content">
            <!-- Coluna da Esquerda: Pedido -->
            <section class="bg-white rounded-lg shadow-md flex flex-col">
                <div class="p-4 border-b">
                    <label for="clientNameInput" class="text-sm font-medium text-gray-700">Nome do Cliente (Opcional)</label>
                    <input type="text" id="clientNameInput" class="w-full p-2 border rounded-md mt-1" placeholder="Cliente Balcão">
                </div>
                <div id="orderItems" class="flex-grow overflow-y-auto p-4">
                     <div id="emptyOrderMessage" class="text-center text-gray-400 p-10 flex flex-col items-center justify-center h-full">
                        <i class="fas fa-shopping-cart fa-3x mb-4"></i>
                        <p class="font-medium">Carrinho Vazio</p>
                    </div>
                </div>
                <div class="p-4 border-t bg-gray-50">
                    <div class="flex justify-between items-center text-gray-600 text-sm">
                        <span>Subtotal</span>
                        <span id="subtotal">R$ 0,00</span>
                    </div>
                    <div class="flex justify-between items-center text-2xl font-bold text-gray-800 mt-2 pt-2 border-t">
                        <span>TOTAL</span>
                        <span id="total">R$ 0,00</span>
                    </div>
                    <div class="mt-4 grid grid-cols-2 gap-4">
                        <button id="cancel-order-btn" class="w-full py-3 bg-red-600 text-white font-bold rounded-md hover:bg-red-700">Cancelar</button>
                        <button id="finalize-order-btn" class="w-full py-3 bg-green-600 text-white font-bold rounded-md hover:bg-green-700">Finalizar</button>
                    </div>
                </div>
            </section>

            <!-- Coluna do Meio: Produtos -->
            <section id="product-display" class="bg-white rounded-lg shadow-md flex flex-col p-4 overflow-hidden">
                 <div class="mb-4">
                    <input type="text" id="search-product" placeholder="Buscar produto..." class="w-full p-2 border rounded-md">
                </div>
                <div id="category-buttons-container" class="flex space-x-2 mb-4 overflow-x-auto pb-2"></div>
                <div id="dynamic-pizza-sections" class="flex-grow overflow-y-auto pr-2"></div>
            </section>

            <!-- Coluna da Direita: Categorias (removida ou pode ser usada para outra coisa) -->
            <section id="category-list-right" class="flex flex-col p-0 space-y-2 overflow-y-auto"></section>
        </main>
    </div>
    
    <div id="pizza-option-modal" class="modal"><div class="modal-content"><span class="close-button" id="close-pizza-option-modal">&times;</span><h3 class="text-xl font-bold text-gray-800 mb-4" id="modal-pizza-name"></h3><p class="text-gray-600 mb-6" id="modal-pizza-description"></p><div id="pizza-size-options" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div></div></div>
    <div id="burger-builder-modal" class="modal"><div class="modal-content builder-modal"><span class="close-button" id="close-burger-builder-modal">&times;</span><h3 class="text-xl font-bold text-gray-800 mb-4">Monte Seu Hambúrguer</h3><div id="burger-ingredients-container" class="mb-4"></div><div class="flex justify-between items-center bg-gray-100 p-4 rounded-lg mt-4"><span class="text-lg font-bold">Total:</span><span id="burger-total-price" class="text-2xl font-bold text-red-600">R$ 0,00</span></div><button id="add-custom-burger-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-full transition w-full">Adicionar ao Pedido</button></div></div>
    <div id="ask-pizza-extras-modal" class="modal"><div class="modal-content"><p class="text-lg font-semibold text-gray-800 mb-4" id="ask-extras-title"></p><div class="flex justify-center gap-4"><button id="ask-extras-no-btn" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-lg font-bold hover:bg-gray-400 transition">Não, obrigado</button><button id="ask-extras-yes-btn" class="px-6 py-2 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition">Sim, quero!</button></div></div></div>
    <div id="pizza-extras-builder-modal" class="modal"><div class="modal-content builder-modal"><span class="close-button" id="close-pizza-extras-builder-modal">&times;</span><h3 class="text-xl font-bold text-gray-800 mb-4" id="pizza-extras-builder-title"></h3><div id="pizza-extras-scope-buttons" class="flex flex-wrap gap-2 mb-4 border-b pb-4"></div><div id="pizza-extras-ingredients-container" class="mb-4 max-h-80 overflow-y-auto p-2"></div><div class="flex justify-between items-center bg-gray-100 p-4 rounded-lg mt-4"><span class="text-lg font-bold">Total da Pizza:</span><span id="pizza-extras-total-price" class="text-2xl font-bold text-red-600">R$ 0,00</span></div><button id="add-pizza-with-extras-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-full transition w-full mt-4">Confirmar Adicionais</button></div></div>
    <div id="alert-modal" class="modal"><div class="modal-content"><p id="alert-message" class="text-lg font-semibold text-gray-800 mb-4 text-center"></p><div class="flex justify-center"><button id="alert-ok-btn" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition">OK</button></div></div></div>
    <div id="confirm-modal" class="modal"><div class="modal-content"><p id="confirm-message" class="text-lg font-semibold text-gray-800 mb-6 text-center"></p><div class="flex justify-center gap-4"><button id="confirm-no-btn" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-lg font-bold hover:bg-gray-400 transition">Não</button><button id="confirm-yes-btn" class="px-6 py-2 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition">Sim</button></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = {
           apiKey: "AIzaSyBJ44RVDGhBIlQBTx-pyIUp47XDKzRXk84",
           authDomain: "pizzaria-pdv.firebaseapp.com",
           projectId: "pizzaria-pdv",
           storageBucket: "pizzaria-pdv.firebasestorage.app",
           messagingSenderId: "304171744691",
           appId: "1:304171744691:web:e54d7f9fe55c7a75485fc6"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserEmail = '';
        let order = [];
        let allMenuData = [];
        let allBurgerIngredients = {};
        let allPizzaIngredients = {};
        let isSelectingHalfPizza = false;
        let firstHalfPizza = null;
        let currentPizzaData = {};
        let currentBurgerBasePrice = 0;
        let isFirstHalfPromotional = false;
        let itemVisibility = {}, unavailableItems = {}, ingredientVisibility = {}, ingredientStatus = {}, extraVisibility = {}, extraStatus = {}, pizzaHalfStatus = {}, itemExtrasStatus = {};
        let currentPizzaExtrasState = {};
        
        const showAlert = (message) => {
            document.getElementById('alert-message').textContent = message;
            document.getElementById('alert-modal').style.display = 'flex';
        };
        const showConfirm = (message) => {
             return new Promise(resolve => {
                document.getElementById('confirm-message').textContent = message;
                document.getElementById('confirm-modal').style.display = 'flex';
                document.getElementById('confirm-yes-btn').onclick = () => { document.getElementById('confirm-modal').style.display = 'none'; resolve(true); };
                document.getElementById('confirm-no-btn').onclick = () => { document.getElementById('confirm-modal').style.display = 'none'; resolve(false); };
            });
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.body.style.visibility = 'visible';
                currentUserEmail = user.email;
                document.getElementById('current-user').textContent = currentUserEmail;
                initializeAppLogic();
            } else {
                window.location.href = 'login.html?redirect=venda-balcao.html';
            }
        });

        async function initializeAppLogic() {
            await loadMenuAndRender();
            listenToControls();
            setupEventListeners();
        }

        async function loadMenuAndRender() {
            try {
                const response = await fetch('/api/menu');
                if (!response.ok) throw new Error('Network error');
                const data = await response.json();
                
                const promotionsWithCategory = (data.promocoes || []).map(promo => {
                    const originalItem = data.cardapio.find(item => item.id === promo.itemId);
                    return { ...promo, category: 'Promocionais', isPizza: originalItem ? originalItem.isPizza : false, isCustomizable: false, basePrice: promo.promoPrice };
                });
                
                allMenuData = [...data.cardapio, ...promotionsWithCategory];

                const rawBurgerIngredients = data.ingredientesHamburguer;
                allBurgerIngredients = rawBurgerIngredients.reduce((acc, current) => {
                    if (!acc[current.category]) acc[current.category] = [];
                    acc[current.category].push(current);
                    return acc;
                }, {});
                
                const rawPizzaIngredients = data.ingredientesPizza || [];
                allPizzaIngredients = rawPizzaIngredients.reduce((acc, current) => {
                    const category = current.category || 'Adicionais';
                    if (!acc[category]) acc[category] = [];
                    acc[category].push(current);
                    return acc;
                }, {});

                updateUI();
            } catch (error) {
                console.error('Erro ao carregar cardápio:', error);
                showAlert('Não foi possível carregar o cardápio.');
            }
        }

        function listenToControls() {
            onSnapshot(doc(db, "config", "item_status"), (doc) => { unavailableItems = doc.exists() ? doc.data() : {}; updateUI(); });
            onSnapshot(doc(db, "config", "item_visibility"), (doc) => { itemVisibility = doc.exists() ? doc.data() : {}; updateUI(); });
            onSnapshot(doc(db, "config", "pizza_half_status"), (doc) => { pizzaHalfStatus = doc.exists() ? doc.data() : {}; });
            onSnapshot(doc(db, "config", "item_extras_status"), (doc) => { itemExtrasStatus = doc.exists() ? doc.data() : {}; });
            onSnapshot(doc(db, "config", "ingredient_status"), (doc) => { ingredientStatus = doc.exists() ? doc.data() : {}; });
            onSnapshot(doc(db, "config", "ingredient_visibility"), (doc) => { ingredientVisibility = doc.exists() ? doc.data() : {}; });
            onSnapshot(doc(db, "config", "extra_status"), (doc) => { extraStatus = doc.exists() ? doc.data() : {}; });
            onSnapshot(doc(db, "config", "extra_visibility"), (doc) => { extraVisibility = doc.exists() ? doc.data() : {}; });
        }
        
        function updateUI() {
            const visibleItems = allMenuData.filter(item => itemVisibility[item.id] !== false);
            const orderedCategories = [...new Set(visibleItems.map(item => item.category).filter(Boolean))];
            createCategoryButtons(orderedCategories);
            populateMenu(visibleItems, orderedCategories);
        }

        function populateMenu(menuItems, orderedCategories) {
            const dynamicSectionsContainer = document.getElementById('dynamic-pizza-sections');
            dynamicSectionsContainer.innerHTML = '';
            
            const itemsByCategory = menuItems.reduce((acc, item) => {
                if(item.category) {
                    if (!acc[item.category]) acc[item.category] = [];
                    acc[item.category].push(item);
                }
                return acc;
            }, {});

            orderedCategories.forEach(category => {
                const sectionId = `${category.toLowerCase().replace(/\s+/g, '-')}-section`;
                const sectionEl = document.createElement('div');
                sectionEl.id = sectionId;
                sectionEl.className = 'pizza-category-section mb-8';
                
                const isPizzaCategory = itemsByCategory[category] && itemsByCategory[category].some(item => item.isPizza);
                const title = isPizzaCategory ? `Pizzas ${capitalizeFirstLetter(category)}` : capitalizeFirstLetter(category);
                
                sectionEl.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="${category}-items"></div>`;
                dynamicSectionsContainer.appendChild(sectionEl);

                const categoryItemsEl = document.getElementById(`${category}-items`);
                itemsByCategory[category].forEach(item => {
                    const isUnavailable = unavailableItems[item.id] === false;
                    const imageUrl = String(item.imageUrl || '').trim();
                    const imageElement = (!imageUrl || imageUrl.toLowerCase() === 'sem imagem') ? `<div class="no-image-placeholder">Sâmia</div>` : `<img src="${imageUrl}" alt="${item.name}" class="w-full h-40 object-cover" onerror="this.parentElement.innerHTML = '<div class=\\'no-image-placeholder\\'>Sâmia</div>';">`;
                    const buttonText = isUnavailable ? 'Esgotado' : (item.isCustomizable ? 'Montar' : 'Adicionar');
                    const buttonClasses = isUnavailable ? 'bg-gray-400 cursor-not-allowed' : 'bg-red-600 hover:bg-red-700';
                    
                    let pricesHtml = '';
                     if (item.isPizza) {
                        pricesHtml = ['price4Slices', 'price6Slices', 'basePrice', 'price10Slices'].map((pk, i) => {
                            if (item[pk] > 0) {
                                const label = [4, 6, 8, 10][i];
                                return `<div class="text-center px-1"><span class="text-xs text-gray-500">${label} Fatias</span><p class="font-bold text-red-600">R$ ${item[pk].toFixed(2).replace('.', ',')}</p></div>`;
                            }
                            return '';
                        }).join('');
                    } else {
                        pricesHtml = `<span class="font-bold text-red-600 text-lg">R$ ${item.basePrice.toFixed(2).replace('.', ',')}</span>`;
                    }
                    
                    const itemHtml = `
                        <div class="product-card ${isUnavailable ? 'opacity-60' : ''}" data-item-id="${item.id}">
                            <div class="p-4 flex flex-col flex-grow">
                                <h3 class="text-sm font-bold text-gray-800 mb-2">${item.name}</h3>
                                <p class="text-xs text-gray-600 flex-grow">${item.description}</p>
                                <div class="mt-auto pt-2">
                                    <div class="flex justify-center flex-wrap gap-2">${pricesHtml}</div>
                                </div>
                            </div>
                        </div>`;
                    categoryItemsEl.insertAdjacentHTML('beforeend', itemHtml);
                });
            });
            attachProductCardListeners();
        }
        
        function attachProductCardListeners() {
            document.querySelectorAll('.product-card:not(.unavailable)').forEach(card => {
                card.addEventListener('click', () => {
                    const itemId = card.dataset.itemId;
                    const product = allMenuData.find(p => p.id === itemId);
                    if (product) {
                        handleProductSelection(product);
                    }
                });
            });
        }

        function createCategoryButtons(categories) {
            const container = document.getElementById('category-buttons-container');
            const rightContainer = document.getElementById('category-list-right');
            container.innerHTML = '';
            rightContainer.innerHTML = '';
            
            categories.forEach(category => {
                const button = document.createElement('button');
                const isPizza = allMenuData.some(item => item.category === category && item.isPizza);
                button.textContent = isPizza ? `Pizzas ${capitalizeFirstLetter(category)}` : capitalizeFirstLetter(category);
                button.className = 'category-btn w-full p-4 text-sm font-bold rounded-md';
                button.dataset.targetId = `${category.toLowerCase().replace(/\s+/g, '-')}-section`;
                
                button.addEventListener('click', (e) => {
                     document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
                     e.currentTarget.classList.add('active');
                     rightContainer.querySelector(`[data-target-id="${e.currentTarget.dataset.targetId}"]`).classList.add('active');
                     filterProductsByCategory(category);
                });

                rightContainer.appendChild(button);
            });
            
            // Set first as active
            if(rightContainer.firstChild){
                 rightContainer.firstChild.classList.add('active');
            }
        }

        function filterProductsByCategory(selectedCategory) {
            document.querySelectorAll('.pizza-category-section').forEach(section => {
                if (selectedCategory === 'Todos' || section.id === `${selectedCategory.toLowerCase().replace(/\s+/g, '-')}-section`) {
                    section.style.display = 'block';
                } else {
                    section.style.display = 'none';
                }
            });
        }

        
        function handleProductSelection(product) {
            // Logic from index.html
        }
        
        function capitalizeFirstLetter(string) {
            if (!string) return '';
            return string.charAt(0).toUpperCase() + string.slice(1).toLowerCase();
        }

        // --- ALL OTHER JS FUNCTIONS GO HERE ---
        
        function setupEventListeners() {
             document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
             document.getElementById('finalize-order-btn').addEventListener('click', finalizeOrder);
             document.getElementById('cancel-order-btn').addEventListener('click', async () => {
                 if (order.length > 0) {
                     const confirmed = await showConfirm('Deseja cancelar o pedido atual?');
                     if (confirmed) {
                         order = [];
                         updateOrderDisplay();
                     }
                 }
             });

            const burgerContainer = document.getElementById('burger-ingredients-container');
            burgerContainer.addEventListener('click', (e) => {
                const quantityBtn = e.target.closest('.quantity-btn');
                const radioInput = e.target.closest('.ingredient-option')?.querySelector('.form-radio');

                if (quantityBtn) {
                    e.stopPropagation();
                    const container = quantityBtn.closest('[data-ingredient-id]');
                    const display = container.querySelector('.quantity-display');
                    const ingredientLimit = parseInt(container.dataset.limit);
                    let quantity = parseInt(display.textContent);
                    const categoryDiv = container.closest('[data-limit]');
                    const categoryLimit = parseInt(categoryDiv.dataset.limit);
                    
                    if (quantityBtn.classList.contains('plus-btn')) {
                        if (quantity >= ingredientLimit) {
                            showAlert(`O limite para este ingrediente é ${ingredientLimit}.`); return;
                        }
                        if (quantity === 0) {
                            let currentVarietyCount = 0;
                            categoryDiv.querySelectorAll('.quantity-display').forEach(d => { if (parseInt(d.textContent) > 0) currentVarietyCount++; });
                            categoryDiv.querySelectorAll('input[type="radio"]:checked').forEach(() => currentVarietyCount++);
                            if (currentVarietyCount >= categoryLimit) {
                               showAlert(`Você pode escolher no máximo ${categoryLimit} variedades nesta categoria.`); return;
                            }
                        }
                        quantity++;
                    } else if (quantity > 0) {
                        quantity--;
                    }
                    display.textContent = quantity;
                    container.closest('.ingredient-option').classList.toggle('selected', quantity > 0);
                } else if (radioInput) {
                    if (radioInput.disabled) return;
                    if (!radioInput.checked) {
                        const categoryDiv = radioInput.closest('[data-limit]');
                        const categoryLimit = parseInt(categoryDiv.dataset.limit);
                        let currentVarietyCount = 0;
                        categoryDiv.querySelectorAll('.quantity-display').forEach(d => { if (parseInt(d.textContent) > 0) currentVarietyCount++; });
                        const isReplacingRadio = categoryDiv.querySelector('input[type="radio"]:checked');
                        if (!isReplacingRadio) currentVarietyCount++;
                        if (currentVarietyCount > categoryLimit) {
                            showAlert(`Você pode escolher no máximo ${categoryLimit} item(ns) nesta categoria.`);
                            e.preventDefault();
                            return;
                        }
                    }
                    setTimeout(() => {
                        document.querySelectorAll(`input[name="${radioInput.name}"]`).forEach(r => r.closest('.ingredient-option').classList.toggle('selected', r.checked));
                        updateBurgerPrice();
                    }, 0);
                }
                updateBurgerPrice();
            });

            document.getElementById('close-pizza-option-modal').addEventListener('click', () => document.getElementById('pizza-option-modal').style.display = 'none');
            document.getElementById('close-burger-builder-modal').addEventListener('click', () => document.getElementById('burger-builder-modal').style.display = 'none');
            document.getElementById('add-custom-burger-btn').addEventListener('click', addCustomBurgerToOrder);
            document.getElementById('ask-extras-no-btn').addEventListener('click', () => document.getElementById('ask-pizza-extras-modal').style.display = 'none');
            document.getElementById('ask-extras-yes-btn').addEventListener('click', () => {
                openPizzaExtrasBuilderModal(document.getElementById('ask-pizza-extras-modal').dataset.uniqueId);
                document.getElementById('ask-pizza-extras-modal').style.display = 'none';
            });
            document.getElementById('close-pizza-extras-builder-modal').addEventListener('click', () => document.getElementById('pizza-extras-builder-modal').style.display = 'none');
            document.getElementById('add-pizza-with-extras-btn').addEventListener('click', confirmPizzaExtras);
            document.getElementById('alert-ok-btn').addEventListener('click', () => document.getElementById('alert-modal').style.display = 'none');
        }

        async function finalizeOrder() {
            if (order.length === 0) {
                showAlert("O carrinho está vazio.");
                return;
            }
            const clientName = document.getElementById('clientNameInput').value || 'Cliente Balcão';
            const total = order.reduce((sum, item) => sum + item.price, 0);

            const cleanedItems = JSON.parse(JSON.stringify(order, (key, value) => {
                if (['originalItem', 'uniqueId', 'firstHalfData', 'secondHalfData'].includes(key)) return undefined;
                return value;
            }));

            const newOrder = {
                itens: cleanedItems,
                endereco: { clientName: clientName, rua: "Retirada no Balcão", bairro: "BALCÃO" },
                total: { subtotal: total, finalTotal: total, deliveryFee: 0, discount: 0 },
                pagamento: 'A Definir',
                status: 'Entregue',
                criadoEm: serverTimestamp(),
                observacao: `Venda de balcão por ${currentUserEmail}`
            };

            try {
                await addDoc(collection(db, "pedidos"), newOrder);
                showAlert(`Pedido para ${clientName} finalizado com sucesso!`);
                order = [];
                document.getElementById('clientNameInput').value = 'Cliente Balcão';
                updateOrderDisplay();
            } catch (error) {
                console.error("Erro ao finalizar pedido:", error);
                showAlert("Falha ao finalizar o pedido. Tente novamente.");
            }
        }
        
        function updateOrderDisplay() {
            const orderItemsContainer = document.getElementById('orderItems');
            const emptyMsg = document.getElementById('emptyOrderMessage');
            let subtotal = 0;
            let totalItemsCount = 0;

            if (order.length === 0) {
                orderItemsContainer.innerHTML = '';
                emptyMsg.classList.remove('hidden');
            } else {
                emptyMsg.classList.add('hidden');
                orderItemsContainer.innerHTML = order.map((item, index) => {
                    subtotal += item.price;
                    totalItemsCount += (item.quantity || 1);
                    return `<div class="py-2 border-b border-gray-100 flex justify-between items-start">
                                <div class="flex-1 pr-2">
                                    <p class="font-medium">${item.name}</p>
                                    ${(item.ingredients || item.extras || []).map(i => `<p class="text-xs text-gray-500 pl-2">- ${i.name}</p>`).join('')}
                                </div>
                                <div class="font-medium">R$ ${item.price.toFixed(2).replace('.',',')}</div>
                                <button data-index="${index}" class="remove-item-btn text-red-500 ml-4 font-bold">&times;</button>
                            </div>`;
                }).join('');

                orderItemsContainer.querySelectorAll('.remove-item-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        order.splice(parseInt(e.target.dataset.index), 1);
                        updateOrderDisplay();
                    });
                });
            }

            document.getElementById('subtotal').textContent = `R$ ${subtotal.toFixed(2).replace('.', ',')}`;
            document.getElementById('total').textContent = `R$ ${subtotal.toFixed(2).replace('.', ',')}`;
        }
        
        function addToOrder(product) {
            const uniqueId = product.uniqueId || `${product.id}-${Date.now()}`;
            const itemWithId = { ...product, uniqueId, quantity: 1, extras: [] };
            order.push(itemWithId);
            updateOrderDisplay();
        }
        
        function openPizzaOptionsModal(pizza) {
            // ... (Logic from index.html)
        }
        function openBurgerBuilderModal(burger) {
            // ... (Logic from index.html)
        }
        function addCustomBurgerToOrder() {
            // ... (Logic from index.html)
        }
        function updateBurgerPrice() {
            // ... (Logic from index.html)
        }
        function openPizzaExtrasBuilderModal(uniqueId){
            // ... (Logic from index.html)
        }
        function renderPizzaExtrasList(orderIndex) {
            // ... (Logic from index.html)
        }
        function updatePizzaExtrasPrice(orderIndex){
            // ... (Logic from index.html)
        }
        function confirmPizzaExtras(){
            // ... (Logic from index.html)
        }

    </script>
</body>
</html>

