<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatórios e Histórico - Sâmia Pizzaria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="icon" href="https://raw.githubusercontent.com/WillianSoares93/cardapio_samia_PDV/refs/heads/main/logo.png" type="image/png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f3f4f6;
            visibility: hidden;
        }
        .flatpickr-input {
            background-color: white;
        }
    </style>
</head>
<body class="bg-gray-100">

    <header class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">Relatórios e Histórico</h1>
            <div class="flex items-center space-x-4">
                <a href="pdv.html" class="px-4 py-2 bg-blue-600 text-white text-sm font-bold rounded-md hover:bg-blue-700 transition-colors">
                    <i class="fas fa-clipboard-list mr-2"></i>Ir para o PDV
                </a>
                <button id="logout-btn" class="px-4 py-2 bg-red-600 text-white text-sm font-bold rounded-md hover:bg-red-700 transition-colors">
                    <i class="fas fa-sign-out-alt mr-2"></i>Sair
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <div id="loading-state" class="text-center py-10">
            <i class="fas fa-spinner fa-spin text-4xl text-blue-500"></i>
            <p class="mt-4 text-gray-600">Carregando dados históricos...</p>
        </div>

        <div id="report-content" class="hidden">
            <!-- Indicadores Chave -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <div class="bg-white p-5 rounded-lg shadow"><h3 class="text-sm font-medium text-gray-500">FATURAMENTO TOTAL</h3><p id="stats-total-revenue" class="text-3xl font-bold text-gray-800 mt-1">R$ 0,00</p></div>
                <div class="bg-white p-5 rounded-lg shadow"><h3 class="text-sm font-medium text-gray-500">TOTAL DE PEDIDOS</h3><p id="stats-total-orders" class="text-3xl font-bold text-gray-800 mt-1">0</p></div>
                <div class="bg-white p-5 rounded-lg shadow"><h3 class="text-sm font-medium text-gray-500">TICKET MÉDIO</h3><p id="stats-avg-ticket" class="text-3xl font-bold text-gray-800 mt-1">R$ 0,00</p></div>
                <div class="bg-white p-5 rounded-lg shadow"><h3 class="text-sm font-medium text-gray-500">PRODUTO MAIS VENDIDO</h3><p id="stats-top-product" class="text-xl font-bold text-gray-800 mt-1">-</p></div>
            </div>

            <!-- Filtros -->
            <div class="bg-white p-4 rounded-lg shadow mb-6 flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-4">
                <div class="flex-1 w-full md:w-auto">
                    <label for="date-filter" class="text-sm font-medium text-gray-700">Filtrar por Período</label>
                    <input type="text" id="date-filter" class="mt-1 w-full p-2 border border-gray-300 rounded-md" placeholder="Selecione um período">
                </div>
                <div class="flex-1 w-full md:w-auto">
                    <label for="search-filter" class="text-sm font-medium text-gray-700">Pesquisar</label>
                    <input type="text" id="search-filter" class="mt-1 w-full p-2 border border-gray-300 rounded-md" placeholder="Nome, telefone, item...">
                </div>
                <div class="self-end">
                    <button id="export-csv-btn" class="w-full md:w-auto px-4 py-2 bg-green-600 text-white font-bold rounded-md hover:bg-green-700 transition-colors">
                        <i class="fas fa-file-excel mr-2"></i>Exportar CSV
                    </button>
                </div>
            </div>

            <!-- Gráficos -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="bg-white p-5 rounded-lg shadow">
                    <h3 class="font-bold text-gray-800 mb-4">Faturamento por Dia</h3>
                    <canvas id="revenue-chart"></canvas>
                </div>
                <div class="bg-white p-5 rounded-lg shadow">
                    <h3 class="font-bold text-gray-800 mb-4">Vendas por Categoria de Item</h3>
                    <canvas id="category-chart"></canvas>
                </div>
            </div>

            <!-- Tabela de Histórico -->
            <div class="bg-white rounded-lg shadow overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Itens</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pagamento</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Linhas da tabela serão inseridas aqui -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>
    
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

        const firebaseConfig = {
           apiKey: "AIzaSyBJ44RVDGhBIlQBTx-pyIUp47XDKzRXk84",
           authDomain: "pizzaria-pdv.firebaseapp.com",
           projectId: "pizzaria-pdv",
           storageBucket: "pizzaria-pdv.firebasestorage.app",
           messagingSenderId: "304171744691",
           appId: "1:304171744691:web:e54d7f9fe55c7a75485fc6"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        
        document.addEventListener('DOMContentLoaded', () => {
            let allOrders = [];
            let revenueChartInstance = null;
            let categoryChartInstance = null;

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    document.body.style.visibility = 'visible';
                    initializeApp();
                } else {
                    window.location.href = `login.html?redirect=relatorio.html`;
                }
            });

            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

            function parseDate(dateString) {
                if (!dateString || !dateString.includes(',')) return null;
                const [datePart, timePart] = dateString.split(', ');
                const [day, month, year] = datePart.split('/');
                return new Date(`${year}-${month}-${day}T${timePart}`);
            }

            async function initializeApp() {
                try {
                    const response = await fetch('/api/historico');
                    if (!response.ok) {
                        throw new Error(`Erro ao buscar dados: ${response.statusText}`);
                    }
                    const rawOrders = await response.json();

                    allOrders = rawOrders.map(order => ({
                        ...order, 
                        date: parseDate(order.date)
                    })).filter(order => order.date !== null);
                    
                    document.getElementById('loading-state').classList.add('hidden');
                    document.getElementById('report-content').classList.remove('hidden');
                    
                    setupFilters();
                    applyFilters();

                } catch (error) {
                    console.error("Falha ao inicializar:", error);
                    document.getElementById('loading-state').innerHTML = `<p class="text-red-500 font-bold">Não foi possível carregar o histórico de pedidos. Verifique o console para mais detalhes.</p>`;
                }
            }

            function setupFilters() {
                flatpickr("#date-filter", {
                    mode: "range",
                    dateFormat: "d/m/Y",
                    locale: "pt",
                    onChange: applyFilters
                });
                document.getElementById('search-filter').addEventListener('input', applyFilters);
                document.getElementById('export-csv-btn').addEventListener('click', exportToCSV);
            }

            function applyFilters() {
                const dateRange = document.getElementById('date-filter')._flatpickr.selectedDates;
                const searchTerm = document.getElementById('search-filter').value.toLowerCase();

                const filteredOrders = allOrders.filter(order => {
                    const dateMatch = !dateRange.length || (order.date >= dateRange[0] && order.date <= (dateRange[1] || dateRange[0]));
                    const searchMatch = !searchTerm || 
                        order.clientData.toLowerCase().includes(searchTerm) ||
                        order.items.toLowerCase().includes(searchTerm);
                    
                    return dateMatch && searchMatch;
                });

                updateDashboard(filteredOrders);
                updateCharts(filteredOrders);
                renderTable(filteredOrders);
            }
            
            function updateDashboard(orders) {
                const totalRevenue = orders.reduce((sum, order) => sum + order.total, 0);
                const totalOrders = orders.length;
                const avgTicket = totalOrders > 0 ? totalRevenue / totalOrders : 0;
                
                const itemCounts = {};
                orders.forEach(order => {
                    const items = order.items.split('; ');
                    items.forEach(itemString => {
                        const itemName = itemString.split(' (R$')[0].trim();
                        itemCounts[itemName] = (itemCounts[itemName] || 0) + 1;
                    });
                });
                
                const topProduct = Object.keys(itemCounts).length > 0
                    ? Object.entries(itemCounts).reduce((a, b) => a[1] > b[1] ? a : b)[0]
                    : '-';

                document.getElementById('stats-total-revenue').textContent = `R$ ${totalRevenue.toFixed(2).replace('.', ',')}`;
                document.getElementById('stats-total-orders').textContent = totalOrders;
                document.getElementById('stats-avg-ticket').textContent = `R$ ${avgTicket.toFixed(2).replace('.', ',')}`;
                document.getElementById('stats-top-product').textContent = topProduct;
            }

            function updateCharts(orders) {
                // Revenue Chart
                const revenueByDay = orders.reduce((acc, order) => {
                    const day = order.date.toLocaleDateString('pt-BR');
                    acc[day] = (acc[day] || 0) + order.total;
                    return acc;
                }, {});
                
                const sortedDays = Object.keys(revenueByDay).sort((a,b) => {
                    const [dayA, monthA, yearA] = a.split('/');
                    const [dayB, monthB, yearB] = b.split('/');
                    return new Date(`${yearA}-${monthA}-${dayA}`) - new Date(`${yearB}-${monthB}-${dayB}`);
                });

                if (revenueChartInstance) revenueChartInstance.destroy();
                revenueChartInstance = new Chart(document.getElementById('revenue-chart'), {
                    type: 'line',
                    data: {
                        labels: sortedDays,
                        datasets: [{
                            label: 'Faturamento',
                            data: sortedDays.map(day => revenueByDay[day]),
                            borderColor: '#3b82f6',
                            tension: 0.1,
                            fill: false
                        }]
                    }
                });
                
                // Category Chart
                const salesByCategory = {};
                orders.forEach(order => {
                    if (order.items.toLowerCase().includes('pizza')) salesByCategory['Pizzas'] = (salesByCategory['Pizzas'] || 0) + 1;
                    else if (order.items.toLowerCase().includes('hambúrguer')) salesByCategory['Hambúrgueres'] = (salesByCategory['Hambúrgueres'] || 0) + 1;
                    else if (order.items.toLowerCase().includes('bebida')) salesByCategory['Bebidas'] = (salesByCategory['Bebidas'] || 0) + 1;
                    else salesByCategory['Outros'] = (salesByCategory['Outros'] || 0) + 1;
                });

                if (categoryChartInstance) categoryChartInstance.destroy();
                categoryChartInstance = new Chart(document.getElementById('category-chart'), {
                    type: 'pie',
                    data: {
                        labels: Object.keys(salesByCategory),
                        datasets: [{
                            data: Object.values(salesByCategory),
                            backgroundColor: ['#ef4444', '#f59e0b', '#22c55e', '#6b7280']
                        }]
                    }
                });
            }

            function renderTable(orders) {
                const tbody = document.getElementById('history-table-body');
                tbody.innerHTML = '';
                if (orders.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="6" class="text-center py-4">Nenhum pedido encontrado para os filtros selecionados.</td></tr>`;
                    return;
                }
                orders.forEach(order => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.date.toLocaleString('pt-BR')}</td>
                        <td class="px-6 py-4 whitespace-pre-wrap text-sm text-gray-900">${order.clientData.replace(/; /g, '\n')}</td>
                        <td class="px-6 py-4 whitespace-pre-wrap text-sm text-gray-500">${order.items.replace(/; /g, '\n')}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.type}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.payment}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">R$ ${order.total.toFixed(2).replace('.', ',')}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            function exportToCSV() {
                const tableRows = document.querySelectorAll('#history-table-body tr');
                let csvContent = "data:text/csv;charset=utf-8,Data,Cliente,Itens,Tipo,Pagamento,Total\n";
                
                tableRows.forEach(row => {
                    const cols = row.querySelectorAll('td');
                    if (cols.length === 0) return;
                    const rowData = Array.from(cols).map(col => `"${col.innerText.replace(/"/g, '""')}"`);
                    csvContent += rowData.join(',') + "\n";
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "historico_pedidos.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        });
    </script>
</body>
</html>

