<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatórios e Histórico - Sâmia Pizzaria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="icon" href="https://raw.githubusercontent.com/WillianSoares93/cardapio_samia_PDV/refs/heads/main/logo.png" type="image/png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f3f4f6;
            visibility: hidden;
        }
        .flatpickr-input {
            background-color: white;
        }
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .report-tab-btn, .period-filter-btn, .sort-btn, .category-chart-view-btn {
            transition: all 0.2s ease-in-out;
        }
        .report-tab-btn {
            border-bottom: 4px solid transparent;
        }
        .report-tab-btn.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        .period-filter-btn.active, .sort-btn.active, .category-chart-view-btn.active {
            background-color: #3b82f6;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-100">

    <header class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">Relatórios e Histórico</h1>
            <div class="flex items-center space-x-4">
                <a href="pdv.html" class="px-4 py-2 bg-blue-600 text-white text-sm font-bold rounded-md hover:bg-blue-700 transition-colors">
                    <i class="fas fa-clipboard-list mr-2"></i>Ir para o PDV
                </a>
                <button id="logout-btn" class="px-4 py-2 bg-red-600 text-white text-sm font-bold rounded-md hover:bg-red-700 transition-colors">
                    <i class="fas fa-sign-out-alt mr-2"></i>Sair
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <div id="loading-state" class="text-center py-10">
            <i class="fas fa-spinner fa-spin text-4xl text-blue-500"></i>
            <p class="mt-4 text-gray-600">Carregando dados históricos...</p>
        </div>

        <div id="report-content" class="hidden">
            <!-- Indicadores Chave -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <div class="bg-white p-5 rounded-lg shadow"><h3 class="text-sm font-medium text-gray-500">FATURAMENTO TOTAL</h3><p id="stats-total-revenue" class="text-3xl font-bold text-gray-800 mt-1">R$ 0,00</p></div>
                <div class="bg-white p-5 rounded-lg shadow"><h3 class="text-sm font-medium text-gray-500">TOTAL DE PEDIDOS</h3><p id="stats-total-orders" class="text-3xl font-bold text-gray-800 mt-1">0</p></div>
                <div class="bg-white p-5 rounded-lg shadow"><h3 class="text-sm font-medium text-gray-500">TICKET MÉDIO</h3><p id="stats-avg-ticket" class="text-3xl font-bold text-gray-800 mt-1">R$ 0,00</p></div>
                <div class="bg-white p-5 rounded-lg shadow"><h3 class="text-sm font-medium text-gray-500">PRODUTO MAIS VENDIDO</h3><p id="stats-top-product" class="text-xl font-bold text-gray-800 mt-1">-</p></div>
            </div>

            <!-- Filtros -->
            <div class="bg-white p-4 rounded-lg shadow mb-6 space-y-4">
                <div class="flex flex-col md:flex-row items-center gap-4">
                    <div class="flex-grow w-full md:w-auto">
                        <label for="date-filter" class="text-sm font-medium text-gray-700">Filtrar por Período</label>
                        <input type="text" id="date-filter" class="mt-1 w-full p-2 border border-gray-300 rounded-md" placeholder="Selecione um período personalizado">
                    </div>
                    <div class="flex-grow w-full md:w-auto">
                        <label for="search-filter" class="text-sm font-medium text-gray-700">Pesquisar</label>
                        <input type="text" id="search-filter" class="mt-1 w-full p-2 border border-gray-300 rounded-md" placeholder="Nome, telefone, item...">
                    </div>
                    <div class="self-end">
                         <button id="export-csv-btn" class="w-full md:w-auto px-4 py-2 bg-green-600 text-white font-bold rounded-md hover:bg-green-700 transition-colors">
                            <i class="fas fa-file-excel mr-2"></i>Exportar CSV
                        </button>
                    </div>
                </div>
                <div id="period-filter-buttons" class="flex flex-wrap items-center gap-2">
                    <span class="text-sm font-medium text-gray-700">Filtros rápidos:</span>
                    <button class="period-filter-btn px-3 py-1 bg-gray-200 text-gray-800 rounded-full text-sm" data-period="today">Hoje</button>
                    <button class="period-filter-btn px-3 py-1 bg-gray-200 text-gray-800 rounded-full text-sm" data-period="last7">Últimos 7 dias</button>
                    <button class="period-filter-btn px-3 py-1 bg-gray-200 text-gray-800 rounded-full text-sm" data-period="month">Este Mês</button>
                </div>
            </div>

            <!-- Abas de Relatórios -->
            <div class="bg-white rounded-lg shadow">
                <div class="border-b border-gray-200">
                    <nav id="report-tabs" class="-mb-px flex space-x-6 px-6" aria-label="Tabs">
                        <button class="report-tab-btn active py-4 px-1" data-target="geral-panel">Visão Geral</button>
                        <button class="report-tab-btn py-4 px-1" data-target="financeiro-panel">Financeiro</button>
                        <button class="report-tab-btn py-4 px-1" data-target="produtos-panel">Produtos</button>
                        <button class="report-tab-btn py-4 px-1" data-target="clientes-panel">Clientes e Bairros</button>
                    </nav>
                </div>
                <div class="p-6">
                    <div id="geral-panel" class="report-panel grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="space-y-6">
                            <div>
                                <h3 class="font-bold text-gray-800 mb-4">Faturamento por Dia</h3>
                                <canvas id="revenue-chart"></canvas>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-800 mb-4">Vendas por Categoria (Detalhado)</h3>
                                <div id="category-sales-table" class="max-h-96 overflow-y-auto"></div>
                            </div>
                        </div>
                        <div>
                             <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h3 class="font-bold text-gray-800">Vendas por Categoria</h3>
                                    <div id="category-chart-totals" class="text-xs text-gray-500 mt-1"></div>
                                </div>
                                <div class="text-sm bg-gray-100 rounded-full p-0.5">
                                    <button class="category-chart-view-btn active px-2 py-1 rounded-full text-xs" data-view="count">Quantidade</button>
                                    <button class="category-chart-view-btn px-2 py-1 rounded-full text-xs" data-view="revenue">Valor</button>
                                </div>
                            </div>
                            <canvas id="category-chart"></canvas>
                        </div>
                    </div>
                    <div id="financeiro-panel" class="report-panel hidden grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <h3 class="font-bold text-gray-800">Faturamento por Pagamento</h3>
                            <canvas id="payment-chart" class="h-48"></canvas>
                            <div id="payment-table" class="max-h-48 overflow-y-auto"></div>
                        </div>
                        <div class="bg-blue-50 p-5 rounded-lg flex flex-col items-center justify-center"><h3 class="text-lg font-medium text-blue-800">TOTAL TAXAS DE ENTREGA</h3><p id="stats-total-delivery-fee" class="text-4xl font-bold text-blue-900 mt-2">R$ 0,00</p></div>
                    </div>
                    <div id="produtos-panel" class="report-panel hidden">
                        <h3 class="font-bold text-gray-800 mb-4">Ranking de Produtos Vendidos</h3>
                        <div id="product-ranking-table" class="max-h-96 overflow-y-auto"></div>
                    </div>
                    <div id="clientes-panel" class="report-panel hidden grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="space-y-4">
                             <div class="flex justify-between items-center">
                                <h3 class="font-bold text-gray-800">Ranking de Clientes (Top 100)</h3>
                                <div class="text-sm bg-gray-100 rounded-full p-0.5">
                                    <button class="sort-btn active px-2 py-1 rounded-full text-xs" data-sort="revenue" data-target="client">Total Gasto</button>
                                    <button class="sort-btn px-2 py-1 rounded-full text-xs" data-sort="count" data-target="client">Nº Pedidos</button>
                                    <button class="sort-btn px-2 py-1 rounded-full text-xs" data-sort="deliveryFee" data-target="client">Taxas Entrega</button>
                                </div>
                            </div>
                            <canvas id="client-chart"></canvas>
                            <div id="client-ranking-table" class="max-h-96 overflow-y-auto"></div>
                        </div>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <h3 id="neighborhood-report-title" class="font-bold text-gray-800">Ranking de Bairros (Delivery)</h3>
                                <div class="text-sm bg-gray-100 rounded-full p-0.5">
                                    <button class="sort-btn active px-2 py-1 rounded-full text-xs" data-sort="revenue" data-target="neighborhood">Total Gasto</button>
                                    <button class="sort-btn px-2 py-1 rounded-full text-xs" data-sort="count" data-target="neighborhood">Nº Pedidos</button>
                                    <button class="sort-btn px-2 py-1 rounded-full text-xs" data-sort="deliveryFee" data-target="neighborhood">Taxas Entrega</button>
                                </div>
                            </div>
                            <canvas id="neighborhood-chart"></canvas>
                             <div id="neighborhood-table" class="max-h-96 overflow-y-auto"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabela de Histórico -->
            <div class="bg-white rounded-lg shadow overflow-x-auto mt-6">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Itens</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pagamento</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
                <div id="pagination-controls" class="px-6 py-3 flex items-center justify-between border-t">
                    <button id="prev-page-btn" class="pagination-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">Anterior</button>
                    <span id="page-info" class="text-sm text-gray-600">Página 1 de 1</span>
                    <button id="next-page-btn" class="pagination-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">Próxima</button>
                </div>
            </div>
        </div>
    </main>
    
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

        const firebaseConfig = {
           apiKey: "AIzaSyBJ44RVDGhBIlQBTx-pyIUp47XDKzRXk84",
           authDomain: "pizzaria-pdv.firebaseapp.com",
           projectId: "pizzaria-pdv",
           storageBucket: "pizzaria-pdv.firebasestorage.app",
           messagingSenderId: "304171744691",
           appId: "1:304171744691:web:e54d7f9fe55c7a75485fc6"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        
        document.addEventListener('DOMContentLoaded', () => {
            let allOrders = [];
            let fullMenuData = new Map();
            let filteredOrdersCache = [];
            let chartInstances = {};
            let currentPage = 1;
            const ROWS_PER_PAGE = 20;
            let clientSortCriteria = 'revenue'; 
            let neighborhoodSortCriteria = 'revenue';
            let categoryChartView = 'count';

            Chart.register(ChartDataLabels);

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    document.body.style.visibility = 'visible';
                    initializeApp();
                } else {
                    window.location.href = `login.html?redirect=relatorio.html`;
                }
            });

            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

            function parseDate(dateString) {
                if (!dateString || !dateString.includes(',')) return null;
                const [datePart, timePart] = dateString.split(', ');
                const [day, month, year] = datePart.split('/');
                return new Date(`${year}-${month}-${day}T${timePart}`);
            }

            async function initializeApp() {
                try {
                    const [historyResponse, menuResponse] = await Promise.all([
                        fetch('/api/historico'),
                        fetch('/api/menu')
                    ]);

                    if (!historyResponse.ok) throw new Error(`Erro ao buscar histórico: ${historyResponse.statusText}`);
                    if (!menuResponse.ok) throw new Error(`Erro ao buscar cardápio: ${menuResponse.statusText}`);
                    
                    const rawOrders = await historyResponse.json();
                    const menuData = await menuResponse.json();
                    
                    menuData.cardapio.forEach(item => fullMenuData.set(item.name, item));
                    
                    allOrders = rawOrders.map(order => ({ ...order, date: parseDate(order.date) })).filter(order => order.date !== null);
                    
                    document.getElementById('loading-state').classList.add('hidden');
                    document.getElementById('report-content').classList.remove('hidden');
                    
                    setupUI();
                    applyFilters();

                } catch (error) {
                    console.error("Falha ao inicializar:", error);
                    document.getElementById('loading-state').innerHTML = `<p class="text-red-500 font-bold">Não foi possível carregar os dados. Verifique o console.</p>`;
                }
            }

            function setupUI() {
                const datePicker = flatpickr("#date-filter", { mode: "range", dateFormat: "d/m/Y", locale: "pt", onChange: () => { currentPage = 1; applyFilters(); } });

                document.querySelectorAll('.period-filter-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.period-filter-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        
                        const period = btn.dataset.period;
                        const end = new Date();
                        end.setHours(23, 59, 59, 999);

                        let start = new Date();
                        start.setHours(0, 0, 0, 0);

                        switch(period) {
                            case 'today':
                                // start is already correct (start of today)
                                break;
                            case 'last7':
                                start.setDate(start.getDate() - 6);
                                break;
                            case 'month':
                                start = new Date(end.getFullYear(), end.getMonth(), 1);
                                start.setHours(0, 0, 0, 0);
                                break;
                        }
                        datePicker.setDate([start, end], true);
                    });
                });
                
                document.querySelectorAll('.sort-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const target = e.currentTarget.dataset.target;
                        document.querySelectorAll(`.sort-btn[data-target="${target}"]`).forEach(b => b.classList.remove('active'));
                        e.currentTarget.classList.add('active');

                        if(target === 'client'){
                            clientSortCriteria = e.currentTarget.dataset.sort;
                            renderClientRanking(filteredOrdersCache);
                        } else if (target === 'neighborhood') {
                            neighborhoodSortCriteria = e.currentTarget.dataset.sort;
                            renderNeighborhoodReports(filteredOrdersCache);
                        }
                    });
                });

                document.querySelectorAll('.category-chart-view-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.category-chart-view-btn').forEach(b => b.classList.remove('active'));
                        e.currentTarget.classList.add('active');
                        categoryChartView = e.currentTarget.dataset.view;
                        renderCategoryReports(filteredOrdersCache);
                    });
                });

                document.getElementById('search-filter').addEventListener('input', () => { currentPage = 1; applyFilters(); });
                document.getElementById('export-csv-btn').addEventListener('click', exportToCSV);
                document.getElementById('prev-page-btn').addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderTable(filteredOrdersCache); } });
                document.getElementById('next-page-btn').addEventListener('click', () => { const totalPages = Math.ceil(filteredOrdersCache.length / ROWS_PER_PAGE); if (currentPage < totalPages) { currentPage++; renderTable(filteredOrdersCache); } });
            
                document.getElementById('report-tabs').addEventListener('click', (e) => {
                    const btn = e.target.closest('.report-tab-btn');
                    if(btn) {
                        document.querySelectorAll('.report-tab-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        document.querySelectorAll('.report-panel').forEach(p => p.classList.add('hidden'));
                        document.getElementById(btn.dataset.target).classList.remove('hidden');
                    }
                });
            }

            function applyFilters() {
                const dateRange = document.getElementById('date-filter')._flatpickr.selectedDates;
                const searchTerm = document.getElementById('search-filter').value.toLowerCase();
                const keywords = searchTerm.split(/[\s,]+/).filter(k => k);
                
                if(!document.querySelector('.period-filter-btn.active') && dateRange.length > 0) {
                     document.querySelectorAll('.period-filter-btn').forEach(b => b.classList.remove('active'));
                }

                filteredOrdersCache = allOrders.filter(order => {
                    let dateMatch = true;
                    if (dateRange.length > 0) {
                        const startDate = new Date(dateRange[0]);
                        startDate.setHours(0, 0, 0, 0);
                        
                        const endDate = new Date(dateRange.length > 1 ? dateRange[1] : dateRange[0]);
                        endDate.setHours(23, 59, 59, 999);
                        
                        dateMatch = order.date >= startDate && order.date <= endDate;
                    }

                    const searchMatch = !searchTerm || keywords.every(keyword => 
                        order.clientData.toLowerCase().includes(keyword) ||
                        order.items.toLowerCase().includes(keyword)
                    );

                    return dateMatch && searchMatch;
                });

                renderAllReports(filteredOrdersCache);
            }
            
            function renderAllReports(orders) {
                updateDashboard(orders);
                renderTable(orders);
                renderRevenueChart(orders);
                renderCategoryReports(orders);
                renderPaymentReports(orders);
                renderDeliveryFeeReport(orders);
                renderProductRanking(orders);
                renderClientRanking(orders);
                renderNeighborhoodReports(orders);
            }

            function updateDashboard(orders) {
                const totalRevenue = orders.reduce((sum, order) => sum + order.total, 0);
                const totalOrders = orders.length;
                const avgTicket = totalOrders > 0 ? totalRevenue / totalOrders : 0;
                
                const itemCounts = {};
                orders.forEach(order => {
                    const items = order.items.split('; ');
                    items.forEach(itemString => {
                        const itemName = itemString.split(' [')[0].split(' (R$')[0].trim();
                        
                        let baseItemName = itemName;
                        if (itemName.includes('FATIAS: Meia')) {
                            baseItemName = itemName.split(' & Meia ')[1]; 
                        } else if (itemName.includes('FATIAS:')) {
                            baseItemName = itemName.split(': ')[1];
                        } else if (itemName === 'Hambúrguer Personalizado') {
                            baseItemName = 'Hambúrguer Montável';
                        }

                        const menuItem = fullMenuData.get(baseItemName);
                        const category = menuItem ? menuItem.category : 'Outros';
                        
                        if (!itemCounts[itemName]) {
                            itemCounts[itemName] = { count: 0, category: category };
                        }
                        itemCounts[itemName].count++;
                    });
                });
                
                let topProductHTML = '-';
                if (Object.keys(itemCounts).length > 0) {
                    const topProductEntry = Object.entries(itemCounts).reduce((a, b) => a[1].count > b[1].count ? a : b);
                    const topProductName = topProductEntry[0];
                    const topProductData = topProductEntry[1];
                    
                    const isPizzaCategory = Array.from(fullMenuData.values()).some(item => item.category === topProductData.category && item.isPizza);
                    let formattedCategory = topProductData.category;
                    if (topProductData.category !== 'Outros') {
                        formattedCategory = isPizzaCategory ? 
                            `Pizzas ${topProductData.category.charAt(0).toUpperCase() + topProductData.category.slice(1).toLowerCase()}` : 
                            `${topProductData.category.charAt(0).toUpperCase() + topProductData.category.slice(1).toLowerCase()}`;
                    }
                    
                    topProductHTML = `${topProductName} <span class="block text-sm font-medium text-gray-500">${formattedCategory}</span>`;
                }

                document.getElementById('stats-total-revenue').textContent = `R$ ${totalRevenue.toFixed(2).replace('.', ',')}`;
                document.getElementById('stats-total-orders').textContent = totalOrders;
                document.getElementById('stats-avg-ticket').textContent = `R$ ${avgTicket.toFixed(2).replace('.', ',')}`;
                document.getElementById('stats-top-product').innerHTML = topProductHTML;
            }

            function renderRevenueChart(orders) {
                const revenueByDay = orders.reduce((acc, order) => {
                    const day = order.date.toLocaleDateString('pt-BR');
                    acc[day] = (acc[day] || 0) + order.total;
                    return acc;
                }, {});
                const sortedDays = Object.keys(revenueByDay).sort((a,b) => parseDate(a + ", 00:00:00") - parseDate(b + ", 00:00:00"));
                renderChart('revenue-chart', 'line', { labels: sortedDays, datasets: [{ label: 'Faturamento', data: sortedDays.map(day => revenueByDay[day]), borderColor: '#3b82f6', tension: 0.1 }] });
            }

            function renderCategoryReports(orders) {
                const categorySalesData = {};
                const totalRevenue = orders.reduce((sum, order) => sum + order.total, 0);

                const processCategoryData = (itemName, value, price) => {
                    const menuItem = fullMenuData.get(itemName) || fullMenuData.get(itemName.replace('Hambúrguer Personalizado', 'Hambúrguer Montável'));
                    const category = menuItem ? menuItem.category : 'Outros';
                    const isPizzaCategory = Array.from(fullMenuData.values()).some(item => item.category === category && item.isPizza);
                    
                    let formattedCategory;
                    if (category === 'Outros') {
                        formattedCategory = 'Outros';
                    } else if (isPizzaCategory) {
                        formattedCategory = `Pizzas ${category.charAt(0).toUpperCase() + category.slice(1).toLowerCase()}`;
                    } else {
                        formattedCategory = category.charAt(0).toUpperCase() + category.slice(1).toLowerCase();
                    }

                    if (!categorySalesData[formattedCategory]) {
                        categorySalesData[formattedCategory] = { count: 0, revenue: 0 };
                    }
                    categorySalesData[formattedCategory].count += value;
                    categorySalesData[formattedCategory].revenue += price;
                };

                orders.forEach(order => {
                    order.items.split('; ').forEach(itemString => {
                        const itemPriceMatch = itemString.match(/\(R\$\s*([\d,]+)\)/);
                        const itemPrice = itemPriceMatch ? parseFloat(itemPriceMatch[1].replace(',', '.')) : 0;
                        let itemName = itemString.split(' [')[0].split(' (R$')[0].trim();
                        
                        if (itemName.includes('FATIAS: Meia')) {
                            const parts = itemName.split(' & Meia ');
                            const firstHalfName = parts[0].split(' Meia ')[1];
                            const secondHalfName = parts[1];
                            processCategoryData(firstHalfName, 0.5, itemPrice / 2);
                            processCategoryData(secondHalfName, 0.5, itemPrice / 2);
                        } else {
                            if (itemName.includes('FATIAS:')) {
                                itemName = itemName.split(': ')[1];
                            }
                            processCategoryData(itemName, 1, itemPrice);
                        }
                    });
                });
                
                let totalCategoryCount = 0;
                let totalCategoryRevenue = 0;
                for (const category in categorySalesData) {
                    totalCategoryCount += categorySalesData[category].count;
                    totalCategoryRevenue += categorySalesData[category].revenue;
                }

                const totalsContainer = document.getElementById('category-chart-totals');
                if (totalsContainer) {
                    totalsContainer.innerHTML = `
                        <span>Total Itens: <strong>${totalCategoryCount % 1 === 0 ? totalCategoryCount : totalCategoryCount.toFixed(1).replace('.', ',')}</strong></span> | 
                        <span>Valor Total: <strong>R$ ${totalCategoryRevenue.toFixed(2).replace('.', ',')}</strong></span>
                    `;
                }

                // Render Pie Chart
                const chartLabels = Object.keys(categorySalesData);
                let dataForChart;
                let datalabelsFormatter;
                let datalabelsConfig = {
                    color: '#fff',
                    font: {
                        weight: 'bold'
                    }
                };

                switch (categoryChartView) {
                    case 'revenue':
                        dataForChart = chartLabels.map(label => categorySalesData[label].revenue);
                        datalabelsFormatter = (value, ctx) => {
                            const percentage = totalRevenue > 0 ? (value / totalRevenue) * 100 : 0;
                            return [`R$ ${value.toFixed(2).replace('.', ',')}`, `(${percentage.toFixed(1).replace('.', ',')}%)`];
                        };
                        datalabelsConfig.font = { weight: 'bold', size: 12 };
                        datalabelsConfig.align = 'center';
                        break;
                    case 'count':
                    default:
                        dataForChart = chartLabels.map(label => categorySalesData[label].count);
                        datalabelsFormatter = (value) => value % 1 === 0 ? value : value.toFixed(1).replace('.', ',');
                        datalabelsConfig.font = { weight: 'bold', size: 12 };
                        break;
                }

                const pieChartData = {
                    labels: chartLabels,
                    datasets: [{
                        data: dataForChart,
                        backgroundColor: ['#ef4444', '#f59e0b', '#22c55e', '#6b7280', '#6366f1', '#ec4899']
                    }]
                };

                const pieChartOptions = {
                    plugins: {
                        datalabels: {
                            ...datalabelsConfig,
                            formatter: datalabelsFormatter,
                        }
                    }
                };
                renderChart('category-chart', 'pie', pieChartData, pieChartOptions);

                // Render Numerical Table
                const tableContainer = document.getElementById('category-sales-table');
                const sortedCategories = Object.entries(categorySalesData).sort((a, b) => b[1].revenue - a[1].revenue);
                let tableHtml = `<table class="min-w-full divide-y divide-gray-200 text-sm">
                    <thead class="bg-gray-50"><tr>
                        <th class="px-4 py-2 text-left font-medium text-gray-500">Categoria</th>
                        <th class="px-4 py-2 text-left font-medium text-gray-500">Qtd. Vendida</th>
                        <th class="px-4 py-2 text-left font-medium text-gray-500">Valor Total</th>
                    </tr></thead>
                    <tbody class="bg-white divide-y divide-gray-200">`;
                sortedCategories.forEach(([categoryName, data]) => {
                    tableHtml += `<tr>
                        <td class="px-4 py-2">${categoryName}</td>
                        <td class="px-4 py-2">${data.count % 1 === 0 ? data.count : data.count.toFixed(1).replace('.', ',')}</td>
                        <td class="px-4 py-2 font-medium">R$ ${data.revenue.toFixed(2).replace('.', ',')}</td>
                    </tr>`;
                });
                tableHtml += `</tbody></table>`;
                tableContainer.innerHTML = tableHtml;
            }


            function renderPaymentReports(orders) {
                const salesByPayment = orders.reduce((acc, order) => {
                    const paymentMethod = (order.payment && String(order.payment).split(' (')[0].replace(/.*Débito.*/, 'Cartão')) || 'Não definido';
                    acc[paymentMethod] = (acc[paymentMethod] || 0) + order.total;
                    return acc;
                }, {});
                renderChart('payment-chart', 'bar', {
                    labels: Object.keys(salesByPayment),
                    datasets: [{ label: 'Faturamento', data: Object.values(salesByPayment), backgroundColor: '#10b981' }]
                }, { indexAxis: 'y' });
                
                const tableHtml = createSimpleTable(salesByPayment, "Pagamento", "Faturamento", true);
                document.getElementById('payment-table').innerHTML = tableHtml;
            }

            function renderDeliveryFeeReport(orders) {
                const totalFee = orders.reduce((sum, order) => sum + (order.deliveryFee || 0), 0);
                document.getElementById('stats-total-delivery-fee').textContent = `R$ ${totalFee.toFixed(2).replace('.', ',')}`;
            }

            function renderProductRanking(orders) {
                const productCounts = {};
                 orders.forEach(order => {
                    order.items.split('; ').forEach(itemString => {
                        const itemName = itemString.split(' [')[0].split(' (R$')[0].trim();
                        const itemPriceMatch = itemString.match(/\(R\$\s*([\d,]+)\)/);
                        const itemPrice = itemPriceMatch ? parseFloat(itemPriceMatch[1].replace(',', '.')) : 0;
                        if (!productCounts[itemName]) { productCounts[itemName] = { count: 0, revenue: 0 }; }
                        productCounts[itemName].count++;
                        productCounts[itemName].revenue += itemPrice;
                    });
                });
                const sortedProducts = Object.entries(productCounts).sort((a, b) => b[1].count - a[1].count);
                const tableHtml = createRankingTable(sortedProducts, ['Produto', 'Qtd.', 'Faturamento'], [
                    (data, key) => key,
                    (data) => data.count,
                    (data) => `R$ ${data.revenue.toFixed(2).replace('.', ',')}`
                ]);
                document.getElementById('product-ranking-table').innerHTML = tableHtml;
            }

            function renderClientRanking(orders) {
                const clientData = {};
                orders.forEach(order => {
                    const name = (order.clientData.split(';')[0] || 'N/A').trim();
                    if(name === 'N/A' || !name) return;
                    
                    if (!clientData[name]) { 
                        const phoneMatch = order.clientData.match(/\(\s*\d{2}\s*\)\s*\d{4,5}[- ]?\d{4}|\d{10,11}/);
                        clientData[name] = { 
                            count: 0, 
                            revenue: 0, 
                            phone: phoneMatch ? phoneMatch[0] : '',
                            deliveryFee: 0
                        }; 
                    }
                    clientData[name].count++;
                    clientData[name].revenue += order.total;
                    clientData[name].deliveryFee += order.deliveryFee || 0;
                });

                if (Object.keys(clientData).length === 0) {
                     document.getElementById('client-ranking-table').innerHTML = '<p class="text-center text-gray-500 py-4">Nenhum dado de cliente encontrado para exibir o ranking.</p>';
                     document.getElementById('client-chart').style.display = 'none';
                     return;
                }
                
                document.getElementById('client-chart').style.display = 'block';

                const sortedClients = Object.entries(clientData).sort((a, b) => b[1][clientSortCriteria] - a[1][clientSortCriteria]);
                const top5Clients = sortedClients.slice(0,5);

                const chartData = {
                    labels: top5Clients.map(c => c[0]),
                    datasets: [
                        { label: 'Nº de Pedidos', data: top5Clients.map(c => c[1].count), backgroundColor: '#8b5cf6', yAxisID: 'yCount' },
                        { label: 'Total Gasto (R$)', data: top5Clients.map(c => c[1].revenue), backgroundColor: '#16a34a', yAxisID: 'yRevenue' },
                        { label: 'Taxas de Entrega (R$)', data: top5Clients.map(c => c[1].deliveryFee), backgroundColor: '#f97316', yAxisID: 'yRevenue' }
                    ]
                };
                 const chartOptions = { scales: { yCount: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Nº de Pedidos' } }, yRevenue: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Total Gasto (R$)'}, grid: { drawOnChartArea: false } } } };
                
                renderChart('client-chart', 'bar', chartData, chartOptions);

                const top100ClientsForTable = sortedClients.slice(0, 100);

                const tableHtml = createRankingTable(top100ClientsForTable, ['Cliente', 'Pedidos', 'Taxa Entrega', 'Total Gasto'], [
                    (data, key) => `${key} <span class="text-xs text-gray-500 block">${data.phone}</span>`,
                    (data) => data.count,
                    (data) => `R$ ${data.deliveryFee.toFixed(2).replace('.', ',')}`,
                    (data) => `R$ ${data.revenue.toFixed(2).replace('.', ',')}`
                ]);
                document.getElementById('client-ranking-table').innerHTML = tableHtml;
            }
            
            function renderNeighborhoodReports(orders) {
                const deliveryOrders = orders.filter(order => order.type === 'Delivery');
                const titleElement = document.getElementById('neighborhood-report-title');
                titleElement.innerHTML = `Ranking de Bairros (Delivery)`;
                
                const salesByNeighborhood = {};
                deliveryOrders.forEach(order => {
                    if (order.clientData.includes(';')) {
                        let addressPart = (order.clientData.split(';')[1] || '').trim();
                        addressPart = addressPart.replace(/\(Ref:.*\)/i, '').trim();
                        
                        const parts = addressPart.split(/[,-]/);
                        let neighborhood = 'N/A';

                        for (let i = parts.length - 1; i >= 0; i--) {
                            const potentialNeighborhood = parts[i].trim();
                            if (potentialNeighborhood && isNaN(potentialNeighborhood) && potentialNeighborhood.toLowerCase() !== 's/n') {
                                neighborhood = potentialNeighborhood;
                                break;
                            }
                        }
                        
                        if (neighborhood !== 'N/A') { 
                            if (!salesByNeighborhood[neighborhood]) {
                                salesByNeighborhood[neighborhood] = { count: 0, revenue: 0, deliveryFee: 0 };
                            }
                            salesByNeighborhood[neighborhood].count++;
                            salesByNeighborhood[neighborhood].revenue += order.total;
                            salesByNeighborhood[neighborhood].deliveryFee += order.deliveryFee || 0;
                        }
                    }
                });

                const sortedNeighborhoods = Object.entries(salesByNeighborhood)
                    .sort((a,b) => b[1][neighborhoodSortCriteria] - a[1][neighborhoodSortCriteria]);

                if (sortedNeighborhoods.length === 0) {
                    document.getElementById('neighborhood-chart').style.display = 'none';
                    document.getElementById('neighborhood-table').innerHTML = '<p class="text-center text-gray-500 py-4">Nenhum dado de bairro encontrado.</p>';
                    return;
                }
                
                document.getElementById('neighborhood-chart').style.display = 'block';
                const top5Neighborhoods = sortedNeighborhoods.slice(0, 5);
                
                const chartData = {
                    labels: top5Neighborhoods.map(n => n[0]),
                    datasets: [
                        { 
                            label: 'Nº de Pedidos', 
                            data: top5Neighborhoods.map(n => n[1].count), 
                            backgroundColor: '#8b5cf6',
                            yAxisID: 'yCount'
                        },
                        { 
                            label: 'Total Gasto (R$)', 
                            data: top5Neighborhoods.map(n => n[1].revenue), 
                            backgroundColor: '#16a34a',
                            yAxisID: 'yRevenue'
                        },
                        { 
                            label: 'Taxas de Entrega (R$)', 
                            data: top5Neighborhoods.map(n => n[1].deliveryFee), 
                            backgroundColor: '#f97316',
                            yAxisID: 'yRevenue'
                        }
                    ]
                };

                const chartOptions = {
                    scales: {
                        yCount: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Nº de Pedidos'
                            }
                        },
                        yRevenue: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Total Gasto (R$)'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                };
                
                renderChart('neighborhood-chart', 'bar', chartData, chartOptions);
                
                const tableHtml = createRankingTable(sortedNeighborhoods, ['Bairro', 'Pedidos', 'Taxa Entrega', 'Total Gasto'], [
                    (data, key) => key,
                    (data) => data.count,
                    (data) => `R$ ${data.deliveryFee.toFixed(2).replace('.', ',')}`,
                    (data) => `R$ ${data.revenue.toFixed(2).replace('.', ',')}`
                ]);
                document.getElementById('neighborhood-table').innerHTML = tableHtml;
            }

            function renderChart(canvasId, type, data, options = {}) {
                if (chartInstances[canvasId]) chartInstances[canvasId].destroy();
                chartInstances[canvasId] = new Chart(document.getElementById(canvasId), { type, data, options });
            }

            function createSimpleTable(data, keyHeader, valueHeader, isCurrency = false) {
                 return `<table class="min-w-full text-sm">
                    <thead class="bg-gray-100"><tr><th class="px-2 py-1 text-left font-medium">${keyHeader}</th><th class="px-2 py-1 text-left font-medium">${valueHeader}</th></tr></thead>
                    <tbody>${Object.entries(data).map(([key, value]) => `<tr><td class="px-2 py-1">${key}</td><td class="px-2 py-1">${isCurrency ? `R$ ${value.toFixed(2).replace('.',',')}` : value}</td></tr>`).join('')}</tbody>
                </table>`;
            }
            
            function createRankingTable(sortedData, headers, formatters) {
                let table = `<table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50"><tr>${headers.map(h => `<th class="px-4 py-2 text-left text-xs font-medium text-gray-500">${h}</th>`).join('')}</tr></thead>
                    <tbody class="bg-white divide-y divide-gray-200">`;
                
                sortedData.forEach(([key, data]) => {
                    table += '<tr>';
                    formatters.forEach(formatter => {
                        table += `<td class="px-4 py-2 text-sm">${formatter(data, key)}</td>`;
                    });
                    table += '</tr>';
                });

                table += '</tbody></table>';
                return table;
            }


            function renderTable(orders) {
                const tbody = document.getElementById('history-table-body');
                tbody.innerHTML = '';
                const totalPages = Math.ceil(orders.length / ROWS_PER_PAGE);

                if (orders.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="6" class="text-center py-4">Nenhum pedido encontrado.</td></tr>`;
                    document.getElementById('pagination-controls').classList.add('hidden'); return;
                }
                
                document.getElementById('pagination-controls').classList.remove('hidden');
                const start = (currentPage - 1) * ROWS_PER_PAGE;
                const end = start + ROWS_PER_PAGE;
                const paginatedOrders = orders.slice(start, end);

                paginatedOrders.forEach(order => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.date.toLocaleString('pt-BR')}</td>
                        <td class="px-6 py-4 whitespace-pre-wrap text-sm text-gray-900">${order.clientData.replace(/; /g, '\n')}</td>
                        <td class="px-6 py-4 whitespace-pre-wrap text-sm text-gray-500">${order.items.replace(/; /g, '\n')}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.type}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.payment || 'Não definido'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">R$ ${order.total.toFixed(2).replace('.', ',')}</td>`;
                    tbody.appendChild(tr);
                });

                document.getElementById('page-info').textContent = `Página ${currentPage} de ${totalPages}`;
                document.getElementById('prev-page-btn').disabled = currentPage === 1;
                document.getElementById('next-page-btn').disabled = currentPage === totalPages;
            }

            function exportToCSV() {
                let csvContent = "data:text/csv;charset=utf-8,Data,Cliente,Itens,Tipo,Pagamento,Total\n";
                filteredOrdersCache.forEach(order => {
                    const rowData = [
                        order.date.toLocaleString('pt-BR'), order.clientData, order.items, order.type,
                        order.payment, order.total.toFixed(2).replace('.', ',')
                    ].map(field => `"${String(field).replace(/"/g, '""')}"`);
                    csvContent += rowData.join(',') + "\n";
                });
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "historico_pedidos.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        });
    </script>
</body>
</html>

